{
  "name": "Web Chat Adapter - COMPLETE with File Processing",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/webchat-api",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "https://cryptomator.pro,http://localhost,https://*.cryptomator.pro"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1424,
        208
      ],
      "id": "dbd62007-472e-4cd2-9bb4-e4597f944eb2",
      "name": "Web Chat Webhook",
      "webhookId": "2854421e-5b06-49c2-8fcc-d4c86bccaa9c"
    },
    {
      "parameters": {
        "jsCode": "// Rate Limiter - –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô\nconst input = $input.first();\nconsole.log('=== RATE LIMITER ACTIVATED ===');\n\nconst sessionId = input.json?.body?.session_id || input.json?.session_id || 'unknown';\nconsole.log('üîç Session ID:', sessionId);\n\nconst now = Date.now();\n\nif (!global.rateLimitStore) {\n  global.rateLimitStore = {};\n}\n\nconst store = global.rateLimitStore;\n\nObject.keys(store).forEach(key => {\n  const session = store[key];\n  if (now - session.lastActivity > 7200000) {\n    delete store[key];\n    console.log('üßπ –û—á–∏—â–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è —Å–µ—Å—Å–∏—è:', key);\n  }\n});\n\nif (!store[sessionId]) {\n  store[sessionId] = {\n    minuteRequests: [],\n    hourRequests: [],\n    lastActivity: now,\n    totalRequests: 0\n  };\n  console.log('‚ú® –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è:', sessionId);\n}\n\nconst session = store[sessionId];\nsession.lastActivity = now;\nsession.totalRequests++;\n\nconst oneMinuteAgo = now - 60000;\nconst oneHourAgo = now - 3600000;\n\nsession.minuteRequests = session.minuteRequests.filter(timestamp => timestamp > oneMinuteAgo);\nsession.hourRequests = session.hourRequests.filter(timestamp => timestamp > oneHourAgo);\n\nsession.minuteRequests.push(now);\nsession.hourRequests.push(now);\n\nconsole.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:');\nconsole.log('- –ó–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –º–∏–Ω—É—Ç—É:', session.minuteRequests.length);\nconsole.log('- –ó–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —á–∞—Å:', session.hourRequests.length);\n\nconst minuteLimit = 15;\nconst hourLimit = 100;\n\nif (session.minuteRequests.length > minuteLimit) {\n  const errorResponse = {\n    responseType: 'text',\n    content: {\n      text: `‚è∞ <b>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</b><br><br>–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç: ${minuteLimit} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É.`,\n      language: 'ru'\n    },\n    success: false,\n    error: { type: 'rate_limit_minute', limit: minuteLimit, current: session.minuteRequests.length },\n    timestamp: new Date().toISOString()\n  };\n  console.log('‚ùå –ë–õ–û–ö–ò–†–û–í–ö–ê: –ü—Ä–µ–≤—ã—à–µ–Ω –º–∏–Ω—É—Ç–Ω—ã–π –ª–∏–º–∏—Ç');\n  throw new Error(JSON.stringify(errorResponse));\n}\n\nif (session.hourRequests.length > hourLimit) {\n  const errorResponse = {\n    responseType: 'text',\n    content: {\n      text: `‚è∞ <b>–ü—Ä–µ–≤—ã—à–µ–Ω —á–∞—Å–æ–≤–æ–π –ª–∏–º–∏—Ç</b><br><br>–õ–∏–º–∏—Ç: ${hourLimit} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Å.`,\n      language: 'ru'\n    },\n    success: false,\n    error: { type: 'rate_limit_hour', limit: hourLimit, current: session.hourRequests.length },\n    timestamp: new Date().toISOString()\n  };\n  console.log('‚ùå –ë–õ–û–ö–ò–†–û–í–ö–ê: –ü—Ä–µ–≤—ã—à–µ–Ω —á–∞—Å–æ–≤–æ–π –ª–∏–º–∏—Ç');\n  throw new Error(JSON.stringify(errorResponse));\n}\n\nconsole.log('‚úÖ Rate limit check passed');\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -928,
        160
      ],
      "id": "219d4f17-0e15-4357-bdfa-55d88fee1f70",
      "name": "Rate Limiter"
    },
    {
      "parameters": {
        "jsCode": "// Web Chat Processor - –° –ü–û–î–î–ï–†–ñ–ö–û–ô –§–ê–ô–õ–û–í\nconst input = $input.first();\nconsole.log('=== WEB CHAT PROCESSOR (WITH FILE SUPPORT) ===');\n\nconst webhookData = input.json?.body || {};\nconst originalSessionId = webhookData.session_id;\nconst cleanSessionId = originalSessionId ? originalSessionId.replace('webchat_', '') : null;\n\nif (!cleanSessionId) {\n  throw new Error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: session_id –Ω–µ –Ω–∞–π–¥–µ–Ω!');\n}\n\nconst messageText = webhookData.message_text || webhookData.text || webhookData.content?.text || '';\nconst userId = webhookData.user_id || cleanSessionId.split('_')[0] || 'web_user';\nconst userName = webhookData.user_name || webhookData.userName || 'Web User';\nconst language = webhookData.language || webhookData.detected_language || 'ru';\nconst messageType = webhookData.messageType || webhookData.message_type || 'text';\n\nconsole.log('‚úÖ Session ID (CLEANED):', cleanSessionId);\nconsole.log('‚úÖ Message Text:', messageText);\n\n// üÜï –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –§–ê–ô–õ–û–í\nconst hasFile = !!(webhookData.file_data || webhookData.file);\nlet fileData = null;\n\nif (hasFile) {\n  fileData = {\n    file_data: webhookData.file_data || webhookData.file?.data,\n    file_name: webhookData.file_name || webhookData.file?.name || 'unnamed_file',\n    file_type: webhookData.file_type || webhookData.file?.type || 'application/octet-stream',\n    file_size: webhookData.file_size || webhookData.file?.size || 0,\n    file_format: webhookData.file_format || 'base64'\n  };\n  console.log('üìé –§–ê–ô–õ:', fileData.file_name, '(', fileData.file_type, ')');\n}\n\nconst webhookHeaders = input.json?.headers || {};\n\nconst unifiedMessage = {\n  platform: 'webchat',\n  message_text: messageText,\n  user_id: userId,\n  user_name: userName,\n  chat_id: cleanSessionId,\n  session_id: cleanSessionId,\n  language: language,\n  detected_language: language,\n  messageType: messageType,\n  \n  content: webhookData.content || {\n    text: messageText,\n    metadata: {\n      timestamp: new Date().toISOString(),\n      userAgent: webhookHeaders['user-agent'],\n      url: webhookData.content?.metadata?.url,\n      chatLanguage: webhookData.content?.metadata?.chatLanguage || language\n    }\n  },\n  \n  // –§–∞–π–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\n  ...(fileData ? fileData : {}),\n  has_file: hasFile,\n  \n  ip_address: webhookHeaders['x-forwarded-for'] || webhookHeaders['x-real-ip'],\n  user_agent: webhookHeaders['user-agent'],\n  page_url: webhookData.content?.metadata?.url,\n  \n  voice_data: webhookData.content?.voice?.audioData || webhookData.voice_data,\n  voice_format: webhookData.content?.voice?.format || webhookData.voice_format,\n  \n  platformCapabilities: webhookData.platformCapabilities || {\n    supportsVoice: true,\n    supportsButtons: true,\n    supportsFiles: true,\n    maxTextLength: null\n  },\n  \n  timestamp: new Date().toISOString(),\n  requires_processing: true,\n  is_web_chat: true,\n  \n  debug_info: {\n    original_session_id: originalSessionId,\n    cleaned_session_id: cleanSessionId,\n    has_file: hasFile,\n    file_type: fileData?.file_type || 'none'\n  }\n};\n\nif (messageType === 'voice' && unifiedMessage.voice_data) {\n  unifiedMessage.has_voice_data = true;\n  unifiedMessage.message_text = '[–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]';\n}\n\nconsole.log('‚úÖ Unified message prepared');\nreturn [{ json: unifiedMessage }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -768,
        160
      ],
      "id": "b420a860-5521-40c6-95db-e74abcd57c34",
      "name": "Web Chat Processor"
    },
    {
      "parameters": {
        "jsCode": "// INPUT VALIDATOR - –° –í–ê–õ–ò–î–ê–¶–ò–ï–ô –§–ê–ô–õ–û–í\nconst input = $input.first();\nconsole.log('=== INPUT VALIDATOR (WITH FILE VALIDATION) ===');\n\nconst data = input.json;\nconst requiredFields = ['session_id', 'user_id', 'platform'];\nconst missingFields = requiredFields.filter(field => !data[field]);\n\nif (missingFields.length > 0) {\n  throw new Error(`Missing required fields: ${missingFields.join(', ')}`);\n}\n\nconst messageText = data.message_text || data.text || '';\nconst messageType = data.messageType || 'text';\n\nif (messageType === 'text' && !messageText && !data.has_file) {\n  throw new Error(JSON.stringify({\n    responseType: 'text',\n    content: { text: '‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', language: 'ru' },\n    success: false\n  }));\n}\n\nconst maxLength = 5000;\nif (messageText.length > maxLength) {\n  throw new Error(JSON.stringify({\n    responseType: 'text',\n    content: { text: `üìè –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å ${maxLength})`, language: 'ru' },\n    success: false\n  }));\n}\n\n// –í–ê–õ–ò–î–ê–¶–ò–Ø –§–ê–ô–õ–û–í\nif (data.has_file && data.file_data) {\n  const allowedTypes = [\n    'image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp',\n    'application/pdf', 'text/plain', 'text/csv',\n    'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n    'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'\n  ];\n  \n  const fileType = data.file_type;\n  const fileSize = data.file_size || 0;\n  const maxFileSize = 10 * 1024 * 1024;\n  \n  if (!allowedTypes.includes(fileType)) {\n    throw new Error(JSON.stringify({\n      responseType: 'text',\n      content: { text: `üìé –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞: ${fileType}`, language: 'ru' },\n      success: false\n    }));\n  }\n  \n  if (fileSize > maxFileSize) {\n    throw new Error(JSON.stringify({\n      responseType: 'text',\n      content: { text: `üìé –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 10MB)`, language: 'ru' },\n      success: false\n    }));\n  }\n  \n  console.log('‚úÖ –§–∞–π–ª –≤–∞–ª–∏–¥–µ–Ω:', data.file_name);\n}\n\nconsole.log('‚úÖ Validation passed');\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        160
      ],
      "id": "2665c601-0e8d-439d-a214-79d25fdafdf6",
      "name": "Input Validator"
    },
    {
      "parameters": {
        "jsCode": "// FILE DETECTOR & CONVERTER - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô\nconst input = $input.first();\nconsole.log('=== FILE DETECTOR ===');\n\nconst data = input.json;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞\nif (!data.has_file || !data.file_data) {\n  console.log('‚ÑπÔ∏è –§–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');\n  return [{\n    json: {\n      ...data,\n      file_category: 'no_file',\n      skip_file_processing: true\n    }\n  }];\n}\n\nconsole.log('üìé –§–∞–π–ª –æ–±–Ω–∞—Ä—É–∂–µ–Ω:', data.file_name);\nconsole.log('üìé –¢–∏–ø —Ñ–∞–π–ª–∞:', data.file_type);\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ñ–∞–π–ª–∞\nlet fileCategory = 'unknown';\nconst fileType = data.file_type.toLowerCase();\n\nif (fileType.startsWith('image/')) {\n  fileCategory = 'image';\n  console.log('üñºÔ∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï');\n} else if (\n  fileType.includes('pdf') ||\n  fileType.includes('document') ||\n  fileType.includes('word') ||\n  fileType.includes('excel') ||\n  fileType.includes('sheet') ||\n  fileType.includes('text/')\n) {\n  fileCategory = 'document';\n  console.log('üìÑ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –î–û–ö–£–ú–ï–ù–¢');\n} else {\n  console.log('‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø:', fileType);\n  fileCategory = 'no_file'; // –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É\n}\n\nconsole.log('‚úÖ file_category:', fileCategory);\n\n// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 –≤ Buffer\ntry {\n  const buffer = Buffer.from(data.file_data, 'base64');\n  console.log('‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è base64 ‚Üí binary');\n  console.log('üìä –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞:', buffer.length, '–±–∞–π—Ç');\n  \n  // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º file_category!\n  return [{\n    json: {\n      ...data,\n      file_category: fileCategory, // ‚Üê –í–û–¢ –û–ù–û!\n      original_message_text: data.message_text,\n      file_processed: true\n    },\n    binary: {\n      data: {\n        data: buffer,\n        mimeType: data.file_type,\n        fileName: data.file_name\n      }\n    }\n  }];\n} catch (error) {\n  console.error('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:', error.message);\n  return [{\n    json: {\n      ...data,\n      file_category: 'no_file',\n      skip_file_processing: true,\n      conversion_error: error.message\n    }\n  }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        160
      ],
      "id": "c2d5c3a6-6a05-485d-b5bd-d438a81e04d1",
      "name": "File Detector"
    },
    {
      "parameters": {
        "mode": "expression",
        "numberOutputs": 2,
        "output": "={{ $json.file_category === 'image' ? 0 : ($json.file_category === 'document' ? 1 : 2) }}"
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -112,
        16
      ],
      "id": "0e44304f-4b49-45ba-8955-fbf396f23850",
      "name": "File Category Router"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        128,
        16
      ],
      "id": "f9688909-f977-4932-b0fd-06bbb8060f35",
      "name": "Image Analyzer",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        128,
        176
      ],
      "id": "2addc5f7-b208-4a35-aeaa-51bf6a3acb45",
      "name": "Document Analyzer",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// MERGE FILE ANALYSIS\nconst input = $input.first();\nconsole.log('=== MERGE FILE ANALYSIS ===');\n\nconst geminiResponse = input.json;\n\nlet fileAnalysis = '';\nif (geminiResponse.content?.parts) {\n  fileAnalysis = geminiResponse.content.parts[0].text || '';\n} else if (geminiResponse.text) {\n  fileAnalysis = geminiResponse.text;\n} else {\n  fileAnalysis = '[–ê–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω]';\n}\n\nconsole.log('üìÑ –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—É—á–µ–Ω (', fileAnalysis.length, '—Å–∏–º–≤.)');\n\nconst originalText = geminiResponse.original_message_text || '';\nconst fileName = geminiResponse.file_name || '—Ñ–∞–π–ª';\n\nlet enrichedText = '';\nif (originalText && originalText.trim()) {\n  enrichedText = `${originalText}\\n\\nüìé **–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞ \"${fileName}\":**\\n${fileAnalysis}`;\n} else {\n  enrichedText = `üìé **–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞ \"${fileName}\":**\\n${fileAnalysis}`;\n}\n\nconsole.log('‚úÖ –¢–µ–∫—Å—Ç –æ–±–æ–≥–∞—â–µ–Ω –∞–Ω–∞–ª–∏–∑–æ–º —Ñ–∞–π–ª–∞');\n\nreturn [{\n  json: {\n    ...geminiResponse,\n    message_text: enrichedText,\n    text: enrichedText,\n    original_text: enrichedText,\n    file_analysis: fileAnalysis,\n    file_was_processed: true,\n    processed_file_name: fileName\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        96
      ],
      "id": "6a519fdb-b6b7-4804-b5d8-9f2833411057",
      "name": "Merge File Analysis"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        496,
        272
      ],
      "id": "2d5d9b0b-8b03-4dfb-8cdf-7d9e0b413a3d",
      "name": "File Paths Merger"
    },
    {
      "parameters": {
        "jsCode": "// Language Detection - –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø (–±–µ–∑ –ª–æ–≥–æ–≤)\nconst input = $input.all();\n\nif (!input || input.length === 0) {\n  throw new Error('No input data');\n}\n\nlet item;\n\nif (input.length > 1) {\n  const itemWithSessionId = input.find(i => i.json.session_id && i.json.session_id !== 'webchat_unknown');\n  const itemWithFileAnalysis = input.find(i => i.json.file_analysis);\n  \n  if (itemWithSessionId) {\n    item = itemWithSessionId.json;\n    \n    if (itemWithFileAnalysis && itemWithFileAnalysis.json.file_analysis) {\n      const fileAnalysis = itemWithFileAnalysis.json.file_analysis;\n      const fileName = itemWithFileAnalysis.json.processed_file_name || '—Ñ–∞–π–ª';\n      \n      item.message_text = `${item.message_text}\\n\\nüìé **–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞ \"${fileName}\":**\\n${fileAnalysis}`;\n      item.file_was_processed = true;\n      item.processed_file_name = fileName;\n    }\n  } else {\n    item = input[0].json;\n  }\n} else {\n  item = input[0].json;\n}\n\nconst messageText = item.message_text || item.text || '';\n\nfunction detectLanguageFromText(text) {\n  if (!text || text.length < 2) return 'ru';\n  const hasRussian = /[–∞-—è—ë]/i.test(text);\n  return hasRussian ? 'ru' : 'en';\n}\n\nconst detectedLanguage = detectLanguageFromText(messageText);\nconst sessionId = item.session_id;\nconst userId = item.user_id;\nconst userName = item.user_name || 'User';\nconst chatId = item.chat_id || sessionId;\nconst finalText = messageText;\n\nconst voiceData = item.voice_data || item.content?.voice?.audioData || null;\nconst voiceFormat = item.voice_format || item.content?.voice?.format || 'ogg';\n\nreturn [{\n  json: {\n    platform: 'webchat',\n    text: finalText,\n    message_text: finalText,\n    original_text: finalText,\n    user_id: userId,\n    user_name: userName,\n    chat_id: chatId,\n    session_id: sessionId,\n    detected_language: detectedLanguage,\n    language: detectedLanguage,\n    telegram_language: detectedLanguage,\n    interface_language: item.content?.metadata?.chatLanguage || 'ru',\n    current_language: item.content?.metadata?.chatLanguage || 'ru',\n    \n    message: {\n      text: finalText,\n      chat: { id: chatId },\n      from: {\n        id: userId,\n        first_name: userName,\n        language_code: detectedLanguage\n      }\n    },\n    \n    was_command: false,\n    needs_language_selection: false,\n    requires_ai_processing: true,\n    messageType: item.messageType || 'text',\n    timestamp: new Date().toISOString(),\n    \n    platformCapabilities: item.platformCapabilities,\n    is_web_chat: true,\n    \n    voice_data: voiceData,\n    voice_format: voiceFormat,\n    has_voice_data: !!voiceData,\n    \n    file_was_processed: item.file_was_processed || false,\n    processed_file_name: item.processed_file_name || null\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        176
      ],
      "id": "98619753-315d-4b0b-801b-5c187944e667",
      "name": "Language Detection"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b37fe31-e16d-4196-a342-5c9ced420e66",
              "leftValue": "={{ $json.messageType }}",
              "rightValue": "voice",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        848,
        160
      ],
      "id": "25d2569a-133e-44e9-b2f4-c3b116987909",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Convert Audio Data\nconst audioBase64 = $json.voice_data;\nif (!audioBase64) {\n  throw new Error('No audio data');\n}\nconst audioBuffer = Buffer.from(audioBase64, 'base64');\nreturn {\n  json: $json,\n  binary: {\n    audioFile: {\n      data: audioBuffer,\n      mimeType: 'audio/wav',\n      fileName: 'voice.wav'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        64
      ],
      "id": "2d7d529d-c2f7-4869-bae7-01174bb272b8",
      "name": "Convert Audio Data"
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-pro",
          "mode": "list"
        },
        "inputType": "binary",
        "binaryPropertyName": "audioFile",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        1168,
        64
      ],
      "id": "4b140ab5-7f5a-4506-b71c-3a6ba2fc153c",
      "name": "Transcribe Voice",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Process Voice Result\nlet transcription = $json.content.parts[0].text || '';\ntranscription = transcription.replace(/\\[\\s*\\d+m\\d+s\\d+ms\\s*-\\s*\\d+m\\d+s\\d+ms\\s*\\]/g, '').trim();\n\nconst audioData = $('Convert Audio Data').first().json;\n\nreturn {\n  json: {\n    platform: 'webchat',\n    messageType: 'text_from_voice',\n    message_text: transcription,\n    text: transcription,\n    user_id: audioData.user_id,\n    user_name: audioData.user_name,\n    session_id: audioData.session_id,\n    chat_id: audioData.chat_id,\n    language: 'ru',\n    detected_language: 'ru',\n    original_voice: true\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        64
      ],
      "id": "2676afa6-e7bb-4e2e-9d89-12d011730729",
      "name": "Process Voice Result"
    },
    {
      "parameters": {
        "jsCode": "// Prepare Text Message\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1056,
        256
      ],
      "id": "a02bef1c-c391-4676-a62e-754d8b67fc21",
      "name": "Prepare Text Message"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1536,
        160
      ],
      "id": "322255e2-9921-4b50-8316-509af7467472",
      "name": "Merge"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/ai-core-api",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "apiKey",
              "value": "24fs-$r4d-defd-77ds-7eds"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "platform",
              "value": "webchat"
            },
            {
              "name": "text",
              "value": "={{ $json.text }}"
            },
            {
              "name": "user_id",
              "value": "={{ $json.user_id }}"
            },
            {
              "name": "session_id",
              "value": "={{ $json.session_id }}"
            },
            {
              "name": "language",
              "value": "={{ $json.language }}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1728,
        160
      ],
      "id": "8eab9b0a-13ec-4c9f-9e4b-df2915b09f3e",
      "name": "Send to AI Core",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Response Handler –¥–ª—è Web Chat - –¢–û–õ–¨–ö–û –°–í–û–†–ê–ß–ò–í–ê–ù–ò–ï + –í–ò–î–ï–û\nconst input = $input.first();\n\nlet responseData;\n\nif (input.binary && input.binary.data) {\n  responseData = {\n    responseType: 'voice',\n    content: {\n      voice: {\n        mimeType: input.binary.data.mimeType || 'audio/ogg',\n        fileName: input.binary.data.fileName || 'voice_response.ogg',\n        duration: input.json?.duration || 0\n      },\n      text: '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Cryptonus üé§'\n    },\n    success: true,\n    timestamp: new Date().toISOString()\n  };\n  \n  return [{\n    binary: { data: input.binary.data },\n    json: responseData\n  }];\n  \n} else if (input.json) {\n  const coreResponse = input.json;\n\n  // –ü–†–û–í–ï–†–ö–ê –ù–ê –í–ò–î–ï–û\n  function extractVideoJson(text) {\n    if (!text || typeof text !== 'string') return null;\n    \n    const videoPattern = /\\{\\s*\"responseType\"\\s*:\\s*\"video\"/;\n    const match = videoPattern.exec(text);\n    \n    if (!match) return null;\n    \n    const startIndex = match.index;\n    let braceCount = 0;\n    let inString = false;\n    let escapeNext = false;\n    \n    for (let i = startIndex; i < text.length; i++) {\n      const char = text[i];\n      \n      if (escapeNext) {\n        escapeNext = false;\n        continue;\n      }\n      \n      if (char === '\\\\') {\n        escapeNext = true;\n        continue;\n      }\n      \n      if (char === '\"') {\n        inString = !inString;\n        continue;\n      }\n      \n      if (!inString) {\n        if (char === '{') {\n          braceCount++;\n        } else if (char === '}') {\n          braceCount--;\n          \n          if (braceCount === 0) {\n            const jsonStr = text.substring(startIndex, i + 1);\n            try {\n              return JSON.parse(jsonStr);\n            } catch (parseError) {\n              return null;\n            }\n          }\n        }\n      }\n    }\n    \n    return null;\n  }\n\n  const possibleVideoSources = [\n    coreResponse.original_response,\n    coreResponse.response_text,\n    coreResponse.text,\n    JSON.stringify(coreResponse)\n  ];\n\n  for (const source of possibleVideoSources) {\n    if (!source || typeof source !== 'string') continue;\n    \n    const parsedVideo = extractVideoJson(source);\n    \n    if (parsedVideo && parsedVideo.responseType === 'video' && parsedVideo.content?.video) {\n      responseData = {\n        responseType: 'video',\n        content: {\n          text: parsedVideo.content.text || '',\n          video: {\n            url: parsedVideo.content.video.url,\n            thumbnail: parsedVideo.content.video.thumbnail,\n            duration: parsedVideo.content.video.duration\n          },\n          language: coreResponse.language || coreResponse.detected_language || 'ru'\n        },\n        success: true,\n        timestamp: new Date().toISOString()\n      };\n      \n      return [{ json: responseData }];\n    }\n  }\n\n  // –û–ë–´–ß–ù–ê–Ø –¢–ï–ö–°–¢–û–í–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê\n  const responseText = coreResponse.response_text || \n                      coreResponse.text || \n                      coreResponse.message || \n                      '–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Cryptonus';\n  \n  const language = coreResponse.language || \n                  coreResponse.detected_language || \n                  'ru';\n  \n  responseData = {\n    responseType: 'text',\n    content: {\n      text: responseText,\n      language: language\n    },\n    success: true,\n    timestamp: new Date().toISOString()\n  };\n  \n  // –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î\n  const commands = {};\n  const lowerResponseText = responseText.toLowerCase();\n  \n  // –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–ò–Ø –†–ê–ó–ì–û–í–û–†–ê\n  const goodbyePhrasesRu = [\n    '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è', '–ø–æ–∫–∞', '–≤—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ', '–¥–æ –≤—Å—Ç—Ä–µ—á–∏',\n    '–≤—Å–µ–≥–æ —Ö–æ—Ä–æ—à–µ–≥–æ', '–¥–æ –∑–∞–≤—Ç—Ä–∞', '–ø—Ä–æ—â–∞–π', '–ø—Ä–æ—â–∞–π—Ç–µ',\n    '—Å—á–∞—Å—Ç–ª–∏–≤–æ', '—É–¥–∞—á–∏', '–±—ã–≤–∞–π', '–¥–æ —Å–∫–æ—Ä–æ–≥–æ',\n    '–¥–æ —Å–≤—è–∑–∏', '—É–≤–∏–¥–∏–º—Å—è', '–¥–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á',\n    '–≤—Å–µ–≥–æ –Ω–∞–∏–ª—É—á—à–µ–≥–æ', '—Ö–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è', '—Ö–æ—Ä–æ—à–µ–≥–æ –≤–µ—á–µ—Ä–∞',\n    '—Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏', '–¥–æ–±—Ä–æ–π –Ω–æ—á–∏', '–ø—Ä–∏—è—Ç–Ω–æ–≥–æ –≤–µ—á–µ—Ä–∞',\n    '–æ—Ç–ª–∏—á–Ω–æ–≥–æ –¥–Ω—è', '–æ—Ç–ª–∏—á–Ω–æ–≥–æ –≤–µ—á–µ—Ä–∞', '—É–¥–∞—á–Ω–æ–≥–æ –¥–Ω—è',\n    '–≤—Å–µ—Ö –±–ª–∞–≥', '–±—É–¥—å –∑–¥–æ—Ä–æ–≤', '–±—É–¥—å—Ç–µ –∑–¥–æ—Ä–æ–≤—ã'\n  ];\n\n  const goodbyePhrasesEn = [\n    'goodbye', 'bye', 'see you',\n    'see you later', 'see you tomorrow', 'talk to you later',\n    'farewell', 'take care', 'have a nice day', 'catch you later',\n    'good night', 'sweet dreams', 'have a good one',\n    'have a great day', 'have a great evening'\n  ];\n\n  function containsGoodbyePhrase(text, phrases) {\n    const normalizedText = text.toLowerCase()\n      .replace(/[.,!?;:\"\\'\\`\\-‚Äî‚Äìüëãüòä‚ú®ü§óüí´‚ù§Ô∏è]/g, ' ')\n      .replace(/\\s+/g, ' ')\n      .trim();\n    \n    return phrases.some(phrase => {\n      const normalizedPhrase = phrase.toLowerCase();\n      return normalizedText.includes(normalizedPhrase);\n    });\n  }\n\n  const falsePositivePatterns = [\n    '–∑–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å', '–¥–æ —ç—Ç–æ–≥–æ', '–¥–æ —Å–∏—Ö –ø–æ—Ä',\n    '–¥–æ—Ö–æ–¥', '–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å', '–¥–æ –∫–æ–Ω—Ü–∞', '–ø–æ–∫–∞ —á—Ç–æ', '–ø–æ–∫–∞ –Ω–µ',\n    '–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å', '–ø–æ–∫–∞–∂—É', '–ø–æ–∫–∞–∑–∞—Ç—å', '–¥–æ –º–æ–º–µ–Ω—Ç–∞', '–¥–æ —É—Ä–æ–≤–Ω—è',\n    '–ø–æ–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç', '–ø–æ–∫–∞ –≤—Å–µ', '–¥–æ –Ω–∞—á–∞–ª–∞', '–¥–æ —Å—Ç–∞—Ä—Ç–∞',\n    'for today', 'until now', 'so far', 'up to',\n    'income', 'revenue', 'profit', 'until the end',\n    'for now', 'not yet', 'indicator', 'will show',\n    'showing', 'demonstrate', 'until the moment',\n    'up to the level', 'still working', 'for the time being'\n  ];\n\n  const strongContinuationIndicators = [\n    '?',\n    '—Ö–æ—á–µ—à—å', '—Ö–æ—Ç–∏—Ç–µ', '–º–æ–∂–µ—Ç–µ', '–º–æ–∂–µ—à—å',\n    '–¥–∞–≤–∞–π', '–¥–∞–≤–∞–π—Ç–µ', \n    '—Ä–∞—Å—Å–∫–∞–∂—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ', '–ø–æ–∫–∞–∂—É –∫–∞–∫', '–º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å', '–º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å',\n    '—á—Ç–æ –¥—É–º–∞–µ—à—å', '—á—Ç–æ –¥—É–º–∞–µ—Ç–µ', '–∫–∞–∫ —Å—á–∏—Ç–∞–µ—à—å', '–∫–∞–∫ —Å—á–∏—Ç–∞–µ—Ç–µ',\n    '–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —É–∑–Ω–∞—Ç—å', '–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç', '–Ω—É–∂–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',\n    '—Ö–æ—Ç–µ–ª –±—ã —É–∑–Ω–∞—Ç—å', '—Ö–æ—Ç–µ–ª–∞ –±—ã —É–∑–Ω–∞—Ç—å',\n    'want to know', 'would you like', 'can you', 'could you',\n    'let me show', 'let me tell', 'i can show', 'i can tell',\n    'what do you think', 'how about', 'what about',\n    'interested in', 'need information', 'tell me more',\n    'show me', 'can i help', 'shall i', 'should i',\n    'do you want', 'do you need', 'would you prefer'\n  ];\n\n  const isFalsePositive = falsePositivePatterns.some(pattern => \n    lowerResponseText.includes(pattern)\n  );\n\n  const hasGoodbye = containsGoodbyePhrase(responseText, [...goodbyePhrasesRu, ...goodbyePhrasesEn]);\n\n  const hasStrongContinuation = strongContinuationIndicators.some(indicator => \n    lowerResponseText.includes(indicator)\n  );\n\n  const isLongMessage = responseText.length > 250;\n\n  const shouldCloseChat = hasGoodbye && \n                          !isFalsePositive && \n                          !hasStrongContinuation && \n                          !isLongMessage;\n  \n  if (shouldCloseChat) {\n    commands.minimizeChat = true;\n    commands.minimizeChatDelay = 5000;\n    \n    commands.minimizeChatReason = {\n      detectedPhrases: [\n        ...goodbyePhrasesRu.filter(p => containsGoodbyePhrase(responseText, [p])),\n        ...goodbyePhrasesEn.filter(p => containsGoodbyePhrase(responseText, [p]))\n      ],\n      textLength: responseText.length,\n      hasStrongContinuation: hasStrongContinuation,\n      isFalsePositive: false\n    };\n  }\n  \n  if (Object.keys(commands).length > 0) {\n    responseData.commands = commands;\n  }\n  \n} else {\n  responseData = {\n    responseType: 'text',\n    content: {\n      text: 'üîß <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</b><br>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ üìû'\n    },\n    success: false,\n    error: 'Unknown response format',\n    timestamp: new Date().toISOString()\n  };\n}\n\nreturn [{ json: responseData }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1920,
        160
      ],
      "id": "b1e75c94-3c53-484a-ba08-a80a5594e9c0",
      "name": "Response Handler"
    },
    {
      "parameters": {
        "jsCode": "// –£–ª—É—á—à–µ–Ω–Ω—ã–π Web Chat Response Formatter —Å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π –∫–æ–º–∞–Ω–¥\n// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –∏ —Å–ø–∏—Å–∫–æ–≤ + –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–º–∞–Ω–¥\n\nconst input = $input.first();\nconsole.log('=== IMPROVED WEB CHAT FORMATTER + COMMAND CLEANUP ===');\n\nif (!input.json) {\n  return [input];\n}\n\nconst responseData = input.json;\nconsole.log('Response type:', responseData.responseType);\n\nif (responseData.responseType !== 'text' || !responseData.content?.text) {\n  console.log('Skipping non-text response or empty text');\n  return [input];\n}\n\nlet originalText = responseData.content.text;\nconsole.log('Original text length:', originalText.length);\nconsole.log('Original text preview:', originalText.substring(0, 100) + '...');\n\n// üö® –ö–û–ù–¢–†–û–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ö–û–ú–ê–ù–î (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ—Å–∫–æ–∫–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —è–¥—Ä–∞)\nconsole.log('=== –ö–û–ù–¢–†–û–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ö–û–ú–ê–ù–î ===');\n\nlet commandsFound = false;\nlet cleanedText = originalText;\n\n// –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ–º–∞–Ω–¥ (—Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –≤ Command Processor)\nconst commandPatterns = [\n  // –†—É—Å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã\n  { pattern: /[–û–æ]—Ç–≤–µ—á–∞–π –≥–æ–ª–æ—Å–æ–º\\.\\s*/g, name: '–æ—Ç–≤–µ—á–∞–π –≥–æ–ª–æ—Å–æ–º' },\n  { pattern: /[–û–æ]—Ç–≤–µ—á–∞–π —Ç–µ–∫—Å—Ç–æ–º\\.\\s*/g, name: '–æ—Ç–≤–µ—á–∞–π —Ç–µ–∫—Å—Ç–æ–º' },\n  \n  // –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã  \n  { pattern: /[Ss]witch to voice\\.\\s*/g, name: 'switch to voice' },\n  { pattern: /[Ss]witch to text\\.\\s*/g, name: 'switch to text' },\n  \n  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –ò–ò –∏–∑–º–µ–Ω–∏—Ç —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É)\n  { pattern: /[–û–æ]—Ç–≤–µ—Ç –≥–æ–ª–æ—Å–æ–º\\.\\s*/g, name: '–æ—Ç–≤–µ—Ç –≥–æ–ª–æ—Å–æ–º' },\n  { pattern: /[–û–æ]—Ç–≤–µ—Ç —Ç–µ–∫—Å—Ç–æ–º\\.\\s*/g, name: '–æ—Ç–≤–µ—Ç —Ç–µ–∫—Å—Ç–æ–º' },\n  { pattern: /[–ü–ø]–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ –≥–æ–ª–æ—Å\\.\\s*/g, name: '–ø–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ –≥–æ–ª–æ—Å' },\n  { pattern: /[–ü–ø]–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ —Ç–µ–∫—Å—Ç\\.\\s*/g, name: '–ø–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ —Ç–µ–∫—Å—Ç' },\n  \n  // –ö–æ–º–∞–Ω–¥—ã –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ/–∫–æ–Ω—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è\n  { pattern: /\\.\\s*[–û–æ]—Ç–≤–µ—á–∞–π –≥–æ–ª–æ—Å–æ–º\\.\\s*/g, name: '. –æ—Ç–≤–µ—á–∞–π –≥–æ–ª–æ—Å–æ–º' },\n  { pattern: /\\.\\s*[–û–æ]—Ç–≤–µ—á–∞–π —Ç–µ–∫—Å—Ç–æ–º\\.\\s*/g, name: '. –æ—Ç–≤–µ—á–∞–π —Ç–µ–∫—Å—Ç–æ–º' },\n  { pattern: /\\.\\s*[Ss]witch to voice\\.\\s*/g, name: '. switch to voice' },\n  { pattern: /\\.\\s*[Ss]witch to text\\.\\s*/g, name: '. switch to text' }\n];\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É\ncommandPatterns.forEach(({ pattern, name }) => {\n  if (pattern.test(cleanedText)) {\n    console.log(`‚ö†Ô∏è –ù–ê–ô–î–ï–ù–ê –ö–û–ú–ê–ù–î–ê –≤ –≤–µ–±-–æ—Ç–≤–µ—Ç–µ: \"${name}\"`);\n    cleanedText = cleanedText.replace(pattern, '');\n    commandsFound = true;\n  }\n});\n\nif (commandsFound) {\n  console.log('üîß –ö–û–ù–¢–†–û–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê: –ö–æ–º–∞–Ω–¥—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –≤–µ–±-–æ—Ç–≤–µ—Ç–∞');\n  \n  // –û—á–∏—â–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ —Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥\n  cleanedText = cleanedText\n    .replace(/\\.\\s*\\./g, '.')         // –£–±–∏—Ä–∞–µ–º –¥–≤–æ–π–Ω—ã–µ —Ç–æ—á–∫–∏\n    .replace(/\\s+/g, ' ')            // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –≤ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ\n    .replace(/^\\s+|\\s+$/g, '')       // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º\n    .replace(/\\.\\s*$/, '.');         // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ\n    \n  console.log('–¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏:', cleanedText.substring(0, 100) + '...');\n} else {\n  console.log('‚úÖ –ö–û–ù–¢–†–û–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ö–æ–º–∞–Ω–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');\n}\n\n// üö® –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ü–õ–ï–ô–°–•–û–õ–î–ï–†–û–í (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∏ –æ–Ω–∏ –ø—Ä–æ—Å–∫–æ—á–∏–ª–∏)\nconsole.log('=== –ö–û–ù–¢–†–û–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–õ–ï–ô–°–•–û–õ–î–ï–†–û–í ===');\n\nconst placeholderPatterns = [\n  /\\[–ò–º—è\\],?\\s*/g,      // [–ò–º—è], [–ò–º—è] \n  /\\[Name\\],?\\s*/g,     // [Name], [Name]\n  /\\[–∏–º—è\\],?\\s*/g,      // [–∏–º—è], [–∏–º—è]\n  /\\[name\\],?\\s*/g,     // [name], [name]\n  /\\[–ò–ú–Ø\\],?\\s*/g,      // [–ò–ú–Ø], [–ò–ú–Ø]\n  /\\[NAME\\],?\\s*/g      // [NAME], [NAME]\n];\n\nlet placeholdersFound = false;\nplaceholderPatterns.forEach((pattern, index) => {\n  if (pattern.test(cleanedText)) {\n    placeholdersFound = true;\n    console.log(`‚ö†Ô∏è –ù–ê–ô–î–ï–ù –ü–õ–ï–ô–°–•–û–õ–î–ï–† –≤ –≤–µ–±-–æ—Ç–≤–µ—Ç–µ: ${pattern.source}`);\n    cleanedText = cleanedText.replace(pattern, '');\n  }\n});\n\nif (placeholdersFound) {\n  console.log('üîß –ö–û–ù–¢–†–û–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê: –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –≤–µ–±-–æ—Ç–≤–µ—Ç–∞');\n  \n  // –û—á–∏—â–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤\n  cleanedText = cleanedText\n    .replace(/,\\s*,/g, ',')           // –£–±–∏—Ä–∞–µ–º –¥–≤–æ–π–Ω—ã–µ –∑–∞–ø—è—Ç—ã–µ\n    .replace(/^\\s*,\\s*/g, '')        // –£–±–∏—Ä–∞–µ–º –∑–∞–ø—è—Ç—É—é –≤ –Ω–∞—á–∞–ª–µ\n    .replace(/\\s+/g, ' ')            // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –≤ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ\n    .trim();                         // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º\n} else {\n  console.log('‚úÖ –ö–û–ù–¢–†–û–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');\n}\n\n// –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\nconst textToFormat = cleanedText;\n\n// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\nfunction formatForWebChat(text) {\n  let formatted = text;\n  \n  // 1. –ñ–ò–†–ù–´–ô –ò –ö–£–†–°–ò–í–ù–´–ô –¢–ï–ö–°–¢\n  formatted = formatted.replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>');\n  formatted = formatted.replace(/__(.*?)__/g, '<strong>$1</strong>');\n  formatted = formatted.replace(/\\*(.*?)\\*/g, '<em>$1</em>');\n  formatted = formatted.replace(/_(.*?)_/g, '<em>$1</em>');\n  \n  // 2. –°–ü–ò–°–ö–ò –° –≠–ú–û–î–ó–ò - –£–õ–£–ß–®–ï–ù–ù–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï\n  // –ß–µ–∫–±–æ–∫—Å—ã ‚úÖ\n  formatted = formatted.replace(/‚úÖ\\s*(.*?)(?=\\n|$)/g, \n    '<div class=\"emoji-item\"><span class=\"emoji-icon feature-check\">‚úÖ</span><span class=\"emoji-text\">$1</span></div>');\n  \n  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è ‚ùó\n  formatted = formatted.replace(/‚ùó\\s*(.*?)(?=\\n|$)/g, \n    '<div class=\"warning-block\"><span class=\"emoji-icon warning-icon\">‚ùó</span><span>$1</span></div>');\n  \n  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è ‚ö†Ô∏è\n  formatted = formatted.replace(/‚ö†Ô∏è\\s*(.*?)(?=\\n|$)/g, \n    '<div class=\"warning-block\"><span class=\"emoji-icon warning-icon\">‚ö†Ô∏è</span><span>$1</span></div>');\n  \n  // –°–æ–≤–µ—Ç—ã üí°\n  formatted = formatted.replace(/üí°\\s*(.*?)(?=\\n|$)/g, \n    '<div class=\"tip-block\"><span class=\"emoji-icon tip-icon\">üí°</span><span>$1</span></div>');\n  \n  // –û–±—ã—á–Ω—ã–µ —Å–ø–∏—Å–∫–∏ ‚Ä¢\n  formatted = formatted.replace(/‚Ä¢\\s*(.*?)(?=\\n|$)/g, \n    '<div class=\"simple-item\"><span class=\"emoji-icon\">‚Ä¢</span><span class=\"emoji-text\">$1</span></div>');\n  \n  // 3. –¢–ê–†–ò–§–ù–´–ï –ü–õ–ê–ù–´\n  if (formatted.includes('Starter') || formatted.includes('Pro') || formatted.includes('Enterprise')) {\n    formatted = formatTariffPlans(formatted);\n  }\n  \n  // 4. –¶–ï–ù–´\n  formatted = formatted.replace(/\\$(\\d+)/g, '<span class=\"price\">$$$1</span>');\n  formatted = formatted.replace(/(\\d+)\\s*—Ä—É–±/g, '<span class=\"price\">$1 —Ä—É–±</span>');\n  \n  // 5. –ü–ï–†–ï–ù–û–°–´ –°–¢–†–û–ö\n  // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—ã —ç–º–æ–¥–∑–∏\n  formatted = formatted.replace(/(<div class=\"emoji-item\">.*?<\\/div>)\\s*\\n/g, '$1');\n  \n  // –ó–∞—Ç–µ–º –æ–±—ã—á–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã\n  formatted = formatted.replace(/\\n\\n/g, '</p><p>');\n  formatted = formatted.replace(/\\n/g, '<br>');\n  \n  // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã\n  if (formatted.includes('emoji-item') || formatted.includes('simple-item')) {\n    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–ø–∏—Å–∫–∏ —ç–º–æ–¥–∑–∏\n    formatted = formatted.replace(/(<div class=\"emoji-item\">.*?<\\/div>)+/gs, \n      '<div class=\"emoji-list\">$&</div>');\n    formatted = formatted.replace(/(<div class=\"simple-item\">.*?<\\/div>)+/gs, \n      '<div class=\"simple-list\">$&</div>');\n  }\n  \n  // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã\n  if (!formatted.includes('<div') && !formatted.includes('<p>')) {\n    formatted = '<p>' + formatted + '</p>';\n  }\n  \n  return formatted;\n}\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤\nfunction formatTariffPlans(text) {\n  let formatted = text;\n  \n  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤\n  formatted = formatted.replace(/(Starter|Pro|Enterprise)\\s*[-‚Äì]\\s*(.*?)(?=\\n|$)/g, \n    '<div class=\"tariff-header\"><h3>$1</h3><div class=\"tariff-price\">$2</div></div>');\n  \n  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–∞—Ä–∏—Ñ–æ–≤\n  formatted = formatted.replace(/(<div class=\"tariff-header\">.*?<\\/div>)\\s*((?:<div class=\"emoji-item\">.*?<\\/div>\\s*)*)/gs, \n    '<div class=\"tariff-plan\">$1<div class=\"tariff-features\">$2</div></div>');\n  \n  return formatted;\n}\n\n// –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\nconst formattedText = formatForWebChat(textToFormat);\n\nconsole.log('=== FORMATTING RESULT ===');\nconsole.log('Original length:', originalText.length);\nconsole.log('After cleanup length:', textToFormat.length);\nconsole.log('Formatted length:', formattedText.length);\nconsole.log('Commands removed:', commandsFound);\nconsole.log('Placeholders removed:', placeholdersFound);\nconsole.log('Has emoji formatting:', formattedText.includes('emoji-item'));\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç\nconst formattedResponse = {\n  ...responseData,\n  content: {\n    ...responseData.content,\n    text: formattedText,\n    original_text: originalText,\n    formatting_applied: true,\n    format_type: 'improved_web_chat_html_with_command_cleanup'\n  },\n  // –í–ê–ñ–ù–û: –°–û–•–†–ê–ù–Ø–ï–ú –ö–û–ú–ê–ù–î–´!\n  commands: responseData.commands,\n  debug_formatting: {\n    original_length: originalText.length,\n    cleaned_length: textToFormat.length,\n    formatted_length: formattedText.length,\n    commands_found_and_removed: commandsFound,\n    placeholders_found_and_removed: placeholdersFound,\n    has_tariffs: originalText.includes('Starter') || originalText.includes('Pro'),\n    has_emojis: /[‚úÖ‚ùó‚ö†Ô∏èüí°]/.test(originalText),\n    emoji_formatting: formattedText.includes('emoji-item'),\n    cleanup_applied: commandsFound || placeholdersFound,\n    formatting_time: new Date().toISOString()\n  }\n};\n\nif (commandsFound || placeholdersFound) {\n  console.log('üõ°Ô∏è –ó–ê–©–ò–¢–ê –°–†–ê–ë–û–¢–ê–õ–ê: –ö–æ–º–∞–Ω–¥—ã/–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');\n} else {\n  console.log('‚úÖ –ó–ê–©–ò–¢–ê: –ö–æ–º–∞–Ω–¥—ã/–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã');\n}\n\nconsole.log('‚úÖ Improved formatting with command cleanup complete!');\n\nreturn [{\n  json: formattedResponse\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2112,
        160
      ],
      "id": "f90f511b-dde2-4ae0-9348-237b042e7afc",
      "name": "Web Chat Response Formatter"
    },
    {
      "parameters": {
        "mode": "expression",
        "numberOutputs": 2,
        "output": "={{ $json.responseType === 'voice' ? 1 : 0 }}"
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2304,
        160
      ],
      "id": "282effd1-9937-49a7-a0db-3c3a784c9be3",
      "name": "Response Type Switch"
    },
    {
      "parameters": {
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        2496,
        80
      ],
      "id": "75916209-9c83-495e-b978-57a7c2e5f530",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "respondWith": "binary",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "audio/ogg"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        2496,
        240
      ],
      "id": "b42639e1-1f99-4728-94a2-12b1ee248bee",
      "name": "Respond Voice"
    },
    {
      "parameters": {
        "jsCode": "// Error Handler –¥–ª—è Web Chat Adapter\n// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n\nconst error = $input.first();\nconsole.log('=== WEB CHAT ERROR HANDLER ===');\nconsole.log('Error details:', error);\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ\nlet errorMessage = '';\nlet errorType = 'unknown';\n\nif (error.message) {\n  const errorText = error.message.toLowerCase();\n  \n  if (errorText.includes('timeout') || errorText.includes('network')) {\n    errorType = 'network';\n    errorMessage = `üåê <b>–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é</b><br><br>\n                   –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å AI —Å–µ—Ä–≤–µ—Ä–æ–º.<br>\n                   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.<br><br>\n                   <i>–ò–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É üìû</i>`;\n  } else if (errorText.includes('rate limit') || errorText.includes('too many requests')) {\n    errorType = 'rate_limit';\n    errorMessage = `‚è∞ <b>–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤</b><br><br>\n                   –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è.<br>\n                   –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.<br><br>\n                   <i>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ!</i>`;\n  } else if (errorText.includes('unauthorized') || errorText.includes('forbidden')) {\n    errorType = 'auth';\n    errorMessage = `üîê <b>–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</b><br><br>\n                   –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ AI —Å–µ—Ä–≤–∏—Å—É.<br>\n                   –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∞–π—Ç–∞.<br><br>\n                   <i>–ò–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º üìû</i>`;\n  } else {\n    errorType = 'general';\n    errorMessage = `üîß <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</b><br><br>\n                   –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å AI —Å–µ—Ä–≤–∏—Å–æ–º.<br>\n                   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:<br>\n                   ‚úÖ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É<br>\n                   ‚úÖ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å<br>\n                   ‚úÖ –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É üìû<br><br>\n                   <i>–ò–∑–≤–∏–Ω–∏—Ç–µ –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞!</i>`;\n  }\n} else {\n  errorType = 'unknown';\n  errorMessage = `‚ùå <b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞</b><br><br>\n                 –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫.<br>\n                 –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–º–æ—â–∏ üìû<br><br>\n                 <i>–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–µ—Ä–ø–µ–Ω–∏–µ!</i>`;\n}\n\nconst errorResponse = {\n  responseType: 'text',\n  content: {\n    text: errorMessage,\n    language: 'ru'\n  },\n  success: false,\n  error: {\n    type: errorType,\n    message: error.message || 'Unknown error',\n    timestamp: new Date().toISOString()\n  },\n  timestamp: new Date().toISOString()\n};\n\nconsole.log('=== ERROR RESPONSE ===');\nconsole.log('Error Type:', errorType);\nconsole.log('User Message Generated');\n\nreturn [{\n  json: errorResponse\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1920,
        320
      ],
      "id": "05251d9c-c392-458a-b514-14a6dc2329de",
      "name": "Error Handler",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "39932c41-0c5c-4970-984c-371a708bb7a0",
              "leftValue": "={{ $json.file_category }}",
              "rightValue": "image",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "bdafae82-d23c-421c-b2ba-8b8a5d2d7fb0",
              "leftValue": "={{ $json.file_category }}",
              "rightValue": "document",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -320,
        32
      ],
      "id": "9d8d73da-8d59-4bb5-a87b-cf0abf190784",
      "name": "If1"
    },
    {
      "parameters": {
        "jsCode": "// Pass Through Text - –ø–µ—Ä–µ–¥–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–≤—É—é —á–∞—Å—Ç—å –±–µ–∑ binary\nconst input = $input.first();\nconsole.log('=== PASS THROUGH TEXT ===');\n\nconst data = input.json;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º \"—á–∏—Å—Ç—ã–π\" –æ–±—ä–µ–∫—Ç —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏\nconst textOnlyData = {\n  platform: data.platform,\n  message_text: data.message_text,\n  text: data.message_text, // –¥—É–±–ª–∏—Ä—É–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏\n  original_text: data.message_text,\n  \n  user_id: data.user_id,\n  user_name: data.user_name,\n  chat_id: data.chat_id,\n  session_id: data.session_id,\n  \n  language: data.language,\n  detected_language: data.detected_language,\n  \n  messageType: data.messageType,\n  \n  content: data.content,\n  \n  // –ü–µ—Ä–µ–¥–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n  ip_address: data.ip_address,\n  user_agent: data.user_agent,\n  page_url: data.page_url,\n  referrer: data.referrer,\n  platformCapabilities: data.platformCapabilities,\n  timestamp: data.timestamp,\n  is_web_chat: data.is_web_chat,\n  \n  // –§–ª–∞–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è\n  file_was_sent: data.has_file || false, // –æ—Ç–º–µ—á–∞–µ–º —á—Ç–æ —Ñ–∞–π–ª –ë–´–õ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω\n  file_name_original: data.file_name || null, // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞\n  text_only_path: true, // –º–∞—Ä–∫–µ—Ä —á—Ç–æ —ç—Ç–æ –ø—É—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—Å—Ç–∞\n  \n  debug_info: {\n    ...data.debug_info,\n    path: 'text_only_without_file_processing'\n  }\n};\n\nconsole.log('‚úÖ –¢–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã');\nconsole.log('üìù –¢–µ–∫—Å—Ç:', textOnlyData.message_text);\nconsole.log('üë§ User:', textOnlyData.user_id);\nconsole.log('üè∑Ô∏è File was sent:', textOnlyData.file_was_sent);\n\n// –í–ê–ñ–ù–û: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¢–û–õ–¨–ö–û json, –ë–ï–ó binary!\nreturn [{\n  json: textOnlyData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        240
      ],
      "id": "7f8c94d4-ec74-40e4-8b2e-0ea2a05e7475",
      "name": "Pass Through Text"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: API KEY + RATE LIMITING\n// ============================================\n\n// –ù–ê–°–¢–†–û–ô–ö–ò (–∏–∑–º–µ–Ω–∏ –ø–æ–¥ —Å–µ–±—è)\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 60;\n\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1280,
        208
      ],
      "id": "c854cbbb-ed96-4821-acae-44d76075b1d0",
      "name": "Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1136,
        208
      ],
      "id": "8cb9964d-923a-4ba6-9e37-7780648c1cba",
      "name": "Auth Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -928,
        320
      ],
      "id": "d705c336-6ab7-4ca3-a02b-d5f8ca7d589e",
      "name": "Error Response"
    }
  ],
  "pinData": {},
  "connections": {
    "Web Chat Webhook": {
      "main": [
        [
          {
            "node": "Security Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rate Limiter": {
      "main": [
        [
          {
            "node": "Web Chat Processor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Web Chat Processor": {
      "main": [
        [
          {
            "node": "Input Validator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Validator": {
      "main": [
        [
          {
            "node": "File Detector",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "File Detector": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pass Through Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "File Category Router": {
      "main": [
        [
          {
            "node": "Image Analyzer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Document Analyzer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Image Analyzer": {
      "main": [
        [
          {
            "node": "Merge File Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Document Analyzer": {
      "main": [
        [
          {
            "node": "Merge File Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge File Analysis": {
      "main": [
        [
          {
            "node": "File Paths Merger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "File Paths Merger": {
      "main": [
        [
          {
            "node": "Language Detection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Language Detection": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Convert Audio Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Text Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Audio Data": {
      "main": [
        [
          {
            "node": "Transcribe Voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Voice": {
      "main": [
        [
          {
            "node": "Process Voice Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Voice Result": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Text Message": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Send to AI Core",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to AI Core": {
      "main": [
        [
          {
            "node": "Response Handler",
            "type": "main",
            "index": 0
          },
          {
            "node": "Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response Handler": {
      "main": [
        [
          {
            "node": "Web Chat Response Formatter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Web Chat Response Formatter": {
      "main": [
        [
          {
            "node": "Response Type Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response Type Switch": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "File Category Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pass Through Text": {
      "main": [
        [
          {
            "node": "File Paths Merger",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Security Check": {
      "main": [
        [
          {
            "node": "Auth Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Check": {
      "main": [
        [
          {
            "node": "Rate Limiter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "dc40c2a5-0e06-43c9-87c2-443598fb2fa8",
  "meta": {
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "BpJXt7h1Zw08nMUT",
  "tags": []
}