{
  "name": "Monitoring",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-monitoring",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -336,
        -288
      ],
      "id": "c0187933-2362-49c9-8c92-1fbaadecd401",
      "name": "Webhook",
      "webhookId": "eb90ca04-d6ee-45f7-aada-b9b996978901"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ\nconst webhook = items[0].json;\n\n// Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð¸Ð· Ñ‚ÐµÐ»Ð° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°\nconst inputData = webhook.body || webhook;\n\n// Ð’ÐÐ–ÐÐž: Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¼ÐµÑ‚ÐºÐ¸ Ð—Ð”Ð•Ð¡Ð¬, Ð² Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…\nconst currentTime = new Date();\nconst currentTimeISO = currentTime.toISOString();\n\n// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‡Ð¸ÑÑ‚Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð´Ð»Ñ Ð‘Ð”\nconst monitoringData = {\n    // ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹\n    recordId: `${inputData.sessionId}_${Date.now()}`,\n    recordTimestamp: currentTimeISO,\n    session_id: inputData.sessionId,\n    user_id: inputData.userId,\n    user_name: inputData.userName,\n    config_name: inputData.configName,\n    platform: inputData.platform,\n    \n    // Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¼ÐµÑ‚ÐºÐ¸ - Ð’Ð¡Ð•Ð“Ð”Ð Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°\n    timestamp: currentTimeISO,\n    session_start_time: currentTimeISO,\n    last_activity_time: currentTimeISO,\n    session_duration: inputData.sessionDuration || 0,\n    \n    // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¸\n    event_type: inputData.eventType || 'activity',\n    message_count: inputData.messageCount || 0,\n    \n    // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ\n    current_language: inputData.currentLanguage || 'ru',\n    is_minimized: inputData.isMinimized || false,\n    user_agent: inputData.userAgent || '',\n    screen_resolution: inputData.screenResolution || '',\n    language: inputData.language || '',\n    timezone: inputData.timezone || '',\n    referrer: inputData.referrer || '',\n    current_url: inputData.currentUrl || '',\n    domain: inputData.domain || '',\n    \n    // Ð“ÐµÐ¾Ð´Ð°Ð½Ð½Ñ‹Ðµ\n    geo_ip: inputData.geo?.ip || 'Unknown',\n    geo_country: inputData.geo?.country || 'Unknown',\n    geo_city: inputData.geo?.city || 'Unknown',\n    geo_region: inputData.geo?.region || 'Unknown',\n    geo_latitude: inputData.geo?.latitude || null,\n    geo_longitude: inputData.geo?.longitude || null\n};\n\n// ÐžÑ‚Ð»Ð°Ð´ÐºÐ° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸\nconsole.log(`[${monitoringData.platform}] Activity recorded at:`, currentTimeISO);\n\nreturn [{json: monitoringData}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        -368
      ],
      "id": "8d0e2713-5b33-417b-a2ea-108afe8f3898",
      "name": "Code"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"success\",\n  \"message\": \"Data saved\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        688,
        -368
      ],
      "id": "47bb8a6c-8769-490c-803b-0a8af1557427",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "path": "chat-monitoring-data",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -336,
        80
      ],
      "id": "87addc31-2bd4-41c7-9d41-7689d84810e9",
      "name": "Webhook1",
      "webhookId": "f5630924-169d-40d7-977a-7602530143f8"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH real_message_counts AS (\n    SELECT \n        session_id,\n        COUNT(*) as real_count,\n        -- ÐÐžÐ’ÐžÐ•: Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÑÐµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¼ÐµÑ‚ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ð¼Ð°ÑÑÐ¸Ð²\n        array_agg(created_at ORDER BY created_at) as message_timestamps\n    FROM (\n        SELECT session_id, created_at FROM n8n_chat_histories_ru\n        UNION ALL\n        SELECT session_id, created_at FROM n8n_chat_histories_en\n    ) all_messages\n    GROUP BY session_id\n),\nsession_stats AS (\n    SELECT \n        wm.session_id,\n        MIN(wm.session_start_time) as session_start,\n        MAX(wm.last_activity_time) as last_activity,\n        EXTRACT(EPOCH FROM (MAX(wm.last_activity_time) - MIN(wm.session_start_time)))::integer as duration,\n        COALESCE(rmc.real_count, 0) as messages,\n        COALESCE(rmc.message_timestamps, ARRAY[]::timestamp[]) as message_timestamps,\n        FIRST_VALUE(wm.user_id) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as user_id,\n        FIRST_VALUE(wm.user_name) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as user_name,\n        FIRST_VALUE(wm.config_name) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as config_name,\n        FIRST_VALUE(wm.current_language) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as language,\n        FIRST_VALUE(wm.geo_ip) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as ip,\n        FIRST_VALUE(wm.geo_country) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as country,\n        FIRST_VALUE(wm.geo_city) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as city,\n        FIRST_VALUE(wm.user_agent) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as user_agent,\n        FIRST_VALUE(wm.referrer) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as referrer,\n        FIRST_VALUE(wm.domain) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as domain,\n        FIRST_VALUE(wm.platform) OVER (PARTITION BY wm.session_id ORDER BY wm.timestamp) as platform\n    FROM webchat_monitoring wm\n    LEFT JOIN real_message_counts rmc ON wm.session_id = rmc.session_id\n    WHERE wm.last_activity_time >= NOW() - INTERVAL '30 days'\n        AND wm.user_id IS NOT NULL \n        AND wm.user_id != ''\n        AND wm.user_id != 'undefined'\n    GROUP BY wm.session_id, wm.timestamp, wm.user_id, wm.user_name, wm.config_name, \n             wm.current_language, wm.geo_ip, wm.geo_country, wm.geo_city, wm.user_agent, \n             wm.referrer, wm.domain, wm.platform, rmc.real_count, rmc.message_timestamps\n)\nSELECT DISTINCT ON (session_id) \n    *,\n    CASE \n        WHEN last_activity > NOW() - INTERVAL '5 minutes' THEN 'active'\n        ELSE 'inactive'\n    END as status\nFROM session_stats\nORDER BY session_id, last_activity DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        192,
        32
      ],
      "id": "58e80b51-93f3-4add-836a-b179b2fc464c",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð°\nconst formattedData = items.map(item => {\n    const data = item.json;\n    \n    // ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð² timestamps Ð¸Ð· PostgreSQL\n    let messageTimestamps = [];\n    if (data.message_timestamps) {\n        // PostgreSQL Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¼Ð°ÑÑÐ¸Ð² ÐºÐ°Ðº ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð²Ð¸Ð´Ð° \"{2025-11-02 18:45:12,2025-11-02 18:46:30,...}\"\n        if (typeof data.message_timestamps === 'string') {\n            // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ„Ð¸Ð³ÑƒÑ€Ð½Ñ‹Ðµ ÑÐºÐ¾Ð±ÐºÐ¸ Ð¸ Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾ Ð·Ð°Ð¿ÑÑ‚Ð¾Ð¹\n            const timestampsStr = data.message_timestamps.replace(/[{}]/g, '');\n            if (timestampsStr) {\n                messageTimestamps = timestampsStr.split(',').map(ts => ts.trim());\n            }\n        } else if (Array.isArray(data.message_timestamps)) {\n            messageTimestamps = data.message_timestamps;\n        }\n    }\n    \n    return {\n        sessionId: data.session_id,\n        userId: data.user_id || 'unknown',\n        userName: data.user_name || 'Guest',\n        configName: data.config_name || 'unknown',\n        timestamp: data.last_activity,\n        sessionStartTime: data.session_start,\n        lastActivityTime: data.last_activity,\n        sessionDuration: parseInt(data.duration) || 0,\n        messageCount: parseInt(data.messages) || 0,\n        messageTimestamps: messageTimestamps,  // ðŸ”¥ ÐÐžÐ’ÐžÐ• ÐŸÐžÐ›Ð•\n        currentLanguage: data.language || 'ru',\n        userAgent: data.user_agent || '',\n        referrer: data.referrer || '',\n        domain: data.domain || '',\n        platform: data.platform || 'webchat',\n        geo: {\n            ip: data.ip || 'unknown',\n            country: data.country || 'unknown',\n            city: data.city || 'unknown'\n        }\n    };\n});\n\n// Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð² ÐºÐ°Ðº Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ json\nreturn [{\n    json: {\n        data: formattedData\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        32
      ],
      "id": "2e25d60d-4114-4cf3-ab2d-1f030578fcf1",
      "name": "Code1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        640,
        32
      ],
      "id": "eebb9554-d70f-487c-99ed-0a85b3da986f",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "path": "chat-dialogs",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -320,
        384
      ],
      "id": "77b68a13-be27-4196-bf31-34ccd4ee7a47",
      "name": "Webhook2",
      "webhookId": "b3b47b0c-151f-4415-b444-091d814e736e"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ session_id Ð¸Ð· query Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²\nconst webhookData = items[0].json;\nconst sessionId = webhookData.query?.session_id;\n\nif (!sessionId) {\n    throw new Error('session_id parameter is required');\n}\n\nreturn [{\n    json: {\n        session_id: sessionId\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        192,
        368
      ],
      "id": "fbe530eb-bf0e-495c-91b7-f4af541d7cb6",
      "name": "Code2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð²ÑÐµÑ… Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð²\nWITH all_chats AS (\n    -- Ð ÑƒÑÑÐºÐ¸Ðµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸\n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'ru' as language\n    FROM n8n_chat_histories_ru\n    WHERE session_id = '{{ $json.session_id }}'\n\n    UNION ALL\n\n    -- ÐÐ½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ðµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸\n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'en' as language\n    FROM n8n_chat_histories_en\n    WHERE session_id = '{{ $json.session_id }}'\n\n    -- Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÑÐ·Ñ‹ÐºÐ¸ Ð¿Ð¾ Ð¼ÐµÑ€Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸\n    -- UNION ALL\n    -- SELECT ... FROM n8n_chat_histories_de WHERE session_id = '{{ $json.session_id }}'\n)\nSELECT * FROM all_chats\nORDER BY timestamp ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        384,
        368
      ],
      "id": "268cf2fa-6096-4282-bec3-04786e9aef86",
      "name": "Execute a SQL query1",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ\nif (!items || items.length === 0 || !items[0].json) {\n    return [{\n        json: {\n            dialogs: [],\n            message: \"ÐÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ ÑÑ‚Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸\"\n        }\n    }];\n}\n\n// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸ Ð´Ð»Ñ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð°\nconst formattedDialogs = items.map(item => {\n    const data = item.json;\n    \n    // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\n    const messageType = data.message_type === 'human' ? 'user' : 'bot';\n    \n    // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\n    let messageText = data.content || '';\n    \n    // Ð•ÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ - ÑÑ‚Ð¾ JSON ÑÑ‚Ñ€Ð¾ÐºÐ°, Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÐµÑ‘ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ÑŒ\n    try {\n        if (messageText.startsWith('{') || messageText.startsWith('[')) {\n            const parsed = JSON.parse(messageText);\n            messageText = parsed.text || parsed.message || messageText;\n        }\n    } catch (e) {\n        // ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ\n    }\n    \n    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð´Ð»Ñ ÑÐ·Ñ‹ÐºÐ° Ð¸ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹\n    const languageFlag = {\n        'ru': 'ðŸ‡·ðŸ‡º',\n        'en': 'ðŸ‡¬ðŸ‡§',\n        'de': 'ðŸ‡©ðŸ‡ª',\n        'es': 'ðŸ‡ªðŸ‡¸',\n        'fr': 'ðŸ‡«ðŸ‡·'\n    };\n    \n    const platformIcon = {\n    'web': 'ðŸ’»',\n    'webchat': 'ðŸ’¬',  // Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÑ‚Ñƒ ÑÑ‚Ñ€Ð¾ÐºÑƒ!\n    'telegram': 'âœˆï¸',\n    'whatsapp': 'ðŸ’¬',\n    'viber': 'ðŸ’œ',\n    'facebook': 'ðŸ‘¤',\n    'instagram': 'ðŸ“·',\n    'vk': 'ðŸ”µ',\n    'slack': 'ðŸ”·',\n    'discord': 'ðŸŽ®',\n    'mobile': 'ðŸ“²',\n    'api': 'ðŸ”Œ',\n    'email': 'ðŸ“§',\n    'sms': 'ðŸ“¨'\n};\n    \n    return {\n        id: data.id,\n        session_id: data.session_id,\n        message_type: messageType,\n        message_text: messageText,\n        response_text: messageType === 'bot' ? messageText : '',\n        timestamp: data.timestamp,\n        language: data.language || 'unknown',\n        language_flag: languageFlag[data.language] || 'ðŸŒ',\n        platform: data.platform || 'web',\n        platform_icon: platformIcon[data.platform] || 'â“'\n    };\n});\n\nreturn [{json: {dialogs: formattedDialogs}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        544,
        368
      ],
      "id": "763dba37-11e7-4aa1-b08c-c93d1ce1b759",
      "name": "Code3"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        704,
        368
      ],
      "id": "28c6af4c-bff3-410a-b2b5-ea3137a53ca5",
      "name": "Respond to Webhook2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO webchat_monitoring (\n    record_id, record_timestamp, session_id, user_id, user_name,\n    config_name, platform, timestamp, session_start_time, \n    last_activity_time, session_duration, event_type, message_count,\n    current_language, is_minimized, user_agent, screen_resolution,\n    language, timezone, referrer, current_url, domain,\n    geo_ip, geo_country, geo_city, geo_region, geo_latitude, geo_longitude\n)\nVALUES (\n    '{{ $json.recordId }}',\n    '{{ $json.recordTimestamp }}',\n    '{{ $json.session_id }}',\n    '{{ $json.user_id }}',\n    '{{ $json.user_name }}',\n    '{{ $json.config_name }}',\n    '{{ $json.platform }}',\n    '{{ $json.timestamp }}',\n    '{{ $json.session_start_time }}',\n    '{{ $json.last_activity_time }}',\n    {{ $json.session_duration }},\n    '{{ $json.event_type }}',\n    {{ $json.message_count }},\n    '{{ $json.current_language }}',\n    {{ $json.is_minimized }},\n    '{{ $json.user_agent }}',\n    '{{ $json.screen_resolution }}',\n    '{{ $json.language }}',\n    '{{ $json.timezone }}',\n    '{{ $json.referrer }}',\n    '{{ $json.current_url }}',\n    '{{ $json.domain }}',\n    '{{ $json.geo_ip }}',\n    '{{ $json.geo_country }}',\n    '{{ $json.geo_city }}',\n    '{{ $json.geo_region }}',\n    {{ $json.geo_latitude || 'NULL' }},\n    {{ $json.geo_longitude || 'NULL' }}\n)\nON CONFLICT (session_id) \nDO UPDATE SET\n    config_name = EXCLUDED.config_name,\n    platform = EXCLUDED.platform,\n    last_activity_time = EXCLUDED.last_activity_time,\n    session_duration = EXTRACT(EPOCH FROM (EXCLUDED.last_activity_time::timestamp - webchat_monitoring.session_start_time::timestamp))::integer,\n    -- Ð’ÐÐ–ÐÐž: ÐÐ• ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ message_count Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°\n    -- Ð ÐµÐ°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð±ÐµÑ€ÐµÐ¼ Ð¸Ð· Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð²\n    message_count = webchat_monitoring.message_count,\n    current_language = EXCLUDED.current_language,\n    is_minimized = EXCLUDED.is_minimized,\n    geo_ip = EXCLUDED.geo_ip,\n    geo_country = EXCLUDED.geo_country,\n    geo_city = EXCLUDED.geo_city,\n    geo_region = EXCLUDED.geo_region,\n    geo_latitude = EXCLUDED.geo_latitude,\n    geo_longitude = EXCLUDED.geo_longitude,\n    event_type = EXCLUDED.event_type,\n    user_id = CASE \n        WHEN webchat_monitoring.user_id IS NULL OR webchat_monitoring.user_id = '' \n        THEN EXCLUDED.user_id \n        ELSE webchat_monitoring.user_id \n    END,\n    user_name = CASE \n        WHEN webchat_monitoring.user_name IS NULL OR webchat_monitoring.user_name = '' \n        THEN EXCLUDED.user_name \n        ELSE webchat_monitoring.user_name \n    END\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        464,
        -368
      ],
      "id": "bc35b9cf-8f6d-46c1-8bf9-1cafdded71f8",
      "name": "Insert or update rows in a table1",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "path": "server-time",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "8edc9202-0f3b-4df6-87ef-ed0e10893317",
      "name": "Webhook Server Time",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -304,
        752
      ],
      "webhookId": "80106ead-1754-441d-a2b5-bc238d1dab07"
    },
    {
      "parameters": {
        "jsCode": "// Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°\nconst serverTime = new Date();\n\nreturn [{\n    json: {\n        serverTime: serverTime.toISOString(),\n        serverTimestamp: serverTime.getTime(),\n        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'\n    }\n}];"
      },
      "id": "7810ce90-cb38-4e06-b716-5d6a2c8df0cf",
      "name": "Get Server Time",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        192,
        736
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "47c894d7-df82-4312-84a4-1bc78464effa",
      "name": "Respond Server Time",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        416,
        736
      ]
    },
    {
      "parameters": {
        "path": "real-message-count",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "95b1f074-f17a-4b30-a19d-d58af824ec37",
      "name": "Webhook Message Count",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -352,
        -624
      ],
      "webhookId": "real-message-count-webhook"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH message_counts AS (\n    SELECT \n        session_id,\n        COUNT(*) as real_messages\n    FROM (\n        SELECT session_id FROM n8n_chat_histories_ru\n        UNION ALL\n        SELECT session_id FROM n8n_chat_histories_en\n    ) all_messages\n    GROUP BY session_id\n)\nSELECT \n    wm.session_id,\n    COALESCE(mc.real_messages, 0) as message_count\nFROM webchat_monitoring wm\nLEFT JOIN message_counts mc ON wm.session_id = mc.session_id\nWHERE wm.session_id IN (\n    SELECT DISTINCT session_id \n    FROM webchat_monitoring \n    WHERE last_activity_time > NOW() - INTERVAL '24 hours'\n);",
        "options": {}
      },
      "id": "f968132c-c357-4aa9-8cd0-527ef6071333",
      "name": "Get Real Message Count",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -128,
        -624
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "fd94b930-6a8f-4170-81e6-d403fb386fe3",
      "name": "Respond Message Count",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        96,
        -624
      ]
    },
    {
      "parameters": {
        "path": "get-contact-data",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "80bc96e3-e1bd-46a9-aec2-0a5e2bce0077",
      "name": "Get Contact Data",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -304,
        1072
      ],
      "webhookId": "get-contact-data-webhook"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    ucd.session_id,\n    ucd.full_name,\n    ucd.first_name,\n    ucd.last_name,\n    ucd.phone,\n    ucd.phone_raw,\n    ucd.email,\n    ucd.telegram,\n    ucd.whatsapp,\n    ucd.instagram,\n    ucd.other_contacts,\n    ucd.company,\n    ucd.position,\n    ucd.location,\n    ucd.preferred_contact,\n    ucd.confidence_score,\n    ucd.extracted_from,\n    ucd.last_updated\nFROM user_contact_data ucd\nWHERE ucd.session_id IN (\n    SELECT DISTINCT session_id \n    FROM webchat_monitoring \n    WHERE last_activity_time >= NOW() - INTERVAL '30 days'\n);",
        "options": {}
      },
      "id": "12af88b3-0c30-4fe6-a6cb-22bf92d25703",
      "name": "Get Contacts from DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        192,
        1056
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸\nconst contacts = {};\n\nitems.forEach(item => {\n    const data = item.json;\n    \n    // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€Ñ‹ Ð¸Ð· Ð²ÑÐµÑ… Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÐµÐ¹\n    let messengers = [];\n    \n    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Telegram\n    if (data.telegram) {\n        messengers.push(`TG: ${data.telegram}`);\n    }\n    \n    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ WhatsApp  \n    if (data.whatsapp) {\n        messengers.push(`WA: ${data.whatsapp}`);\n    }\n    \n    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Instagram\n    if (data.instagram) {\n        messengers.push(`IG: ${data.instagram}`);\n    }\n  \n    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ Ð¸Ð· other_contacts\n    if (data.other_contacts) {\n        try {\n            const other = typeof data.other_contacts === 'string' \n                ? JSON.parse(data.other_contacts) \n                : data.other_contacts;\n            \n            Object.entries(other).forEach(([platform, contact]) => {\n                // ÐÐµ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÐµÐ¼ email ÐµÑÐ»Ð¸ Ð¾Ð½ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¼ Ð¿Ð¾Ð»Ðµ\n                if (platform.startsWith('email') && data.email) {\n                    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ email\n                    if (contact !== data.email) {\n                        messengers.push(`${platform}: ${contact}`);\n                    }\n                } else if (contact) {\n                    messengers.push(`${platform}: ${contact}`);\n                }\n            });\n        } catch (e) {\n            console.error('Error parsing other_contacts:', e);\n        }\n    }\n    \n    contacts[data.session_id] = {\n        name: data.full_name || `${data.first_name || ''} ${data.last_name || ''}`.trim() || null,\n        firstName: data.first_name,\n        lastName: data.last_name,\n        phone: data.phone || data.phone_raw,\n        email: data.email,\n        messengers: messengers.join(', ') || null, // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€Ð¾Ð²\n        telegram: data.telegram, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸\n        whatsapp: data.whatsapp,\n        instagram: data.instagram,\n        company: data.company,\n        position: data.position,\n        location: data.location,\n        preferredContact: data.preferred_contact,\n        confidence: data.confidence_score,\n        extractedFrom: data.extracted_from,\n        lastUpdated: data.last_updated\n    };\n});\n\nreturn [{json: {contacts}}];"
      },
      "id": "a0ff8433-18e1-48f6-a43f-8f1774e62cd7",
      "name": "Format Contacts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        1056
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "3f32980a-f9ac-4019-a1bb-c337591676b8",
      "name": "Respond Contacts",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        592,
        1056
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐÐ¯ Ð—ÐÐ©Ð˜Ð¢Ð: API KEY + RATE LIMITING\n// ============================================\n\n// ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ (Ð¸Ð·Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð´ ÑÐµÐ±Ñ)\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 60;\n\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -128,
        80
      ],
      "id": "8722714f-e316-49bf-ae37-af027e9a1e18",
      "name": "Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        16,
        80
      ],
      "id": "62cce6ad-ebbb-4130-852a-f42368cce598",
      "name": "Auth Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        192,
        208
      ],
      "id": "1565b882-7e55-4170-9859-0a863a4e02f1",
      "name": "Error Response"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐÐ¯ Ð—ÐÐ©Ð˜Ð¢Ð: API KEY + RATE LIMITING\n// ============================================\n\n// ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ (Ð¸Ð·Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð´ ÑÐµÐ±Ñ)\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 60;\n\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -160,
        384
      ],
      "id": "3c123a65-8bd5-462a-8854-5e5ee8a96c0e",
      "name": "Security Check1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -16,
        384
      ],
      "id": "af096c9e-397a-4798-97d6-1da1ef411002",
      "name": "Auth Check1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        208,
        528
      ],
      "id": "a350a7cc-c888-4b1b-8dca-70df1c51351d",
      "name": "Error Response1"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐÐ¯ Ð—ÐÐ©Ð˜Ð¢Ð: API KEY + RATE LIMITING\n// ============================================\n\n// ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ (Ð¸Ð·Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð´ ÑÐµÐ±Ñ)\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 60;\n\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        752
      ],
      "id": "8b9ac5ac-470e-4242-bd4f-eda89cbbd0c0",
      "name": "Security Check2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        0,
        752
      ],
      "id": "28fd5b69-6112-4219-a964-97375e1b880e",
      "name": "Auth Check2"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        192,
        896
      ],
      "id": "99f835a9-aa31-4ced-94c9-a83deb995ff2",
      "name": "Error Response2"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐÐ¯ Ð—ÐÐ©Ð˜Ð¢Ð: API KEY + RATE LIMITING\n// ============================================\n\n// ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ (Ð¸Ð·Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð´ ÑÐµÐ±Ñ)\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 60;\n\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        1072
      ],
      "id": "004d97c8-1a21-42d8-ab04-606d41415c95",
      "name": "Security Check3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        0,
        1072
      ],
      "id": "9aa54b97-fd7a-4c7f-ad40-dc24e762dbb7",
      "name": "Auth Check3"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        208,
        1232
      ],
      "id": "365c4db9-6bba-4aaf-87cb-cfb4db037dbe",
      "name": "Error Response3"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐÐ¯ Ð—ÐÐ©Ð˜Ð¢Ð: API KEY + RATE LIMITING\n// ============================================\n\n// ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ (Ð¸Ð·Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð´ ÑÐµÐ±Ñ)\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 60;\n\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        -288
      ],
      "id": "6362507d-e02a-43f1-9069-00ef7a8c602a",
      "name": "Security Check4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        48,
        -288
      ],
      "id": "d34dad2e-91df-4561-9f25-3d9f7a014a69",
      "name": "Auth Check4"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        240,
        -192
      ],
      "id": "353986b7-5da2-40e5-a49b-b38353f02f4c",
      "name": "Error Response4"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Security Check4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Insert or update rows in a table1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Security Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook2": {
      "main": [
        [
          {
            "node": "Security Check1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert or update rows in a table1": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Server Time": {
      "main": [
        [
          {
            "node": "Security Check2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Server Time": {
      "main": [
        [
          {
            "node": "Respond Server Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Message Count": {
      "main": [
        [
          {
            "node": "Get Real Message Count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Real Message Count": {
      "main": [
        [
          {
            "node": "Respond Message Count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Contact Data": {
      "main": [
        [
          {
            "node": "Security Check3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Contacts from DB": {
      "main": [
        [
          {
            "node": "Format Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Contacts": {
      "main": [
        [
          {
            "node": "Respond Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Security Check": {
      "main": [
        [
          {
            "node": "Auth Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Check": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Security Check1": {
      "main": [
        [
          {
            "node": "Auth Check1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Check1": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Security Check2": {
      "main": [
        [
          {
            "node": "Auth Check2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Check2": {
      "main": [
        [
          {
            "node": "Get Server Time",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Security Check3": {
      "main": [
        [
          {
            "node": "Auth Check3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Check3": {
      "main": [
        [
          {
            "node": "Get Contacts from DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Security Check4": {
      "main": [
        [
          {
            "node": "Auth Check4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Check4": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "4006f1a1-88b9-4417-b6d6-b5ac42f2a04c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "MbI4So3XlqEZTZ8b",
  "tags": []
}