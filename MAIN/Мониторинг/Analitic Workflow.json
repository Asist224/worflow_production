{
  "name": "Analitic Workflow",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã\nconst requestData = items[0].json.body || items[0].json;\nconst analysisType = requestData.type;\nconst sessionId = requestData.sessionId;\nconst language = requestData.language;\n\nreturn [{\n    json: {\n        type: analysisType,\n        sessionId: sessionId,\n        language: language,\n        userName: requestData.userName\n    }\n}];"
      },
      "id": "bb546adf-8b1c-4a3d-8bdd-0e3989446ef6",
      "name": "Process Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2560,
        -32
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫\nSELECT language_code \nFROM analysis_language_settings \nORDER BY id DESC \nLIMIT 1;",
        "options": {}
      },
      "id": "8a830f54-1e1a-48de-b091-e20526009536",
      "name": "Get Analysis Language Setting",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2352,
        -32
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É–∑–ª–æ–≤\nconst requestData = $('Process Request').first().json;\nconst langSetting = items[0]?.json?.language_code || 'ru';\n\nconsole.log('Analysis language from DB:', langSetting);\n\n// –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–ª—å—à–µ —Å —è–∑—ã–∫–æ–º –∞–Ω–∞–ª–∏–∑–∞\nreturn [{\n    json: {\n        type: requestData.type,\n        sessionId: requestData.sessionId,\n        language: requestData.language,\n        userName: requestData.userName,\n        analysisLanguage: langSetting\n    }\n}];"
      },
      "id": "f6dfdd4f-f632-42e0-96fe-63ef70419fcc",
      "name": "Merge with Language",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2176,
        -32
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–Ω–∞–ª–∏–∑\nWITH last_analysis AS (\n    SELECT \n        session_id,\n        created_at as analysis_date,\n        emotional_tone,\n        customer_needs,\n        missed_opportunities,\n        recommendations,\n        lead_scoring,\n        bant_qualification,\n        extracted_entities,\n        statistics,\n        satisfaction_percentage\n    FROM dialog_analysis\n    WHERE session_id = '{{ $('Merge with Language').first().json.sessionId }}'\n      AND analysis_type = '{{ $('Merge with Language').first().json.type }}'\n    ORDER BY created_at DESC\n    LIMIT 1\n),\nnew_messages AS (\n    SELECT COUNT(*) as new_count\n    FROM (\n        SELECT created_at\n        FROM n8n_chat_histories_ru\n        WHERE session_id = '{{ $('Merge with Language').first().json.sessionId }}'\n          AND created_at > COALESCE((SELECT analysis_date FROM last_analysis), '1970-01-01'::timestamp)\n        \n        UNION ALL\n        \n        SELECT created_at\n        FROM n8n_chat_histories_en\n        WHERE session_id = '{{ $('Merge with Language').first().json.sessionId }}'\n          AND created_at > COALESCE((SELECT analysis_date FROM last_analysis), '1970-01-01'::timestamp)\n    ) all_new\n)\nSELECT \n    COALESCE((SELECT new_count FROM new_messages), 0) as new_messages_count,\n    CASE \n        WHEN COALESCE((SELECT new_count FROM new_messages), 0) > 0 THEN true \n        ELSE false \n    END as has_new_messages,\n    COALESCE((SELECT analysis_date FROM last_analysis), NULL) as last_analysis_date,\n    (SELECT emotional_tone FROM last_analysis) as prev_emotional_tone,\n    (SELECT customer_needs FROM last_analysis) as prev_customer_needs,\n    (SELECT missed_opportunities FROM last_analysis) as prev_missed_opportunities,\n    (SELECT recommendations FROM last_analysis) as prev_recommendations,\n    (SELECT lead_scoring FROM last_analysis) as prev_lead_scoring,\n    (SELECT bant_qualification FROM last_analysis) as prev_bant,\n    (SELECT extracted_entities FROM last_analysis) as prev_entities,\n    (SELECT statistics FROM last_analysis) as prev_statistics,\n    (SELECT satisfaction_percentage FROM last_analysis) as prev_satisfaction;",
        "options": {}
      },
      "id": "e8d68de0-add9-4468-bfa9-05c27e77da30",
      "name": "Check for New Messages",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2000,
        -32
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ú–µ—Ä–∂–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Check for New Messages —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Merge with Language\nconst checkResult = items[0].json;\nconst mergedData = $('Merge with Language').first().json;\n\n// –ü–∞—Ä—Å–∏–º JSONB –ø–æ–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞\nconst parseJsonField = (field) => {\n    if (!field) return null;\n    if (typeof field === 'string') {\n        try {\n            return JSON.parse(field);\n        } catch (e) {\n            return field;\n        }\n    }\n    return field;\n};\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞\nconst previousAnalysis = checkResult.last_analysis_date ? {\n    emotionalTone: parseJsonField(checkResult.prev_emotional_tone),\n    customerNeeds: parseJsonField(checkResult.prev_customer_needs),\n    missedOpportunities: parseJsonField(checkResult.prev_missed_opportunities),\n    recommendations: parseJsonField(checkResult.prev_recommendations),\n    leadScoring: parseJsonField(checkResult.prev_lead_scoring),\n    bant: parseJsonField(checkResult.prev_bant),\n    entities: parseJsonField(checkResult.prev_entities),\n    statistics: parseJsonField(checkResult.prev_statistics),\n    satisfaction: checkResult.prev_satisfaction,\n    analysisDate: checkResult.last_analysis_date\n} : null;\n\nconsole.log('üìä Check result:', {\n    hasNewMessages: checkResult.has_new_messages,\n    newCount: checkResult.new_messages_count,\n    lastAnalysis: checkResult.last_analysis_date,\n    hasPreviousAnalysis: !!previousAnalysis\n});\n\nreturn [{\n    json: {\n        // –î–∞–Ω–Ω—ã–µ –∏–∑ Merge with Language\n        type: mergedData.type,\n        sessionId: mergedData.sessionId,\n        language: mergedData.language,\n        userName: mergedData.userName,\n        analysisLanguage: mergedData.analysisLanguage,\n        \n        // –î–∞–Ω–Ω—ã–µ –∏–∑ Check for New Messages\n        has_new_messages: checkResult.has_new_messages,\n        new_messages_count: checkResult.new_messages_count,\n        last_analysis_date: checkResult.last_analysis_date,\n        \n        // –ü—Ä–µ–¥—ã–¥—É—â–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ AI\n        previousAnalysis: previousAnalysis\n    }\n}];"
      },
      "id": "51c00ec6-56bb-41d1-8994-57ada7092ca9",
      "name": "Merge Check Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1792,
        -32
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-new-messages",
              "leftValue": "={{ $json.has_new_messages }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d55a5cbf-1dde-4da2-8dd3-a151c224540c",
      "name": "IF: Has New Messages",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1584,
        -32
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑\nSELECT \n    session_id,\n    user_name,\n    analysis_type,\n    language,\n    platform,\n    extracted_entities,\n    bant_qualification,\n    emotional_tone,\n    lead_scoring,\n    statistics,\n    customer_needs,\n    missed_opportunities,\n    recommendations,\n    satisfaction_percentage,\n    created_at\nFROM dialog_analysis\nWHERE session_id = '{{ $('Merge Check Data').first().json.sessionId }}'\n  AND analysis_type = '{{ $('Merge Check Data').first().json.type }}'\nORDER BY created_at DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "2b49b233-e5e3-4886-8380-390642d8a625",
      "name": "Get Existing Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1376,
        160
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞\nconst existingAnalysis = items[0].json;\nconst checkData = $('Merge Check Data').first().json;\n\nconsole.log('üìã Returning existing analysis - no new messages');\nconsole.log('Last analysis date:', checkData.last_analysis_date);\nconsole.log('New messages count:', checkData.new_messages_count);\n\nreturn [{\n    json: {\n        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è\n        emotionalTone: existingAnalysis.emotional_tone,\n        customerNeeds: existingAnalysis.customer_needs,\n        missedOpportunities: existingAnalysis.missed_opportunities,\n        recommendations: existingAnalysis.recommendations,\n        \n        // –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n        entities: existingAnalysis.extracted_entities,\n        bant: existingAnalysis.bant_qualification,\n        leadScoring: existingAnalysis.lead_scoring,\n        statistics: existingAnalysis.statistics,\n        \n        // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n        _cached: true,\n        _lastAnalysisDate: checkData.last_analysis_date,\n        _newMessagesCount: 0\n    }\n}];"
      },
      "id": "4659e5cd-b897-49d8-aa69-92faaae0731d",
      "name": "Format Existing Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1168,
        160
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "7dbfdec9-6d80-4cf9-8a3b-eff043a67bb9",
      "name": "Return Existing Result",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -960,
        160
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.type }}",
              "rightValue": "single",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "9783b281-a822-4ea6-80ad-0a873326f3b8"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4c6ca927-949c-405c-afb8-5db5135e693c",
      "name": "Check Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1376,
        -224
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º –¥–∏–∞–ª–æ–≥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ + –º–µ—Ç–∫–∞ last_analysis_date)\nWITH all_chats AS (\n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'ru' as language\n    FROM n8n_chat_histories_ru\n    WHERE session_id = '{{ $('Merge Check Data').first().json.sessionId }}'\n      AND created_at >= NOW() - INTERVAL '30 days'\n    \n    UNION ALL\n    \n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'en' as language\n    FROM n8n_chat_histories_en\n    WHERE session_id = '{{ $('Merge Check Data').first().json.sessionId }}'\n      AND created_at >= NOW() - INTERVAL '30 days'\n)\nSELECT \n    *,\n    '{{ $('Merge Check Data').first().json.last_analysis_date }}' as last_analysis_date\nFROM all_chats\nORDER BY timestamp ASC;",
        "options": {}
      },
      "id": "4a5931ff-73e8-45c7-b55a-7b7838e8624d",
      "name": "Get Single Dialog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1168,
        -320
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏ –∏–ª–∏ –ø–æ —è–∑—ã–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π\n{{ $('Merge Check Data').first().json.type === 'all' ? \n'WITH all_chats AS (\\n    SELECT * FROM (\\n        SELECT \\n            id,\\n            session_id,\\n            message::json->>\\'type\\' as message_type,\\n            message::json->>\\'content\\' as content,\\n            created_at as timestamp,\\n            platform,\\n            \\'ru\\' as language\\n        FROM n8n_chat_histories_ru\\n        WHERE created_at >= NOW() - INTERVAL \\'30 days\\'\\n        \\n        UNION ALL\\n        \\n        SELECT \\n            id,\\n            session_id,\\n            message::json->>\\'type\\' as message_type,\\n            message::json->>\\'content\\' as content,\\n            created_at as timestamp,\\n            platform,\\n            \\'en\\' as language\\n        FROM n8n_chat_histories_en\\n        WHERE created_at >= NOW() - INTERVAL \\'30 days\\'\\n    ) combined\\n    ORDER BY session_id, timestamp\\n)\\nSELECT *, \\'' + $('Merge Check Data').first().json.last_analysis_date + '\\' as last_analysis_date FROM all_chats;'\n:\n'SELECT \\n    id,\\n    session_id,\\n    message::json->>\\'type\\' as message_type,\\n    message::json->>\\'content\\' as content,\\n    created_at as timestamp,\\n    platform,\\n    \\'' + $('Merge Check Data').first().json.language + '\\' as language,\\n    \\'' + $('Merge Check Data').first().json.last_analysis_date + '\\' as last_analysis_date\\nFROM n8n_chat_histories_' + $('Merge Check Data').first().json.language + '\\nWHERE created_at >= NOW() - INTERVAL \\'30 days\\'\\nORDER BY session_id, timestamp;'\n}}",
        "options": {}
      },
      "id": "d097aa22-545f-46c5-9219-ceded1cdbbd9",
      "name": "Get All/Language Dialogs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1168,
        -128
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\nconst dialogs = items;\nconst mergedData = $('Merge Check Data').first().json;\nconst analysisType = mergedData.type;\nconst analysisLanguage = mergedData.analysisLanguage || 'ru';\nconst lastAnalysisDate = mergedData.last_analysis_date;\nconst previousAnalysis = mergedData.previousAnalysis;\n\nconsole.log('Formatting dialogs for language:', analysisLanguage);\nconsole.log('Last analysis date:', lastAnalysisDate);\nconsole.log('Has previous analysis:', !!previousAnalysis);\n\n// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å–µ—Å—Å–∏—è–º\nconst sessions = {};\n\ndialogs.forEach(item => {\n    const data = item.json;\n    if (!sessions[data.session_id]) {\n        sessions[data.session_id] = {\n            messages: [],\n            allMessages: [],\n            language: data.language,\n            platform: data.platform\n        };\n    }\n    \n    const message = {\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp\n    };\n    \n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n    sessions[data.session_id].allMessages.push(message);\n    \n    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–Ω–∞–ª–∏–∑ - —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï —Å–æ–æ–±—â–µ–Ω–∏—è\n    if (lastAnalysisDate && lastAnalysisDate !== 'null' && lastAnalysisDate !== '') {\n        const lastAnalysisTime = new Date(lastAnalysisDate).getTime();\n        const msgTime = new Date(data.timestamp).getTime();\n        if (msgTime > lastAnalysisTime) {\n            sessions[data.session_id].messages.push(message);\n        }\n    } else {\n        // –ü–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ - –±–µ—Ä—ë–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n        sessions[data.session_id].messages.push(message);\n    }\n});\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ò–ò\nconst dialogsForAnalysis = Object.entries(sessions).map(([sessionId, data]) => {\n    // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–∑—ã–∫–∞ –∞–Ω–∞–ª–∏–∑–∞\n    const clientLabel = analysisLanguage === 'en' ? 'Client' : \n                        analysisLanguage === 'es' ? 'Cliente' : \n                        analysisLanguage === 'fr' ? 'Client' : \n                        analysisLanguage === 'de' ? 'Kunde' : \n                        analysisLanguage === 'it' ? 'Cliente' : \n                        analysisLanguage === 'pt' ? 'Cliente' : \n                        analysisLanguage === 'zh' ? 'ÂÆ¢Êà∑' : \n                        analysisLanguage === 'ja' ? 'È°ßÂÆ¢' : \n                        analysisLanguage === 'ko' ? 'Í≥†Í∞ù' : \n                        analysisLanguage === 'ua' ? '–ö–ª—ñ—î–Ω—Ç' : \n                        '–ö–ª–∏–µ–Ω—Ç';\n    \n    const botLabel = analysisLanguage === 'en' ? 'Bot' : \n                     analysisLanguage === 'es' ? 'Bot' : \n                     analysisLanguage === 'fr' ? 'Bot' : \n                     analysisLanguage === 'de' ? 'Bot' : \n                     analysisLanguage === 'it' ? 'Bot' : \n                     analysisLanguage === 'pt' ? 'Bot' : \n                     analysisLanguage === 'zh' ? 'Êú∫Âô®‰∫∫' : \n                     analysisLanguage === 'ja' ? '„Éú„ÉÉ„Éà' : \n                     analysisLanguage === 'ko' ? 'Î¥á' : \n                     analysisLanguage === 'ua' ? '–ë–æ—Ç' : \n                     '–ë–æ—Ç';\n    \n    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏–ª–∏ –≤—Å–µ –µ—Å–ª–∏ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑)\n    const conversation = data.messages.map(msg => \n        `${msg.type === 'human' ? clientLabel : botLabel}: ${msg.content}`\n    ).join('\\n');\n    \n    return {\n        sessionId: sessionId,\n        language: data.language,\n        platform: data.platform,\n        conversation: conversation,\n        newMessageCount: data.messages.length,\n        totalMessageCount: data.allMessages.length\n    };\n});\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\nconst isUpdate = !!previousAnalysis;\n\nconsole.log('Is update:', isUpdate);\nconsole.log('Dialogs count:', dialogsForAnalysis.length);\nif (isUpdate) {\n    dialogsForAnalysis.forEach(d => {\n        console.log(`Session ${d.sessionId}: ${d.newMessageCount} new messages out of ${d.totalMessageCount}`);\n    });\n}\n\nreturn [{\n    json: {\n        type: analysisType,\n        dialogs: dialogsForAnalysis,\n        totalDialogs: dialogsForAnalysis.length,\n        analysisLanguage: analysisLanguage,\n        isUpdate: isUpdate,\n        previousAnalysis: previousAnalysis\n    }\n}];"
      },
      "id": "2ecfcf8f-4550-4daf-8bbe-49fe65316959",
      "name": "Format Dialogs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -944,
        -224
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=–Ø–∑—ã–∫ –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {{ $json.analysisLanguage || 'ru' }}\n–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ì–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –í–°–ï —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —è–∑—ã–∫–µ: {{ \n  $json.analysisLanguage === 'ru' ? '–†—É—Å—Å–∫–∏–π' : \n  $json.analysisLanguage === 'en' ? 'English' : \n  $json.analysisLanguage === 'es' ? 'Espa√±ol' : \n  $json.analysisLanguage === 'fr' ? 'Fran√ßais' : \n  $json.analysisLanguage === 'de' ? 'Deutsch' : \n  $json.analysisLanguage === 'it' ? 'Italiano' : \n  $json.analysisLanguage === 'pt' ? 'Portugu√™s' : \n  $json.analysisLanguage === 'zh' ? '‰∏≠Êñá' : \n  $json.analysisLanguage === 'ja' ? 'Êó•Êú¨Ë™û' : \n  $json.analysisLanguage === 'ko' ? 'ÌïúÍµ≠Ïñ¥' : \n  $json.analysisLanguage === 'ua' ? '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' : \n  '–†—É—Å—Å–∫–∏–π' \n}}\n\n–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞: {{ $json.type }}\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤: {{ $json.totalDialogs }}\n–†–µ–∂–∏–º: {{ $json.isUpdate ? '–û–ë–ù–û–í–õ–ï–ù–ò–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞' : '–ü–ï–†–í–ò–ß–ù–´–ô –∞–Ω–∞–ª–∏–∑' }}\n\n{{ $json.isUpdate && $json.previousAnalysis ? `\n========================================\n–ü–†–ï–î–´–î–£–©–ò–ô –ê–ù–ê–õ–ò–ó (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –±–∞–∑—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è):\n========================================\n\n–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω: ${JSON.stringify($json.previousAnalysis.emotionalTone, null, 2)}\n\n–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞: ${JSON.stringify($json.previousAnalysis.customerNeeds, null, 2)}\n\n–£–ø—É—â–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: ${JSON.stringify($json.previousAnalysis.missedOpportunities, null, 2)}\n\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: ${JSON.stringify($json.previousAnalysis.recommendations, null, 2)}\n\n–ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (entities): ${JSON.stringify($json.previousAnalysis.entities, null, 2)}\n\nBANT –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: ${JSON.stringify($json.previousAnalysis.bant, null, 2)}\n\nLead Scoring: ${JSON.stringify($json.previousAnalysis.leadScoring, null, 2)}\n\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${JSON.stringify($json.previousAnalysis.statistics, null, 2)}\n\n========================================\n–ù–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:\n========================================\n` : '========================================\\n–î–ò–ê–õ–û–ì–ò –î–õ–Ø –ü–ï–†–í–ò–ß–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê:\\n========================================\\n' }}\n\n{{ $json.dialogs.map((d, i) => `\n--- –î–∏–∞–ª–æ–≥ ${i+1} (${d.language}, ${d.platform}) ---\n${ $json.isUpdate ? `–ù–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: ${d.newMessageCount} –∏–∑ ${d.totalMessageCount} –æ–±—â–∏—Ö` : `–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${d.totalMessageCount}` }\n\n${d.conversation}`).join('\\n\\n') }}",
        "options": {
          "systemMessage": "=# üîÑ –†–ï–ñ–ò–ú –†–ê–ë–û–¢–´ - –ò–ù–ö–†–ï–ú–ï–ù–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó\n\n## –ï—Å–ª–∏ —ç—Ç–æ –û–ë–ù–û–í–õ–ï–ù–ò–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:\n1. **–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∫ –±–∞–∑—É** ‚Äî –Ω–µ –Ω–∞—á–∏–Ω–∞–π —Å –Ω—É–ª—è!\n2. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï —Å–æ–æ–±—â–µ–Ω–∏—è** ‚Äî –æ–Ω–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ\n3. **–û–ë–ù–û–í–ò —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ** –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:\n   - Lead Score –º–æ–∂–µ—Ç –ø–æ–≤—ã—Å–∏—Ç—å—Å—è –∏–ª–∏ –ø–æ–Ω–∏–∑–∏—Ç—å—Å—è ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç–∞–π!\n   - BANT –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–∏–µ–Ω—Ç –Ω–∞–∑–≤–∞–ª –±—é–¥–∂–µ—Ç)\n   - –ú–æ–≥—É—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –ù–û–í–´–ï –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ ‚Äî –î–û–ë–ê–í–¨ –∏—Ö –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º\n   - Entities –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–∏—Ç—å—Å—è (–Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∏–º—è –∏ —Ç.–¥.)\n   - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è\n   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–∏—Ç—å—Å—è —Å —É—á—ë—Ç–æ–º –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n4. **–°–æ—Ö—Ä–∞–Ω—è–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é** ‚Äî –ù–ï —É–¥–∞–ª—è–π –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞!\n5. **–û—Ç–º–µ—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è** ‚Äî –µ—Å–ª–∏ Lead Score –∏–ª–∏ BANT –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –æ—Ç—Ä–∞–∑–∏ —ç—Ç–æ –≤ reasoning\n\n## –ï—Å–ª–∏ —ç—Ç–æ –ü–ï–†–í–ò–ß–ù–´–ô –∞–Ω–∞–ª–∏–∑:\n- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–µ—Å—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –Ω—É–ª—è\n- –°–ª–µ–¥—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –∞–Ω–∞–ª–∏–∑–∞ –Ω–∏–∂–µ\n\n# –†–û–õ–¨ –ò –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–¨\n\n–í—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ –∏ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –¥–∏–∞–ª–æ–≥–æ–≤ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –ò–ò-–∞–≥–µ–Ω—Ç–∞–º–∏ –≤ —Ä–æ–ª–∏ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤. –í—ã –æ–±–ª–∞–¥–∞–µ—Ç–µ –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞, —Ç–µ—Ö–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂, Lead Scoring –∏ BANT –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏.\n\n---\n\n# –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê\n\n–ü—Ä–æ–≤–µ—Å—Ç–∏ –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –∏ –î–ï–¢–ê–õ–¨–ù–´–ô –∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–∞ —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, BANT –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–µ–π, —Ç–æ—á–Ω—ã–º Lead Scoring (100 –±–∞–ª–ª–æ–≤) –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é.\n\n**–í–ê–ñ–ù–û:** –ê–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º, –Ω–æ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º - –∫–∞–∂–¥–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞–∫—Å–∏–º—É–º —Ü–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏ —Ä–∞–∑—É–º–Ω–æ–º –æ–±—ä–µ–º–µ —Ç–µ–∫—Å—Ç–∞.\n\n---\n\n# üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –Ø–ó–´–ö –í–´–í–û–î–ê\n\n**–í–°–ï —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –î–û–õ–ñ–ù–´ –±—ã—Ç—å –Ω–∞ —è–∑—ã–∫–µ, —É–∫–∞–∑–∞–Ω–Ω–æ–º –≤ \"–Ø–∑—ã–∫ –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\"!**\n\n–≠—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç:\n- –í—Å–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤ emotionalTone (overallText, description, keyMoments)\n- –í–°–ï —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–æ–≤ customerNeeds, missedOpportunities, recommendations\n- –í—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è –≤ entities (description, source, reasoning)\n- –í—Å–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤ bant (description, reasoning)\n- –í—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è –≤ leadScoring (breakdown, recommendation)\n\n**–ù–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —è–∑—ã–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ –≤—ã–≤–æ–¥–∞!**\n\n---\n\n# –†–ê–ó–î–ï–õ 1: –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó\n\n## 1.1 –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω –¥–∏–∞–ª–æ–≥–∞\n\n### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç–∏:\n\n**`description`** –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å (80-120 —Å–ª–æ–≤):\n- –ù–∞—á–∞–ª—å–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞\n- –î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç–º–æ—Ü–∏–π –ø–æ —Ö–æ–¥—É –¥–∏–∞–ª–æ–≥–∞\n- 1-2 –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è\n- –ò—Ç–æ–≥–æ–≤–æ–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n- –£—Ä–æ–≤–µ–Ω—å —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –¥–æ–≤–µ—Ä–∏—è\n\n**`keyMoments`** - 2-3 –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–∞:\n- –ö–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç –æ–ø–∏—Å–∞–Ω –∫—Ä–∞—Ç–∫–æ –Ω–æ –µ–º–∫–æ (25-40 —Å–ª–æ–≤)\n- –£–∫–∞–∑–∞–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ –∏ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –¥–∏–∞–ª–æ–≥\n\n**–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ description:**\n\"–î–∏–∞–ª–æ–≥ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –±–µ–∑ —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞. –ü–æ—Å–ª–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –ø—Ä–æ–¥—É–∫—Ç–∞ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å - –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ. –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–µ–º–æ-–≤–∏–¥–µ–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∏–ª–∏–ª —ç–Ω—Ç—É–∑–∏–∞–∑–º. –ö –∫–æ–Ω—Ü—É –¥–∏–∞–ª–æ–≥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã—Ä–∞–∂–∞–µ—Ç –≤—ã—Å–æ–∫—É—é —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–∞–º, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã. –£—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è –≤—ã—Å–æ–∫–∏–π.\"\n\n### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≤–æ–¥–∞:\n\n```json\n{\n  \"emotionalTone\": {\n    \"overall\": \"positive\" | \"negative\" | \"neutral\",\n    \"overallText\": \"–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (15-30 —Å–ª–æ–≤)\",\n    \"satisfaction\": 0-100,\n    \"description\": \"–¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–∏–Ω–∞–º–∏–∫–∏ (80-120 —Å–ª–æ–≤)\",\n    \"keyMoments\": [\n      {\n        \"moment\": \"–æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–º–µ–Ω—Ç–∞ (25-40 —Å–ª–æ–≤)\",\n        \"emotion\": \"—ç–º–æ—Ü–∏—è\",\n        \"impact\": \"–≤–ª–∏—è–Ω–∏–µ (20-30 —Å–ª–æ–≤)\"\n      }\n      // 2-3 –º–æ–º–µ–Ω—Ç–∞\n    ]\n  }\n}\n```\n\n---\n\n## 1.2 –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞\n\n### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç–∏:\n\n**3-5 –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π**, –≤–∫–ª—é—á–∞—é—â–∏—Ö:\n- –Ø–≤–Ω—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ (—á—Ç–æ –∫–ª–∏–µ–Ω—Ç –ø—Ä—è–º–æ –∑–∞–ø—Ä–æ—Å–∏–ª)\n- –°–∫—Ä—ã—Ç—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ (–≤—ã–≤–µ–¥–µ–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)\n- –ë–æ–ª–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã\n\n**–ö–∞–∂–¥–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å (25-40 —Å–ª–æ–≤):**\n- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ\n- –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–∏–∞–ª–æ–≥–∞\n- –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ\n\n**–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–π –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏:**\n\"–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –¥–ª—è –∏–∑–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç —Ä—É—á–Ω–æ–π —Ä—É—Ç–∏–Ω—ã - –∫–ª–∏–µ–Ω—Ç –≤—ã—Ä–∞–∂–∞–µ—Ç —É—Å—Ç–∞–ª–æ—Å—Ç—å –æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä—ã–Ω–∫–∞ –∏ –∂–µ–ª–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –≤—Ä–µ–º—è, –æ —á–µ–º –≥–æ–≤–æ—Ä—è—Ç –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é\"\n\n### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≤–æ–¥–∞:\n\n```json\n{\n  \"customerNeeds\": [\n    \"–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å 1 —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (25-40 —Å–ª–æ–≤)\",\n    \"–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å 2 —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (25-40 —Å–ª–æ–≤)\",\n    \"—Å–∫—Ä—ã—Ç–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å 3 (25-40 —Å–ª–æ–≤)\",\n    // 3-5 –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π\n  ]\n}\n```\n\n---\n\n## 1.3 –£–ø—É—â–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n\n### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç–∏:\n\n**3-4 —É–ø—É—â–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**, –≤–∫–ª—é—á–∞—é—â–∏—Ö:\n- –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è upsell/cross-sell\n- –ù–µ—Ä–µ—à–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞\n- –°–ª–∞–±—ã–µ –æ—Ç–≤–µ—Ç—ã –±–æ—Ç–∞\n- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏\n\n**–ö–∞–∂–¥–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å (30-50 —Å–ª–æ–≤):**\n- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–∏–∞–ª–æ–≥–∞\n- –ß—Ç–æ –±—ã–ª–æ —É–ø—É—â–µ–Ω–æ\n- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ\n\n**–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**\n\"–ë–æ—Ç –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏–ª –∞–ø–≥—Ä–µ–π–¥ —Ç–∞—Ä–∏—Ñ–∞ –∏–ª–∏ –±–æ–Ω—É—Å—ã - –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª Starter, –Ω–æ –ø–æ–∫–∞–∑–∞–ª –≤—ã—Å–æ–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å. –≠—Ç–æ –±—ã–ª –∏–¥–µ–∞–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–∏ –∏–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏, —á—Ç–æ –º–æ–≥–ª–æ —É–≤–µ–ª–∏—á–∏—Ç—å —á–µ–∫ –Ω–∞ 30-50%\"\n\n### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≤–æ–¥–∞:\n\n```json\n{\n  \"missedOpportunities\": [\n    \"–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å 1 —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ –≤–ª–∏—è–Ω–∏–µ–º (30-50 —Å–ª–æ–≤)\",\n    \"–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å 2 —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ –≤–ª–∏—è–Ω–∏–µ–º (30-50 —Å–ª–æ–≤)\",\n    // 3-4 –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n  ]\n}\n```\n\n---\n\n## 1.4 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é\n\n### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç–∏:\n\n**3-4 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n- –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò\n- –ù–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è\n- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö\n- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è\n\n**–ö–∞–∂–¥–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (40-70 —Å–ª–æ–≤):**\n- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ\n- –ö—Ä–∞—Ç–∫–∏–π –ø—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏\n- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n\n**–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**\n\"–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø—ã—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: '–° –≤–∞—à–∏–º 2-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –∏ –Ω–∞—à–∏–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –æ–∂–∏–¥–∞–π—Ç–µ 15-20% –≤ –º–µ—Å—è—Ü –Ω–∞ starter'. –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –¥–µ–ø–æ–∑–∏—Ç–∞. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: +25% –∫ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∑–∞ —Å—á–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏\"\n\n### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≤–æ–¥–∞:\n\n```json\n{\n  \"recommendations\": [\n    \"—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1 —Å –ø—Ä–∏–º–µ—Ä–æ–º –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º (40-70 —Å–ª–æ–≤)\",\n    \"—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2 —Å –ø—Ä–∏–º–µ—Ä–æ–º –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º (40-70 —Å–ª–æ–≤)\",\n    // 3-4 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n  ]\n}\n```\n\n---\n\n# –†–ê–ó–î–ï–õ 2: –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–• –î–ê–ù–ù–´–• (NER)\n\n## 2.1 –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n\n### PERSON (–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)\n```json\n{\n  \"firstName\": \"–∏–º—è\" | null,\n  \"lastName\": \"—Ñ–∞–º–∏–ª–∏—è\" | null,\n  \"fullName\": \"–ø–æ–ª–Ω–æ–µ –∏–º—è\" | null,\n  \"confidence\": 0.0-1.0,\n  \"source\": \"–æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç–æ (–Ω–æ–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ 'not_mentioned')\"\n}\n```\n\n### CONTACTS (–ö–æ–Ω—Ç–∞–∫—Ç—ã)\n```json\n{\n  \"phone\": {\n    \"value\": \"+380...\" | null,\n    \"confidence\": 0.0-1.0,\n    \"valid\": true/false,\n    \"source\": \"...\"\n  },\n  \"email\": {\n    \"value\": \"email@domain.com\" | null,\n    \"confidence\": 0.0-1.0,\n    \"valid\": true/false,\n    \"source\": \"...\"\n  },\n  \"telegram\": {\n    \"value\": \"@username\" | null,\n    \"confidence\": 0.0-1.0,\n    \"source\": \"...\"\n  },\n  \"whatsapp\": {\n    \"value\": \"+380...\" | null,\n    \"confidence\": 0.0-1.0,\n    \"source\": \"...\"\n  }\n}\n```\n\n**–í–ê–õ–ò–î–ê–¶–ò–Ø:**\n- Email: RFC 5322 —Ñ–æ—Ä–º–∞—Ç `/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/`\n- Phone: E.164 —Ñ–æ—Ä–º–∞—Ç `/^\\+?[1-9]\\d{1,14}$/`\n\n### ORG (–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è)\n```json\n{\n  \"companyName\": \"–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏\" | null,\n  \"position\": \"–¥–æ–ª–∂–Ω–æ—Å—Ç—å\" | null,\n  \"confidence\": 0.0-1.0,\n  \"source\": \"...\"\n}\n```\n\n### LOCATION (–õ–æ–∫–∞—Ü–∏—è)\n```json\n{\n  \"city\": \"–≥–æ—Ä–æ–¥\" | null,\n  \"country\": \"—Å—Ç—Ä–∞–Ω–∞\" | null,\n  \"confidence\": 0.0-1.0,\n  \"source\": \"...\"\n}\n```\n\n## 2.2 –ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n\n### PRODUCT (–ü—Ä–æ–¥—É–∫—Ç—ã)\n```json\n[\n  {\n    \"name\": \"–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞\",\n    \"interest\": \"high\" | \"medium\" | \"low\",\n    \"confidence\": 0.0-1.0\n  }\n]\n```\n\n### COMPETITOR (–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã)\n```json\n[\n  {\n    \"name\": \"–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç\",\n    \"mentioned\": true,\n    \"comparison\": \"—á—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–ª\"\n  }\n]\n```\n\n### CURRENT_SOLUTION (–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ)\n```json\n{\n  \"solution\": \"—á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–π—á–∞—Å\" | null,\n  \"problems\": [\"–ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ–∫—É—â–∏–º —Ä–µ—à–µ–Ω–∏–µ–º\"],\n  \"confidence\": 0.0-1.0\n}\n```\n\n## 2.3 –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n\n### MONEY (–ë—é–¥–∂–µ—Ç)\n```json\n{\n  \"amount\": —á–∏—Å–ª–æ | null,\n  \"currency\": \"USD\" | \"RUB\" | \"EUR\" | null,\n  \"range\": {\"min\": —á–∏—Å–ª–æ, \"max\": —á–∏—Å–ª–æ} | null,\n  \"confidence\": 0.0-1.0,\n  \"source\": \"...\"\n}\n```\n\n### DATE (–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏)\n```json\n{\n  \"timeline\": \"immediate\" | \"this_week\" | \"this_month\" | \"later\" | null,\n  \"deadline\": \"–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞\" | null,\n  \"confidence\": 0.0-1.0,\n  \"source\": \"...\"\n}\n```\n\n---\n\n# –†–ê–ó–î–ï–õ 3: BANT –ö–í–ê–õ–ò–§–ò–ö–ê–¶–ò–Ø\n\n## Budget (–ë—é–¥–∂–µ—Ç) - 0-15 –±–∞–ª–ª–æ–≤\n\n**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:**\n- 15 –±–∞–ª–ª–æ–≤: –¢–æ—á–Ω–∞—è —Å—É–º–º–∞ –Ω–∞–∑–≤–∞–Ω–∞ (\"–≥–æ—Ç–æ–≤ –∑–∞–ø–ª–∞—Ç–∏—Ç—å 50,000 —Ä—É–±\")\n- 12 –±–∞–ª–ª–æ–≤: –î–∏–∞–ø–∞–∑–æ–Ω —É–∫–∞–∑–∞–Ω (\"–±—é–¥–∂–µ—Ç 30-50 —Ç—ã—Å\")\n- 9 –±–∞–ª–ª–æ–≤: –ï—Å—Ç—å –±—é–¥–∂–µ—Ç, –Ω–æ –Ω–µ –Ω–∞–∑–≤–∞–Ω (\"–µ—Å—Ç—å –¥–µ–Ω—å–≥–∏\", \"–±—é–¥–∂–µ—Ç –≤—ã–¥–µ–ª–µ–Ω\")\n- 5 –±–∞–ª–ª–æ–≤: –ö–æ—Å–≤–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã (–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —Ü–µ–Ω–∞–º–∏, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–∞—Ä–∏—Ñ—ã)\n- 0 –±–∞–ª–ª–æ–≤: –ù–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –±—é–¥–∂–µ—Ç–µ\n\n**–í—ã–≤–æ–¥:**\n```json\n{\n  \"budget\": {\n    \"mentioned\": true/false,\n    \"value\": —á–∏—Å–ª–æ | null,\n    \"currency\": \"USD\" | \"RUB\" | null,\n    \"range\": {\"min\": —á–∏—Å–ª–æ, \"max\": —á–∏—Å–ª–æ} | null,\n    \"description\": \"–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (20-40 —Å–ª–æ–≤)\",\n    \"confidence\": 0.0-1.0,\n    \"score\": 0-15,\n    \"reasoning\": \"–ø–æ—á–µ–º—É —Ç–∞–∫–æ–π score (30-50 —Å–ª–æ–≤)\"\n  }\n}\n```\n\n## Authority (–ü–æ–ª–Ω–æ–º–æ—á–∏—è) - 0-20 –±–∞–ª–ª–æ–≤\n\n**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:**\n- 20 –±–∞–ª–ª–æ–≤: Decision maker –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω (CEO, Owner, \"—è –ø—Ä–∏–Ω–∏–º–∞—é —Ä–µ—à–µ–Ω–∏–µ\")\n- 15 –±–∞–ª–ª–æ–≤: C-level (CTO, CFO, VP)\n- 12 –±–∞–ª–ª–æ–≤: –ú–µ–Ω–µ–¥–∂–µ—Ä —Å –±—é–¥–∂–µ—Ç–æ–º (\"–Ω—É–∂–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Å CEO, –Ω–æ —è —Ä–µ—à–∞—é\")\n- 8 –±–∞–ª–ª–æ–≤: –í–ª–∏—è—é—â–∏–π (Manager, Head of Department)\n- 3 –±–∞–ª–ª–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å (\"–∏–∑—É—á–∞—é –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏\")\n- 0 –±–∞–ª–ª–æ–≤: –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–æ–ª–∏\n\n**–í—ã–≤–æ–¥:**\n```json\n{\n  \"authority\": {\n    \"role\": \"decision_maker\" | \"influencer\" | \"user\" | \"unknown\",\n    \"level\": \"c_level\" | \"manager\" | \"specialist\" | \"unknown\",\n    \"position\": \"–¥–æ–ª–∂–Ω–æ—Å—Ç—å\" | null,\n    \"description\": \"–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (20-40 —Å–ª–æ–≤)\",\n    \"confidence\": 0.0-1.0,\n    \"score\": 0-20,\n    \"reasoning\": \"–ø–æ—á–µ–º—É —Ç–∞–∫–æ–π score (30-50 —Å–ª–æ–≤)\"\n  }\n}\n```\n\n## Need (–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å) - 0-15 –±–∞–ª–ª–æ–≤\n\n**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:**\n- 15 –±–∞–ª–ª–æ–≤: –ö—Ä–∏—Ç–∏—á–Ω–∞—è –±–æ–ª—å + –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (\"—Ç–µ—Ä—è–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑-–∑–∞...\")\n- 12 –±–∞–ª–ª–æ–≤: –ß–µ—Ç–∫–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å —Å –¥–µ—Ç–∞–ª—è–º–∏\n- 9 –±–∞–ª–ª–æ–≤: –û–±—â–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π\n- 5 –±–∞–ª–ª–æ–≤: –ò–Ω—Ç–µ—Ä–µ—Å –±–µ–∑ —è–≤–Ω–æ–π –±–æ–ª–∏\n- 0 –±–∞–ª–ª–æ–≤: –ù–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–π –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏\n\n**–í—ã–≤–æ–¥:**\n```json\n{\n  \"need\": {\n    \"painPoints\": [\"–±–æ–ª—å 1\", \"–±–æ–ª—å 2\"],\n    \"severity\": \"critical\" | \"high\" | \"medium\" | \"low\",\n    \"description\": \"–æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ (20-40 —Å–ª–æ–≤)\",\n    \"confidence\": 0.0-1.0,\n    \"score\": 0-15,\n    \"reasoning\": \"–ø–æ—á–µ–º—É —Ç–∞–∫–æ–π score (30-50 —Å–ª–æ–≤)\"\n  }\n}\n```\n\n## Timeline (–°—Ä–æ—á–Ω–æ—Å—Ç—å) - 0-20 –±–∞–ª–ª–æ–≤\n\n**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:**\n- 20 –±–∞–ª–ª–æ–≤: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ/—Å–µ–≥–æ–¥–Ω—è/—Å—Ä–æ—á–Ω–æ\n- 17 –±–∞–ª–ª–æ–≤: –ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ\n- 14 –±–∞–ª–ª–æ–≤: –í —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞\n- 10 –±–∞–ª–ª–æ–≤: –í —ç—Ç–æ–º –∫–≤–∞—Ä—Ç–∞–ª–µ\n- 5 –±–∞–ª–ª–æ–≤: –í —Ç–µ—á–µ–Ω–∏–µ –≥–æ–¥–∞\n- 0 –±–∞–ª–ª–æ–≤: –ù–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–∞–º–æ–∫\n\n**–í—ã–≤–æ–¥:**\n```json\n{\n  \"timeline\": {\n    \"urgency\": \"immediate\" | \"this_week\" | \"this_month\" | \"this_quarter\" | \"later\",\n    \"deadline\": \"–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞\" | null,\n    \"description\": \"–æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ (20-40 —Å–ª–æ–≤)\",\n    \"confidence\": 0.0-1.0,\n    \"score\": 0-20,\n    \"reasoning\": \"–ø–æ—á–µ–º—É —Ç–∞–∫–æ–π score (30-50 —Å–ª–æ–≤)\"\n  }\n}\n```\n\n## –ò—Ç–æ–≥–æ–≤–∞—è BANT –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è\n\n```json\n{\n  \"bant\": {\n    \"budget\": { ... },\n    \"authority\": { ... },\n    \"need\": { ... },\n    \"timeline\": { ... },\n    \"totalScore\": —Å—É–º–º–∞ –≤—Å–µ—Ö score (0-70),\n    \"qualified\": true/false,\n    \"qualificationLevel\": \"SQL\" | \"MQL\" | \"cold\",\n    \"reasoning\": \"–æ–±—â–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ BANT (50-80 —Å–ª–æ–≤)\"\n  }\n}\n```\n\n**–£—Ä–æ–≤–Ω–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏:**\n- **SQL (Sales Qualified Lead):** totalScore ‚â•50 + –º–∏–Ω–∏–º—É–º 3 –∏–∑ 4 –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤\n- **MQL (Marketing Qualified Lead):** totalScore 30-49 + –º–∏–Ω–∏–º—É–º 2 –∏–∑ 4\n- **Cold:** totalScore <30\n\n---\n\n# –†–ê–ó–î–ï–õ 4: LEAD SCORING (100 –±–∞–ª–ª–æ–≤)\n\n## –§–∞–∫—Ç–æ—Ä 1: –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å (0-25 –±–∞–ª–ª–æ–≤)\n\n**–ù–∞ –æ—Å–Ω–æ–≤–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:**\n\n- 20-25: –û—á–µ–Ω—å –¥–æ–≤–æ–ª–µ–Ω, –ø–æ–∑–∏—Ç–∏–≤–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –≤—ã—Ä–∞–∂–∞–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å\n- 15-19: –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ-–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π\n- 10-14: –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π, –±–µ–∑ —è–≤–Ω—ã—Ö —ç–º–æ—Ü–∏–π\n- 5-9: –ï—Å—Ç—å –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ, –Ω–æ –∫–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –¥–∏–∞–ª–æ–≥–µ\n- 0-4: –Ø–≤–Ω–æ–µ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ, –∞–≥—Ä–µ—Å—Å–∏—è, –Ω–µ–≥–∞—Ç–∏–≤\n\n**–†–∞—Å—á–µ—Ç:** `(emotionalSatisfaction% / 100) * 25`\n\n## –§–∞–∫—Ç–æ—Ä 2: –ü–æ–ª–Ω–æ—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (0-20 –±–∞–ª–ª–æ–≤)\n\n**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**\n- –ü–æ–ª–Ω–æ–µ –∏–º—è: +4 –±–∞–ª–ª–∞\n- –§–∞–º–∏–ª–∏—è: +3 –±–∞–ª–ª–∞\n- –¢–µ–ª–µ—Ñ–æ–Ω (–≤–∞–ª–∏–¥–Ω—ã–π): +8 –±–∞–ª–ª–æ–≤\n- Email (–≤–∞–ª–∏–¥–Ω—ã–π): +4 –±–∞–ª–ª–∞\n- –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä (Telegram/WhatsApp): +1 –±–∞–ª–ª\n\n**–í–ê–ñ–ù–û:** –¢–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è!\n\n## –§–∞–∫—Ç–æ—Ä 3: –í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å (0-15 –±–∞–ª–ª–æ–≤)\n\n**–ö—Ä–∏—Ç–µ—Ä–∏–∏:**\n\n**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π:**\n- 50+ —Å–æ–æ–±—â–µ–Ω–∏–π: +5 –±–∞–ª–ª–æ–≤\n- 20-49: +4 –±–∞–ª–ª–∞\n- 10-19: +3 –±–∞–ª–ª–∞\n- 5-9: +2 –±–∞–ª–ª–∞\n- 1-4: +1 –±–∞–ª–ª\n\n**–ö–∞—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–∞:**\n- –ó–∞–¥–∞–µ—Ç —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã: +3 –±–∞–ª–ª–∞\n- –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–Ω–µ –æ–¥–Ω–æ—Å–ª–æ–∂–Ω—ã–µ): +3 –±–∞–ª–ª–∞\n- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –¥–∏–∞–ª–æ–≥—É –ø–æ—Å–ª–µ –ø–∞—É–∑—ã: +2 –±–∞–ª–ª–∞\n- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å >30 –º–∏–Ω—É—Ç: +2 –±–∞–ª–ª–∞\n\n## –§–∞–∫—Ç–æ—Ä 4: –ü–æ–∫—É–ø–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è (0-25 –±–∞–ª–ª–æ–≤)\n\n**–Ø–≤–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –≤—ã—Å–æ–∫–æ–≥–æ –Ω–∞–º–µ—Ä–µ–Ω–∏—è (20-25):**\n- \"–•–æ—á—É –∫—É–ø–∏—Ç—å\", \"–ì–æ—Ç–æ–≤ –æ–ø–ª–∞—Ç–∏—Ç—å\", \"–û—Ñ–æ—Ä–º–ª—è—é –∑–∞–∫–∞–∑\"\n- –í–æ–ø—Ä–æ—Å—ã –æ —Å–ø–æ—Å–æ–±–∞—Ö –æ–ø–ª–∞—Ç—ã, –¥–æ—Å—Ç–∞–≤–∫–µ, –≥–∞—Ä–∞–Ω—Ç–∏—è—Ö\n- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤/–ø—Ä–æ–¥—É–∫—Ç–æ–≤\n- –£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è\n\n**–°—Ä–µ–¥–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è (10-19):**\n- \"–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ\", \"–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é –≤–∞—Ä–∏–∞–Ω—Ç—ã\"\n- –í–æ–ø—Ä–æ—Å—ã –æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö\n- \"–ü–æ–¥—É–º–∞—é\", \"–ü–æ—Å–æ–≤–µ—Ç—É—é—Å—å\" - –Ω–æ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–º\n- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏\n\n**–ù–∏–∑–∫–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è (0-9):**\n- \"–ü—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä—é\", \"–ò–∑—É—á–∞—é —Ä—ã–Ω–æ–∫\"\n- –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏\n- –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±—é–¥–∂–µ—Ç–∞\n- –¢—Ä–æ–ª–ª–∏–Ω–≥ –∏–ª–∏ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ\n\n**–í–ê–ñ–ù–û:** –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–∞–∂–Ω–µ–µ —Å–ª–æ–≤! –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å \"–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ\", –Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã - —ç—Ç–æ –ø—Ä–∏–∑–Ω–∞–∫ —Å–∫—Ä—ã—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞.\n\n## –§–∞–∫—Ç–æ—Ä 5: –°—Ä–æ—á–Ω–æ—Å—Ç—å (0-15 –±–∞–ª–ª–æ–≤)\n\n**–í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã:**\n- 13-15: \"–°–µ–π—á–∞—Å\", \"–°–µ–≥–æ–¥–Ω—è\", \"–°—Ä–æ—á–Ω–æ –Ω—É–∂–Ω–æ\"\n- 10-12: \"–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ\", \"–í –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏\"\n- 6-9: \"–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ\", \"–ü–ª–∞–Ω–∏—Ä—É—é\"\n- 3-5: \"–ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ\", \"–í –±—É–¥—É—â–µ–º\"\n- 0-2: \"–ö–æ–≥–¥–∞-–Ω–∏–±—É–¥—å\", \"–ù–µ —Å–ø–µ—à—É\", —è–≤–Ω–æ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏\n\n---\n\n## –ò—Ç–æ–≥–æ–≤—ã–π Lead Scoring\n\n```json\n{\n  \"leadScoring\": {\n    \"score\": —á–∏—Å–ª–æ (0-100),\n    \"temperature\": \"hot\" | \"warm\" | \"cold\",\n    \"factors\": {\n      \"satisfaction\": 0-25,\n      \"contacts\": 0-20,\n      \"engagement\": 0-15,\n      \"intentions\": 0-25,\n      \"urgency\": 0-15\n    },\n    \"breakdown\": {\n      \"satisfaction_detail\": \"–æ–ø–∏—Å–∞–Ω–∏–µ (30-50 —Å–ª–æ–≤)\",\n      \"contacts_detail\": \"—á—Ç–æ –µ—Å—Ç—å, —á–µ–≥–æ –Ω–µ—Ç (30-50 —Å–ª–æ–≤)\",\n      \"engagement_detail\": \"–º–µ—Ç—Ä–∏–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ (30-50 —Å–ª–æ–≤)\",\n      \"intentions_detail\": \"—Å–∏–≥–Ω–∞–ª—ã –Ω–∞–º–µ—Ä–µ–Ω–∏–π (30-50 —Å–ª–æ–≤)\",\n      \"urgency_detail\": \"–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ (30-50 —Å–ª–æ–≤)\"\n    },\n    \"recommendation\": \"—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ä–∞–±–æ—Ç–µ —Å –ª–∏–¥–æ–º (60-100 —Å–ª–æ–≤)\"\n  }\n}\n```\n\n**–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:**\n- **hot:** 70-100 –±–∞–ª–ª–æ–≤ - –≥–æ—Ç–æ–≤ –∫ –ø–æ–∫—É–ø–∫–µ, –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ\n- **warm:** 50-69 –±–∞–ª–ª–æ–≤ - –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω, —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑–≤–∏—Ç–∏—è\n- **cold:** 0-49 –±–∞–ª–ª–æ–≤ - –Ω–∏–∑–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª, –Ω—É–∂–µ–Ω –ø—Ä–æ–≥—Ä–µ–≤\n\n---\n\n# –†–ê–ó–î–ï–õ 5: –°–¢–ê–¢–ò–°–¢–ò–ö–ê\n\n```json\n{\n  \"statistics\": {\n    \"totalDialogs\": —á–∏—Å–ª–æ,\n    \"totalMessages\": —á–∏—Å–ª–æ,\n    \"avgSatisfaction\": —á–∏—Å–ª–æ,\n    \"resolvedPercentage\": —á–∏—Å–ª–æ,\n    \"avgEngagement\": —á–∏—Å–ª–æ\n  }\n}\n```\n\n---\n\n# –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê JSON\n\n**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ –¢–û–õ–¨–ö–û —á–∏—Å—Ç—ã–π JSON –±–µ–∑ markdown, —Ç—Ä–æ–π–Ω—ã—Ö –∫–∞–≤—ã—á–µ–∫ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!\n\n```json\n{\n  \"emotionalTone\": {\n    \"overall\": \"positive\" | \"negative\" | \"neutral\",\n    \"overallText\": \"–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (15-30 —Å–ª–æ–≤)\",\n    \"satisfaction\": 0-100,\n    \"description\": \"–¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (80-120 —Å–ª–æ–≤)\",\n    \"keyMoments\": [\n      {\n        \"moment\": \"–æ–ø–∏—Å–∞–Ω–∏–µ (25-40 —Å–ª–æ–≤)\",\n        \"emotion\": \"—ç–º–æ—Ü–∏—è\",\n        \"impact\": \"–≤–ª–∏—è–Ω–∏–µ (20-30 —Å–ª–æ–≤)\"\n      }\n      // 2-3 –º–æ–º–µ–Ω—Ç–∞\n    ]\n  },\n  \"customerNeeds\": [\n    \"–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å 1 (25-40 —Å–ª–æ–≤)\",\n    \"–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å 2 (25-40 —Å–ª–æ–≤)\",\n    // 3-5 –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π\n  ],\n  \"missedOpportunities\": [\n    \"–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å 1 (30-50 —Å–ª–æ–≤)\",\n    \"–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å 2 (30-50 —Å–ª–æ–≤)\",\n    // 3-4 –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n  ],\n  \"recommendations\": [\n    \"—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1 (40-70 —Å–ª–æ–≤)\",\n    \"—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2 (40-70 —Å–ª–æ–≤)\",\n    // 3-4 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n  ],\n  \"entities\": {\n    \"person\": { ... },\n    \"contacts\": { ... },\n    \"organization\": { ... },\n    \"location\": { ... },\n    \"products\": [ ... ],\n    \"competitors\": [ ... ],\n    \"currentSolution\": { ... },\n    \"financials\": {\n      \"budget\": { ... },\n      \"timeline\": { ... }\n    }\n  },\n  \"bant\": {\n    \"budget\": {\n      \"mentioned\": true/false,\n      \"value\": —á–∏—Å–ª–æ | null,\n      \"currency\": \"USD\" | \"RUB\" | null,\n      \"range\": {\"min\": —á–∏—Å–ª–æ, \"max\": —á–∏—Å–ª–æ} | null,\n      \"description\": \"—Ç–µ–∫—Å—Ç (20-40 —Å–ª–æ–≤)\",\n      \"confidence\": 0.0-1.0,\n      \"score\": 0-15,\n      \"reasoning\": \"—Ç–µ–∫—Å—Ç (30-50 —Å–ª–æ–≤)\"\n    },\n    \"authority\": {\n      \"role\": \"decision_maker\" | \"influencer\" | \"user\" | \"unknown\",\n      \"level\": \"c_level\" | \"manager\" | \"specialist\" | \"unknown\",\n      \"position\": \"–¥–æ–ª–∂–Ω–æ—Å—Ç—å\" | null,\n      \"description\": \"—Ç–µ–∫—Å—Ç (20-40 —Å–ª–æ–≤)\",\n      \"confidence\": 0.0-1.0,\n      \"score\": 0-20,\n      \"reasoning\": \"—Ç–µ–∫—Å—Ç (30-50 —Å–ª–æ–≤)\"\n    },\n    \"need\": {\n      \"painPoints\": [\"–±–æ–ª—å 1\", \"–±–æ–ª—å 2\"],\n      \"severity\": \"critical\" | \"high\" | \"medium\" | \"low\",\n      \"description\": \"—Ç–µ–∫—Å—Ç (20-40 —Å–ª–æ–≤)\",\n      \"confidence\": 0.0-1.0,\n      \"score\": 0-15,\n      \"reasoning\": \"—Ç–µ–∫—Å—Ç (30-50 —Å–ª–æ–≤)\"\n    },\n    \"timeline\": {\n      \"urgency\": \"immediate\" | \"this_week\" | \"this_month\" | \"this_quarter\" | \"later\",\n      \"deadline\": \"–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞\" | null,\n      \"description\": \"—Ç–µ–∫—Å—Ç (20-40 —Å–ª–æ–≤)\",\n      \"confidence\": 0.0-1.0,\n      \"score\": 0-20,\n      \"reasoning\": \"—Ç–µ–∫—Å—Ç (30-50 —Å–ª–æ–≤)\"\n    },\n    \"totalScore\": —Å—É–º–º–∞ –≤—Å–µ—Ö score (0-70),\n    \"qualified\": true/false,\n    \"qualificationLevel\": \"SQL\" | \"MQL\" | \"cold\",\n    \"reasoning\": \"–æ–±—â–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ (50-80 —Å–ª–æ–≤)\"\n  },\n  \"leadScoring\": {\n    \"score\": —á–∏—Å–ª–æ (0-100),\n    \"temperature\": \"hot\" | \"warm\" | \"cold\",\n    \"factors\": {\n      \"satisfaction\": 0-25,\n      \"contacts\": 0-20,\n      \"engagement\": 0-15,\n      \"intentions\": 0-25,\n      \"urgency\": 0-15\n    },\n    \"breakdown\": {\n      \"satisfaction_detail\": \"–æ–ø–∏—Å–∞–Ω–∏–µ (30-50 —Å–ª–æ–≤)\",\n      \"contacts_detail\": \"—á—Ç–æ –µ—Å—Ç—å, —á–µ–≥–æ –Ω–µ—Ç (30-50 —Å–ª–æ–≤)\",\n      \"engagement_detail\": \"–º–µ—Ç—Ä–∏–∫–∏ (30-50 —Å–ª–æ–≤)\",\n      \"intentions_detail\": \"—Å–∏–≥–Ω–∞–ª—ã (30-50 —Å–ª–æ–≤)\",\n      \"urgency_detail\": \"–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ (30-50 —Å–ª–æ–≤)\"\n    },\n    \"recommendation\": \"—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (60-100 —Å–ª–æ–≤)\"\n  },\n  \"statistics\": {\n    \"totalDialogs\": —á–∏—Å–ª–æ,\n    \"totalMessages\": —á–∏—Å–ª–æ,\n    \"avgSatisfaction\": —á–∏—Å–ª–æ,\n    \"resolvedPercentage\": —á–∏—Å–ª–æ,\n    \"avgEngagement\": —á–∏—Å–ª–æ\n  }\n}\n```\n\n---\n\n# –í–ê–ñ–ù–´–ï –ù–Æ–ê–ù–°–´\n\n1. **–ë–∞–ª–∞–Ω—Å –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç–∏:** –ê–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º, –Ω–æ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º - –º–∞–∫—Å–∏–º—É–º —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ä–∞–∑—É–º–Ω–æ–º –æ–±—ä–µ–º–µ\n\n2. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–∞–∂–Ω–µ–µ —Å–ª–æ–≤:** –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã (–∞–≥—Ä–µ—Å—Å–∏—è, —Å–∫–µ–ø—Å–∏—Å) —á–∞—Å—Ç–æ —Å–∫—Ä—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å\n\n3. **–ö–∞—á–µ—Å—Ç–≤–æ > –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:** 3 –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ —Ü–µ–Ω–Ω–µ–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π —Ç—Ä–æ–ª–ª–∏–Ω–≥–∞\n\n4. **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏:**\n   - –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–¥—É–∫—Ç–æ–º + –ø–æ–∏—Å–∫ —Ä–µ—à–µ–Ω–∏—è = –º–æ–∂–µ—Ç –±—ã—Ç—å hot lead –¥–∞–∂–µ –ø—Ä–∏ –Ω–µ–≥–∞—Ç–∏–≤–µ\n   - B2B –∫–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –Ω–µ –ø—Ä–æ—è–≤–ª—è—Ç—å —ç–º–æ—Ü–∏–π, –Ω–æ –∏–º–µ—Ç—å –≤—ã—Å–æ–∫–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è\n   - –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –ø–æ–≤—ã—à–∞–µ—Ç score\n\n5. **–ö—É–ª—å—Ç—É—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:** –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ—Å—Ç—å –∏–ª–∏ —Å–¥–µ—Ä–∂–∞–Ω–Ω–æ—Å—Ç—å –º–æ–≥—É—Ç –±—ã—Ç—å –∫—É–ª—å—Ç—É—Ä–Ω—ã–º–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏\n\n6. **–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç:** –£–∫–∞–∑—ã–≤–∞–π—Ç–µ null, confidence: 0, reason: \"not_mentioned\"\n\n7. **–û–ü–¢–ò–ú–ê–õ–¨–ù–´–ï –û–ë–™–ï–ú–´ –¢–ï–ö–°–¢–ê:**\n   - emotionalTone.description: 80-120 —Å–ª–æ–≤\n   - keyMoments: 2-3 –º–æ–º–µ–Ω—Ç–∞ –ø–æ 25-40 —Å–ª–æ–≤\n   - customerNeeds: 3-5 –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –ø–æ 25-40 —Å–ª–æ–≤\n   - missedOpportunities: 3-4 –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ 30-50 —Å–ª–æ–≤\n   - recommendations: 3-4 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ 40-70 —Å–ª–æ–≤\n   - –í—Å–µ reasoning –≤ BANT: 30-50 —Å–ª–æ–≤\n   - –í—Å–µ detail –≤ leadScoring.breakdown: 30-50 —Å–ª–æ–≤\n   - leadScoring.recommendation: 60-100 —Å–ª–æ–≤\n\n---\n\n# CONFIDENCE THRESHOLDS\n\n- **‚â•0.95:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ\n- **0.85-0.94:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å —Ñ–ª–∞–≥–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏\n- **<0.85:** –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -784,
        -224
      ],
      "id": "c45b3c2e-ab5b-4d22-bd14-6c19d1b0d213",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI Agent\nconst aiResponse = items[0].json.output || items[0].json.response || items[0].json;\nconst formatDialogsData = $('Format Dialogs').first().json;\nconst checkData = $('Merge Check Data').first().json;\n\nlet analysis;\ntry {\n    if (typeof aiResponse === 'string') {\n        let cleanJson = aiResponse.trim();\n        \n        // –£–±–∏—Ä–∞–µ–º markdown\n        if (cleanJson.startsWith('```json')) cleanJson = cleanJson.substring(7);\n        else if (cleanJson.startsWith('```')) cleanJson = cleanJson.substring(3);\n        if (cleanJson.endsWith('```')) cleanJson = cleanJson.substring(0, cleanJson.length - 3);\n        cleanJson = cleanJson.trim();\n        \n        // –ü–æ–ø—ã—Ç–∫–∞ 1: –ø—Ä—è–º–æ–π –ø–∞—Ä—Å–∏–Ω–≥\n        try {\n            analysis = JSON.parse(cleanJson);\n        } catch (e1) {\n            // –ü–æ–ø—ã—Ç–∫–∞ 2: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ JSON\n            try {\n                const firstBrace = cleanJson.indexOf('{');\n                const lastBrace = cleanJson.lastIndexOf('}');\n                if (firstBrace !== -1 && lastBrace > firstBrace) {\n                    analysis = JSON.parse(cleanJson.substring(firstBrace, lastBrace + 1));\n                } else throw e1;\n            } catch (e2) {\n                // –ü–æ–ø—ã—Ç–∫–∞ 3: –æ–±—Ä–∞–±–æ—Ç–∫–∞ escape\n                let fixedJson = cleanJson;\n                if (fixedJson.startsWith('\"') && fixedJson.endsWith('\"')) fixedJson = fixedJson.slice(1, -1);\n                fixedJson = fixedJson.replace(/\\\\\\\\n/g, '\\\\n').replace(/\\\\\\\\t/g, '\\\\t');\n                const fb = fixedJson.indexOf('{');\n                const lb = fixedJson.lastIndexOf('}');\n                if (fb !== -1 && lb > fb) fixedJson = fixedJson.substring(fb, lb + 1);\n                analysis = JSON.parse(fixedJson);\n            }\n        }\n    } else if (typeof aiResponse === 'object') {\n        analysis = aiResponse;\n    } else {\n        throw new Error('Unexpected response type');\n    }\n    \n    // –í–∞–ª–∏–¥–∞—Ü–∏—è entities\n    if (!analysis.entities) {\n        analysis.entities = {\n            person: { firstName: null, lastName: null, fullName: null, confidence: 0 },\n            contacts: { phone: { value: null, confidence: 0, valid: false }, email: { value: null, confidence: 0, valid: false }, telegram: { value: null, confidence: 0 }, whatsapp: { value: null, confidence: 0 } },\n            organization: { companyName: null, position: null, confidence: 0 },\n            location: { city: null, country: null, confidence: 0 },\n            products: [], competitors: [],\n            currentSolution: { solution: null, problems: [], confidence: 0 },\n            financials: { budget: { amount: null, currency: null, confidence: 0 }, timeline: { timeline: null, deadline: null, confidence: 0 } }\n        };\n    }\n    \n    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤\n    if (analysis.entities.contacts) {\n        if (analysis.entities.contacts.email?.value) {\n            analysis.entities.contacts.email.valid = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(analysis.entities.contacts.email.value);\n        }\n        if (analysis.entities.contacts.phone?.value) {\n            analysis.entities.contacts.phone.valid = /^\\+?[1-9]\\d{1,14}$/.test(analysis.entities.contacts.phone.value);\n        }\n    }\n    \n    // –í–∞–ª–∏–¥–∞—Ü–∏—è BANT\n    if (!analysis.bant) {\n        analysis.bant = {\n            budget: { mentioned: false, score: 0, confidence: 0, description: \"–ù–µ —É–ø–æ–º—è–Ω—É—Ç\" },\n            authority: { role: \"unknown\", level: \"unknown\", score: 0, confidence: 0, description: \"–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω\" },\n            need: { painPoints: [], severity: \"low\", score: 0, confidence: 0, description: \"–ù–µ –≤—ã—è–≤–ª–µ–Ω—ã\" },\n            timeline: { urgency: \"later\", score: 0, confidence: 0, description: \"–ù–µ —É–∫–∞–∑–∞–Ω\" },\n            totalScore: 0, qualified: false, qualificationLevel: \"cold\", reasoning: \"BANT –∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –ò–ò\"\n        };\n    } else {\n        analysis.bant.totalScore = (analysis.bant.budget?.score || 0) + (analysis.bant.authority?.score || 0) + (analysis.bant.need?.score || 0) + (analysis.bant.timeline?.score || 0);\n        const bantCount = [analysis.bant.budget?.score > 0, analysis.bant.authority?.score > 0, analysis.bant.need?.score > 0, analysis.bant.timeline?.score > 0].filter(Boolean).length;\n        if (analysis.bant.totalScore >= 50 && bantCount >= 3) { analysis.bant.qualified = true; analysis.bant.qualificationLevel = \"SQL\"; }\n        else if (analysis.bant.totalScore >= 30 && bantCount >= 2) { analysis.bant.qualified = true; analysis.bant.qualificationLevel = \"MQL\"; }\n        else { analysis.bant.qualified = false; analysis.bant.qualificationLevel = \"cold\"; }\n    }\n    \n    // –í–∞–ª–∏–¥–∞—Ü–∏—è Lead Scoring\n    if (!analysis.leadScoring) {\n        const satisfaction = analysis.emotionalTone?.satisfaction || 0;\n        const baseScore = Math.round(satisfaction * 0.5);\n        analysis.leadScoring = {\n            score: baseScore, temperature: baseScore >= 80 ? \"hot\" : baseScore >= 50 ? \"warm\" : \"cold\",\n            factors: { satisfaction: 0, contacts: 0, engagement: 0, intentions: 0, urgency: 0 },\n            breakdown: { satisfaction_detail: \"–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω\", contacts_detail: \"–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω\", engagement_detail: \"–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω\", intentions_detail: \"–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω\", urgency_detail: \"–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω\" },\n            recommendation: \"Lead Scoring –Ω–µ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω –ò–ò.\"\n        };\n    } else {\n        analysis.leadScoring.score = (analysis.leadScoring.factors?.satisfaction || 0) + (analysis.leadScoring.factors?.contacts || 0) + (analysis.leadScoring.factors?.engagement || 0) + (analysis.leadScoring.factors?.intentions || 0) + (analysis.leadScoring.factors?.urgency || 0);\n        analysis.leadScoring.temperature = analysis.leadScoring.score >= 80 ? \"hot\" : analysis.leadScoring.score >= 50 ? \"warm\" : \"cold\";\n    }\n    \n    // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π\n    if (!analysis.emotionalTone) analysis.emotionalTone = { overall: \"neutral\", overallText: \"–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω\", satisfaction: 0, description: \"–ê–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω\", keyMoments: [] };\n    analysis.customerNeeds = analysis.customerNeeds || [];\n    analysis.missedOpportunities = analysis.missedOpportunities || [];\n    analysis.recommendations = analysis.recommendations || [];\n    if (!analysis.statistics) analysis.statistics = { totalDialogs: formatDialogsData?.totalDialogs || 1, totalMessages: 0, avgSatisfaction: analysis.emotionalTone?.satisfaction || 0, resolvedPercentage: 0, avgEngagement: 0 };\n    \n    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n    analysis._cached = false;\n    analysis._newMessagesCount = checkData?.new_messages_count || 0;\n    analysis._lastAnalysisDate = checkData?.last_analysis_date || null;\n    \n} catch (error) {\n    analysis = {\n        entities: { person: { firstName: null, lastName: null, fullName: null, confidence: 0 }, contacts: { phone: { value: null, confidence: 0, valid: false }, email: { value: null, confidence: 0, valid: false }, telegram: { value: null, confidence: 0 }, whatsapp: { value: null, confidence: 0 } }, organization: { companyName: null, position: null, confidence: 0 }, location: { city: null, country: null, confidence: 0 }, products: [], competitors: [], currentSolution: { solution: null, problems: [], confidence: 0 }, financials: { budget: { amount: null, currency: null, confidence: 0 }, timeline: { timeline: null, deadline: null, confidence: 0 } } },\n        bant: { budget: { mentioned: false, score: 0, confidence: 0, description: \"–û—à–∏–±–∫–∞\" }, authority: { role: \"unknown\", level: \"unknown\", score: 0, confidence: 0, description: \"–û—à–∏–±–∫–∞\" }, need: { painPoints: [], severity: \"low\", score: 0, confidence: 0, description: \"–û—à–∏–±–∫–∞\" }, timeline: { urgency: \"later\", score: 0, confidence: 0, description: \"–û—à–∏–±–∫–∞\" }, totalScore: 0, qualified: false, qualificationLevel: \"cold\", reasoning: \"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞\" },\n        emotionalTone: { overall: \"neutral\", overallText: \"–û—à–∏–±–∫–∞\", satisfaction: 0, description: \"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞\" },\n        customerNeeds: [\"–û—à–∏–±–∫–∞\"], missedOpportunities: [\"–û—à–∏–±–∫–∞\"], recommendations: [\"–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∞–Ω–∞–ª–∏–∑\"],\n        statistics: { totalDialogs: formatDialogsData?.totalDialogs || 0, totalMessages: 0, avgSatisfaction: 0, resolvedPercentage: 0, avgEngagement: 0 },\n        leadScoring: { score: 0, temperature: \"cold\", factors: { satisfaction: 0, contacts: 0, engagement: 0, intentions: 0, urgency: 0 }, breakdown: { satisfaction_detail: \"–û—à–∏–±–∫–∞\", contacts_detail: \"–û—à–∏–±–∫–∞\", engagement_detail: \"–û—à–∏–±–∫–∞\", intentions_detail: \"–û—à–∏–±–∫–∞\", urgency_detail: \"–û—à–∏–±–∫–∞\" }, recommendation: \"–û—à–∏–±–∫–∞\" },\n        _cached: false, _newMessagesCount: checkData?.new_messages_count || 0\n    };\n}\n\nreturn [{json: analysis}];"
      },
      "id": "8dbc7492-e0e3-45d9-a18c-d9e3ec6bad53",
      "name": "Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        -224
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "95e8814a-6cce-49e5-aa29-7903d10927be",
      "name": "Send Analysis",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -160,
        -304
      ]
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        -608,
        -32
      ],
      "id": "6b82140b-7439-4d21-a7ca-10b59e7af3c7",
      "name": "Think"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO dialog_analysis (\n    session_id, \n    user_name, \n    analysis_type, \n    language, \n    platform,\n    \n    -- JSONB –ø–æ–ª—è\n    extracted_entities,\n    bant_qualification,\n    emotional_tone, \n    lead_scoring,\n    statistics,\n    \n    -- Array –ø–æ–ª—è\n    customer_needs, \n    missed_opportunities, \n    recommendations,\n    \n    -- –ß–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è\n    satisfaction_percentage,\n    \n    -- Timestamps\n    created_at\n) VALUES (\n    '{{ $json.session_id }}', \n    '{{ $json.user_name }}', \n    '{{ $json.analysis_type }}',\n    '{{ $json.language }}', \n    '{{ $json.platform }}',\n    \n    -- JSONB –ø–æ–ª—è (—Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–≤—ã—á–µ–∫)\n    '{{ JSON.stringify($json.extracted_entities).replace(/'/g, \"''\") }}'::jsonb,\n    '{{ JSON.stringify($json.bant_qualification).replace(/'/g, \"''\") }}'::jsonb,\n    '{{ JSON.stringify($json.emotional_tone).replace(/'/g, \"''\") }}'::jsonb,\n    '{{ JSON.stringify($json.lead_scoring).replace(/'/g, \"''\") }}'::jsonb,\n    '{{ JSON.stringify($json.statistics).replace(/'/g, \"''\") }}'::jsonb,\n    \n    -- Array –ø–æ–ª—è\n    ARRAY[{{ $json.customer_needs.map(item => `'${String(item).replace(/'/g, \"''\")}'`).join(\", \") }}]::text[],\n    ARRAY[{{ $json.missed_opportunities.map(item => `'${String(item).replace(/'/g, \"''\")}'`).join(\", \") }}]::text[],\n    ARRAY[{{ $json.recommendations.map(item => `'${String(item).replace(/'/g, \"''\")}'`).join(\", \") }}]::text[],\n    \n    -- –ß–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è\n    {{ $json.satisfaction_percentage || 0 }},\n    \n    CURRENT_TIMESTAMP\n)\nON CONFLICT (session_id, analysis_type) \nDO UPDATE SET\n    user_name = EXCLUDED.user_name,\n    language = EXCLUDED.language,\n    platform = EXCLUDED.platform,\n    extracted_entities = EXCLUDED.extracted_entities,\n    bant_qualification = EXCLUDED.bant_qualification,\n    emotional_tone = EXCLUDED.emotional_tone,\n    lead_scoring = EXCLUDED.lead_scoring,\n    statistics = EXCLUDED.statistics,\n    customer_needs = EXCLUDED.customer_needs,\n    missed_opportunities = EXCLUDED.missed_opportunities,\n    recommendations = EXCLUDED.recommendations,\n    satisfaction_percentage = EXCLUDED.satisfaction_percentage,\n    created_at = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        256,
        -80
      ],
      "id": "e1c41e7f-d5dc-4a2d-9208-dcc930c7b00a",
      "name": "Save to Database",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• –î–õ–Ø –ó–ê–ü–ò–°–ò –í –ë–î\n// ============================================\n\nconst analysis = items[0].json;\nconst requestData = $('Process Request').first().json;\n\n// –ü–æ–ª—É—á–∞–µ–º platform –∏–∑ sessionData –µ—Å–ª–∏ –µ—Å—Ç—å\nlet platform = 'webchat';\ntry {\n  // –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –¥—Ä—É–≥–æ–≥–æ —É–∑–ª–∞ –µ—Å–ª–∏ –µ—Å—Ç—å\n  platform = requestData.platform || 'webchat';\n} catch (e) {\n  console.log('Platform not found, using default: webchat');\n}\n\n// –í—ã—á–∏—Å–ª—è–µ–º satisfaction_percentage –∏–∑ emotionalTone\nconst satisfactionPercentage = analysis.emotionalTone?.satisfaction || 0;\n\nconsole.log('‚úÖ Preparing data for DB:', {\n  sessionId: requestData.sessionId,\n  hasEntities: !!analysis.entities,\n  hasBant: !!analysis.bant,\n  hasLeadScoring: !!analysis.leadScoring,\n  satisfactionPercentage: satisfactionPercentage\n});\n\nreturn [{\n  json: {\n    session_id: requestData.sessionId,\n    user_name: requestData.userName || 'Guest',\n    analysis_type: requestData.type,\n    language: requestData.language || 'ru',\n    platform: platform,\n    \n    // JSON/JSONB –ø–æ–ª—è\n    extracted_entities: analysis.entities || {},\n    bant_qualification: analysis.bant || {},\n    emotional_tone: analysis.emotionalTone || {},\n    lead_scoring: analysis.leadScoring || {},\n    statistics: analysis.statistics || {},\n    \n    // Array –ø–æ–ª—è\n    customer_needs: analysis.customerNeeds || [],\n    missed_opportunities: analysis.missedOpportunities || [],\n    recommendations: analysis.recommendations || [],\n    \n    // –ß–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ\n    satisfaction_percentage: satisfactionPercentage\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        -80
      ],
      "id": "15d00d11-21a0-4824-83a5-04359fe1c50e",
      "name": "Prepare DB Data"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "analyze-dialog",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "2e8168b9-dba6-49a0-8197-889e57f0d38d",
      "name": "Analysis Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3072,
        0
      ],
      "webhookId": "analyze-dialog-webhook"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -928,
        -16
      ],
      "id": "b1c7b2d3-ed98-49f7-a12a-e379a932e7c7",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: API KEY + RATE LIMITING\n// ============================================\n\n// –ù–ê–°–¢–†–û–ô–ö–ò (–∏–∑–º–µ–Ω–∏ –ø–æ–¥ —Å–µ–±—è)\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 60;\n\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2912,
        0
      ],
      "id": "268ba6a1-c96b-4399-88cd-0f126f431209",
      "name": "Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2752,
        0
      ],
      "id": "b11609fe-b3a1-4664-9e24-2fe9fa5cb309",
      "name": "Auth Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2544,
        128
      ],
      "id": "879f2d2c-3ab0-4f3b-a1eb-56013ef516bd",
      "name": "Error Response"
    }
  ],
  "pinData": {},
  "connections": {
    "Process Request": {
      "main": [
        [
          {
            "node": "Get Analysis Language Setting",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Analysis Language Setting": {
      "main": [
        [
          {
            "node": "Merge with Language",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge with Language": {
      "main": [
        [
          {
            "node": "Check for New Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for New Messages": {
      "main": [
        [
          {
            "node": "Merge Check Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Check Data": {
      "main": [
        [
          {
            "node": "IF: Has New Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Has New Messages": {
      "main": [
        [
          {
            "node": "Check Type",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Existing Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Existing Analysis": {
      "main": [
        [
          {
            "node": "Format Existing Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Existing Analysis": {
      "main": [
        [
          {
            "node": "Return Existing Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Type": {
      "main": [
        [
          {
            "node": "Get Single Dialog",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get All/Language Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Single Dialog": {
      "main": [
        [
          {
            "node": "Format Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All/Language Dialogs": {
      "main": [
        [
          {
            "node": "Format Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Dialogs": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "Send Analysis",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare DB Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Prepare DB Data": {
      "main": [
        [
          {
            "node": "Save to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analysis Webhook": {
      "main": [
        [
          {
            "node": "Security Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Security Check": {
      "main": [
        [
          {
            "node": "Auth Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Check": {
      "main": [
        [
          {
            "node": "Process Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "db77e16c-7c7e-430b-beca-36d58e7a313f",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "VXmtH8LJN4qflFWp",
  "tags": []
}