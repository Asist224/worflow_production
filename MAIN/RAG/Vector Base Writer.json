{
  "name": "Vector Base Writer",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "write-vector-base",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "e5711bae-640b-4d29-a762-37ed9fd3569f",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1824,
        944
      ],
      "webhookId": "23185d3e-8d97-4d02-a46c-6fbfb27ee70e"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.mode }}",
                    "rightValue": "replace",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a8fc5f12-73e3-4e7f-8b4a-e9595fc1855a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "replace"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.mode }}",
                    "rightValue": "append",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7c3dc21c-edcd-40a1-90eb-d4b4100ea390"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "append"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.mode }}",
                    "rightValue": "edit",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "b3fc5f12-73e3-4e7f-8b4a-e9595fc1855b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "edit"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "8f3d74c6-3700-48f2-8e84-7ae36d86f983",
                    "leftValue": "={{ $json.body.mode }}",
                    "rightValue": "delete",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "delete"
            }
          ]
        },
        "options": {}
      },
      "id": "cd91b7dd-7a69-4def-b9c3-fb0200ce1c78",
      "name": "Switch Mode",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -1120,
        896
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ file_id Ð¸Ð· Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹\nWITH file_ids AS (\n  SELECT DISTINCT metadata->>'file_id' as file_id \n  FROM {{ $json.body.table }}\n  WHERE metadata->>'file_id' IS NOT NULL\n),\n-- Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†\nrows_delete AS (\n  DELETE FROM document_rows \n  WHERE dataset_id IN (SELECT file_id FROM file_ids)\n  RETURNING 1\n),\n-- Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†\nmetadata_delete AS (\n  DELETE FROM document_metadata \n  WHERE id IN (SELECT file_id FROM file_ids)\n  RETURNING 1\n)\n-- Ð¢ÐµÐ¿ÐµÑ€ÑŒ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¸Ð· Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹\nDELETE FROM {{ $json.body.table }}\nRETURNING 'Table cleared successfully' as status",
        "options": {}
      },
      "id": "a21941b1-7400-4c16-bd6e-2fbdfee98649",
      "name": "Clear Table",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -976,
        656
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {},
      "id": "2cacefc4-f169-405d-8be4-5bb1905671a9",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -592,
        720
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ\nWITH table_check AS (\n  SELECT metadata->>'file_id' as file_id \n  FROM {{ $json.body.table }}\n  WHERE id = {{ $json.body.editId }}\n  LIMIT 1\n),\n-- Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¸Ð· document_rows ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ file_id\nrows_delete AS (\n  DELETE FROM document_rows \n  WHERE dataset_id IN (SELECT file_id FROM table_check WHERE file_id IS NOT NULL)\n  RETURNING dataset_id\n),\n-- Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¸Ð· document_metadata\nmetadata_delete AS (\n  DELETE FROM document_metadata \n  WHERE id IN (SELECT file_id FROM table_check WHERE file_id IS NOT NULL)\n  RETURNING id\n)\n-- Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ\nDELETE FROM {{ $json.body.table }}\nWHERE id = {{ $json.body.editId }}\nRETURNING id, \n  CASE \n    WHEN EXISTS (SELECT 1 FROM rows_delete) \n    THEN 'Deleted with table data' \n    ELSE 'Deleted single record' \n  END as deletion_type",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        96,
        576
      ],
      "id": "6e7f1574-6998-40b5-8d15-5afd858a7809",
      "name": "Delete Record",
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ÑÐ»Ðµ Switch Mode\nconst inputData = $input.first().json;\nconst body = inputData.body || inputData;\n\nif (!body) {\n  return [{\n    json: {\n      error: \"No data received\",\n      body: {},\n      content: \"\",\n      hasFiles: \"false\",\n      hasUrls: \"false\",\n      filesCount: 0,\n      keepFull: \"false\"\n    }\n  }];\n}\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²\nconst hasFilesRaw = body.hasFiles === true || \n                    body.hasFiles === 'true' || \n                    (body.files && body.files.length > 0) || \n                    (body.combinedFiles && body.combinedFiles.length > 0) || \n                    false;\n\n// ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð¾Ð´Ð¸Ð½ Ð¼Ð°ÑÑÐ¸Ð²\nconst files = [...(body.files || []), ...(body.combinedFiles || [])];\n\n// Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚\nlet content = body.content || body.textContent || \"\";\n\n// ðŸ†• ÐÐžÐ’ÐžÐ•: ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ [FULL]\nconst fullBlockPattern = /\\[FULL\\]/gi;\nconst hasFullCommand = fullBlockPattern.test(content);\n\n// Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° (Ð¾Ð½Ð° Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð¿Ð¾Ð¿Ð°ÑÑ‚ÑŒ Ð² Ð±Ð°Ð·Ñƒ)\nif (hasFullCommand) {\n  content = content.replace(fullBlockPattern, '').trim();\n}\n\n// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° URL Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°\nconst urlPattern = /https?:\\/\\/(www\\.)?[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*)/gi;\nconst urls = content.match(urlPattern) || [];\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ URL Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ðµ\nconst hasUrlsRaw = urls.length > 0 && (\n  content.trim().startsWith('http') || \n  content.trim().startsWith('Ð¡Ð¡Ð«Ð›ÐšÐ˜ Ð”Ð›Ð¯ ÐÐÐÐ›Ð˜Ð—Ð') ||\n  content.trim().startsWith('URL') ||\n  (urls.length > 0 && content.trim().replace(urlPattern, '').trim().length < 50)\n);\n\nconst isUrlOnlyMode = hasUrlsRaw;\n\n// ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð²ÑÐµ boolean Ð² ÑÑ‚Ñ€Ð¾ÐºÐ¸\nconst hasFiles = String(hasFilesRaw);\nconst hasUrls = String(hasUrlsRaw);\nconst keepFull = String(hasFullCommand);  // ðŸ†• ÐÐžÐ’Ð«Ð™ Ð¤Ð›ÐÐ“\n\nreturn [{\n  json: {\n    body: {\n      ...body,\n      hasFiles: hasFiles,\n      hasUrls: hasUrls,\n      urls: urls,\n      files: files,\n      filesCount: files.length,\n      content: content,  // ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑƒÐ¶Ðµ Ð±ÐµÐ· ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ [FULL]\n      textContent: content,\n      isUrlOnlyMode: String(isUrlOnlyMode),\n      keepFull: keepFull  // ðŸ†• Ð¤Ð›ÐÐ“ Ð´Ð»Ñ AI Agent\n    },\n    table: body.table || 'knowledge_base',\n    mode: body.mode || 'append',\n    editId: body.editId || null,\n    content: content,\n    hasFiles: hasFiles,\n    hasUrls: hasUrls,\n    urls: urls,\n    filesCount: files.length,\n    keepFull: keepFull,  // ðŸ†• ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð´Ð°Ð»ÑŒÑˆÐµ\n    dataSource: inputData.body ? 'webhook' : 'processed'\n  }\n}];"
      },
      "id": "762934f2-bcdd-48f1-b239-43edbf7da543",
      "name": "Prepare Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -560,
        960
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.body.hasFiles === \"true\" || $json.body.hasUrls === \"true\" }}",
              "rightValue": "=true",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "id": "d3b3de1f-16de-4195-9353-a323859877f9"
            }
          ],
          "combinator": "or"
        },
        "options": {
          "looseTypeValidation": true
        }
      },
      "id": "e8401816-2a7f-43ec-9985-3c87ba35f2da",
      "name": "Has Files?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -400,
        960
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "body.files",
        "options": {}
      },
      "id": "f0965d1c-a180-4b2f-be50-a9aaba307d9a",
      "name": "Split Files",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        512,
        656
      ]
    },
    {
      "parameters": {
        "jsCode": "const files = $input.all(); // Ð‘ÐµÑ€ÐµÐ¼ Ð’Ð¡Ð• Ñ„Ð°Ð¹Ð»Ñ‹\nconst processedFiles = [];\n\n// Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ\nconst originalBody = $node[\"Webhook\"]?.item?.json?.body || {};\n\nfiles.forEach((fileItem, index) => {\n  const file = fileItem.json;\n  \n  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…\n  if (!file || (!file.name && !file.fileName)) {\n    console.log(`Ð¤Ð°Ð¹Ð» ${index} Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼`);\n    return;\n  }\n  \n  // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð¼Ñ Ð¸ Ñ‚Ð¸Ð¿ Ñ„Ð°Ð¹Ð»Ð°\n  const fileName = file.name || file.fileName || `document_${index}`;\n  const fileType = file.fileType || fileName.split('.').pop().toLowerCase();\n  const fileContent = file.content || '';\n  \n  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ñ… Ñ‡ÐµÑ€ÐµÐ· URL)\n  if (fileItem.binary && fileItem.binary.data) {\n    // Ð¤Ð°Ð¹Ð» ÑƒÐ¶Ðµ Ð² Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ (Ð¿Ñ€Ð¸ÑˆÐµÐ» Ð¸Ð· Convert Downloaded to File Format)\n    const binaryData = fileItem.binary.data;\n    processedFiles.push({\n      json: {\n        fileName: fileName,\n        fileType: fileType,\n        detectedEncoding: 'binary',\n        metadata: {\n          fileName: fileName,\n          fileType: fileType,\n          fileSize: file.size || 0,\n          encoding: 'binary',\n          processedAt: new Date().toISOString(),\n          source: file.metadata?.source || 'upload'\n        },\n        originalTable: originalBody.table || file.originalTable,\n        originalMode: originalBody.mode || file.originalMode\n      },\n      binary: {\n        data: binaryData\n      }\n    });\n  } else {\n    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° base64 ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° (Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ñ… Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ)\n    let binaryDataBuffer;\n    let encoding = 'utf8'; // ÐžÐ±ÑŠÑÐ²Ð»ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ encoding\n    \n    if (fileContent && fileContent.startsWith('data:')) {\n      const base64Data = fileContent.split(',')[1];\n      binaryDataBuffer = Buffer.from(base64Data || '', 'base64');\n      encoding = 'base64';\n    } else if (fileContent) {\n      // Ð•ÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ Ð½Ðµ base64, Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°Ðº Ñ‚ÐµÐºÑÑ‚\n      binaryDataBuffer = Buffer.from(fileContent, 'utf8');\n      encoding = 'utf8';\n    } else {\n      console.log(`Ð¤Ð°Ð¹Ð» ${index} Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼`);\n      return;\n    }\n    \n    // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ MIME type\n    let mimeType = 'text/plain';\n    \n    const mimeTypes = {\n      'pdf': 'application/pdf',\n      'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n      'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n      'txt': 'text/plain',\n      'csv': 'text/csv',\n      'doc': 'application/msword',\n      'xls': 'application/vnd.ms-excel'\n    };\n    \n    mimeType = mimeTypes[fileType] || 'application/octet-stream';\n    \n    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¹ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°\n    processedFiles.push({\n      json: {\n        fileName: fileName,\n        fileType: fileType,\n        detectedEncoding: encoding,\n        metadata: {\n          fileName: fileName,\n          fileType: fileType,\n          fileSize: file.size || binaryDataBuffer.length,\n          encoding: encoding,\n          processedAt: new Date().toISOString(),\n          source: file.metadata?.source || 'upload'\n        },\n        originalTable: originalBody.table || file.originalTable,\n        originalMode: originalBody.mode || file.originalMode\n      },\n      binary: {\n        data: {\n          data: binaryDataBuffer.toString('base64'),\n          mimeType: mimeType,\n          fileName: fileName,\n          fileExtension: fileType\n        }\n      }\n    });\n  }\n});\n\nif (processedFiles.length === 0) {\n  // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ„Ð°Ð¹Ð»Ð¾Ð², Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹\n  return [{\n    json: {\n      fileName: 'no_files',\n      fileType: 'error',\n      error: 'No files to process',\n      originalTable: originalBody.table || 'knowledge_base',\n      originalMode: originalBody.mode || 'append'\n    }\n  }];\n}\n\nconsole.log(`ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²: ${processedFiles.length}`);\nreturn processedFiles;"
      },
      "id": "3cc5c1e5-f858-4cc2-b64c-17934c72beed",
      "name": "Process File Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        768
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.fileType }}",
                    "rightValue": "pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "71705598-f385-45e8-8398-4dc6f93eb6a3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pdf"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.fileType }}",
                    "rightValue": "txt",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "352adff7-f336-43d6-a650-9461490edb35"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.fileType }}",
                    "rightValue": "docx",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4bac029a-9960-47ca-b588-c48155ca9a38"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "docx"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "05f6f04b-5048-45c9-8dd4-439b3e42abeb",
                    "leftValue": "={{ $json.fileType }}",
                    "rightValue": "xlsx",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "excel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "8e32e3d7-369c-4ee8-b6c9-c3317d9e2c2c",
                    "leftValue": "={{ $json.fileType }}",
                    "rightValue": "csv",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "csv"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "3df3e338-0dff-463e-b2be-80ce0238d364",
      "name": "Switch File Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        912,
        720
      ]
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "id": "78245b38-4324-4cbb-aa86-ee0e8601b877",
      "name": "Extract PDF Text",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1152,
        304
      ]
    },
    {
      "parameters": {
        "operation": "text",
        "options": {}
      },
      "id": "7699ae73-d320-4cb1-b633-56523acce5bc",
      "name": "Extract Text",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1152,
        480
      ]
    },
    {
      "parameters": {
        "jsCode": "// Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÑŽÑ‚ÑÑ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¼Ð¸ Ð¼ÐµÑ‚Ð¾Ð´Ð°Ð¼Ð¸\n// Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÐºÐ°Ðº Ñ‚ÐµÐºÑÑ‚\nconst originalData = $('Process File Content').item.json;\n\nreturn [{\n  json: {\n    data: originalData.content || '[ÐÐµÐ¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ„Ð°Ð¹Ð»Ð°]',\n    fileName: originalData.fileName,\n    fileType: originalData.fileType,\n    metadata: originalData.metadata\n  }\n}];"
      },
      "id": "e25cb1ed-6290-46a9-a5dd-d7a6c40e2882",
      "name": "Fallback Extraction",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1168,
        1136
      ]
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "id": "8eda9f90-64c8-47c6-9476-125e43b91da8",
      "name": "Aggregate Files",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        2032,
        368
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.extractedContent || $json.content || $json.body?.content || \"ÐŸÑƒÑÑ‚Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ\" }}",
        "options": {
          "systemMessage": "=Ð¢Ñ‹ - ÑÐºÑÐ¿ÐµÑ€Ñ‚ Ð¿Ð¾ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð²ÐµÐºÑ‚Ð¾Ñ€Ð½Ñ‹Ñ… Ð±Ð°Ð· Ð·Ð½Ð°Ð½Ð¸Ð¹ AI-Ð°Ð³ÐµÐ½Ñ‚Ð°.\n\nÐ¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: {{ $json.body?.table || $json.table || \"knowledge_base\" }}\nÐ ÐµÐ¶Ð¸Ð¼: {{ $json.body?.mode || $json.mode || \"append\" }}\n{{ $json.body?.editId || $json.editId ? 'ID Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ: ' + ($json.body?.editId || $json.editId) : '' }}\nðŸ†• Ð Ð•Ð–Ð˜Ðœ ÐŸÐžÐ›ÐÐžÐ“Ðž Ð‘Ð›ÐžÐšÐ: {{ $json.body?.keepFull === \"true\" || $json.keepFull === \"true\" ? \"Ð”Ð - ÐÐ• Ð ÐÐ—Ð‘Ð˜Ð’ÐÐ¢Ð¬!\" : \"Ð½ÐµÑ‚\" }}\n\nðŸ†• === ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž: Ð Ð•Ð–Ð˜Ðœ ÐŸÐžÐ›ÐÐžÐ“Ðž Ð‘Ð›ÐžÐšÐ ===\nÐ•Ð¡Ð›Ð˜ Ñ„Ð»Ð°Ð³ \"Ð Ð•Ð–Ð˜Ðœ ÐŸÐžÐ›ÐÐžÐ“Ðž Ð‘Ð›ÐžÐšÐ\" = \"Ð”Ð - ÐÐ• Ð ÐÐ—Ð‘Ð˜Ð’ÐÐ¢Ð¬!\", Ñ‚Ð¾:\n1. Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÐžÐ”Ð˜Ð Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ ÑÐ¾ Ð’Ð¡Ð•Ðœ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ñ†ÐµÐ»Ð¸ÐºÐ¾Ð¼\n2. ÐÐ• Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð½Ð¸ Ð½Ð° ÐºÐ°ÐºÐ¸Ðµ Ñ‡Ð°ÑÑ‚Ð¸\n3. ÐÐ• Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐ¹ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾/Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°\n4. Ð’ÐµÑÑŒ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð¾Ð´Ð½Ð¾Ð¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ðµ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ\n5. Ð”Ð¾Ð±Ð°Ð²ÑŒ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ°Ðº Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ (category, keywords, topic Ð¸ Ñ‚.Ð´.)\n\nÐ•ÑÐ»Ð¸ Ñ„Ð»Ð°Ð³ \"Ð Ð•Ð–Ð˜Ðœ ÐŸÐžÐ›ÐÐžÐ“Ðž Ð‘Ð›ÐžÐšÐ\" = \"Ð½ÐµÑ‚\", Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐ¹ Ð¿Ð¾ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼ Ð½Ð¸Ð¶Ðµ.\n===========================================\n\nÐŸÐ ÐÐ’Ð˜Ð›Ð Ð¤ÐžÐ ÐœÐÐ¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð¯ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐÐ• Ñ€ÐµÐ¶Ð¸Ð¼ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð±Ð»Ð¾ÐºÐ°):\n1. Ð•ÑÐ»Ð¸ Ñ€ÐµÐ¶Ð¸Ð¼ 'edit', ÑÐ¾Ð·Ð´Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÐžÐ”Ð˜Ð Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¼ÐµÐ½Ñ‹ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ Ð·Ð°Ð¿Ð¸ÑÐ¸\n2. Ð”Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ñ€ÐµÐ¶Ð¸Ð¼Ð¾Ð² - Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ñ‹\n3. ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑÐ°Ð¼Ð¾Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¼ Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚\n4. ÐÐµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ñ Ð¿Ð¾ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼. Ð¢ÐµÐºÑÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¼ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼ Ð±ÐµÐ· Ñ€Ð°Ð·Ñ€Ñ‹Ð²Ð¾Ð²! Ð­Ñ‚Ð¾ Ð²Ð°Ð¶Ð½Ð¾!\n5. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ\n6. ÐÐ• Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ ÑÐ²Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚, Ð¾Ð±ÑŠÑÑÐ½ÐµÐ½Ð¸Ñ Ð¸Ð»Ð¸ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸\n7. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¢ÐžÐ›Ð¬ÐšÐž Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¸Ð· Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°\n\nÐŸÐ ÐÐ’Ð˜Ð›Ð Ð“Ð Ð£ÐŸÐŸÐ˜Ð ÐžÐ’ÐšÐ˜ Ð¢Ð•ÐšÐ¡Ð¢Ð (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐÐ• Ñ€ÐµÐ¶Ð¸Ð¼ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð±Ð»Ð¾ÐºÐ°):\n- ÐœÐ˜ÐÐ˜ÐœÐÐ›Ð¬ÐÐ«Ð™ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°: 200 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\n- ÐœÐÐšÐ¡Ð˜ÐœÐÐ›Ð¬ÐÐ«Ð™ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°: 500 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\n- Ð•ÑÐ»Ð¸ Ñ‚ÐµÐºÑÑ‚ Ð¼ÐµÐ½ÐµÐµ 200 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² - ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸ ÐºÐ°Ðº ÐžÐ”Ð˜Ð Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚\n- ÐÑƒÐ¼ÐµÑ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ/Ð¼Ð°Ñ€ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¿Ð¸ÑÐºÐ¸ Ñ Ð¾Ð±Ñ‰Ð¸Ð¼ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð¼ - Ð´ÐµÑ€Ð¶Ð¸ Ð²Ð¼ÐµÑÑ‚Ðµ ÐºÐ°Ðº Ð¾Ð´Ð¸Ð½ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚\n- Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð¿ÑƒÐ½ÐºÑ‚Ñ‹ Ð¿Ñ€Ð°Ð²Ð¸Ð» - Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐ¹ Ð² Ð¾Ð´Ð¸Ð½ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚\n- Ð Ð°Ð·Ð´ÐµÐ»ÑÐ¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ ÑÐ²Ð½Ñ‹Ð¼ ÑÐ¼Ñ‹ÑÐ»Ð¾Ð²Ñ‹Ð¼ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ð°Ð¼ (Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ñ‚ÐµÐ¼Ñ‹, Ñ€Ð°Ð·Ð´ÐµÐ»Ñ‹)\n- ÐÐ• Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ ÑÐ¿Ð¸ÑÐºÐ¸ Ð½Ð° Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹\n\nÐŸÐ Ð˜ÐœÐ•Ð Ð« ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐžÐ™ Ð“Ð Ð£ÐŸÐŸÐ˜Ð ÐžÐ’ÐšÐ˜:\nâœ… \"ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸: 1. ÐžÑ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚ 2. Ð‘Ñ‹Ñ‚ÑŒ Ð²ÐµÐ¶Ð»Ð¸Ð²Ñ‹Ð¼ 3. ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°Ñ‚ÑŒ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ\" - ÐžÐ”Ð˜Ð Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚\nâŒ Ð¢Ñ€Ð¸ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð° Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿ÑƒÐ½ÐºÑ‚Ð° - ÐÐ•ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž\n\nÐŸÐ ÐÐ’Ð˜Ð›Ð Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð¯ ÐœÐ•Ð¢ÐÐ”ÐÐÐÐ«Ð¥:\n\n1. Ð‘ÐÐ—ÐžÐ’Ð«Ð• ÐœÐ•Ð¢ÐÐ”ÐÐÐÐ«Ð• (Ð´Ð»Ñ Ð²ÑÐµÑ… Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²):\n   - category: Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸ Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° (pricing, security, algorithms, rules, instructions, dialogue, policy, technical, general)\n   - keywords: Ð¸Ð·Ð²Ð»ÐµÐºÐ¸ 3-5 ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ»Ð¾Ð²/Ñ„Ñ€Ð°Ð· Ð¸Ð· ÑÐ°Ð¼Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°\n   - topic: Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ‚ÐµÐ¼Ð° Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð° (ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ)\n\n2. Ð˜ÐÐ¢Ð•Ð›Ð›Ð•ÐšÐ¢Ð£ÐÐ›Ð¬ÐÐ«Ð™ ÐÐÐÐ›Ð˜Ð— ÐšÐžÐÐ¢Ð•ÐÐ¢Ð:\n   ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ñ‚ÐµÐºÑÑ‚ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ðµ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚:\n   - Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸/Ð¼ÐµÑ‚Ð¾Ð´Ð¸ÐºÐ¸ â†’ technique: \"Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸\"\n   - Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÑ‚Ð°Ð¿Ñ‹/ÑÑ‚Ð°Ð´Ð¸Ð¸ â†’ stage: \"ÑÑ‚Ð°Ð¿ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°\", order: Ð¿Ð¾Ñ€ÑÐ´ÐºÐ¾Ð²Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€\n   - Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾ Ð²Ð¾Ð·Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ â†’ objection: \"Ñ‚Ð¸Ð¿ Ð²Ð¾Ð·Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ\"  \n   - Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² â†’ client_type: \"Ñ‚Ð¸Ð¿ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°\"\n   - Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°/ÐºÐ°Ð½Ð°Ð» â†’ platform: \"Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹\"\n   - Ð•ÑÐ»Ð¸ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ð°Ð¶Ð½Ð¾ (ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÑÐ»Ð¾Ð²Ð°: Ð’ÐÐ–ÐÐž, ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž, ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž) â†’ critical: true\n   - Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ‚Ð¸Ð¿ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ â†’ policy_type: \"Ñ‚Ð¸Ð¿\"\n   - Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº â†’ items_count: ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿ÑƒÐ½ÐºÑ‚Ð¾Ð²\n   - Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð°/Ñ†ÐµÐ½Ñ‹ â†’ has_numbers: true, price_mentioned: true\n   - Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ â†’ has_questions: true\n   - Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÑ€Ð¾ÐºÐ¸/Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ñ‹ â†’ has_deadlines: true\n   - Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ â†’ has_contacts: true\n   - entities: [\"ÑƒÐ¿Ð¾Ð¼ÑÐ½ÑƒÑ‚Ñ‹Ðµ Ð¸Ð¼ÐµÐ½Ð°\", \"Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹\", \"ÑƒÑÐ»ÑƒÐ³Ð¸\"] (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)\n   - action_required: true/false (ÐµÑÐ»Ð¸ Ñ‚ÐµÐºÑÑ‚ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹)\n\n3. Ð”Ð»Ñ Ñ€ÐµÐ¶Ð¸Ð¼Ð° 'edit' ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð´Ð¾Ð±Ð°Ð²ÑŒ:\n   - updated: Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð°Ñ‚Ð° Ð² ISO Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ\n   - edited: true\n\nÐ’ÐÐ–ÐÐž: \n- ÐÐ• Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ \"Ð´Ð»Ñ Ð³Ð°Ð»Ð¾Ñ‡ÐºÐ¸\" - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ðµ, Ñ‡Ñ‚Ð¾ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ ÐµÑÑ‚ÑŒ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ðµ\n- ÐœÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ñ‹ Ð¸Ð· Ñ‚ÐµÐºÑÑ‚Ð°, Ð° Ð½Ðµ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ð°Ð½Ñ‹\n- ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð»ÑƒÑ‡ÑˆÐµ, Ñ‡ÐµÐ¼ Ð¸Ð·Ð±Ñ‹Ñ‚Ð¾Ñ‡Ð½Ñ‹Ðµ Ð½ÐµÑ€ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ\n\nðŸ”§ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž - Ð¤ÐžÐ ÐœÐÐ¢ JSON:\n\n1. Ð­ÐšÐ ÐÐÐ˜Ð ÐžÐ’ÐÐÐ˜Ð• ÐšÐÐ’Ð«Ð§Ð•Ðš (ÑÐ°Ð¼Ð¾Ðµ Ð²Ð°Ð¶Ð½Ð¾Ðµ!):\n   âŒ ÐÐ•ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž: \"content\": \"Ð’Ð¾Ð·Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ: \"Ð”Ð¾Ñ€Ð¾Ð³Ð¾\" - Ñ‡Ð°ÑÑ‚Ð¾Ðµ Ð²Ð¾Ð·Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ\"\n   âœ… ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž: \"content\": \"Ð’Ð¾Ð·Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ: \\\"Ð”Ð¾Ñ€Ð¾Ð³Ð¾\\\" - Ñ‡Ð°ÑÑ‚Ð¾Ðµ Ð²Ð¾Ð·Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ\"\n   \n   ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾: Ð’Ð¡Ð• ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ¸ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÑÑ‚Ñ€Ð¾Ðº ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž ÑÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐ¹ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð¼ \\\n\n2. Ð¤ÐžÐ ÐœÐÐ¢ ÐžÐ¢Ð’Ð•Ð¢Ð:\n   - Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž JSON Ð¼Ð°ÑÑÐ¸Ð²\n   - Ð‘Ð•Ð— markdown Ð±Ð»Ð¾ÐºÐ¾Ð² ```json```\n   - Ð‘Ð•Ð— Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð¾ Ð¸Ð»Ð¸ Ð¿Ð¾ÑÐ»Ðµ JSON\n   - Ð”Ð»Ñ Ñ€ÐµÐ¶Ð¸Ð¼Ð° 'edit' - Ð¼Ð°ÑÑÐ¸Ð² Ñ ÐžÐ”ÐÐ˜Ðœ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð¼\n   - Ð”Ð»Ñ Ñ€ÐµÐ¶Ð¸Ð¼Ð° ÐŸÐžÐ›ÐÐžÐ“Ðž Ð‘Ð›ÐžÐšÐ - Ð¼Ð°ÑÑÐ¸Ð² Ñ ÐžÐ”ÐÐ˜Ðœ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð¼ ÑÐ¾ Ð²ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼\n   \n3. ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐšÐžÐÐ¢Ð•ÐÐ¢Ð:\n   - ÐÐ• Ð¸Ð·Ð¼ÐµÐ½ÑÐ¹ Ð¸ Ð½Ðµ Ð´Ð¾Ð¿Ð¾Ð»Ð½ÑÐ¹ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚\n   - ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÐºÑÑ‚Ñ‹ Ð’Ð¡Ð•Ð“Ð”Ð Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐ¹ Ð²Ð¼ÐµÑÑ‚Ðµ\n   - Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð²ÑÐµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹, Ñ†Ð¸Ñ„Ñ€Ñ‹, ÑÐ¼Ð¾Ð´Ð·Ð¸ ÐºÐ°Ðº Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»Ðµ\n\n4. Ð’ÐÐ›Ð˜Ð”ÐÐ¦Ð˜Ð¯ ÐŸÐ•Ð Ð•Ð” ÐžÐ¢ÐŸÐ ÐÐ’ÐšÐžÐ™:\n   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ { } Ð¸ [ ] Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹\n   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‡Ñ‚Ð¾ Ð¿Ð¾ÑÐ»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ñ ÐµÑÑ‚ÑŒ Ð·Ð°Ð¿ÑÑ‚Ð°Ñ (ÐºÑ€Ð¾Ð¼Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾)\n   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ¸ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹\n\nÐ¨ÐÐ‘Ð›ÐžÐ ÐšÐžÐ Ð Ð•ÐšÐ¢ÐÐžÐ“Ðž ÐžÐ¢Ð’Ð•Ð¢Ð:\n[\n  {\n    \"content\": \"Ð¢ÐµÐºÑÑ‚ Ñ \\\"ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼Ð¸ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ°Ð¼Ð¸\\\" Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°Ð¼Ð¸\",\n    \"metadata\": {\n      \"category\": \"general\",\n      \"keywords\": [\"ÐºÐ»ÑŽÑ‡1\", \"ÐºÐ»ÑŽÑ‡2\"],\n      \"topic\": \"ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ‚ÐµÐ¼Ñ‹\"\n    }\n  }\n]\n\nâš ï¸ Ð¢Ð˜ÐŸÐ˜Ð§ÐÐ«Ð• ÐžÐ¨Ð˜Ð‘ÐšÐ˜ - ÐÐ• Ð”Ð•Ð›ÐÐ™ Ð¢ÐÐš:\nâŒ \"content\": \"ÐžÐ½ ÑÐºÐ°Ð·Ð°Ð»: \"ÐŸÑ€Ð¸Ð²ÐµÑ‚\"\"  â†’ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ¸ Ð½Ðµ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹\nâŒ ```json\\n[{...}]\\n```  â†’ ÐµÑÑ‚ÑŒ markdown Ð±Ð»Ð¾ÐºÐ¸\nâŒ [{...},]  â†’ Ð»Ð¸ÑˆÐ½ÑÑ Ð·Ð°Ð¿ÑÑ‚Ð°Ñ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°\nâŒ {\"content\": \"text\" \"metadata\": {...}}  â†’ Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð° Ð·Ð°Ð¿ÑÑ‚Ð°Ñ Ð¼ÐµÐ¶Ð´Ñƒ Ð¿Ð¾Ð»ÑÐ¼Ð¸\n\nâœ… Ð’Ð¡Ð•Ð“Ð”Ð Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐ¹ ÑÐ²Ð¾Ð¹ JSON Ð¿ÐµÑ€ÐµÐ´ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð¾Ð¼!"
        }
      },
      "id": "a2f60c98-e17f-4546-8672-1fd0d6d4f114",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        3680,
        1360
      ],
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3664,
        1584
      ],
      "id": "45cab0cf-6a6a-4cdf-86fd-ded0b8e21730",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ð£Ð›Ð£Ð§Ð¨Ð•ÐÐÐ«Ð™ Parse AI Response Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\nconst items = $input.all();\nconst allProcessedDocuments = [];\n\nconst prepareData = $('Prepare Data').item.json;\nconst prepareBody = prepareData.body || prepareData;\n\n// === Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ˜ ===\n\n// 1. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° markdown Ð±Ð»Ð¾ÐºÐ¾Ð²\nfunction cleanMarkdown(text) {\n  if (!text) return '';\n  let cleaned = text.trim();\n  cleaned = cleaned.replace(/^```(?:json)?\\s*\\n?/gi, '');\n  cleaned = cleaned.replace(/\\n?```\\s*$/gi, '');\n  return cleaned.trim();\n}\n\n// 2. ðŸ†• Ð”Ð•ÐšÐžÐ”Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð­ÐšÐ ÐÐÐ˜Ð ÐžÐ’ÐÐÐÐ«Ð¥ Ð¡Ð˜ÐœÐ’ÐžÐ›ÐžÐ’\nfunction decodeEscapedChars(jsonString) {\n  // Ð’ÐÐ–ÐÐž: ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ!\n  \n  // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð´Ð²Ð¾Ð¹Ð½Ñ‹Ðµ ÑÐ»ÐµÑˆÐ¸ Ð½Ð° Ð¾Ð´Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ\n  let decoded = jsonString.replace(/\\\\\\\\/g, '\\\\');\n  \n  // Ð—Ð°Ñ‚ÐµÐ¼ Ð·Ð°Ð¼ÐµÐ½ÑÐµÐ¼ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÑ‹ ÑÑ‚Ñ€Ð¾Ðº Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ\n  decoded = decoded.replace(/\\\\n/g, '\\n');\n  \n  // Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ð°Ð±Ñ‹\n  decoded = decoded.replace(/\\\\t/g, '\\t');\n  \n  // ÐÐ• Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ¸ - Ð¾Ð½Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¾ÑÑ‚Ð°Ñ‚ÑŒÑÑ ÐºÐ°Ðº \\\"\n  \n  return decoded;\n}\n\n// 3. ðŸ†• Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐ«Ð™ JSON ÐŸÐÐ Ð¡Ð•Ð \nfunction parseAIResponse(response) {\n  if (!response || response === \"\") {\n    throw new Error(\"Empty AI response\");\n  }\n\n  console.log('ðŸ“¥ Raw response length:', response.length);\n  console.log('ðŸ“¥ First 200 chars:', response.substring(0, 200));\n\n  // Ð¨Ð°Ð³ 1: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° markdown\n  let cleaned = cleanMarkdown(response);\n  console.log('ðŸ§¹ After markdown cleanup:', cleaned.substring(0, 150));\n\n  // Ð¨Ð°Ð³ 2: Ð”ÐµÐºÐ¾Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹\n  let decoded = decodeEscapedChars(cleaned);\n  console.log('ðŸ”“ After decoding escapes:', decoded.substring(0, 150));\n\n  // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 1: ÐŸÑ€ÑÐ¼Ð¾Ð¹ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Ð´ÐµÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ JSON\n  try {\n    const parsed = JSON.parse(decoded);\n    console.log('âœ… Direct parse successful');\n    return Array.isArray(parsed) ? parsed : [parsed];\n  } catch (e1) {\n    console.log('âŒ Direct parse failed:', e1.message);\n  }\n\n  // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 2: Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· regex\n  try {\n    const jsonMatch = decoded.match(/\\[\\s*\\{[\\s\\S]*\\}\\s*\\]/);\n    if (jsonMatch) {\n      console.log('ðŸ” Regex found JSON array');\n      \n      // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑŽÑ‰Ð¸Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\n      const superClean = jsonMatch[0]\n        .replace(/[\\u0000-\\u001F\\u007F-\\u009F]/g, '') // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑŽÑ‰Ð¸Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹\n        .replace(/,\\s*}/g, '}') // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð·Ð°Ð¿ÑÑ‚Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ´ }\n        .replace(/,\\s*\\]/g, ']'); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð·Ð°Ð¿ÑÑ‚Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ´ ]\n      \n      const parsed = JSON.parse(superClean);\n      console.log('âœ… Regex extraction successful');\n      return Array.isArray(parsed) ? parsed : [parsed];\n    }\n  } catch (e2) {\n    console.log('âŒ Regex extraction failed:', e2.message);\n  }\n\n  // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 3: ÐŸÐ¾Ð¸ÑÐº Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð±ÑŠÐµÐºÑ‚Ð° (ÐµÑÐ»Ð¸ Ð½Ðµ Ð¼Ð°ÑÑÐ¸Ð²)\n  try {\n    const objectMatch = decoded.match(/\\{[\\s\\S]*\\}/);\n    if (objectMatch) {\n      console.log('ðŸ” Regex found JSON object');\n      const parsed = JSON.parse(objectMatch[0]);\n      console.log('âœ… Object extraction successful');\n      return [parsed]; // ÐžÐ±Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð² Ð¼Ð°ÑÑÐ¸Ð²\n    }\n  } catch (e3) {\n    console.log('âŒ Object extraction failed:', e3.message);\n  }\n\n  // Fallback: Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ÑŒ\n  throw new Error('All parsing attempts failed');\n}\n\n// 4. Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°\nfunction validateDocument(doc) {\n  if (!doc || typeof doc !== 'object') {\n    console.warn('âš ï¸ Document is not an object');\n    return false;\n  }\n  \n  if (!doc.content) {\n    console.warn('âš ï¸ Document has no content field');\n    return false;\n  }\n  \n  if (typeof doc.content !== 'string') {\n    console.warn('âš ï¸ Document content is not a string');\n    return false;\n  }\n  \n  if (doc.content.trim().length === 0) {\n    console.warn('âš ï¸ Document content is empty');\n    return false;\n  }\n  \n  return true;\n}\n\n// 5. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° Ð¾Ñ‚ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\nfunction cleanContent(content) {\n  if (typeof content !== 'string') return content;\n  \n  // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð±ÑƒÐºÐ²Ð°Ð»ÑŒÐ½Ñ‹Ðµ \\n, \\t ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð¾ÑÑ‚Ð°Ð»Ð¸ÑÑŒ\n  let cleaned = content\n    .replace(/\\\\n/g, ' ')   // Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ \\n Ð½Ð° Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹\n    .replace(/\\\\t/g, ' ')   // Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ \\t Ð½Ð° Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹\n    .replace(/\\s+/g, ' ')   // Ð¡Ñ…Ð»Ð¾Ð¿Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹\n    .trim();\n  \n  return cleaned;\n}\n\n// === ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ Ð­Ð›Ð•ÐœÐ•ÐÐ¢ÐžÐ’ ===\n\nitems.forEach((item, index) => {\n  const aiResponse = item.json.output;\n  \n  const tableName = prepareBody.table || prepareData.table || 'knowledge_base';\n  const mode = prepareBody.mode || prepareData.mode || 'append';\n  const editId = prepareBody.editId || prepareData.editId || null;\n  \n  console.log(`\\nðŸ“‹ ===== Processing Item ${index} =====`);\n  console.log(`Table: \"${tableName}\", Mode: \"${mode}\"`);\n  \n  try {\n    // ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ÑƒÐ¼Ð½Ð¾Ð³Ð¾ Ð¿Ð°Ñ€ÑÐµÑ€Ð°\n    let documents = parseAIResponse(aiResponse);\n    console.log(`ðŸ“¦ Parsed ${documents.length} document(s)`);\n    \n    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ð¹ JSON (Ð´Ð²Ð¾Ð¹Ð½Ð¾Ð¹ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³)\n    if (documents.length === 1 && documents[0].content) {\n      const content = documents[0].content.trim();\n      if ((content.startsWith('[') && content.endsWith(']')) ||\n          (content.startsWith('{') && content.endsWith('}'))) {\n        try {\n          const innerParsed = JSON.parse(content);\n          if (Array.isArray(innerParsed) && innerParsed[0]?.content) {\n            console.log('ðŸ”„ Detected nested JSON, unwrapping...');\n            documents = innerParsed;\n          }\n        } catch (e) {\n          console.log('âœ… Content looks like JSON but is not - keeping as text');\n        }\n      }\n    }\n    \n    // Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ\n    const validDocuments = documents.filter(doc => {\n      const isValid = validateDocument(doc);\n      if (!isValid) {\n        console.warn(`âš ï¸ Document failed validation, skipping:`, \n          JSON.stringify(doc).substring(0, 200));\n      }\n      return isValid;\n    });\n    \n    if (validDocuments.length === 0) {\n      throw new Error('No valid documents after validation');\n    }\n    \n    documents = validDocuments;\n    console.log(`âœ… ${documents.length} document(s) passed validation`);\n    \n    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€ÐµÐ¶Ð¸Ð¼Ð° edit\n    if (mode === 'edit') {\n      documents = [documents[0]];\n      console.log('âœï¸ Edit mode: keeping only first document');\n      \n      if (!documents[0].metadata?.edited) {\n        documents[0].metadata = {\n          ...documents[0].metadata,\n          edited: true,\n          updated: new Date().toISOString(),\n          editId: editId\n        };\n      }\n    }\n    \n    // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ\n    documents = documents.map((doc, docIndex) => {\n      // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚\n      let cleanedContent = cleanContent(doc.content);\n      \n      console.log(`ðŸ“„ Document ${docIndex}: ${cleanedContent.length} chars`);\n      \n      return {\n        content: cleanedContent,\n        metadata: {\n          category: doc.metadata?.category || \"general\",\n          created_at: new Date().toISOString(),\n          table: tableName,\n          mode: mode,\n          fileIndex: index,\n          ...doc.metadata // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ AI\n        }\n      };\n    });\n    \n    allProcessedDocuments.push(...documents);\n    console.log(`âœ… Successfully processed ${documents.length} document(s) from item ${index}`);\n    \n  } catch (error) {\n    // Fallback Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð°\n    console.error(`âŒ CRITICAL ERROR for item ${index}:`, error.message);\n    console.error('Full error:', error);\n    \n    // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚\n    let fallbackContent = aiResponse || \"Processing error\";\n    \n    // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð¾Ñ‚ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\n    fallbackContent = cleanContent(fallbackContent);\n    \n    allProcessedDocuments.push({\n      content: fallbackContent,\n      metadata: {\n        category: mode === 'edit' ? \"edited\" : \"general\",\n        note: \"Fallback processing: \" + error.message,\n        error: true,\n        edited: mode === 'edit',\n        updated: new Date().toISOString(),\n        editId: mode === 'edit' ? editId : undefined,\n        table: tableName,\n        mode: mode,\n        fileIndex: index\n      }\n    });\n    \n    console.log('âš ï¸ Used fallback processing for item', index);\n  }\n});\n\n// === Ð¤Ð˜ÐÐÐ›Ð¬ÐÐ«Ð™ Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ ===\n\nconst finalTable = prepareBody.table || prepareData.table || 'knowledge_base';\nconst finalMode = prepareBody.mode || prepareData.mode || 'append';\nconst finalEditId = prepareBody.editId || prepareData.editId || null;\n\nconsole.log(`\\nâœ… ===== FINAL RESULT =====`);\nconsole.log(`Table: \"${finalTable}\"`);\nconsole.log(`Mode: \"${finalMode}\"`);\nconsole.log(`Documents: ${allProcessedDocuments.length}`);\nconsole.log(`Files processed: ${items.length}`);\n\nreturn [{\n  json: {\n    table: finalTable,\n    documents: allProcessedDocuments,\n    mode: finalMode,\n    editId: finalEditId,\n    documentsCount: allProcessedDocuments.length,\n    filesProcessed: items.length\n  }\n}];"
      },
      "id": "b5de16b1-bd55-4d69-9fda-06573b65ddb0",
      "name": "Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4048,
        1168
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.mode }}",
              "rightValue": "edit",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "35230005-5e67-4eff-a2b1-2bff7f0e4d81"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "dc281cd6-0d60-400b-8816-dadfe36449be",
      "name": "Check Edit Mode",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        4208,
        1168
      ]
    },
    {
      "parameters": {
        "jsCode": "const table = $json.table;\nconst content = $json.documents[0].content;\nconst metadata = JSON.stringify($json.documents[0].metadata);\nconst editId = parseInt($json.editId);\n\nconst query = `UPDATE ${table}\nSET \n  content = $1,\n  metadata = $2::jsonb\nWHERE id = $3\nRETURNING id, content, metadata, created_at`;\n\nreturn [{\n  json: {\n    query: query,\n    values: [content, metadata, editId]\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4448,
        1024
      ],
      "id": "cfddae5f-fb63-469b-8ea3-ef8f6e8e1f35",
      "name": "Prepare SQL for Update"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ $json.query }}",
        "options": {
          "queryReplacement": "={{ $json.values }}"
        }
      },
      "id": "2e488bff-6a38-4a35-8736-6c44532a5073",
      "name": "Update Record",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4720,
        1024
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "documents",
        "options": {}
      },
      "id": "e74cbac1-a43b-4cec-ac8f-40eb9621c14b",
      "name": "Split Documents",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        4464,
        1264
      ]
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "={{ $json.metadata.table }}",
          "mode": ""
        },
        "embeddingBatchSize": 400,
        "options": {}
      },
      "id": "2441ce9e-2bcc-4538-ac1e-bec7ddb40c48",
      "name": "Insert to Supabase",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        4688,
        1360
      ],
      "credentials": {
        "supabaseApi": {
          "id": "7ldcSWe5TTPVh3zH",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {},
      "id": "d65f03d5-27ef-4582-8212-5ed35d8fc898",
      "name": "Google Gemini Embeddings",
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        4656,
        1552
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.content }}",
        "textSplittingMode": "custom",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "table",
                "value": "={{ $json.metadata.table }}"
              },
              {
                "name": "category",
                "value": "={{ $json.metadata.category || 'general' }}"
              },
              {
                "name": "keywords",
                "value": "={{ $json.metadata.keywords || [] }}"
              },
              {
                "name": "topic",
                "value": "={{ $json.metadata.topic || '' }}"
              },
              {
                "name": "created_at",
                "value": "={{ $json.metadata.created_at || new Date().toISOString() }}"
              },
              {
                "name": "technique",
                "value": "={{ $json.metadata.technique || null }}"
              },
              {
                "name": "stage",
                "value": "={{ $json.metadata.stage || null }}"
              },
              {
                "name": "has_questions",
                "value": "={{ $json.metadata.has_questions || false }}"
              },
              {
                "name": "items_count",
                "value": "={{ $json.metadata.items_count || 0 }}"
              },
              {
                "name": "entities",
                "value": "={{ $json.metadata.entities || [] }}"
              }
            ]
          }
        }
      },
      "id": "b362db17-c3ba-481e-9b4c-f69d6a40c668",
      "name": "Default Data Loader",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        4768,
        1552
      ]
    },
    {
      "parameters": {
        "numberInputs": 4
      },
      "id": "2d273151-3872-4c07-be14-b0628a52dd40",
      "name": "Merge After Edit",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        5136,
        1136
      ]
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ð²ÑÐµÑ… Ñ‚Ð¸Ð¿Ð¾Ð² Ñ„Ð°Ð¹Ð»Ð¾Ð² (Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹)\nconst items = $input.all();\nlet documentsCount = 0;\nlet tablesCount = 0;\nlet editCount = 0;\nlet deleteCount = 0;\nconst processedFiles = [];\n\n// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· webhook\nconst webhookData = $node[\"Webhook\"]?.json?.body || {};\nconst originalMode = webhookData.mode || \"unknown\";\nconst originalTable = webhookData.table || \"knowledge_base\";\nconst originalEditId = webhookData.editId || null;\n\n// ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹\nitems.forEach(item => {\n  const data = item.json;\n  \n  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚Ð°Ð±Ð»Ð¸Ñ†\n  if (data.type === 'table') {\n    tablesCount++;\n    processedFiles.push({\n      type: 'table',\n      name: data.fileName,\n      rows: data.totalRows,\n      columns: data.totalColumns\n    });\n  }\n  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ\n  else if (data.mode === 'edit' || originalMode === 'edit') {\n    editCount++;\n    if (data.editId || originalEditId) {\n      processedFiles.push({\n        type: 'edit',\n        id: data.editId || originalEditId\n      });\n    }\n  }\n  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€ÐµÐ¶Ð¸Ð¼Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ\n  else if (data.mode === 'delete' || originalMode === 'delete') {\n    deleteCount++;\n    if (data.editId || originalEditId) {\n      processedFiles.push({\n        type: 'delete',\n        id: data.editId || originalEditId\n      });\n    }\n  }\n  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²\n  else {\n    const count = data.documentsCount || \n                  data.documents_processed || \n                  data.documentCount || 0;\n    if (count > 0) {\n      documentsCount += count;\n    }\n  }\n});\n\n// Ð•ÑÐ»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ Ð½Ð¾ ÐµÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ, ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÐºÐ°Ðº 1 Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚\nif (documentsCount === 0 && tablesCount === 0 && editCount === 0 && deleteCount === 0 && items.length > 0) {\n  documentsCount = 1;\n}\n\n// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ\nlet message = '';\nconst messages = [];\n\n// Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ€ÐµÐ¶Ð¸Ð¼Ð¾Ð²\nif (originalMode === 'delete' && deleteCount > 0) {\n  message = `Successfully deleted record ID: ${originalEditId} from ${originalTable}`;\n} else if (originalMode === 'edit' && editCount > 0) {\n  message = `Successfully updated record ID: ${originalEditId} in ${originalTable}`;\n} else if (originalMode === 'replace') {\n  message = `Successfully replaced content in ${originalTable}`;\n} else {\n  // Ð ÐµÐ¶Ð¸Ð¼ append - Ð´ÐµÑ‚Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾\n  if (documentsCount > 0) {\n    messages.push(`Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾: ${documentsCount}`);\n  }\n  if (tablesCount > 0) {\n    messages.push(`Ð¢Ð°Ð±Ð»Ð¸Ñ† Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾: ${tablesCount}`);\n    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð¿Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼\n    processedFiles\n      .filter(f => f.type === 'table')\n      .forEach(table => {\n        messages.push(`  - ${table.name}: ${table.rows} ÑÑ‚Ñ€Ð¾Ðº, ${table.columns} ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº`);\n      });\n  }\n  \n  if (messages.length > 0) {\n    message = messages.join('\\n');\n  } else {\n    message = `Operation completed successfully in ${originalTable}`;\n  }\n}\n\n// ÐŸÐ¾Ð´ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²\nconst totalProcessed = documentsCount + tablesCount + editCount + deleteCount;\n\n// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚\nreturn [{\n  json: {\n    success: true,\n    message: message,\n    table: originalTable,\n    mode: originalMode,\n    documents_processed: documentsCount,\n    tables_processed: tablesCount,\n    total_items_processed: totalProcessed,\n    editId: originalEditId,\n    details: processedFiles.length > 0 ? processedFiles : null,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "89e6a95b-c074-489b-a707-733258020311",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5312,
        1152
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "c603f276-b6d3-41b7-9e1f-cc098eb51742",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        5488,
        1152
      ]
    },
    {
      "parameters": {
        "jsCode": "// ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð²ÑÐµÑ… Ñ‚Ð¸Ð¿Ð¾Ð² Ñ„Ð°Ð¹Ð»Ð¾Ð²\nconst items = $input.all();\nconst processedItems = [];\n\nitems.forEach(item => {\n  const json = item.json;\n  \n  // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð´Ð°Ð½Ð½Ñ‹Ñ…\n  let fileName = json.fileName || 'unknown';\n  let fileType = json.fileType || '';\n  let extractedContent = '';\n  let structuredData = null;\n  \n  // Ð”Ð»Ñ Ð°Ð³Ñ€ÐµÐ³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…\n  if (json.data && Array.isArray(json.data)) {\n    // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð¸Ð· Ð°Ð³Ñ€ÐµÐ³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…\n    json.data.forEach(fileData => {\n      let currentContent = '';\n      let currentStructured = null;\n      \n      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð¼Ñ Ð¸ Ñ‚Ð¸Ð¿ Ñ„Ð°Ð¹Ð»Ð°\n      const currentFileName = fileData.fileName || fileName;\n      const currentFileType = fileData.fileType || fileType;\n      \n      // CSV Ð¸ Excel Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¼ÐµÑÑ‚Ð°Ñ…\n      if (Array.isArray(fileData)) {\n        // Ð¡Ð°Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ²Ð»ÑÑŽÑ‚ÑÑ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼ (CSV/Excel)\n        currentStructured = fileData;\n        currentContent = fileData.map((row, index) => {\n          const cleanRow = {...row};\n          delete cleanRow._row_number;\n          \n          return `Ð¡Ñ‚Ñ€Ð¾ÐºÐ° ${index + 1}: ` + Object.entries(cleanRow)\n            .filter(([key, value]) => value !== null && value !== undefined)\n            .map(([key, value]) => `${key}=\"${value}\"`)\n            .join(', ');\n        }).join('\\n');\n      } else if (fileData.data) {\n        // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð¿Ð¾Ð»Ðµ data\n        if (Array.isArray(fileData.data)) {\n          currentStructured = fileData.data;\n          currentContent = fileData.data.map((row, index) => {\n            const cleanRow = {...row};\n            delete cleanRow._row_number;\n            \n            return `Ð¡Ñ‚Ñ€Ð¾ÐºÐ° ${index + 1}: ` + Object.entries(cleanRow)\n              .filter(([key, value]) => value !== null && value !== undefined)\n              .map(([key, value]) => `${key}=\"${value}\"`)\n              .join(', ');\n          }).join('\\n');\n        } else {\n          currentContent = fileData.data;\n        }\n      } else if (fileData.text) {\n        currentContent = fileData.text;\n      } else {\n        currentContent = JSON.stringify(fileData);\n      }\n      \n      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»\n      processedItems.push({\n        json: {\n          fileName: currentFileName,\n          fileType: currentFileType,\n          extractedContent: currentContent,\n          structuredData: currentStructured,\n          metadata: {\n            ...fileData.metadata,\n            hasStructuredData: currentStructured !== null,\n            contentLength: currentContent.length,\n            fileType: currentFileType\n          },\n          originalTable: json.originalTable || $('Webhook').item.json.body.table,\n          originalMode: json.originalMode || $('Webhook').item.json.body.mode\n        }\n      });\n    });\n  } \n  // Ð”Ð»Ñ Ð½Ðµ Ð°Ð³Ñ€ÐµÐ³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ Ð¸Ð· Extract ÑƒÐ·Ð»Ð¾Ð²)\n  else {\n    let content = '';\n    let structured = null;\n    \n    // CSV/Excel Ð´Ð°Ð½Ð½Ñ‹Ðµ\n    if (Array.isArray(json)) {\n      structured = json;\n      content = json.map((row, index) => {\n        const cleanRow = {...row};\n        delete cleanRow._row_number;\n        \n        return `Ð¡Ñ‚Ñ€Ð¾ÐºÐ° ${index + 1}: ` + Object.entries(cleanRow)\n          .filter(([key, value]) => value !== null && value !== undefined)\n          .map(([key, value]) => `${key}=\"${value}\"`)\n          .join(', ');\n      }).join('\\n');\n    }\n    // PDF Ñ Ð¿Ð¾ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ‡Ð½Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹\n    else if (json.pages && Array.isArray(json.pages)) {\n      content = json.pages.map(page => page.text || '').join('\\n\\n--- Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° ---\\n\\n');\n    }\n    // Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ\n    else if (json.text) {\n      content = json.text;\n    }\n    // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð¿Ð¾Ð»Ðµ data\n    else if (json.data) {\n      if (typeof json.data === 'string') {\n        content = json.data;\n      } else if (Array.isArray(json.data)) {\n        structured = json.data;\n        content = JSON.stringify(json.data, null, 2);\n      } else {\n        content = JSON.stringify(json.data);\n      }\n    }\n    // Ð•ÑÐ»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð¿Ð¾Ð´Ð¾ÑˆÐ»Ð¾\n    else {\n      content = JSON.stringify(json);\n    }\n    \n    processedItems.push({\n      json: {\n        fileName: fileName,\n        fileType: fileType,\n        extractedContent: content,\n        structuredData: structured,\n        metadata: {\n          hasStructuredData: structured !== null,\n          contentLength: content.length,\n          fileType: fileType\n        },\n        originalTable: $('Webhook').item.json.body.table,\n        originalMode: $('Webhook').item.json.body.mode\n      }\n    });\n  }\n});\n\n// Ð•ÑÐ»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸ÐµÐ¼\nif (processedItems.length === 0) {\n  return [{\n    json: {\n      fileName: 'no_data',\n      fileType: 'error',\n      extractedContent: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð°',\n      structuredData: null,\n      metadata: {\n        hasStructuredData: false,\n        contentLength: 0,\n        error: true\n      },\n      originalTable: $('Webhook').item.json.body.table,\n      originalMode: $('Webhook').item.json.body.mode\n    }\n  }];\n}\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2496,
        624
      ],
      "id": "a50d991d-88ef-4629-99cc-e08d61142791",
      "name": "Format File Data"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -176,
        1024
      ],
      "id": "e5dfe6a0-5f51-4fa0-8bb8-7d028fa57612",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "jsCode": "// DOCX ÑÑ‚Ð¾ ZIP Ð°Ñ€Ñ…Ð¸Ð², Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð´Ð»Ñ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸\nconst items = $input.all(); // Ð‘ÐµÑ€ÐµÐ¼ Ð’Ð¡Ð• ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹, Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ð¹\nconst processedItems = [];\n\nitems.forEach(item => {\n  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ binary data\n  if (!item.binary || !item.binary.data) {\n    // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ binary data, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÑ‚Ð¾Ñ‚ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚\n    processedItems.push(item);\n    return;\n  }\n  \n  // ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»\n  const processedItem = JSON.parse(JSON.stringify(item));\n  \n  // ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ DOCX Ð² ZIP\n  const bin = processedItem.binary.data;\n  bin.fileName = bin.fileName.replace(/\\.docx$/i, '.zip');\n  bin.fileExtension = 'zip';\n  bin.mimeType = 'application/zip';\n  \n  processedItems.push(processedItem);\n});\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        640
      ],
      "id": "be1ef457-a8b9-44ff-81eb-d34af6e0e488",
      "name": "Rename DOCX to ZIP"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.compression",
      "typeVersion": 1.1,
      "position": [
        1328,
        592
      ],
      "id": "2da8d208-dca5-457b-be7b-31535441fa8a",
      "name": "Compression"
    },
    {
      "parameters": {
        "jsCode": "// Ð˜Ñ‰ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð° Ð²Ð¾ Ð²ÑÐµÑ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ñ…\nconst items = $input.all();\nconst processedItems = [];\n\nitems.forEach(item => {\n  const binaries = item.binary;\n  \n  if (!binaries) {\n    console.log('ÐÐµÑ‚ binary Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼');\n    return;\n  }\n  \n  // Ð˜Ñ‰ÐµÐ¼ document.xml Ð² Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð°Ñ…\n  for (const [key, file] of Object.entries(binaries)) {\n    if (file.fileName && file.fileName.includes('document.xml')) {\n      processedItems.push({ \n        binary: { data: file },\n        json: item.json || {}\n      });\n      return; // ÐÐ°ÑˆÐ»Ð¸ document.xml, Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñƒ\n    }\n  }\n  \n  // Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸ document.xml, Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ\n  processedItems.push({\n    json: {\n      ...item.json,\n      error: \"document.xml Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð°Ñ€Ñ…Ð¸Ð²Ðµ\"\n    }\n  });\n});\n\nif (processedItems.length === 0) {\n  return [{json: {error: \"ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ document.xml\"}}];\n}\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1488,
        592
      ],
      "id": "4b34a051-52f9-4aa7-88fc-00a088d1ab5e",
      "name": "Extract document"
    },
    {
      "parameters": {
        "jsCode": "// Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¸Ð· Ð²ÑÐµÑ… document.xml Ñ„Ð°Ð¹Ð»Ð¾Ð²\nconst items = $input.all();\nconst processedItems = [];\n\nitems.forEach((item, index) => {\n  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ ÑƒÐ·Ð»Ð°\n  if (item.json && item.json.error) {\n    console.log(`Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚ ${index} ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¾ÑˆÐ¸Ð±ÐºÑƒ: ${item.json.error}`);\n    processedItems.push(item);\n    return;\n  }\n  \n  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ binary data\n  if (!item.binary || !item.binary.data) {\n    console.log(`Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚ ${index} Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ binary data`);\n    processedItems.push({\n      json: {\n        data: '',\n        fileName: `document_${index}.docx`,\n        fileType: \"docx\",\n        error: \"No binary data found\"\n      }\n    });\n    return;\n  }\n  \n  try {\n    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ binary data\n    const binaryData = item.binary.data;\n    const buffer = Buffer.from(binaryData.data, 'base64');\n    const xml = buffer.toString('utf8');\n    \n    // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð²ÐµÑÑŒ Ñ‚ÐµÐºÑÑ‚ Ð¸Ð· XML\n    // Ð˜Ñ‰ÐµÐ¼ Ð²ÑÐµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ <w:t>\n    const textMatches = xml.match(/<w:t[^>]*>([^<]*)<\\/w:t>/g) || [];\n    const fullText = textMatches\n      .map(match => {\n        // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ XML Ñ‚ÐµÐ³Ð¸\n        return match.replace(/<[^>]+>/g, '');\n      })\n      .join(' ')\n      .replace(/\\s+/g, ' ')\n      .trim();\n    \n    console.log(`Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚ ${index}: Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¾ ${fullText.length} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ñ‚ÐµÐºÑÑ‚Ð°`);\n    \n    // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð°\n    const fileName = item.json?.fileName || \n                    item.json?.originalData?.fileName ||\n                    `document_${index}.docx`;\n    \n    processedItems.push({\n      json: {\n        data: fullText,\n        fileName: fileName,\n        fileType: \"docx\",\n        metadata: {\n          ...item.json?.metadata,\n          textLength: fullText.length,\n          processedAt: new Date().toISOString()\n        }\n      }\n    });\n  } catch (error) {\n    console.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° ${index}:`, error);\n    processedItems.push({\n      json: {\n        data: '',\n        fileName: `error_${index}.docx`,\n        fileType: \"docx\",\n        error: `ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ñ‚ÐµÐºÑÑ‚Ð°: ${error.message}`\n      }\n    });\n  }\n});\n\nconsole.log(`ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²: ${processedItems.length}`);\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        592
      ],
      "id": "27b51452-ed14-4165-b689-ae510e25382d",
      "name": "Extract Text from XML"
    },
    {
      "parameters": {
        "chunkSize": 1500,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        4752,
        1712
      ],
      "id": "56384d0b-0386-4730-a3d0-e4bfaa81e967",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Switch Mode Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹\n// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Switch Mode\nconst originalData = $node[\"Switch Mode\"].json;\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ÑÑ‚ÑŒ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸\nconst clearResult = $input.all();\nconst clearSuccess = clearResult.length > 0;\n\nif (!clearSuccess) {\n  throw new Error(\"Failed to clear table\");\n}\n\n// Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ body\nconst body = originalData.body || originalData;\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² (ÐºÐ°Ðº Ð² Prepare Data)\nconst hasFilesRaw = body.hasFiles === true || \n                    body.hasFiles === 'true' || \n                    (body.files && body.files.length > 0) || \n                    false;\n\n// ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ\nconst files = [...(body.files || [])];\n\n// Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚\nlet content = body.content || body.textContent || \"\";\n\n// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° URL Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°\nconst urlPattern = /https?:\\/\\/(www\\.)?[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*)/gi;\nconst urls = content.match(urlPattern) || [];\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ URL\nconst hasUrlsRaw = urls.length > 0 && (\n  content.trim().startsWith('http') || \n  content.trim().startsWith('Ð¡Ð¡Ð«Ð›ÐšÐ˜ Ð”Ð›Ð¯ ÐÐÐÐ›Ð˜Ð—Ð') ||\n  content.trim().startsWith('URL') ||\n  (urls.length > 0 && content.trim().replace(urlPattern, '').trim().length < 50)\n);\n\n// ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸\nconst hasFiles = String(hasFilesRaw);\nconst hasUrls = String(hasUrlsRaw);\n\n// ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð»ÑŒÑˆÐµ Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ñ„Ð»Ð°Ð³Ð°Ð¼Ð¸\nreturn [{\n  json: {\n    ...originalData,\n    tableCleared: true,\n    clearSuccess: true,\n    body: {\n      ...body,\n      hasFiles: hasFiles,\n      hasUrls: hasUrls,\n      urls: urls,\n      files: files,\n      filesCount: files.length\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -768,
        656
      ],
      "id": "f0c6cc18-d8c0-40a8-8163-2619e7c94f5d",
      "name": "Pass Data After Clear"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.hasFiles }}",
                    "rightValue": "true",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "48d978cf-eead-44dc-bcba-248ea583885c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "files"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0145af52-7c2a-4e4b-a58a-6677d1627589",
                    "leftValue": "={{ $json.body.hasUrls }}",
                    "rightValue": "true",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "(urls"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -256,
        784
      ],
      "id": "3e05e6d2-1b5c-409a-94fa-4b762cf74d9b",
      "name": "Check Data Type"
    },
    {
      "parameters": {
        "jsCode": "// Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ URLs\nconst data = $input.first().json;\nconst urls = data.body?.urls || data.urls || [];\nconst processedUrls = [];\n\n// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ñ‚Ð¸Ð¿Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð° Ð¿Ð¾ URL\nfunction detectDocType(url) {\n  // Google Docs - ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ðº DOCX\n  if (url.includes('docs.google.com/document')) {\n    const match = url.match(/\\/d\\/([a-zA-Z0-9-_]+)/);\n    if (match) {\n      return {\n        type: 'google_doc',\n        id: match[1],\n        exportUrl: `https://docs.google.com/document/d/${match[1]}/export?format=docx`,\n        expectedFormat: 'docx'\n      };\n    }\n  }\n  \n  // Google Sheets - ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ðº XLSX\n  if (url.includes('docs.google.com/spreadsheets')) {\n    const match = url.match(/\\/d\\/([a-zA-Z0-9-_]+)/);\n    if (match) {\n      return {\n        type: 'google_sheet',\n        id: match[1],\n        exportUrl: `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=xlsx`,\n        expectedFormat: 'xlsx'\n      };\n    }\n  }\n  \n  // Google Presentations - ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ðº PPTX\n  if (url.includes('docs.google.com/presentation')) {\n    const match = url.match(/\\/d\\/([a-zA-Z0-9-_]+)/);\n    if (match) {\n      return {\n        type: 'google_presentation',\n        id: match[1],\n        exportUrl: `https://docs.google.com/presentation/d/${match[1]}/export?format=pptx`,\n        expectedFormat: 'pptx'\n      };\n    }\n  }\n  \n  // Google Forms - ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÐºÐ°Ðº CSV\n  if (url.includes('docs.google.com/forms')) {\n    const match = url.match(/\\/d\\/([a-zA-Z0-9-_]+)/);\n    if (match) {\n      return {\n        type: 'google_form',\n        id: match[1],\n        exportUrl: `https://docs.google.com/forms/d/${match[1]}/export?format=csv`,\n        expectedFormat: 'csv'\n      };\n    }\n  }\n  \n  // ÐŸÑ€ÑÐ¼Ñ‹Ðµ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ñ„Ð°Ð¹Ð»Ñ‹ - Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ\n  if (url.match(/\\.(pdf|docx|doc|txt|xlsx|xls|csv|pptx|ppt)$/i)) {\n    const extension = url.match(/\\.([^.]+)$/)[1].toLowerCase();\n    return {\n      type: 'direct_file',\n      extension: extension,\n      downloadUrl: url,\n      expectedFormat: extension\n    };\n  }\n  \n  // Google Drive Ñ„Ð°Ð¹Ð»Ñ‹ - Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ð¿\n  if (url.includes('drive.google.com')) {\n    const match = url.match(/\\/d\\/([a-zA-Z0-9-_]+)|id=([a-zA-Z0-9-_]+)/);\n    if (match) {\n      const fileId = match[1] || match[2];\n      // Ð”Ð»Ñ Drive Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð±ÐµÐ· ÑÐ²Ð½Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð° ÑÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ\n      return {\n        type: 'google_drive',\n        id: fileId,\n        downloadUrl: `https://drive.google.com/uc?export=download&id=${fileId}`,\n        expectedFormat: 'unknown'\n      };\n    }\n  }\n  \n  // Dropbox\n  if (url.includes('dropbox.com')) {\n    const directUrl = url.replace('dl=0', 'dl=1');\n    // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¿Ð¾ URL\n    const extensionMatch = url.match(/\\.([^.?]+)(\\?|$)/);\n    const format = extensionMatch ? extensionMatch[1].toLowerCase() : 'unknown';\n    return {\n      type: 'dropbox',\n      downloadUrl: directUrl,\n      expectedFormat: format\n    };\n  }\n  \n  // OneDrive/SharePoint\n  if (url.includes('sharepoint.com') || url.includes('1drv.ms')) {\n    return {\n      type: 'onedrive',\n      downloadUrl: url,\n      expectedFormat: 'unknown'\n    };\n  }\n  \n  return {\n    type: 'unknown',\n    url: url,\n    expectedFormat: 'unknown'\n  };\n}\n\n// ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ URL\nurls.forEach((url, index) => {\n  const docInfo = detectDocType(url);\n  \n  processedUrls.push({\n    originalUrl: url,\n    ...docInfo,\n    index: index\n  });\n});\n\n// Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ðµ URLs Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸\nreturn [{\n  json: {\n    ...data,\n    processedUrls: processedUrls,\n    urlsToDownload: processedUrls.filter(u => \n      u.exportUrl || u.downloadUrl\n    )\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        848
      ],
      "id": "3379dca6-3740-488c-b8b3-65f85c929379",
      "name": "Process URLs"
    },
    {
      "parameters": {
        "fieldToSplitOut": "urlsToDownload",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        112,
        944
      ],
      "id": "b3aff558-b91a-40c9-9375-0bc8f472aae2",
      "name": "Split Out"
    },
    {
      "parameters": {
        "url": "={{ $json.exportUrl || $json.downloadUrl }}",
        "options": {
          "allowUnauthorizedCerts": true,
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "responseFormat": "file"
            }
          },
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        288,
        800
      ],
      "id": "dd6f4882-9016-483c-bd57-5e61140f5756",
      "name": "Download Files from URLs"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸\nconst items = $input.all(); // Ð‘ÐµÑ€ÐµÐ¼ Ð’Ð¡Ð• ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹, Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ð¹\nconst processedFiles = [];\n\nitems.forEach((item, index) => {\n  const binary = item.binary;\n  const json = item.json;\n  \n  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ\n  if (!binary || Object.keys(binary).length === 0) {\n    processedFiles.push({\n      json: {\n        name: `error_file_${index}`,\n        fileType: 'error',\n        content: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð». ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð¸Ð¼ÐµÐµÑ‚ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿.',\n        metadata: {\n          source: 'url',\n          originalUrl: json.originalUrl || '',\n          error: true,\n          errorMessage: 'File download failed'\n        }\n      }\n    });\n    return;\n  }\n\n  // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»\n  const fileKey = Object.keys(binary)[0];\n  const file = binary[fileKey];\n\n  // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ñ„Ð°Ð¹Ð»Ð° Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð³Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð¸Ð»Ð¸ MIME type\n  let fileType = json.expectedFormat || 'unknown';\n  let fileName = file.fileName || `downloaded_file_${index}.${fileType}`;\n\n  // Ð£Ñ‚Ð¾Ñ‡Ð½ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ñ„Ð°Ð¹Ð»Ð° Ð¿Ð¾ MIME type ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾\n  if (fileType === 'unknown' && file.mimeType) {\n    if (file.mimeType.includes('pdf')) {\n      fileType = 'pdf';\n    } else if (file.mimeType.includes('wordprocessingml') || file.mimeType.includes('msword')) {\n      fileType = 'docx';\n    } else if (file.mimeType.includes('spreadsheetml') || file.mimeType.includes('ms-excel')) {\n      fileType = 'xlsx';\n    } else if (file.mimeType.includes('presentationml') || file.mimeType.includes('ms-powerpoint')) {\n      fileType = 'pptx';\n    } else if (file.mimeType.includes('text/plain')) {\n      fileType = 'txt';\n    } else if (file.mimeType.includes('text/csv')) {\n      fileType = 'csv';\n    }\n  }\n\n  // ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ\n  const formatMap = {\n    'doc': 'docx',\n    'xls': 'xlsx',\n    'ppt': 'pptx'\n  };\n  fileType = formatMap[fileType] || fileType;\n\n  // Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ Ñ‡Ñ‚Ð¾ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ\n  if (!fileName.endsWith(`.${fileType}`)) {\n    fileName = fileName.replace(/\\.[^.]+$/, '') + `.${fileType}`;\n  }\n\n  // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ base64 data URL\n  const base64Data = file.data;\n  const dataUrl = `data:${file.mimeType || 'application/octet-stream'};base64,${base64Data}`;\n\n  // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»\n  processedFiles.push({\n    json: {\n      name: fileName,\n      fileType: fileType,\n      size: file.fileSize || Buffer.from(base64Data, 'base64').length,\n      content: dataUrl,\n      metadata: {\n        source: 'url',\n        originalUrl: json.originalUrl || '',\n        documentType: json.type || 'unknown',\n        originalFormat: json.expectedFormat || fileType,\n        downloadedAt: new Date().toISOString()\n      },\n      originalTable: $node[\"Webhook\"]?.json?.body?.table || 'knowledge_base',\n      originalMode: $node[\"Webhook\"]?.json?.body?.mode || 'append'\n    },\n    binary: {\n      data: file\n    }\n  });\n});\n\nreturn processedFiles;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        880
      ],
      "id": "28160ece-1926-48be-9c0a-fceb7ba0eeea",
      "name": "Convert Downloaded to File Format"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "options": {
          "headerRow": true
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1152,
        800
      ],
      "id": "b0f01bec-2ab1-40f5-8c86-b98d4197e40f",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1152,
        960
      ],
      "id": "06e1da79-efac-44b8-ba2f-b18c9e721007",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚Ð°Ð±Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…\nconst items = $input.all();\nconst processedTables = [];\n\nconsole.log(`ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²: ${items.length}`);\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…\nif (items.length > 0) {\n  // Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¸ÑˆÐ»Ð¾ Ð¼Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² - ÑÑ‚Ð¾ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹\n  if (items.length > 1 && items[0].json && !Array.isArray(items[0].json)) {\n    // Ð’ÑÐµ items - ÑÑ‚Ð¾ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹\n    const rows = items.map(item => item.json);\n    \n    // Ð’ÐÐ–ÐÐžÐ• Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð•: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð°\n    const originalBody = $node[\"Webhook\"]?.json?.body || {};\n    const switchFileTypeData = $('Switch File Type').item.json;\n    \n    // Ð‘ÐµÑ€ÐµÐ¼ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° Ð¸Ð· Switch File Type Ð¸Ð»Ð¸ Ð¸Ð· webhook\n    let fileName = switchFileTypeData.fileName || \n                   originalBody.fileName ||\n                   originalBody.files?.[0]?.name ||\n                   'unknown_spreadsheet.xlsx';\n    \n    // ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° (ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)\n    fileName = fileName.split('/').pop().split('\\\\').pop();\n    \n    // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ID Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¸Ð¼ÐµÐ½Ð¸ Ñ„Ð°Ð¹Ð»Ð°\n    // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ Ð¸ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ID\n    const baseFileName = fileName.replace(/\\.[^.]+$/, '').replace(/[^a-zA-Z0-9_-]/g, '_');\n    const fileId = `table_${baseFileName}`;\n    \n    const fileType = fileName.toLowerCase().endsWith('.csv') ? 'csv' : 'xlsx';\n    const sourceUrl = originalBody.urls ? originalBody.urls[0] : null;\n    \n    // Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð² Ð¸Ð· Ð¿ÐµÑ€Ð²Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸\n    const headers = Object.keys(rows[0]).map(h => String(h).trim());\n    console.log(`Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸: ${headers.join(', ')}`);\n    console.log(`Ð˜Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð°: ${fileName}, ID: ${fileId}`);\n    \n    // Ð¡Ð±Ð¾Ñ€ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾\n    const textParts = [`Ð¤Ð°Ð¹Ð»: ${fileName}`];\n    textParts.push(`ÐšÐ¾Ð»Ð¾Ð½ÐºÐ¸: ${headers.join(', ')}`);\n    textParts.push(`ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹: ${rows.length}`);\n    \n    // Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ñ‚ÐµÐºÑÑ‚Ð¾Ð²\n    const uniqueTexts = new Set();\n    rows.forEach(row => {\n      Object.entries(row).forEach(([key, value]) => {\n        if (value && typeof value === 'string' && isNaN(value)) {\n          const cleaned = value.trim();\n          if (cleaned.length > 2 && cleaned.length < 500) {\n            uniqueTexts.add(cleaned);\n          }\n        }\n      });\n    });\n    \n    if (uniqueTexts.size > 0) {\n      textParts.push('\\nÐ¢ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ:');\n      textParts.push(...Array.from(uniqueTexts).slice(0, 100));\n    }\n    \n    const fullTextContent = textParts.join('\\n');\n    \n    // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ñ€Ð¾Ðº\n    const cleanedRows = rows.map(row => {\n      const cleanRow = {};\n      headers.forEach(header => {\n        let value = row[header];\n        if (value === null || value === undefined) {\n          value = '';\n        } else if (typeof value === 'object') {\n          value = JSON.stringify(value);\n        } else {\n          value = String(value).trim();\n        }\n        cleanRow[header] = value;\n      });\n      return cleanRow;\n    });\n    \n    processedTables.push({\n      json: {\n        fileId: fileId,\n        fileName: fileName,\n        fileType: fileType,\n        sourceUrl: sourceUrl,\n        \n        metadata: {\n          id: fileId,\n          title: fileName,\n          file_type: fileType,\n          url: sourceUrl,\n          schema: JSON.stringify(headers),\n          total_rows: rows.length,\n          text_content: fullTextContent\n        },\n        \n        rows: cleanedRows,\n        headers: headers,\n        textContent: fullTextContent,\n        \n        totalRows: rows.length,\n        totalColumns: headers.length,\n        uniqueTextValues: uniqueTexts.size,\n        \n        originalTable: originalBody.table || 'knowledge_base',\n        originalMode: originalBody.mode || 'append'\n      }\n    });\n    \n    console.log(`ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°: ${fileName}, ${rows.length} ÑÑ‚Ñ€Ð¾Ðº`);\n    \n  } else if (items.length === 1 && Array.isArray(items[0].json)) {\n    // ÐžÐ´Ð¸Ð½ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ñ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼ - ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚\n    const rows = items[0].json;\n    // ... Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° ÐºÐ°Ðº Ð±Ñ‹Ð»Ð°\n  }\n}\n\nif (processedTables.length === 0) {\n  console.log(\"ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸\");\n  throw new Error(\"No table data to process\");\n}\n\nconsole.log(`Ð’ÑÐµÐ³Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†: ${processedTables.length}`);\nreturn processedTables;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        816
      ],
      "id": "a235828c-0502-4891-a1bc-aeac4c088554",
      "name": "Process Table Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO document_metadata (id, title, file_type, url, schema, total_rows, text_content)\nVALUES ($1, $2, $3, $4, $5::jsonb, $6, $7)\nON CONFLICT (id) DO UPDATE SET\n  title = EXCLUDED.title,\n  file_type = EXCLUDED.file_type,\n  url = EXCLUDED.url,\n  schema = EXCLUDED.schema,\n  total_rows = EXCLUDED.total_rows,\n  text_content = EXCLUDED.text_content,\n  created_at = NOW()\nRETURNING *;",
        "options": {
          "queryReplacement": "=[\n  \"{{ $json.fileId }}\",\n  \"{{ $json.fileName }}\",\n  \"{{ $json.fileType }}\",\n  \"{{ $json.sourceUrl || null }}\",\n  \"{{ $json.metadata.schema }}\",\n  {{ $json.totalRows }},\n  \"{{ $json.textContent }}\"\n]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2752,
        864
      ],
      "id": "ae3094ac-af39-466a-ae67-379436d89bf2",
      "name": "Save Table Metadata",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "rows",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        3184,
        704
      ],
      "id": "ece4f73d-6cd5-4a7b-be1e-b5feea903df0",
      "name": "Split Table Rows"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO document_rows (dataset_id, row_number, row_data)\nVALUES ($1, $2, $3::jsonb)\nON CONFLICT DO NOTHING\nRETURNING id;",
        "options": {
          "queryReplacement": "=[\n  \"{{ $('Pass Table Data').item.json.fileId }}\",\n  {{ $itemIndex + 1 }},\n  \"{{ JSON.stringify($json).replace(/'/g, \"''\") }}\"\n]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3456,
        704
      ],
      "id": "df8f4ae3-7fc1-490f-b996-2810545bc7dd",
      "name": "Save Table Rows",
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹\nconst input = $input.first().json;\nconst metadata = $('Pass Table Data').item.json;\n\nreturn [{\n  json: {\n    success: true,\n    type: 'table',\n    message: `Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° \"${metadata.fileName}\" Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°: ${metadata.totalRows} ÑÑ‚Ñ€Ð¾Ðº`,\n    fileId: metadata.fileId,\n    fileName: metadata.fileName,\n    totalRows: metadata.totalRows,\n    totalColumns: metadata.totalColumns,\n    table: metadata.originalTable,\n    mode: metadata.originalMode\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3184,
        864
      ],
      "id": "f8cde010-c279-4853-8213-7e307e4a377c",
      "name": "Table Process Complete"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ ÑƒÐ·Ð»Ð° (Save Table Metadata)\nconst inputItems = $input.all();\nconst inputData = inputItems[0].json;\n\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð´Ð°Ð½Ð½Ñ‹Ñ…\nlet sourceData;\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¿Ñ€Ð¸ÑˆÐ»Ð¸ Ð»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÑ‚ÐºÑƒ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ\ntry {\n  // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Pass Data After Delete\n  const deleteData = $('Pass Data After Delete').all();\n  if (deleteData && deleteData.length > 0 && deleteData[0].json.deletionCompleted) {\n    // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸ÑˆÐ»Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÑ‚ÐºÑƒ TRUE (ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ)\n    sourceData = deleteData[0].json;\n  }\n} catch (e) {\n  // Pass Data After Delete Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ»ÑÑ\n}\n\n// Ð•ÑÐ»Ð¸ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Pass Data After Delete, Ð±ÐµÑ€ÐµÐ¼ Ð¾Ñ‚ Pass Original Table Data\nif (!sourceData) {\n  try {\n    const originalData = $('Pass Original Table Data').all();\n    if (originalData && originalData.length > 0) {\n      // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸ÑˆÐ»Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÑ‚ÐºÑƒ FALSE\n      sourceData = originalData[0].json;\n    }\n  } catch (e) {\n    // Pass Original Table Data Ñ‚Ð¾Ð¶Ðµ Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ»ÑÑ\n  }\n}\n\n// Ð•ÑÐ»Ð¸ Ð²ÑÐµ ÐµÑ‰Ðµ Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð±ÐµÑ€ÐµÐ¼ Ð¸Ð· Process Table Data\nif (!sourceData) {\n  sourceData = $('Process Table Data').item.json;\n}\n\n// Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ Ñ„Ð»Ð°Ð³Ð¾Ð¼ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ…\nreturn [{\n  json: {\n    ...sourceData,\n    metadataSaved: true,\n    metadataId: inputData.id || sourceData.fileId\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2944,
        848
      ],
      "id": "0c46cefd-4aca-4b06-8540-3f2cc131527a",
      "name": "Pass Table Data"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ñ‚Ð°Ð±Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð²ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸\nconst data = $input.first().json;\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾\nif (!data.textContent || data.textContent.length < 10) {\n  return []; // ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ‚ÐµÐºÑÑ‚Ð°\n}\n\n// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð²ÐµÐºÑ‚Ð¾Ñ€Ð½Ð¾Ð¹ Ð±Ð°Ð·Ñ‹\nreturn [{\n  json: {\n    content: data.textContent,\n    metadata: {\n      type: 'spreadsheet',\n      source_type: 'table',\n      file_id: data.fileId,\n      file_name: data.fileName,\n      file_type: data.fileType,\n      columns: data.headers.join(', '),\n      total_rows: data.totalRows,\n      total_columns: data.totalColumns,\n      unique_text_values: data.uniqueTextValues,\n      table: data.originalTable || 'knowledge_base',\n      created_at: new Date().toISOString()\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3184,
        1008
      ],
      "id": "7bf14615-c1a3-4f81-ae5b-cd4a991c9dbd",
      "name": "Vectorize Table"
    },
    {
      "parameters": {},
      "id": "48606489-da34-45ef-aea9-a2989ca05f1b",
      "name": "Google Gemini Embeddings1",
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        4048,
        1552
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        4144,
        1712
      ],
      "id": "fe13f801-ad02-422b-8874-3b5f0a343e50",
      "name": "Recursive Character Text Splitter1"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "={{ $json.metadata.table }}",
          "mode": ""
        },
        "embeddingBatchSize": 400,
        "options": {}
      },
      "id": "6e189449-6c28-4636-b384-a8b036982a3b",
      "name": "Insert Table to Supabase",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        4144,
        1376
      ],
      "credentials": {
        "supabaseApi": {
          "id": "7ldcSWe5TTPVh3zH",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.content }}",
        "textSplittingMode": "custom",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "table",
                "value": "={{ $json.metadata.table }}"
              },
              {
                "name": "file_id",
                "value": "={{ $json.metadata.file_id || '' }}"
              },
              {
                "name": "file_name",
                "value": "={{ $json.metadata.file_name || '' }}"
              },
              {
                "name": "type",
                "value": "={{ $json.metadata.type || 'spreadsheet' }}"
              },
              {
                "name": "file_type",
                "value": "={{ $json.metadata.file_type || 'xlsx' }}"
              },
              {
                "name": "total_rows",
                "value": "={{ $json.metadata.total_rows || 0 }}"
              },
              {
                "name": "columns",
                "value": "={{ $json.metadata.columns || '' }}"
              }
            ]
          }
        }
      },
      "id": "656582e8-eeec-4423-bf7a-a84c058bd09b",
      "name": "Default Data Loader Table",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        4192,
        1568
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  id, \n  COALESCE(content, '') as content,\n  COALESCE(metadata, '{}'::jsonb) as metadata,\n  created_at \nFROM {{ $json.body.table }} \nORDER BY id ASC",
        "options": {}
      },
      "id": "3d3a9c8d-23cf-4aa3-9d94-2c56c1a4b0f4",
      "name": "Read from Postgres",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1120,
        304
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°\nconst items = $input.all();\nconst tableName = $('Webhook1').item.json.body.table;\n\n// Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÑÐµ Ð·Ð°Ð¿Ð¸ÑÐ¸\nconst formattedResults = items.map(item => ({\n  id: item.json.id,\n  content: item.json.content,\n  metadata: item.json.metadata,\n  created_at: item.json.created_at\n}));\n\n// Ð’Ð°Ð¶Ð½Ð¾: Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ°Ðº ÐµÐ´Ð¸Ð½Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚, Ð½Ð¾ Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼\nreturn [{\n  json: {\n    success: true,\n    table: tableName,\n    total_records: formattedResults.length,\n    records: formattedResults,\n    raw_count: items.length // Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸\n  }\n}];"
      },
      "id": "f990591f-e5a8-41b4-bad9-1289513fb80a",
      "name": "Format Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -912,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð´Ð»Ñ Ñ‡Ð¸Ñ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ\nconst input = $input.first().json;\nconst tableName = input.table;\nconst records = input.records || [];\n\n// Ð£Ð¶Ðµ Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¿Ð¾ id ASC Ð¸Ð· Ð±Ð°Ð·Ñ‹, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼\nconst formattedRecords = records.map((record, index) => {\n  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð° Ð¿ÑƒÑÑ‚Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ\n  const contentDisplay = record.content || '[ÐŸÑƒÑÑ‚Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ]';\n  \n  return {\n    number: index + 1,\n    content: contentDisplay,\n    id: record.id,\n    created_at: new Date(record.created_at).toLocaleString('ru-RU')\n  };\n});\n\n// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ - Ð£ÐŸÐ ÐžÐ©Ð•ÐÐÐ«Ð™ Ð¤ÐžÐ ÐœÐÐ¢\nconst textOutput = formattedRecords.map(record => \n  `Ð—Ð°Ð¿Ð¸ÑÑŒ #${record.number} (ID: ${record.id})\\n${record.content}`\n).join('\\n\\n');\n\nreturn [{\n  json: {\n    success: true,\n    table: tableName,\n    total_records: formattedRecords.length,\n    records: formattedRecords,\n    formatted_text: textOutput\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        304
      ],
      "id": "bbdd520e-4742-41b0-930d-774627e35e2f",
      "name": "Format for Display"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "read-vector-base",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "a8636dd0-5b4f-4414-a28d-6ea900de0baf",
      "name": "Webhook1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1808,
        384
      ],
      "webhookId": "15c9b3da-a4cf-4b6e-9cbc-e7debcca6825"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "147e554d-f810-44fd-a4e4-98c93fcdd270",
      "name": "Respond to Webhook1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -512,
        464
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        -464,
        1488
      ],
      "id": "9b32daa6-9c30-42cf-9334-0ece90018e94",
      "name": "Error Trigger"
    },
    {
      "parameters": {
        "jsCode": "// Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐ«Ð™ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜Ðš ÐžÐ¨Ð˜Ð‘ÐžÐš v2.0\n// Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ Ð»ÑŽÐ±Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ñ‚ Error Trigger\n\nconst input = $input.first().json;\n\n// Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð² Error Trigger\nlet errorInfo = {};\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹\nif (input.execution) {\n  // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ execution (ÐºÐ°Ðº Ð² Ð²Ð°ÑˆÐµÐ¼ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ðµ)\n  errorInfo = {\n    workflowName: input.workflow?.name || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ workflow',\n    workflowId: input.workflow?.id || 'unknown',\n    executionId: input.execution?.id || 'unknown',\n    executionUrl: input.execution?.url || '',\n    failedNode: input.execution?.error?.node?.name || input.execution?.lastNodeExecuted || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ ÑƒÐ·ÐµÐ»',\n    nodeType: input.execution?.error?.node?.type || 'unknown',\n    errorMessage: input.execution?.error?.message || input.execution?.error?.description || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð±ÐµÐ· Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ',\n    errorStack: input.execution?.error?.stack || '',\n    timestamp: input.execution?.error?.timestamp || Date.now()\n  };\n} else if (input.error) {\n  // ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ error\n  errorInfo = {\n    workflowName: input.workflow || $workflow.name || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ workflow',\n    workflowId: $workflow.id || 'unknown',\n    executionId: $execution.id || 'unknown',\n    executionUrl: '',\n    failedNode: input.node || input.error.node || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ ÑƒÐ·ÐµÐ»',\n    nodeType: input.nodeType || 'unknown',\n    errorMessage: input.error.message || input.error || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð±ÐµÐ· Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ',\n    errorStack: input.error.stack || '',\n    timestamp: Date.now()\n  };\n} else {\n  // Fallback Ð´Ð»Ñ Ð»ÑŽÐ±Ð¾Ð³Ð¾ Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°\n  errorInfo = {\n    workflowName: $workflow.name || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ workflow',\n    workflowId: $workflow.id || 'unknown',\n    executionId: $execution.id || 'unknown',\n    executionUrl: '',\n    failedNode: input.node || input.nodeName || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ ÑƒÐ·ÐµÐ»',\n    nodeType: 'unknown',\n    errorMessage: input.message || JSON.stringify(input).substring(0, 500),\n    errorStack: '',\n    timestamp: Date.now()\n  };\n}\n\n// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ\nconst errorTime = new Date(errorInfo.timestamp).toLocaleString('ru-RU');\n\n// Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐ«Ð™ ÐÐÐÐ›Ð˜Ð—ÐÐ¢ÐžÐ  ÐžÐ¨Ð˜Ð‘ÐžÐš\n// Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´Ð»Ñ Ð»ÑŽÐ±Ð¾Ð³Ð¾ workflow\nlet errorCategory = 'ðŸ”§ Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°';\nlet recommendation = '';\nlet priority = 'ðŸŸ¡ Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹';\n\n// ÐÐ½Ð°Ð»Ð¸Ð· Ð¿Ð¾ Ñ‚ÐµÐºÑÑ‚Ñƒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ (ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹)\nconst errorLower = errorInfo.errorMessage.toLowerCase();\n\n// Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…\nif (errorLower.includes('relation') && errorLower.includes('does not exist')) {\n  errorCategory = 'ðŸ—„ï¸ Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð² Ð‘Ð”';\n  recommendation = `Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° \"${errorInfo.errorMessage.match(/\"([^\"]+)\"/)?.[1] || 'Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ'}\" Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ ÐµÑ‘ Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ.`;\n  priority = 'ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹';\n}\nelse if (errorLower.includes('column') && errorLower.includes('does not exist')) {\n  errorCategory = 'ðŸ—„ï¸ ÐšÐ¾Ð»Ð¾Ð½ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð² Ð‘Ð”';\n  recommendation = `ÐšÐ¾Ð»Ð¾Ð½ÐºÐ° Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð‘Ð”.`;\n  priority = 'ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹';\n}\nelse if (errorLower.includes('postgres') || errorLower.includes('sql')) {\n  errorCategory = 'ðŸ—„ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° PostgreSQL';\n  recommendation = 'ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð”';\n  priority = 'ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹';\n}\n// Ð¡ÐµÑ‚ÑŒ Ð¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ\nelse if (errorLower.includes('econnrefused')) {\n  errorCategory = 'ðŸ”Œ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½';\n  recommendation = 'Ð¡ÐµÑ€Ð²ÐµÑ€ Ð¾Ñ‚ÐºÐ»Ð¾Ð½Ð¸Ð» ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾ ÑÐµÑ€Ð²Ð¸Ñ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½.';\n  priority = 'ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹';\n}\nelse if (errorLower.includes('timeout') || errorLower.includes('etimedout')) {\n  errorCategory = 'â±ï¸ ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ';\n  recommendation = 'ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð½ÑÐ»Ð° ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸. Ð£Ð²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÐµÑ€Ð²ÐµÑ€.';\n  priority = 'ðŸŸ  Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹';\n}\nelse if (errorLower.includes('404') || errorLower.includes('not found')) {\n  errorCategory = 'ðŸ” Ð ÐµÑÑƒÑ€Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½';\n  recommendation = 'ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ URL Ð¸Ð»Ð¸ Ð¿ÑƒÑ‚Ð¸ Ðº Ñ€ÐµÑÑƒÑ€ÑÑƒ.';\n  priority = 'ðŸŸ  Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹';\n}\n// API Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ\nelse if (errorLower.includes('unauthorized') || errorLower.includes('401')) {\n  errorCategory = 'ðŸ”‘ ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸';\n  recommendation = 'ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ API ÐºÐ»ÑŽÑ‡Ð¸ Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°.';\n  priority = 'ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹';\n}\nelse if (errorLower.includes('rate limit') || errorLower.includes('quota')) {\n  errorCategory = 'ðŸš« ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½ Ð»Ð¸Ð¼Ð¸Ñ‚ API';\n  recommendation = 'Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½ÑƒÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð². ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ Ð¸Ð»Ð¸ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹.';\n  priority = 'ðŸŸ  Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹';\n}\n// Ð”Ð°Ð½Ð½Ñ‹Ðµ\nelse if (errorLower.includes('undefined') || errorLower.includes('cannot read')) {\n  errorCategory = 'âš ï¸ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ';\n  recommendation = 'Ð£Ð·ÐµÐ» Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» Ð¿ÑƒÑÑ‚Ñ‹Ðµ Ð¸Ð»Ð¸ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ ÑƒÐ·Ð»Ñ‹.';\n  priority = 'ðŸŸ  Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹';\n}\nelse if (errorLower.includes('json') || errorLower.includes('parse')) {\n  errorCategory = 'ðŸ“ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…';\n  recommendation = 'ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ JSON. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ….';\n  priority = 'ðŸŸ  Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹';\n}\n// AI\nelse if (errorLower.includes('gemini') || errorLower.includes('openai') || errorLower.includes('anthropic')) {\n  errorCategory = 'ðŸ¤– ÐžÑˆÐ¸Ð±ÐºÐ° AI ÑÐµÑ€Ð²Ð¸ÑÐ°';\n  recommendation = 'ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ API ÐºÐ»ÑŽÑ‡, Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ðº AI.';\n  priority = 'ðŸŸ  Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹';\n}\n\n// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ\nconst message = `${priority} *ÐžÐ¨Ð˜Ð‘ÐšÐ Ð’ WORKFLOW*\n\n${errorCategory}\n\nðŸ“‹ *Workflow:* ${errorInfo.workflowName}\nâŒ *Ð¡Ð±Ð¾Ð¹Ð½Ñ‹Ð¹ ÑƒÐ·ÐµÐ»:* ${errorInfo.failedNode}\nâ° *Ð’Ñ€ÐµÐ¼Ñ:* ${errorTime}\n\nðŸ“ *ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸:*\n\\`\\`\\`\n${errorInfo.errorMessage.substring(0, 500)}\n\\`\\`\\`\n\nðŸ’¡ *Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ:* \n${recommendation || 'Ð˜Ð·ÑƒÑ‡Ð¸Ñ‚Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð² Ð»Ð¾Ð³Ð°Ñ… n8n'}\n\nðŸ” *ÐšÐ°Ðº Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ:*\n1. ${errorInfo.executionUrl ? `ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ: ${errorInfo.executionUrl}` : `ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ n8n â†’ Executions â†’ ID: ${errorInfo.executionId}`}\n2. ÐšÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð½Ð° ÑƒÐ·ÐµÐ» \"${errorInfo.failedNode}\"\n3. ${recommendation ? 'ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑŽ Ð²Ñ‹ÑˆÐµ' : 'Ð˜Ð·ÑƒÑ‡Ð¸Ñ‚Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸'}\n\nðŸ“Š *Ð”ÐµÑ‚Ð°Ð»Ð¸:*\n- Workflow ID: \\`${errorInfo.workflowId}\\`\n- Execution ID: \\`${errorInfo.executionId}\\`\n- Ð¢Ð¸Ð¿ ÑƒÐ·Ð»Ð°: ${errorInfo.nodeType}`;\n\n// Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸\nconsole.log('Error processed:', {\n  workflow: errorInfo.workflowName,\n  node: errorInfo.failedNode,\n  error: errorInfo.errorMessage\n});\n\nreturn [{\n  json: {\n    message: message,\n    parse_mode: 'Markdown',\n    priority: priority,\n    error_details: errorInfo\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -256,
        1488
      ],
      "id": "8b05e829-b16f-4331-8ea3-95dbe95f97a1",
      "name": "Format Error Message"
    },
    {
      "parameters": {
        "chatId": "-1002588885971",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "={{ $json.parse_mode }}"
        }
      },
      "id": "b44ee13a-932c-4e27-a2a6-fcb59fcfc408",
      "name": "Error Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -64,
        1488
      ],
      "webhookId": "95289c60-3387-4996-8ec5-82ef2d620a80",
      "credentials": {
        "telegramApi": {
          "id": "fn7ywFo6SxQJtPcU",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// Ð•Ð”Ð˜ÐÐÐ¯ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ API ÐšÐ›Ð®Ð§Ð Ð¡ RATE LIMITING\n// ============================================\n\n// ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 30;\n\n// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// ============================================\n// RATE LIMITING\n// ============================================\nconst staticData = $getWorkflowStaticData('global');\n\nif (!staticData.rateLimits) {\n  staticData.rateLimits = {};\n}\n\n// ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ð¼Ð¸Ñ‚Ð°\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  \n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{\n      json: {\n        success: false,\n        error: 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²',\n        details: `ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½ Ð»Ð¸Ð¼Ð¸Ñ‚: ${RATE_LIMIT_MAX_REQUESTS} Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ`,\n        status: 429,\n        retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000),\n        timestamp: new Date().toISOString(),\n        authorized: false\n      }\n    }];\n  }\n}\n\n// ============================================\n// ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ API ÐšÐ›Ð®Ð§Ð\n// ============================================\nlet providedKey = headers['x-api-key'] || body.apiKey || inputData.query?.apiKey || '';\n\nconst mode = body.mode || 'append';\nconst table = body.table || 'knowledge_base';\nconst editId = body.editId || null;\n\nif (!providedKey) {\n  return [{\n    json: {\n      success: false,\n      error: 'API ÐºÐ»ÑŽÑ‡ Ð½Ðµ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½',\n      details: 'Ð”Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð»ÑŽÐ±Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ API ÐºÐ»ÑŽÑ‡',\n      status: 401,\n      mode: mode,\n      table: table,\n      timestamp: new Date().toISOString(),\n      authorized: false\n    }\n  }];\n}\n\nif (providedKey !== API_KEY) {\n  return [{\n    json: {\n      success: false,\n      error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ API ÐºÐ»ÑŽÑ‡',\n      details: 'ÐŸÑ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ API ÐºÐ»ÑŽÑ‡ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½',\n      status: 401,\n      mode: mode,\n      table: table,\n      timestamp: new Date().toISOString(),\n      authorized: false\n    }\n  }];\n}\n\n// ============================================\n// Ð’ÐÐ›Ð˜Ð”ÐÐ¦Ð˜Ð¯ Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð«\n// ============================================\nconst ALLOWED_TABLES = [\n  'lead_qualification',\n  'knowledge_base_en',\n  'sales_strategies_en',\n  'contact_capture_en',\n  'conversation_scenarios_en',\n  'communication_style_en',\n  'interaction_policies_en',\n  'knowledge_base',\n  'sales_strategies', \n  'contact_capture',\n  'conversation_scenarios',\n  'communication_style',\n  'interaction_policies',\n  'documents'\n];\n\nif (!ALLOWED_TABLES.includes(table)) {\n  return [{\n    json: {\n      success: false,\n      error: `ÐÐµÐ´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°: ${table}`,\n      details: `Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹: ${ALLOWED_TABLES.join(', ')}`,\n      status: 400,\n      mode: mode,\n      timestamp: new Date().toISOString(),\n      authorized: false\n    }\n  }];\n}\n\n// ============================================\n// ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ˜ Ð”Ð›Ð¯ Ð ÐÐ—ÐÐ«Ð¥ Ð Ð•Ð–Ð˜ÐœÐžÐ’\n// ============================================\nif (mode === 'delete' || mode === 'edit') {\n  if (!editId || isNaN(parseInt(editId)) || parseInt(editId) <= 0) {\n    return [{\n      json: {\n        success: false,\n        error: `ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ ID Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ ${mode}`,\n        details: 'ID Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼',\n        status: 400,\n        mode: mode,\n        table: table,\n        timestamp: new Date().toISOString(),\n        authorized: false\n      }\n    }];\n  }\n}\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° (ÐºÑ€Ð¾Ð¼Ðµ delete)\nif (mode !== 'delete' && !body.content && !body.files && !body.urls) {\n  return [{\n    json: {\n      success: false,\n      error: 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸',\n      details: 'ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚, Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð»Ð¸ URL',\n      status: 400,\n      mode: mode,\n      table: table,\n      timestamp: new Date().toISOString(),\n      authorized: false\n    }\n  }];\n}\n\n// ============================================\n// Ð£Ð¡ÐŸÐ•Ð¥\n// ============================================\nreturn [{\n  json: {\n    ...inputData,\n    body: {\n      ...body,\n      apiKey: providedKey,\n      authorized: true\n    },\n    authorized: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1616,
        944
      ],
      "id": "7abf109f-50ce-4353-9cd8-fe2c6302e0aa",
      "name": "API Authorization Check"
    },
    {
      "parameters": {
        "jsCode": "// Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸\nconst error = $input.first().json;\n\nreturn [{\n  json: {\n    success: false,\n    message: error.error || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸',\n    details: error.details || '',\n    status: error.status || 401,\n    operation: {\n      mode: error.mode,\n      table: error.table,\n      editId: error.editId\n    },\n    timestamp: error.timestamp || new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        1120
      ],
      "id": "1685e444-9f70-4073-98a6-916480733036",
      "name": "Universal Auth Error"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec520a04-3b3e-4198-830c-b65b3d2e03d1",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": " true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1392,
        944
      ],
      "id": "fd958a6f-2d62-4d01-86bf-8327f3cfdec1",
      "name": "API Authorization Check2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec520a04-3b3e-4198-830c-b65b3d2e03d1",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": " true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1392,
        384
      ],
      "id": "094c22fb-1982-49d6-bc9d-dcb808a66b15",
      "name": "API Authorization Check1"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ API ÐšÐ›Ð®Ð§Ð Ð¡ RATE LIMITING\n// ============================================\n\n// ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 30;\n\n// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// ============================================\n// RATE LIMITING\n// ============================================\nconst staticData = $getWorkflowStaticData('global');\n\nif (!staticData.rateLimits) {\n  staticData.rateLimits = {};\n}\n\n// ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ð¼Ð¸Ñ‚Ð°\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  \n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{\n      json: {\n        success: false,\n        error: 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²',\n        details: `ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½ Ð»Ð¸Ð¼Ð¸Ñ‚: ${RATE_LIMIT_MAX_REQUESTS} Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ`,\n        status: 429,\n        retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000),\n        timestamp: new Date().toISOString(),\n        authorized: false\n      }\n    }];\n  }\n}\n\n// ============================================\n// ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ API ÐšÐ›Ð®Ð§Ð\n// ============================================\nlet providedKey = headers['x-api-key'] || body.apiKey || inputData.query?.apiKey || '';\n\nconst table = body.table || 'knowledge_base';\nconst tables = table.includes(',') ? table.split(',').map(t => t.trim()) : [table];\n\nif (!providedKey) {\n  return [{\n    json: {\n      success: false,\n      error: 'API ÐºÐ»ÑŽÑ‡ Ð½Ðµ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½',\n      details: 'Ð”Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ API ÐºÐ»ÑŽÑ‡',\n      status: 401,\n      table: table,\n      timestamp: new Date().toISOString(),\n      authorized: false\n    }\n  }];\n}\n\nif (providedKey !== API_KEY) {\n  return [{\n    json: {\n      success: false,\n      error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ API ÐºÐ»ÑŽÑ‡',\n      details: 'ÐŸÑ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ API ÐºÐ»ÑŽÑ‡ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½',\n      status: 401,\n      table: table,\n      timestamp: new Date().toISOString(),\n      authorized: false\n    }\n  }];\n}\n\n// ============================================\n// Ð’ÐÐ›Ð˜Ð”ÐÐ¦Ð˜Ð¯ Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð«\n// ============================================\nconst ALLOWED_TABLES = [\n  'knowledge_base_en',\n  'lead_qualification',\n  'sales_strategies_en',\n  'contact_capture_en',\n  'conversation_scenarios_en',\n  'communication_style_en',\n  'interaction_policies_en',\n  'knowledge_base',\n  'sales_strategies', \n  'contact_capture',\n  'conversation_scenarios',\n  'communication_style',\n  'interaction_policies',\n  'documents'\n];\n\nconst invalidTables = tables.filter(t => !ALLOWED_TABLES.includes(t));\n\nif (invalidTables.length > 0) {\n  return [{\n    json: {\n      success: false,\n      error: `ÐÐµÐ´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹: ${invalidTables.join(', ')}`,\n      details: `Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹: ${ALLOWED_TABLES.join(', ')}`,\n      status: 400,\n      table: table,\n      requested_tables: tables,\n      timestamp: new Date().toISOString(),\n      authorized: false\n    }\n  }];\n}\n\n// ============================================\n// Ð£Ð¡ÐŸÐ•Ð¥\n// ============================================\nreturn [{\n  json: {\n    ...inputData,\n    body: {\n      ...body,\n      apiKey: providedKey,\n      authorized: true\n    },\n    authorized: true,\n    success: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1600,
        384
      ],
      "id": "1e7b170c-8a1b-4404-8d50-73b27ca7b93c",
      "name": "API Authorization Check3"
    },
    {
      "parameters": {
        "jsCode": "// Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸\nconst error = $input.first().json;\n\nreturn [{\n  json: {\n    success: false,\n    message: error.error || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸',\n    details: error.details || '',\n    status: error.status || 401,\n    operation: {\n      mode: error.mode,\n      table: error.table,\n      editId: error.editId\n    },\n    timestamp: error.timestamp || new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        464
      ],
      "id": "bb6b0181-5d99-4189-bc22-00e6c9699c5f",
      "name": "Universal Auth Error1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, title FROM document_metadata \n   WHERE title = '{{ $json.fileName }}' \n   OR id = '{{ $json.fileId }}'\n   LIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1488,
        816
      ],
      "id": "fe2dca65-d4ce-453e-80f6-38056fd2341d",
      "name": "Check Existing Table",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8e474418-7192-4a32-9fe6-5ac2f25ff9bf",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1648,
        816
      ],
      "id": "41acb52f-cdba-4dda-8ed9-e8cb76d818a3",
      "name": "Table Exists?"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ Ð¸Ð· Check Existing Table\nconst checkResult = $('Check Existing Table').item.json;\nconst originalTableData = $('Process Table Data').item.json;\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÐµÑÑ‚ÑŒ\nif (!checkResult || checkResult.length === 0) {\n  throw new Error(\"No existing table data found\");\n}\n\nconst existingTable = Array.isArray(checkResult) ? checkResult[0] : checkResult;\nconst tableId = existingTable.id || originalTableData.fileId;\n\nreturn [{\n  json: {\n    tableId: tableId,\n    tableName: originalTableData.originalTable || 'documents',\n    fileName: originalTableData.fileName,\n    originalData: originalTableData,\n    existingTableId: existingTable.id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1840,
        784
      ],
      "id": "61d104ab-fc93-434f-b3d4-8d8b4c8987ff",
      "name": "Delete Old Table Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM {{ $json.tableName }}\n   WHERE metadata->>'file_id' = '{{ $json.tableId }}'\n   OR metadata->>'file_name' = '{{ $json.fileName }}'\n   RETURNING id",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2048,
        544
      ],
      "id": "27d8c9b3-75c1-4053-aa7d-32b378654a1e",
      "name": "Delete from Documents",
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM document_rows\n   WHERE dataset_id = '{{ $json.tableId }}'\n   RETURNING id",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2048,
        720
      ],
      "id": "41a0f041-8904-46cc-a848-502238e21c6b",
      "name": "Delete Table Rows",
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM document_metadata\n   WHERE id = '{{ $json.tableId }}'\n   RETURNING id",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2048,
        880
      ],
      "id": "c02f82f8-6293-47e1-ae02-451b1bc9ba15",
      "name": "Delete Table Metadata",
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Process Table Data\nconst originalTableData = $('Process Table Data').item.json;\n\n// ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð»ÑŒÑˆÐµ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ\nreturn [{\n  json: {\n    ...originalTableData,\n    skipDelete: true,  // Ð¤Ð»Ð°Ð³ Ñ‡Ñ‚Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð½Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð»Ð¾ÑÑŒ\n    message: \"New table - no deletion needed\"\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1840,
        960
      ],
      "id": "4d97891b-9958-4018-b85e-50494891e1c1",
      "name": "Pass Original Table Data"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2288,
        784
      ],
      "id": "a58ce4fe-54d0-4fae-a1fe-df548ad781f5",
      "name": "Merge Delete Results"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾ÑÐ»Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð½Ð¾Ð²Ñ‹Ñ…\nconst deleteResults = $input.all();\n// Ð‘ÐµÑ€ÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· ÑƒÐ·Ð»Ð° Delete Old Table Data\nconst deleteNodeData = $('Delete Old Table Data').first().json;\nconst originalData = deleteNodeData.originalData;\n\n// ÐŸÐ¾Ð´ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹\nlet totalDeleted = 0;\ndeleteResults.forEach(result => {\n  if (result.json && Array.isArray(result.json)) {\n    totalDeleted += result.json.length;\n  } else if (result.json && result.json.id) {\n    totalDeleted += 1;\n  }\n});\n\nreturn [{\n  json: {\n    ...originalData,\n    deletionCompleted: true,\n    deletedRecords: totalDeleted,\n    message: \"Old data deleted, ready to save new\"\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2496,
        800
      ],
      "id": "d5a5f5f1-a5fe-4384-a13a-ff85cacab6b7",
      "name": "Pass Data After Delete"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ==========================================\n-- 1. Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð ÐœÐ•Ð¢ÐÐ”ÐÐÐÐ«Ð¥ Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢ÐžÐ’\n-- ==========================================\nCREATE TABLE IF NOT EXISTS {{ $json.table_metadata }} (\n    id VARCHAR PRIMARY KEY,\n    title VARCHAR NOT NULL,\n    file_type VARCHAR(10),\n    url VARCHAR,\n    schema JSONB,\n    total_rows INTEGER,\n    text_content TEXT,\n    vector_indexed BOOLEAN DEFAULT FALSE,\n    created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- ==========================================\n-- 2. Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð Ð”Ð›Ð¯ Ð¡Ð¢Ð ÐžÐš Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢ÐžÐ’\n-- ==========================================\nCREATE TABLE IF NOT EXISTS {{ $json.table_rows }} (\n    id SERIAL PRIMARY KEY,\n    dataset_id VARCHAR REFERENCES {{ $json.table_metadata }}(id) ON DELETE CASCADE,\n    row_number INTEGER,\n    row_data JSONB NOT NULL,\n    created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- ==========================================\n-- 3. Ð˜ÐÐ”Ð•ÐšÐ¡Ð« Ð”Ð›Ð¯ ÐŸÐ ÐžÐ˜Ð—Ð’ÐžÐ”Ð˜Ð¢Ð•Ð›Ð¬ÐÐžÐ¡Ð¢Ð˜\n-- ==========================================\nCREATE INDEX IF NOT EXISTS idx_{{ $json.table_rows }}_dataset \n  ON {{ $json.table_rows }}(dataset_id);\n  \nCREATE INDEX IF NOT EXISTS idx_{{ $json.table_rows }}_data \n  ON {{ $json.table_rows }} USING GIN(row_data);\n  \nCREATE INDEX IF NOT EXISTS idx_{{ $json.table_metadata }}_created \n  ON {{ $json.table_metadata }}(created_at);\n  \nCREATE INDEX IF NOT EXISTS idx_{{ $json.table_metadata }}_text \n  ON {{ $json.table_metadata }} USING GIN(to_tsvector('english', COALESCE(text_content, '')));\n\n-- ==========================================\n-- 4. Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð Ð”Ð›Ð¯ Ð’Ð¡Ð•Ð¥ Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢ÐžÐ’ (Ð’Ð•ÐšÐ¢ÐžÐ ÐÐ«Ð™ ÐŸÐžÐ˜Ð¡Ðš)\n-- ==========================================\nCREATE TABLE IF NOT EXISTS {{ $json.table_documents }} (\n  id BIGSERIAL PRIMARY KEY,\n  content TEXT NOT NULL,\n  metadata JSONB DEFAULT '{}',\n  embedding vector(768),\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- ==========================================\n-- 5. Ð˜ÐÐ”Ð•ÐšÐ¡Ð« Ð”Ð›Ð¯ Ð’Ð•ÐšÐ¢ÐžÐ ÐÐžÐ“Ðž ÐŸÐžÐ˜Ð¡ÐšÐ\n-- ==========================================\nCREATE INDEX IF NOT EXISTS idx_{{ $json.table_documents }}_embedding \n  ON {{ $json.table_documents }} USING ivfflat (embedding vector_cosine_ops) \n  WITH (lists = 100);\n  \nCREATE INDEX IF NOT EXISTS idx_{{ $json.table_documents }}_metadata \n  ON {{ $json.table_documents }} USING GIN (metadata);\n\n-- ==========================================\n-- 6. Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯ Ð”Ð›Ð¯ Ð’Ð•ÐšÐ¢ÐžÐ ÐÐžÐ“Ðž ÐŸÐžÐ˜Ð¡ÐšÐ\n-- ==========================================\nCREATE OR REPLACE FUNCTION public.match_{{ $json.table_documents }}(\n  filter jsonb,\n  match_count int, \n  query_embedding vector(768)\n)\nRETURNS TABLE (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\nBEGIN\n  RETURN QUERY\n  SELECT \n    d.id,\n    d.content,\n    d.metadata,\n    1 - (d.embedding <=> query_embedding) as similarity\n  FROM {{ $json.table_documents }} d\n  WHERE \n    CASE \n      WHEN filter IS NOT NULL THEN d.metadata @> filter\n      ELSE true\n    END\n  ORDER BY d.embedding <=> query_embedding\n  LIMIT match_count;\nEND;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1392,
        -128
      ],
      "id": "e53fe731-8c6a-4b60-8202-a6f2f337792d",
      "name": "CREATE TABLE EXEL",
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2b5d44ea-57a0-494f-a3bf-c96ae28b43cd",
              "name": "table_metadata",
              "value": "reports_metadata",
              "type": "string"
            },
            {
              "id": "0c87497c-95ad-4b47-a8fa-35dca9d0cec9",
              "name": "table_rows",
              "value": "reports_rows",
              "type": "string"
            },
            {
              "id": "bbd79ac9-e1ee-4934-95c7-e2d864a56f8b",
              "name": "table_documents",
              "value": "reports_documents",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1600,
        -128
      ],
      "id": "ba376f44-42f7-428b-ae25-cca238f2a94d",
      "name": "Table Config"
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ (Ð±ÐµÐ· AI Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸)\nconst inputData = $input.first().json;\nconst body = inputData.body || inputData;\n\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð´Ð°Ð½Ð½Ñ‹Ñ…\nlet rawContent = '';\nlet sourceType = '';\nlet fileName = 'text_content';\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ñ‚ÐºÑƒÐ´Ð° Ð¿Ñ€Ð¸ÑˆÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ\nif (inputData.extractedContent) {\n  // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Format File Data (Ñ„Ð°Ð¹Ð»Ñ‹)\n  rawContent = inputData.extractedContent;\n  sourceType = 'file';\n  fileName = inputData.fileName || 'uploaded_file';\n} else if (body.content || body.textContent) {\n  // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Prepare Data (Ñ‚ÐµÐºÑÑ‚)\n  rawContent = body.content || body.textContent || \"\";\n  sourceType = 'text';\n} else {\n  // Fallback\n  rawContent = JSON.stringify(inputData);\n  sourceType = 'unknown';\n}\n\n// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹\nconst table = body.table || inputData.originalTable || 'knowledge_base';\nconst mode = body.mode || inputData.originalMode || 'append';\n\nconsole.log(`Format Direct Content: source=${sourceType}, length=${rawContent.length}, table=${table}`);\n\n// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ‡Ð½ÑƒÑŽ Parse AI Response\nreturn [{\n  json: {\n    table: table,\n    documents: [{\n      content: rawContent,\n      metadata: {\n        category: \"general\",\n        created_at: new Date().toISOString(),\n        table: table,\n        mode: mode,\n        skipAI: true,\n        direct_load: true,\n        source_type: sourceType,\n        file_name: fileName,\n        content_length: rawContent.length\n      }\n    }],\n    mode: mode,\n    documentsCount: 1,\n    filesProcessed: 1\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3488,
        1264
      ],
      "id": "5b319865-4407-4ca9-8326-ce4766c71666",
      "name": "Format Direct Content"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2896,
        1376
      ],
      "id": "e167d4cf-e662-4737-bd46-a687bd2f474e",
      "name": "Merge1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1f9b4d1c-5557-401e-95c9-29e43bd15ab1",
              "leftValue": "={{ $json.body.skipAI === true && ($json.body.mode === 'append' || $json.body.mode === 'replace') }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3328,
        1376
      ],
      "id": "26977d89-c466-45b4-b1fa-446dcf88767b",
      "name": "Check Skip AI"
    },
    {
      "parameters": {
        "jsCode": "// Ð Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÐµÐ¼ Ñ„Ð»Ð°Ð³ skipAI Ð½Ð° Ð²ÑÐµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹\nconst items = $input.all();\nconst processedItems = [];\n\n// Ð˜Ñ‰ÐµÐ¼ skipAI Ð² ÑƒÐ·Ð»Ðµ Prepare Data\nlet skipAIFlag = false;\nconst prepareDataNode = $('Prepare Data');\nif (prepareDataNode && prepareDataNode.item && prepareDataNode.item.json) {\n  skipAIFlag = prepareDataNode.item.json.body?.skipAI || false;\n}\n\nconsole.log(`Propagate Skip AI: found skipAI=${skipAIFlag} from Prepare Data`);\n\n// ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹\nitems.forEach((item, index) => {\n  const json = item.json;\n  \n  // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð¾Ñ‚ Format File Data (Ð½ÐµÑ‚ body.skipAI)\n  if (!json.body || json.body.skipAI === undefined) {\n    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ skipAI Ð¸Ð· Prepare Data\n    processedItems.push({\n      json: {\n        ...json,\n        body: {\n          ...(json.body || {}),\n          skipAI: skipAIFlag,\n          mode: json.originalMode || json.body?.mode || 'append',\n          table: json.originalTable || json.body?.table || 'knowledge_base'\n        }\n      }\n    });\n    console.log(`Item ${index}: Added skipAI=${skipAIFlag} from Prepare Data`);\n  } else {\n    // Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚ ÑƒÐ¶Ðµ Ð¸Ð¼ÐµÐµÑ‚ skipAI (Ð¾Ñ‚ Prepare Data)\n    processedItems.push(item);\n    console.log(`Item ${index}: Already has skipAI=${json.body.skipAI}`);\n  }\n});\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3104,
        1376
      ],
      "id": "140046ad-b2cd-496b-a4b6-5826437af145",
      "name": "Propagate Skip AI"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Ð‘Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¾ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ðµ\nCREATE TABLE {{ $json.table_interaction }} (\n  id BIGSERIAL PRIMARY KEY,\n  content TEXT NOT NULL,\n  metadata JSONB DEFAULT '{}',\n  embedding vector(768),\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ° Ð´Ð»Ñ Ð²ÐµÐºÑ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ°\nCREATE INDEX ON {{ $json.table_interaction }} USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);\n\n-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²ÐµÐºÑ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ°\nCREATE OR REPLACE FUNCTION public.match_{{ $json.table_interaction }}(\n  filter jsonb,\n  match_count int, \n  query_embedding vector(768)\n)\nRETURNS TABLE (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\nBEGIN\n  RETURN QUERY\n  SELECT \n    kb.id,\n    kb.content,\n    kb.metadata,\n    1 - (kb.embedding <=> query_embedding) as similarity\n  FROM {{ $json.table_interaction }} kb\n  ORDER BY kb.embedding <=> query_embedding\n  LIMIT match_count;\nEND;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1376,
        48
      ],
      "id": "fcb53b19-4e05-4868-82bf-b1f4793ce963",
      "name": "CREATE TABLE",
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1808,
        48
      ],
      "id": "10791516-fa4d-475c-ad87-3b6551055285",
      "name": "CREATE TABLE1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "99a0428a-8f3a-4f3d-af56-01af8463f8aa",
              "name": "table_interaction",
              "value": "LEAD_QUALIFICATION",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1584,
        48
      ],
      "id": "ef36bb41-3d2a-4600-a63b-cdaa5fbf5ef7",
      "name": "Table Config t"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ai_learning_log ORDER BY created_at DESC LIMIT 200",
        "options": {}
      },
      "id": "445668c0-37ef-4354-b8ea-de3ac6eeade9",
      "name": "Get Learning Logs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1568,
        1488
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð²ÑÐµÑ… Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð²\nconst logs = $input.all();\n\n// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸\nconst stats = {\n  totalCycles: 0,\n  totalDialogs: 0,\n  approvedUpdates: 0,\n  rejectedUpdates: 0,\n  currentCycle: null,\n  recentUpdates: [],\n  dailyStats: [],\n  tableStats: {},\n  avgPriority: 0,\n  mostActiveTable: ''\n};\n\n// ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÑ‡ÐµÑ‚Ð°\nlet totalDialogs = 0;\nlet priorities = [];\nconst tableCount = {};\nlet cycleCount = 0;\nlet approvedCount = 0;\nlet rejectedCount = 0;\n\n// Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ†Ð¸ÐºÐ»\nlet lastCycle = null;\nlet hasCompletedRecord = false;\n\n// ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´ - ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð¸Ñ‰ÐµÐ¼ cycle_completed, Ð¿Ð¾Ñ‚Ð¾Ð¼ cycle_started\nlet completedSessions = new Set();\n\n// Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÑÐµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ðµ ÑÐµÑÑÐ¸Ð¸\nfor (const item of logs) {\n  const log = item.json;\n  if (log.type === 'cycle_completed') {\n    completedSessions.add(log.session_id);\n  }\n}\n\n// Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ†Ð¸ÐºÐ»\nfor (const item of logs) {\n  const log = item.json;\n  \n  // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ (Ð¾Ð½ Ð¶Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸) cycle_started\n  if (log.type === 'cycle_started' && !lastCycle) {\n    lastCycle = {\n      log: log,\n      metadata: typeof log.metadata === 'string' ? JSON.parse(log.metadata || '{}') : (log.metadata || {})\n    };\n    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ð»Ð¸ ÑÑ‚Ð¾Ñ‚ Ñ†Ð¸ÐºÐ»\n    hasCompletedRecord = completedSessions.has(log.session_id);\n    break; // ÐÐ°ÑˆÐ»Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ†Ð¸ÐºÐ», Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼\n  }\n}\n\n// Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ†Ð¸ÐºÐ» ÐµÑÐ»Ð¸ Ð½Ð°ÑˆÐ»Ð¸\nif (lastCycle) {\n  stats.currentCycle = {\n    status: hasCompletedRecord ? 'completed' : lastCycle.log.status,\n    startTime: lastCycle.log.created_at,\n    dialogs: 0,\n    totalDialogs: lastCycle.metadata.dialogs_to_analyze || 15,\n    workflowId: lastCycle.metadata.workflow_execution_id || 'N/A',\n    sessionId: lastCycle.log.session_id,\n    completionTime: null // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»Ðµ Ð´Ð»Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ\n  };\n  \n  // Ð•ÑÐ»Ð¸ Ñ†Ð¸ÐºÐ» Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½, Ð¸Ñ‰ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¸Ð· Ð·Ð°Ð¿Ð¸ÑÐ¸ cycle_completed\n  if (hasCompletedRecord) {\n    for (const item of logs) {\n      const log = item.json;\n      if (log.type === 'cycle_completed' && log.session_id === lastCycle.log.session_id) {\n        stats.currentCycle.completionTime = log.created_at;\n        // Ð¢Ð°ÐºÐ¶Ðµ Ð¼Ð¾Ð¶ÐµÐ¼ Ð²Ð·ÑÑ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð² Ð¸Ð· metadata ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ\n        if (log.metadata) {\n          try {\n            const completedMeta = typeof log.metadata === 'string' ? JSON.parse(log.metadata) : log.metadata;\n            if (completedMeta.dialogs_analyzed) {\n              stats.currentCycle.dialogs = parseInt(completedMeta.dialogs_analyzed) || 0;\n            }\n          } catch (e) {\n            // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð°\n          }\n        }\n        break;\n      }\n    }\n  }\n}\n\n// Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´ - ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ\nfor (const item of logs) {\n  const log = item.json;\n  \n  let metadata = {};\n  if (log.metadata) {\n    try {\n      metadata = typeof log.metadata === 'string' ? JSON.parse(log.metadata) : log.metadata;\n    } catch (e) {\n      metadata = {};\n    }\n  }\n  \n  // Ð”Ð°Ð»ÑŒÑˆÐµ Ð¸Ð´ÐµÑ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÐºÐ¾Ð´ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸...\n  \n  // ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚ Ñ†Ð¸ÐºÐ»Ð¾Ð²\n  if (log.type === 'cycle_started') {\n    cycleCount++;\n    totalDialogs += parseInt(metadata.dialogs_to_analyze) || 0;\n  }\n  \n  // ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹\n  if (log.type === 'approved_update') {\n    approvedCount++;\n    const update = {\n      time: log.created_at,\n      type: log.type,\n      action: log.action || 'unknown',\n      table: log.table_name || 'unknown',\n      status: log.status || 'applied',\n      priority: metadata.priority || null,\n      content: log.content || null,\n      reason: log.reason || null,  // Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž\n      problem_addressed: log.problem_addressed || null  // Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž\n    };\n    \n    stats.recentUpdates.push(update);\n    \n    if (metadata.priority) {\n      priorities.push(parseInt(metadata.priority));\n    }\n    \n    if (log.table_name) {\n      tableCount[log.table_name] = (tableCount[log.table_name] || 0) + 1;\n    }\n  }\n  \n  if (log.type === 'rejected_update') {\n    rejectedCount++;\n    const update = {\n      time: log.created_at,\n      type: log.type,\n      action: log.action || 'unknown',\n      table: log.table_name || 'unknown',\n      status: log.status || 'rejected',\n      priority: null,\n      content: log.content || null,\n      reason: log.reason || null,  // Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž\n      problem_addressed: log.problem_addressed || null  // Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž\n    };\n    \n    stats.recentUpdates.push(update);\n    \n    if (log.table_name) {\n      tableCount[log.table_name] = (tableCount[log.table_name] || 0) + 1;\n    }\n  }\n}\n\n// Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ\nstats.totalCycles = cycleCount;\nstats.totalDialogs = totalDialogs;\nstats.approvedUpdates = approvedCount;\nstats.rejectedUpdates = rejectedCount;\n\n// Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ€ÐµÐ´Ð½Ð¸Ð¹ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚\nif (priorities.length > 0) {\n  stats.avgPriority = Math.round(priorities.reduce((a, b) => a + b, 0) / priorities.length);\n}\n\n// ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ ÑÐ°Ð¼ÑƒÑŽ Ð°ÐºÑ‚Ð¸Ð²Ð½ÑƒÑŽ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ\nif (Object.keys(tableCount).length > 0) {\n  const sorted = Object.entries(tableCount).sort((a, b) => b[1] - a[1]);\n  stats.mostActiveTable = sorted[0][0];\n}\n\n// Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¿Ð¾ Ð´Ð½ÑÐ¼\nconst dayNames = ['Ð’Ñ', 'ÐŸÐ½', 'Ð’Ñ‚', 'Ð¡Ñ€', 'Ð§Ñ‚', 'ÐŸÑ‚', 'Ð¡Ð±'];\nconst today = new Date();\n\n// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð² Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… 7 Ð´Ð½ÐµÐ¹\nfor (let i = 6; i >= 0; i--) {\n  const date = new Date(today);\n  date.setDate(date.getDate() - i);\n  const dayName = dayNames[date.getDay()];\n  \n  // ÐŸÐ¾Ð´ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð° ÑÑ‚Ð¾Ñ‚ Ð´ÐµÐ½ÑŒ\n  let dayUpdates = 0;\n  let dayRejected = 0;\n  \n  const dayStart = new Date(date.setHours(0, 0, 0, 0));\n  const dayEnd = new Date(date.setHours(23, 59, 59, 999));\n  \n  for (const update of stats.recentUpdates) {\n    const updateDate = new Date(update.time);\n    if (updateDate >= dayStart && updateDate <= dayEnd) {\n      if (update.status === 'applied') dayUpdates++;\n      if (update.status === 'rejected') dayRejected++;\n    }\n  }\n  \n  stats.dailyStats.push({\n    date: dayName,\n    updates: dayUpdates,\n    rejected: dayRejected\n  });\n}\n\n// Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼\nfor (const [table, count] of Object.entries(tableCount)) {\n  if (!stats.tableStats[table]) {\n    stats.tableStats[table] = {\n      total: 0,\n      approved: 0,\n      rejected: 0\n    };\n  }\n  stats.tableStats[table].total = count;\n}\n\n// ÐŸÐ¾Ð´ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ approved/rejected Ð¿Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼\nfor (const update of stats.recentUpdates) {\n  if (update.table && stats.tableStats[update.table]) {\n    if (update.status === 'applied') {\n      stats.tableStats[update.table].approved++;\n    } else if (update.status === 'rejected') {\n      stats.tableStats[update.table].rejected++;\n    }\n  }\n}\n\n// ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹\nstats.recentUpdates = stats.recentUpdates.slice(0, 50);\n\n// Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ñ†Ð¸ÐºÐ»Ð°, ÑÑ‚Ð°Ð²Ð¸Ð¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ\nif (!stats.currentCycle) {\n  stats.currentCycle = {\n    status: 'completed',\n    startTime: new Date().toISOString(),\n    dialogs: 0,\n    totalDialogs: 0,\n    workflowId: 'N/A'\n  };\n}\n\n// Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚\nreturn {\n  success: true,\n  stats: stats,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "abac25e7-f518-4b46-abd1-a509e3adaf4f",
      "name": "Process Statistics",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        1568
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "condition_1",
                    "leftValue": "={{ $json.error }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Error"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "5b6ffd7b-00fc-47f5-9f1b-df8dc93e6481",
      "name": "Check for Errors",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -1376,
        1488
      ]
    },
    {
      "parameters": {
        "jsCode": "// Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ\nreturn {\n  success: false,\n  error: 'Failed to fetch statistics',\n  stats: {\n    totalCycles: 0,\n    totalDialogs: 0,\n    approvedUpdates: 0,\n    rejectedUpdates: 0,\n    currentCycle: null,\n    recentUpdates: [],\n    dailyStats: [],\n    tableStats: {}\n  }\n};"
      },
      "id": "7e704029-dc92-462f-a19c-9fd3b513cc69",
      "name": "Return Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        1408
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "12e41d34-6486-48e4-b72e-7ab2231e6047",
      "name": "Respond to Webhook2",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -928,
        1488
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "get-learning-stats",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "1831517b-c241-401c-a9e9-e9073e7d2f5c",
      "name": "Webhook2",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1744,
        1488
      ],
      "webhookId": "23185d3e-8d97-4d02-a46c-6fbfb27ee70e"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "API Authorization Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Mode": {
      "main": [
        [
          {
            "node": "Clear Table",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Prepare Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear Table": {
      "main": [
        [
          {
            "node": "Pass Data After Clear",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Prepare Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Data": {
      "main": [
        [
          {
            "node": "Has Files?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Record": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Files?": {
      "main": [
        [
          {
            "node": "Check Data Type",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Files": {
      "main": [
        [
          {
            "node": "Process File Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process File Content": {
      "main": [
        [
          {
            "node": "Switch File Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch File Type": {
      "main": [
        [
          {
            "node": "Extract PDF Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rename DOCX to ZIP",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fallback Extraction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract PDF Text": {
      "main": [
        [
          {
            "node": "Aggregate Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Text": {
      "main": [
        [
          {
            "node": "Aggregate Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fallback Extraction": {
      "main": [
        [
          {
            "node": "Aggregate Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Files": {
      "main": [
        [
          {
            "node": "Format File Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "Check Edit Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Edit Mode": {
      "main": [
        [
          {
            "node": "Prepare SQL for Update",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split Documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare SQL for Update": {
      "main": [
        [
          {
            "node": "Update Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Record": {
      "main": [
        [
          {
            "node": "Merge After Edit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Documents": {
      "main": [
        [
          {
            "node": "Insert to Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert to Supabase": {
      "main": [
        [
          {
            "node": "Merge After Edit",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Google Gemini Embeddings": {
      "ai_embedding": [
        [
          {
            "node": "Insert to Supabase",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Insert to Supabase",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Merge After Edit": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format File Data": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Rename DOCX to ZIP": {
      "main": [
        [
          {
            "node": "Compression",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compression": {
      "main": [
        [
          {
            "node": "Extract document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract document": {
      "main": [
        [
          {
            "node": "Extract Text from XML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Text from XML": {
      "main": [
        [
          {
            "node": "Aggregate Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Pass Data After Clear": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Data Type": {
      "main": [
        [
          {
            "node": "Split Files",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process URLs": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Download Files from URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Files from URLs": {
      "main": [
        [
          {
            "node": "Convert Downloaded to File Format",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Downloaded to File Format": {
      "main": [
        [
          {
            "node": "Process File Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Process Table Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "Process Table Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Table Data": {
      "main": [
        [
          {
            "node": "Check Existing Table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Table Metadata": {
      "main": [
        [
          {
            "node": "Pass Table Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Table Rows": {
      "main": [
        [
          {
            "node": "Save Table Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Table Process Complete": {
      "main": [
        [
          {
            "node": "Merge After Edit",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Pass Table Data": {
      "main": [
        [
          {
            "node": "Vectorize Table",
            "type": "main",
            "index": 0
          },
          {
            "node": "Split Table Rows",
            "type": "main",
            "index": 0
          },
          {
            "node": "Table Process Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vectorize Table": {
      "main": [
        [
          {
            "node": "Insert Table to Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Embeddings1": {
      "ai_embedding": [
        [
          {
            "node": "Insert Table to Supabase",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter1": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader Table",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Insert Table to Supabase": {
      "main": [
        [
          {
            "node": "Merge After Edit",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Default Data Loader Table": {
      "ai_document": [
        [
          {
            "node": "Insert Table to Supabase",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Read from Postgres": {
      "main": [
        [
          {
            "node": "Format Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Results": {
      "main": [
        [
          {
            "node": "Format for Display",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Display": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "API Authorization Check3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Trigger": {
      "main": [
        [
          {
            "node": "Format Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Error Message": {
      "main": [
        [
          {
            "node": "Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Authorization Check": {
      "main": [
        [
          {
            "node": "API Authorization Check2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Universal Auth Error": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Authorization Check2": {
      "main": [
        [
          {
            "node": "Switch Mode",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Universal Auth Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Authorization Check1": {
      "main": [
        [
          {
            "node": "Read from Postgres",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Universal Auth Error1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Authorization Check3": {
      "main": [
        [
          {
            "node": "API Authorization Check1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Universal Auth Error1": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Existing Table": {
      "main": [
        [
          {
            "node": "Table Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Table Exists?": {
      "main": [
        [
          {
            "node": "Delete Old Table Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pass Original Table Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Table Data": {
      "main": [
        [
          {
            "node": "Delete from Documents",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delete Table Rows",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delete Table Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete from Documents": {
      "main": [
        [
          {
            "node": "Merge Delete Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Table Rows": {
      "main": [
        [
          {
            "node": "Merge Delete Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Delete Table Metadata": {
      "main": [
        [
          {
            "node": "Merge Delete Results",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Pass Original Table Data": {
      "main": [
        [
          {
            "node": "Save Table Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Delete Results": {
      "main": [
        [
          {
            "node": "Pass Data After Delete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pass Data After Delete": {
      "main": [
        [
          {
            "node": "Save Table Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Table Config": {
      "main": [
        [
          {
            "node": "CREATE TABLE EXEL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Propagate Skip AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Skip AI": {
      "main": [
        [
          {
            "node": "Format Direct Content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Direct Content": {
      "main": [
        [
          {
            "node": "Split Documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Propagate Skip AI": {
      "main": [
        [
          {
            "node": "Check Skip AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CREATE TABLE1": {
      "main": [
        [
          {
            "node": "Table Config t",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Table Config t": {
      "main": [
        [
          {
            "node": "CREATE TABLE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Learning Logs": {
      "main": [
        [
          {
            "node": "Check for Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Statistics": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for Errors": {
      "main": [
        [
          {
            "node": "Return Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Statistics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Return Error": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook2": {
      "main": [
        [
          {
            "node": "Get Learning Logs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "30115c99-50a4-429f-9658-57897fc58fca",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "lJt2puFWBfSteZKx",
  "tags": []
}