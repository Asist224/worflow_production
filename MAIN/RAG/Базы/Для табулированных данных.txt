 Создайте таблицы PostgreSQL:

-- Таблица метаданных документов
CREATE TABLE IF NOT EXISTS document_metadata (
    id VARCHAR PRIMARY KEY,
    title VARCHAR NOT NULL,
    file_type VARCHAR(10),
    url VARCHAR,
    schema JSONB,
    total_rows INTEGER,
    text_content TEXT,
    vector_indexed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Таблица для строк документов
CREATE TABLE IF NOT EXISTS document_rows (
    id SERIAL PRIMARY KEY,
    dataset_id VARCHAR REFERENCES document_metadata(id) ON DELETE CASCADE,
    row_number INTEGER,
    row_data JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Индексы для производительности
CREATE INDEX idx_document_rows_dataset ON document_rows(dataset_id);
CREATE INDEX idx_document_rows_data ON document_rows USING GIN(row_data);
CREATE INDEX idx_document_metadata_created ON document_metadata(created_at);
CREATE INDEX idx_document_metadata_text ON document_metadata USING GIN(to_tsvector('english', COALESCE(text_content, '')));


Создайте таблицу и функцию в Supabase (вектор)

-- Таблица для всех документов (включая текстовые и таблицы)
CREATE TABLE documents (
  id BIGSERIAL PRIMARY KEY,
  content TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  embedding vector(768),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Индекс для векторного поиска
CREATE INDEX ON documents USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

-- Индекс для метаданных
CREATE INDEX idx_documents_metadata ON documents USING GIN (metadata);

-- Функция для векторного поиска
CREATE OR REPLACE FUNCTION public.match_documents(
  filter jsonb,
  match_count int, 
  query_embedding vector(768)
)
RETURNS TABLE (
  id bigint,
  content text,
  metadata jsonb,
  similarity float
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    d.id,
    d.content,
    d.metadata,
    1 - (d.embedding <=> query_embedding) as similarity
  FROM documents d
  WHERE 
    CASE 
      WHEN filter IS NOT NULL THEN d.metadata @> filter
      ELSE true
    END
  ORDER BY d.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;