{
  "name": "ğŸ” Auth API [Production EN]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ” Auth API\n\n### ğŸ“‹ Description\nAuthentication API for administrators and clients with JWT token generation.\n\n---\n\n### âš™ï¸ CONFIG (Chain 1 - Admin Auth)\n\n| Parameter | Description |\n|-----------|-------------|\n| `jwt_expires_hours` | Token expiration (hours) |\n| `table_admins` | Admins table |\n\n### âš™ï¸ CONFIG (Chain 2 - Client Auth)\n\n| Parameter | Description |\n|-----------|-------------|\n| `jwt_expires_days` | Token expiration (days) |\n| `table_clients` | Clients table |\n\n---\n\n### ğŸ”„ Chains\n1. POST /admin/auth - Admin authentication\n2. POST /client/auth - Client authentication",
        "height": 480,
        "width": 400,
        "color": 5
      },
      "id": "sticky-note-main",
      "name": "ğŸ“ Instructions",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-1600, -600]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "admin/auth",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-admin-auth",
      "name": "ğŸŒ Webhook: POST /admin/auth",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-1216, -400],
      "webhookId": "admin-auth-webhook"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "jwt-exp", "name": "jwt_expires_hours", "value": 24, "type": "number"},
            {"id": "table-admins", "name": "table_admins", "value": "admins", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-admin",
      "name": "âš™ï¸ CONFIG Admin",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-1016, -400]
    },
    {
      "parameters": {
        "jsCode": "const webhookData = $('ğŸŒ Webhook: POST /admin/auth').item.json;\nconst body = webhookData.body || {};\nconst username = body.username || '';\nconst password = body.password || '';\n\nif (!username || !password) {\n  return [{\n    json: {\n      error: true,\n      message: 'Username and password are required'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    username: username,\n    password: password,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "extract-admin",
      "name": "ğŸ“¥ Extract Credentials (Admin)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-816, -400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  id,\n  username,\n  password_hash,\n  role,\n  is_active,\n  last_login\nFROM {{ $('âš™ï¸ CONFIG Admin').first().json.table_admins }}\nWHERE username = '{{ $json.username }}'\n  AND is_active = true\nLIMIT 1;",
        "options": {}
      },
      "id": "check-admin-db",
      "name": "ğŸ˜ Find Admin",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [-616, -400],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "const adminData = $input.item.json;\nconst requestData = $('ğŸ“¥ Extract Credentials (Admin)').item.json;\n\nif (!adminData.username) {\n  return [{\n    json: {\n      success: false,\n      message: 'Invalid credentials',\n      authenticated: false\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    admin_id: adminData.id,\n    username: adminData.username,\n    password_hash: adminData.password_hash,\n    role: adminData.role,\n    input_password: requestData.password\n  }\n}];"
      },
      "id": "prepare-admin-check",
      "name": "ğŸ”„ Prepare Check (Admin)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-416, -400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  CASE \n    WHEN '{{ $json.password_hash }}' = crypt('{{ $json.input_password }}', '{{ $json.password_hash }}')\n    THEN true\n    ELSE false\n  END as password_valid;",
        "options": {}
      },
      "id": "verify-admin-password",
      "name": "ğŸ˜ Verify Password (Admin)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [-216, -400],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "const passwordCheck = $input.item.json;\nconst adminData = $('ğŸ”„ Prepare Check (Admin)').item.json;\n\nreturn [{\n  json: {\n    ...adminData,\n    password_valid: passwordCheck.password_valid\n  }\n}];"
      },
      "id": "merge-admin-results",
      "name": "ğŸ”€ Merge (Admin)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-16, -400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {
              "id": "password-ok",
              "leftValue": "={{ $json.password_valid }}",
              "rightValue": true,
              "operator": {"type": "boolean", "operation": "true"}
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-admin-auth",
      "name": "â“ Auth OK? (Admin)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [184, -400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE {{ $('âš™ï¸ CONFIG Admin').first().json.table_admins }} \nSET last_login = NOW()\nWHERE id = {{ $json.admin_id }}\nRETURNING id, username, role;",
        "options": {}
      },
      "id": "update-admin-login",
      "name": "ğŸ˜ Update last_login",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [384, -480],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "useJson": true,
        "claimsJson": "={\n  \"admin_id\": \"{{ $('ğŸ”€ Merge (Admin)').item.json.admin_id }}\",\n  \"username\": \"{{ $('ğŸ”€ Merge (Admin)').item.json.username }}\",\n  \"role\": \"{{ $('ğŸ”€ Merge (Admin)').item.json.role }}\"\n}",
        "options": {"algorithm": "HS256"}
      },
      "id": "jwt-admin",
      "name": "ğŸ”‘ Generate JWT (Admin)",
      "type": "n8n-nodes-base.jwt",
      "typeVersion": 1,
      "position": [584, -480],
      "credentials": {"jwtAuth": {"id": "YOUR_JWT_CREDENTIAL_ID", "name": "JWT Auth"}}
    },
    {
      "parameters": {
        "jsCode": "const config = $('âš™ï¸ CONFIG Admin').first().json;\nconst jwtToken = $input.item.json;\nconst adminData = $('ğŸ”€ Merge (Admin)').item.json;\n\nreturn [{\n  json: {\n    success: true,\n    authenticated: true,\n    token: jwtToken.token,\n    expires_in: config.jwt_expires_hours + 'h',\n    admin: {\n      username: adminData.username,\n      role: adminData.role\n    }\n  }\n}];"
      },
      "id": "format-admin-response",
      "name": "ğŸ“¤ Format Response (Admin)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [784, -480]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {"name": "Content-Type", "value": "application/json"},
              {"name": "Access-Control-Allow-Origin", "value": "*"},
              {"name": "Access-Control-Allow-Methods", "value": "POST, OPTIONS"},
              {"name": "Access-Control-Allow-Headers", "value": "Content-Type"}
            ]
          }
        }
      },
      "id": "response-admin-success",
      "name": "âœ… Response: Success (Admin)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [984, -480]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({success: false, authenticated: false, message: 'Invalid credentials'}) }}",
        "options": {
          "responseCode": 401,
          "responseHeaders": {
            "entries": [
              {"name": "Content-Type", "value": "application/json"},
              {"name": "Access-Control-Allow-Origin", "value": "*"},
              {"name": "Access-Control-Allow-Methods", "value": "POST, OPTIONS"},
              {"name": "Access-Control-Allow-Headers", "value": "Content-Type"}
            ]
          }
        }
      },
      "id": "response-admin-failed",
      "name": "âŒ Response: Failed (Admin)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [384, -320]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "client/auth",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-client-auth",
      "name": "ğŸŒ Webhook: POST /client/auth",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-1216, -32],
      "webhookId": "client-auth-webhook"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "jwt-exp", "name": "jwt_expires_days", "value": 7, "type": "number"},
            {"id": "table-clients", "name": "table_clients", "value": "clients", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-client",
      "name": "âš™ï¸ CONFIG Client",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-1016, -32]
    },
    {
      "parameters": {
        "jsCode": "const webhookData = $('ğŸŒ Webhook: POST /client/auth').item.json;\nconst body = webhookData.body || {};\nconst clientId = body.client_id || '';\nconst password = body.password || '';\n\nif (!clientId || !password) {\n  return [{\n    json: {\n      error: true,\n      message: 'Client ID and password are required'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    client_id: clientId,\n    password: password,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "extract-client",
      "name": "ğŸ“¥ Extract Credentials (Client)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-816, -32]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  client_id,\n  name,\n  email,\n  password_hash,\n  license_key,\n  status,\n  allowed_domains,\n  features,\n  expires_at,\n  max_domains\nFROM {{ $('âš™ï¸ CONFIG Client').first().json.table_clients }}\nWHERE client_id = '{{ $json.client_id }}'\nLIMIT 1;",
        "options": {}
      },
      "id": "check-client-db",
      "name": "ğŸ˜ Find Client",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [-616, -32],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "const clientData = $input.item.json;\nconst requestData = $('ğŸ“¥ Extract Credentials (Client)').item.json;\n\nif (!clientData.client_id) {\n  return [{\n    json: {\n      success: false,\n      message: 'Invalid credentials',\n      authenticated: false\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    client_id: clientData.client_id,\n    name: clientData.name,\n    email: clientData.email,\n    license_key: clientData.license_key,\n    password_hash: clientData.password_hash,\n    status: clientData.status,\n    allowed_domains: clientData.allowed_domains,\n    features: clientData.features,\n    expires_at: clientData.expires_at,\n    max_domains: clientData.max_domains,\n    input_password: requestData.password\n  }\n}];"
      },
      "id": "prepare-client-check",
      "name": "ğŸ”„ Prepare Check (Client)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-416, -32]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  CASE \n    WHEN '{{ $json.password_hash }}' = crypt('{{ $json.input_password }}', '{{ $json.password_hash }}')\n    THEN true\n    ELSE false\n  END as password_valid;",
        "options": {}
      },
      "id": "verify-client-password",
      "name": "ğŸ˜ Verify Password (Client)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [-216, -32],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "const passwordCheck = $input.item.json;\nconst clientData = $('ğŸ”„ Prepare Check (Client)').item.json;\n\nreturn [{\n  json: {\n    ...clientData,\n    password_valid: passwordCheck.password_valid\n  }\n}];"
      },
      "id": "merge-client-results",
      "name": "ğŸ”€ Merge (Client)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-16, -32]
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {
              "id": "password-ok",
              "leftValue": "={{ $json.password_valid }}",
              "rightValue": true,
              "operator": {"type": "boolean", "operation": "true"}
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-client-auth",
      "name": "â“ Auth OK? (Client)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [184, -32]
    },
    {
      "parameters": {
        "jsCode": "const config = $('âš™ï¸ CONFIG Client').first().json;\nconst clientData = $('ğŸ”€ Merge (Client)').item.json;\n\nconst expiresAt = Math.floor(Date.now() / 1000) + (config.jwt_expires_days * 24 * 60 * 60);\n\nreturn [{\n  json: {\n    client_id: clientData.client_id,\n    name: clientData.name,\n    email: clientData.email,\n    license_key: clientData.license_key,\n    status: clientData.status,\n    allowed_domains: clientData.allowed_domains,\n    features: clientData.features,\n    expires_at: clientData.expires_at,\n    max_domains: clientData.max_domains,\n    exp: expiresAt\n  }\n}];"
      },
      "id": "prepare-client-jwt",
      "name": "ğŸ”„ Prepare JWT (Client)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [384, -112]
    },
    {
      "parameters": {
        "claims": {},
        "options": {"algorithm": "HS256"}
      },
      "id": "jwt-client",
      "name": "ğŸ”‘ Generate JWT (Client)",
      "type": "n8n-nodes-base.jwt",
      "typeVersion": 1,
      "position": [584, -112],
      "credentials": {"jwtAuth": {"id": "YOUR_JWT_CREDENTIAL_ID", "name": "JWT Auth"}}
    },
    {
      "parameters": {
        "jsCode": "const config = $('âš™ï¸ CONFIG Client').first().json;\nconst jwtToken = $input.item.json;\nconst clientData = $('ğŸ”„ Prepare JWT (Client)').item.json;\n\nreturn [{\n  json: {\n    success: true,\n    authenticated: true,\n    token: jwtToken.token,\n    expires_in: config.jwt_expires_days + 'd',\n    client: {\n      client_id: clientData.client_id,\n      name: clientData.name,\n      email: clientData.email,\n      license_key: clientData.license_key,\n      status: clientData.status,\n      allowed_domains: clientData.allowed_domains,\n      features: clientData.features,\n      expires_at: clientData.expires_at,\n      max_domains: clientData.max_domains\n    }\n  }\n}];"
      },
      "id": "format-client-response",
      "name": "ğŸ“¤ Format Response (Client)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [784, -112]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {"name": "Content-Type", "value": "application/json"},
              {"name": "Access-Control-Allow-Origin", "value": "*"},
              {"name": "Access-Control-Allow-Methods", "value": "POST, OPTIONS"},
              {"name": "Access-Control-Allow-Headers", "value": "Content-Type"}
            ]
          }
        }
      },
      "id": "response-client-success",
      "name": "âœ… Response: Success (Client)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [984, -112]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({success: false, authenticated: false, message: 'Invalid credentials'}) }}",
        "options": {
          "responseCode": 401,
          "responseHeaders": {
            "entries": [
              {"name": "Content-Type", "value": "application/json"},
              {"name": "Access-Control-Allow-Origin", "value": "*"},
              {"name": "Access-Control-Allow-Methods", "value": "POST, OPTIONS"},
              {"name": "Access-Control-Allow-Headers", "value": "Content-Type"}
            ]
          }
        }
      },
      "id": "response-client-failed",
      "name": "âŒ Response: Failed (Client)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [384, 48]
    }
  ],
  "pinData": {},
  "connections": {
    "ğŸŒ Webhook: POST /admin/auth": {"main": [[{"node": "âš™ï¸ CONFIG Admin", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG Admin": {"main": [[{"node": "ğŸ“¥ Extract Credentials (Admin)", "type": "main", "index": 0}]]},
    "ğŸ“¥ Extract Credentials (Admin)": {"main": [[{"node": "ğŸ˜ Find Admin", "type": "main", "index": 0}]]},
    "ğŸ˜ Find Admin": {"main": [[{"node": "ğŸ”„ Prepare Check (Admin)", "type": "main", "index": 0}]]},
    "ğŸ”„ Prepare Check (Admin)": {"main": [[{"node": "ğŸ˜ Verify Password (Admin)", "type": "main", "index": 0}]]},
    "ğŸ˜ Verify Password (Admin)": {"main": [[{"node": "ğŸ”€ Merge (Admin)", "type": "main", "index": 0}]]},
    "ğŸ”€ Merge (Admin)": {"main": [[{"node": "â“ Auth OK? (Admin)", "type": "main", "index": 0}]]},
    "â“ Auth OK? (Admin)": {"main": [[{"node": "ğŸ˜ Update last_login", "type": "main", "index": 0}], [{"node": "âŒ Response: Failed (Admin)", "type": "main", "index": 0}]]},
    "ğŸ˜ Update last_login": {"main": [[{"node": "ğŸ”‘ Generate JWT (Admin)", "type": "main", "index": 0}]]},
    "ğŸ”‘ Generate JWT (Admin)": {"main": [[{"node": "ğŸ“¤ Format Response (Admin)", "type": "main", "index": 0}]]},
    "ğŸ“¤ Format Response (Admin)": {"main": [[{"node": "âœ… Response: Success (Admin)", "type": "main", "index": 0}]]},
    "ğŸŒ Webhook: POST /client/auth": {"main": [[{"node": "âš™ï¸ CONFIG Client", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG Client": {"main": [[{"node": "ğŸ“¥ Extract Credentials (Client)", "type": "main", "index": 0}]]},
    "ğŸ“¥ Extract Credentials (Client)": {"main": [[{"node": "ğŸ˜ Find Client", "type": "main", "index": 0}]]},
    "ğŸ˜ Find Client": {"main": [[{"node": "ğŸ”„ Prepare Check (Client)", "type": "main", "index": 0}]]},
    "ğŸ”„ Prepare Check (Client)": {"main": [[{"node": "ğŸ˜ Verify Password (Client)", "type": "main", "index": 0}]]},
    "ğŸ˜ Verify Password (Client)": {"main": [[{"node": "ğŸ”€ Merge (Client)", "type": "main", "index": 0}]]},
    "ğŸ”€ Merge (Client)": {"main": [[{"node": "â“ Auth OK? (Client)", "type": "main", "index": 0}]]},
    "â“ Auth OK? (Client)": {"main": [[{"node": "ğŸ”„ Prepare JWT (Client)", "type": "main", "index": 0}], [{"node": "âŒ Response: Failed (Client)", "type": "main", "index": 0}]]},
    "ğŸ”„ Prepare JWT (Client)": {"main": [[{"node": "ğŸ”‘ Generate JWT (Client)", "type": "main", "index": 0}]]},
    "ğŸ”‘ Generate JWT (Client)": {"main": [[{"node": "ğŸ“¤ Format Response (Client)", "type": "main", "index": 0}]]},
    "ğŸ“¤ Format Response (Client)": {"main": [[{"node": "âœ… Response: Success (Client)", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {"executionOrder": "v1"},
  "versionId": "production-en-v1",
  "meta": {"templateCredsSetupCompleted": true, "instanceId": "production-template"},
  "id": "auth-api-en",
  "tags": []
}
