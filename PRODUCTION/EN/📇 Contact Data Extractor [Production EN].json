{
  "name": "üìá Contact Data Extractor [Production EN]",
  "nodes": [
    {
      "parameters": {
        "content": "## üìá Contact Data Extractor\n\n### üìã Description\nExtract client contact data from dialogs using AI.\n\n**Modes:**\n- `single` - extraction for one session (by sessionId)\n- `batch` - batch extraction for all new dialogs\n\n---\n\n### ‚öôÔ∏è CONFIG Settings\n\n| Parameter | Description |\n|-----------|-------------|\n| `api_key` | API key for authentication |\n| `rate_limit_window_ms` | Rate limiting window (ms) |\n| `rate_limit_max_requests` | Max requests per window |\n| `table_chat_histories_ru` | Chat history table RU |\n| `table_chat_histories_en` | Chat history table EN |\n| `table_user_contact_data` | Contact data table |\n| `table_prechat_submissions` | Prechat forms table |\n\n---\n\n### üîë Credentials\nConfigure credentials separately:\n- **Postgres** - for all database nodes\n- **Google Gemini** - for AI models (model configured in node)\n\n---\n\n### üì• Request Examples\n\n**Single extraction:**\n```json\nPOST /webhook/extract-contact-data\nHeaders: x-api-key: YOUR_KEY\n{\"type\": \"single\", \"sessionId\": \"webchat_xxx\"}\n```\n\n**Batch extraction:**\n```json\nPOST /webhook/extract-contact-data\nHeaders: x-api-key: YOUR_KEY\n{\"type\": \"batch\"}\n```",
        "height": 720,
        "width": 420,
        "color": 5
      },
      "id": "sticky-note-main",
      "name": "üìù Instructions",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1680,
        160
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "api-key",
              "name": "api_key",
              "value": "YOUR_API_KEY_HERE",
              "type": "string"
            },
            {
              "id": "rate-window",
              "name": "rate_limit_window_ms",
              "value": 60000,
              "type": "number"
            },
            {
              "id": "rate-max",
              "name": "rate_limit_max_requests",
              "value": 60,
              "type": "number"
            },
            {
              "id": "table-chat-ru",
              "name": "table_chat_histories_ru",
              "value": "n8n_chat_histories_ru",
              "type": "string"
            },
            {
              "id": "table-chat-en",
              "name": "table_chat_histories_en",
              "value": "n8n_chat_histories_en",
              "type": "string"
            },
            {
              "id": "table-contacts",
              "name": "table_user_contact_data",
              "value": "user_contact_data",
              "type": "string"
            },
            {
              "id": "table-prechat",
              "name": "table_prechat_submissions",
              "value": "prechat_submissions",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "config-node",
      "name": "‚öôÔ∏è CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1320,
        368
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "extract-contact-data",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "9482fd9f-fb9a-4d1f-a528-6877a19335cb",
      "name": "üåê Webhook: Extract Contact",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1424,
        368
      ],
      "webhookId": "extract-contact-data-webhook"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞\nconst requestData = items[0].json.body || items[0].json;\nconst sessionId = requestData.sessionId;\nconst extractionType = requestData.type || 'single';\n\nreturn [{\n    json: {\n        sessionId: sessionId,\n        extractionType: extractionType\n    }\n}];"
      },
      "id": "b794ec13-62f3-41ba-8c17-155d1cf2626b",
      "name": "üì• Process Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        352
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.extractionType }}",
              "rightValue": "single",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "73ede9a3-1374-4970-9e90-8a2a78034c9b",
      "name": "‚ùì Check Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -656,
        352
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ last_updated\nWITH last_extraction AS (\n    SELECT \n        COALESCE(last_updated, '1970-01-01'::timestamp) as last_extracted\n    FROM {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}\n    WHERE session_id = '{{ $json.sessionId }}'\n),\nall_chats AS (\n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'ru' as language\n    FROM {{ $('‚öôÔ∏è CONFIG').first().json.table_chat_histories_ru }}\n    WHERE session_id = '{{ $json.sessionId }}'\n      AND created_at > COALESCE((SELECT last_extracted FROM last_extraction), '1970-01-01'::timestamp)\n    \n    UNION ALL\n    \n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'en' as language\n    FROM {{ $('‚öôÔ∏è CONFIG').first().json.table_chat_histories_en }}\n    WHERE session_id = '{{ $json.sessionId }}'\n      AND created_at > COALESCE((SELECT last_extracted FROM last_extraction), '1970-01-01'::timestamp)\n)\nSELECT * FROM all_chats\nORDER BY timestamp ASC;",
        "options": {}
      },
      "id": "85e9c47b-f83f-4da3-9c3c-4685eaf5e3ca",
      "name": "üêò Get Single Dialog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -432,
        112
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º –ø–∞–∫–µ—Ç–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ —Å —É–º–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π\nWITH recent_dialogs AS (\n    SELECT \n        session_id,\n        MAX(created_at) as last_message\n    FROM (\n        SELECT session_id, created_at FROM {{ $('‚öôÔ∏è CONFIG').first().json.table_chat_histories_ru }}\n        UNION ALL\n        SELECT session_id, created_at FROM {{ $('‚öôÔ∏è CONFIG').first().json.table_chat_histories_en }}\n    ) all_messages\n    WHERE created_at > NOW() - INTERVAL '24 hours'\n    GROUP BY session_id\n),\nsessions_to_process AS (\n    SELECT \n        rd.session_id,\n        rd.last_message,\n        COALESCE(ucd.last_updated, '1970-01-01'::timestamp) as last_extracted\n    FROM recent_dialogs rd\n    LEFT JOIN {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }} ucd ON rd.session_id = ucd.session_id\n    WHERE ucd.session_id IS NULL OR ucd.last_updated < rd.last_message\n    LIMIT 20\n)\nSELECT \n    ac.id,\n    ac.session_id,\n    ac.message_type,\n    ac.content,\n    ac.timestamp,\n    ac.platform,\n    ac.language\nFROM (\n    SELECT \n        r.id,\n        r.session_id,\n        r.message::json->>'type' as message_type,\n        r.message::json->>'content' as content,\n        r.created_at as timestamp,\n        r.platform,\n        'ru' as language\n    FROM {{ $('‚öôÔ∏è CONFIG').first().json.table_chat_histories_ru }} r\n    INNER JOIN sessions_to_process stp ON r.session_id = stp.session_id\n    WHERE r.created_at > stp.last_extracted\n    \n    UNION ALL\n    \n    SELECT \n        e.id,\n        e.session_id,\n        e.message::json->>'type' as message_type,\n        e.message::json->>'content' as content,\n        e.created_at as timestamp,\n        e.platform,\n        'en' as language\n    FROM {{ $('‚öôÔ∏è CONFIG').first().json.table_chat_histories_en }} e\n    INNER JOIN sessions_to_process stp ON e.session_id = stp.session_id\n    WHERE e.created_at > stp.last_extracted\n) ac\nORDER BY ac.session_id, ac.timestamp;",
        "options": {}
      },
      "id": "d1eea9f7-ad09-4217-9c2d-b94e0ebe5b55",
      "name": "üêò Get Batch Dialogs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -416,
        576
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pass data from Postgres node\nreturn items;"
      },
      "id": "739eb108-5377-4f2b-ba00-b3d45948c337",
      "name": "üì§ Pass Batch Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -192,
        576
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ session_id\nconst sessions = {};\n\n// –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Å–µ—Å—Å–∏—è–º\nitems.forEach(item => {\n    const data = item.json;\n    const sessionId = data.session_id;\n    \n    if (!sessions[sessionId]) {\n        sessions[sessionId] = {\n            sessionId: sessionId,\n            language: data.language,\n            platform: data.platform || 'unknown',\n            messages: []\n        };\n    }\n    \n    sessions[sessionId].messages.push({\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp\n    });\n});\n\n// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è Loop\nconst result = Object.values(sessions).map(session => ({\n    json: session\n}));\n\n\nreturn result;"
      },
      "id": "dd2de959-6725-40ae-9ebe-bc8050142793",
      "name": "üìä Group By Session",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16,
        576
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "7ff364e4-518c-45f5-a7ba-a7312ceb961a",
      "name": "üîÑ Loop Over Sessions",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        256,
        576
      ]
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ –¥–ª—è AI\nconst sessionData = items[0].json;\nconst sessionId = sessionData.sessionId;\nconst messages = sessionData.messages || [];\nconst language = sessionData.language;\nconst platform = sessionData.platform;\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É\nlet platformInfo = '';\nif (sessionId.startsWith('telegram_')) {\n    platformInfo = '\\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: Telegram (–ø—Ä–æ–≤–µ—Ä—å –±–∞–∑—É user_contact_data –¥–ª—è –∏–º–µ–Ω–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è)';\n} else if (sessionId.startsWith('webchat_')) {\n    platformInfo = '\\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: WebChat (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è)';\n} else if (sessionId.startsWith('whatsapp_')) {\n    platformInfo = '\\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: WhatsApp (—Ç–µ–ª–µ—Ñ–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ session_id)';\n}\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥\nconst conversation = messages.map(msg => \n    `${msg.type === 'human' ? '–ö–ª–∏–µ–Ω—Ç' : '–ë–æ—Ç'}: ${msg.content}`\n).join('\\n');\n\nreturn [{\n    json: {\n        sessionId: sessionId,\n        language: language,\n        platform: platform,\n        platformInfo: platformInfo,\n        conversation: conversation,\n        messagesCount: messages.length\n    }\n}];"
      },
      "id": "b3981f67-d74e-4c80-b9e1-f53dca4826b3",
      "name": "üìù Format Loop Dialog",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        576
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.platform }}",
              "rightValue": "webchat",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ee75e5a6-c200-4265-83f6-15e6bb076922",
      "name": "‚ùì IF Webchat Loop",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        672,
        576
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT session_id, name, email, phone, company, custom_fields\nFROM {{ $('‚öôÔ∏è CONFIG').first().json.table_prechat_submissions }}\nWHERE session_id = '{{ $json.sessionId }}'\nLIMIT 1;",
        "options": {}
      },
      "id": "7ccd7187-cf95-49b7-bcc1-7aaa8b3e0c21",
      "name": "üêò Get PreChat Loop",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        880,
        480
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ prechat –∏–∑ —Ñ–æ—Ä–º—ã\nconst dialogData = $('üìù Format Loop Dialog').first().json;\nconst preChat = items[0]?.json || null;\nconst hasPreChat = !!(preChat && preChat.session_id);\n\nreturn [{\n    json: {\n        ...dialogData,\n        preChat: hasPreChat ? preChat : null,\n        hasPreChat: hasPreChat\n    }\n}];"
      },
      "id": "b8d74fcd-8ef1-474b-a324-4ee138110ebf",
      "name": "üì§ Pass PreChat Loop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1088,
        480
      ]
    },
    {
      "parameters": {
        "jsCode": "// –î–ª—è –Ω–µ-webchat –ø–ª–∞—Ç—Ñ–æ—Ä–º - –±–µ–∑ prechat –¥–∞–Ω–Ω—ã—Ö\nconst dialogData = $('üìù Format Loop Dialog').first().json;\n\nreturn [{\n    json: {\n        ...dialogData,\n        preChat: null,\n        hasPreChat: false\n    }\n}];"
      },
      "id": "7a762006-42b7-4e3a-84ae-95b966ae00cc",
      "name": "üì§ Pass Empty PreChat",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        672
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏\nSELECT \n    session_id,\n    platform,\n    platform_user_id,\n    platform_username,\n    platform_first_name,\n    full_name,\n    telegram,\n    confidence_score\nFROM {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}\nWHERE session_id = '{{ $json.sessionId }}';",
        "options": {}
      },
      "id": "8ad23489-b30e-4f25-95d6-394f408894df",
      "name": "üêò Check Loop Existing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1296,
        576
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pass data from Postgres and prepare for merge\nconst existingContact = items.length > 0 && items[0].json ? items[0].json : null;\n\nreturn [{\n    json: {\n        existingContact: existingContact\n    }\n}];"
      },
      "id": "44b05f38-73b4-4d7c-85c8-a6dc6bbac3fb",
      "name": "üì§ Pass Loop Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1504,
        576
      ]
    },
    {
      "parameters": {
        "jsCode": "// –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º –∏ prechat\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Pass PreChat Loop –∏–ª–∏ Pass Empty PreChat Loop\nlet dialogData;\ntry {\n    dialogData = $('üì§ Pass PreChat Loop').first().json;\n} catch (e) {\n    try {\n        dialogData = $('üì§ Pass Empty PreChat').first().json;\n    } catch (e2) {\n        dialogData = $('üìù Format Loop Dialog').first().json;\n    }\n}\n\nconst checkData = items[0].json;\nconst existingContact = checkData.existingContact;\nconst preChat = dialogData.preChat || null;\nconst hasPreChat = dialogData.hasPreChat || false;\n\nlet contextInfo = dialogData.platformInfo || '';\n\n// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ prechat —Ñ–æ—Ä–º—ã\nlet preChatInfo = '';\nif (hasPreChat && preChat) {\n    preChatInfo = `\\n\\nüìã –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´ PRECHAT (–∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø–µ—Ä–µ–¥ —á–∞—Ç–æ–º):\\n- –ò–º—è: ${preChat.name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\\n- Email: ${preChat.email || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\\n- –¢–µ–ª–µ—Ñ–æ–Ω: ${preChat.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\\n- –ö–æ–º–ø–∞–Ω–∏—è: ${preChat.company || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`;\n}\n\nif (existingContact) {\n    if (existingContact.platform === 'telegram' && existingContact.platform_first_name) {\n        contextInfo += `\\n–í –ø—Ä–æ—Ñ–∏–ª–µ Telegram —É–∫–∞–∑–∞–Ω–æ –∏–º—è: ${existingContact.platform_first_name}`;\n    }\n    if (existingContact.platform_username) {\n        contextInfo += `\\nTelegram username: ${existingContact.platform_username}`;\n    }\n    if (existingContact.full_name && existingContact.confidence_score < 100) {\n        contextInfo += `\\n–†–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏–º—è: ${existingContact.full_name} (confidence: ${existingContact.confidence_score})`;\n    }\n}\n\nreturn [{\n    json: {\n        sessionId: dialogData.sessionId,\n        language: dialogData.language,\n        platform: dialogData.platform,\n        platformInfo: contextInfo,\n        preChatInfo: preChatInfo,\n        conversation: dialogData.conversation,\n        hasExistingContact: !!existingContact,\n        existingConfidence: existingContact ? existingContact.confidence_score : 0,\n        hasPreChat: hasPreChat\n    }\n}];"
      },
      "id": "98a4199e-aa6e-40e1-b6fe-eb0d8c430c51",
      "name": "üîÄ Merge Loop Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1712,
        576
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Session ID: {{ $json.sessionId }}\n–Ø–∑—ã–∫: {{ $json.language }}\n{{ $json.platformInfo }}\n{{ $json.preChatInfo }}\n\nüí¨ –î–ò–ê–õ–û–ì:\n{{ $json.conversation }}",
        "options": {
          "systemMessage": "=#–†–æ–ª—å: –í—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ AI-–∞–≥–µ–Ω—Ç–∞–º–∏.\n\n#–ó–∞–¥–∞—á–∞: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ –û–î–ù–û–ô —Å–µ—Å—Å–∏–∏ –∏ –∏–∑–≤–ª–µ—á—å –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ö–õ–ò–ï–ù–¢–ê, –≤–∫–ª—é—á–∞—è –∏–º–µ–Ω–∞, —Ç–µ–ª–µ—Ñ–æ–Ω—ã, email, –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã –∏ –¥—Ä—É–≥—É—é –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.\n\n#–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ó–õ–ò–ß–ê–ô –û–¢–ü–†–ê–í–ò–¢–ï–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô:\n\n–í –¥–∏–∞–ª–æ–≥–µ –µ—Å—Ç—å –î–í–ê —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:\n- \"–ö–ª–∏–µ–Ω—Ç:\" ‚Üí —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (—á–µ–ª–æ–≤–µ–∫–∞)\n- \"–ë–æ—Ç:\" ‚Üí —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è AI-–ë–û–¢–ê/–ú–ï–ù–ï–î–ñ–ï–†–ê\n\n‚ö†Ô∏è –ü–†–ê–í–ò–õ–û: –ò–∑–≤–ª–µ–∫–∞–π –¢–û–õ–¨–ö–û –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –ö–õ–ò–ï–ù–¢–ê!\n\n‚ùå –ò–ì–ù–û–†–ò–†–£–ô –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞:\n- –ë–æ—Ç –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è: \"–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞\" ‚Üí –ù–ï –∏–∑–≤–ª–µ–∫–∞—Ç—å\n- –ë–æ—Ç –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏: \"–ù–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω +7-999-111-22-33\" ‚Üí –ù–ï –∏–∑–≤–ª–µ–∫–∞—Ç—å\n- –ë–æ—Ç –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å email –ø–æ–¥–¥–µ—Ä–∂–∫–∏: \"–ü–∏—à–∏—Ç–µ –Ω–∞ support@company.com\" ‚Üí –ù–ï –∏–∑–≤–ª–µ–∫–∞—Ç—å\n\n‚úÖ –ò–ó–í–õ–ï–ö–ê–ô –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞:\n- –ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è: \"–ú–µ–Ω—è –∑–æ–≤—É—Ç –õ–æ–±–∑–∏–∫\" ‚Üí –ò–ó–í–õ–ï–ß–¨ –∏–º—è\n- –ö–ª–∏–µ–Ω—Ç –¥–∞—ë—Ç —Ç–µ–ª–µ—Ñ–æ–Ω: \"–ú–æ–π –Ω–æ–º–µ—Ä +7-999-222-33-44\" ‚Üí –ò–ó–í–õ–ï–ß–¨ —Ç–µ–ª–µ—Ñ–æ–Ω\n- –ö–ª–∏–µ–Ω—Ç –¥–∞—ë—Ç email: \"–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –Ω–∞ lobzik@mail.ru\" ‚Üí –ò–ó–í–õ–ï–ß–¨ email\n\n#–î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´ PRECHAT:\n\n–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —á–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ (—Å–µ–∫—Ü–∏—è üìã –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´ PRECHAT).\n–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ FALLBACK (–∑–∞–ø–∞—Å–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫):\n\n- –ü–†–ò–û–†–ò–¢–ï–¢ 1: –î–∞–Ω–Ω—ã–µ –∏–∑ –î–ò–ê–õ–û–ì–ê (–∫–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –Ω–∞–∑–≤–∞–ª) ‚Üí confidence 100\n- –ü–†–ò–û–†–ò–¢–ï–¢ 2: –î–∞–Ω–Ω—ã–µ –∏–∑ –§–û–†–ú–´ PRECHAT (–µ—Å–ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ –Ω–µ—Ç) ‚Üí confidence 50-70\n- –ü–†–ò–û–†–ò–¢–ï–¢ 3: –î–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ ‚Üí confidence 60\n\n–ü—Ä–∏–º–µ—Ä: –í —Ñ–æ—Ä–º–µ –∏–º—è \"–õ–∞–ø–æ—Ç—å\", –≤ –¥–∏–∞–ª–æ–≥–µ –∫–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª \"–ú–µ–Ω—è –∑–æ–≤—É—Ç –õ–æ–±–∑–∏–∫\" ‚Üí –ò—Å–ø–æ–ª—å–∑—É–π \"–õ–æ–±–∑–∏–∫\" (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–∏–∞–ª–æ–≥–∞)\n–ü—Ä–∏–º–µ—Ä: –í —Ñ–æ—Ä–º–µ email \"test@mail.com\", –≤ –¥–∏–∞–ª–æ–≥–µ email –Ω–µ —É–ø–æ–º–∏–Ω–∞–ª—Å—è ‚Üí –ò—Å–ø–æ–ª—å–∑—É–π \"test@mail.com\" –∏–∑ —Ñ–æ—Ä–º—ã\n\n#–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ô –†–ê–ë–û–¢–´:\n\n–ü—Ä–∏–º–µ—Ä 1 - –ö–æ–Ω—Ç–∞–∫—Ç—ã –±–æ—Ç–∞ (–ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨):\n–ë–æ—Ç: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–æ–≤—É—Ç Cryptonus, —è AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∫–∏: +7-999-111-22-33\n–ö–ª–∏–µ–Ω—Ç: –ü—Ä–∏–≤–µ—Ç, —è –õ–æ–±–∑–∏–∫\n\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:\n- name: \"–õ–æ–±–∑–∏–∫\" ‚Üê –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞\n- phone: null ‚Üê —Ç–µ–ª–µ—Ñ–æ–Ω –±–æ—Ç–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º\n\n–ü—Ä–∏–º–µ—Ä 2 - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–∏–∞–ª–æ–≥–∞ –Ω–∞–¥ —Ñ–æ—Ä–º–æ–π:\nüìã –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´: –ò–º—è: –õ–∞–ø–æ—Ç—å, Email: lapot@mail.com\n–ö–ª–∏–µ–Ω—Ç: –ú–µ–Ω—è –∑–æ–≤—É—Ç –õ–æ–±–∑–∏–∫\n\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:\n- name: \"–õ–æ–±–∑–∏–∫\" ‚Üê –∏–∑ –¥–∏–∞–ª–æ–≥–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)\n- email: \"lapot@mail.com\" ‚Üê –∏–∑ —Ñ–æ—Ä–º—ã (fallback)\n\n#–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é:\n\n1. **–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞**:\n   - –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è –≤ –¥–∏–∞–ª–æ–≥–µ\n   - –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ò–º—è –∏–∑ —Ñ–æ—Ä–º—ã prechat (–µ—Å–ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ –Ω–µ—Ç)\n   - –ü–†–ò–û–†–ò–¢–ï–¢ 3: –ë–æ—Ç –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –ø–æ –∏–º–µ–Ω–∏\n   - –ü–†–ò–û–†–ò–¢–ï–¢ 4: –ò–º—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞\n\n2. **–¢–µ–ª–µ—Ñ–æ–Ω/Email**:\n   - –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ö–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –≤ –¥–∏–∞–ª–æ–≥–µ\n   - –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ò–∑ —Ñ–æ—Ä–º—ã prechat\n   - –ü–†–ò–û–†–ò–¢–ï–¢ 3: –ò–∑ –ø—Ä–æ—Ñ–∏–ª—è\n\n#–ü–†–ê–í–ò–õ–ê –î–õ–Ø –£–í–ï–†–ï–ù–ù–û–°–¢–ò (confidence):\n\n- –ö–ª–∏–µ–Ω—Ç –Ø–í–ù–û –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è/—É–∫–∞–∑–∞–ª –≤ –¥–∏–∞–ª–æ–≥–µ ‚Üí confidence = 100\n- –î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã prechat (–∫–ª–∏–µ–Ω—Ç –Ω–µ —É–∫–∞–∑–∞–ª –≤ –¥–∏–∞–ª–æ–≥–µ) ‚Üí confidence = 60\n- –ë–æ—Ç –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –ø–æ –∏–º–µ–Ω–∏ ‚Üí confidence = 85\n- –ò–º—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ ‚Üí confidence = 60\n- –î–∞–Ω–Ω—ã–µ —É–≥–∞–¥–∞–Ω—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Üí confidence = 40\n\n#–ü—Ä–∞–≤–∏–ª–∞:\n- –ò–∑–≤–ª–µ–∫–∞–π –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ –ö–õ–ò–ï–ù–¢–ê, –∏–≥–Ω–æ—Ä–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –±–æ—Ç–∞/–∫–æ–º–ø–∞–Ω–∏–∏\n- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ\n- –ù–æ—Ä–º–∞–ª–∏–∑—É–π —Ç–µ–ª–µ—Ñ–æ–Ω—ã –∫ —Ñ–æ—Ä–º–∞—Ç—É +7XXXXXXXXXX –¥–ª—è –†–§\n- –í extractedFrom —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫: \"–∏–∑ –¥–∏–∞–ª–æ–≥–∞\", \"–∏–∑ —Ñ–æ—Ä–º—ã prechat\", \"–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è\"\n\n#–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ - —á–∏—Å—Ç—ã–π JSON:\n{\n  \"sessionId\": \"id —Å–µ—Å—Å–∏–∏\",\n  \"name\": \"–ø–æ–ª–Ω–æ–µ –∏–º—è –∏–ª–∏ null\",\n  \"firstName\": \"–∏–º—è –∏–ª–∏ null\",\n  \"lastName\": \"—Ñ–∞–º–∏–ª–∏—è –∏–ª–∏ null\",\n  \"phone\": \"–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ null\",\n  \"phoneRaw\": \"—Ç–µ–ª–µ—Ñ–æ–Ω –∫–∞–∫ —É–∫–∞–∑–∞–Ω –∏–ª–∏ null\",\n  \"email\": \"email –∏–ª–∏ null\",\n  \"telegram\": \"@username –∏–ª–∏ null\",\n  \"whatsapp\": \"–Ω–æ–º–µ—Ä WhatsApp –∏–ª–∏ null\",\n  \"otherContacts\": {},\n  \"company\": \"–∫–æ–º–ø–∞–Ω–∏—è –∏–ª–∏ null\",\n  \"position\": \"–¥–æ–ª–∂–Ω–æ—Å—Ç—å –∏–ª–∏ null\",\n  \"location\": \"–≥–æ—Ä–æ–¥/—Å—Ç—Ä–∞–Ω–∞ –∏–ª–∏ null\",\n  \"preferredContact\": \"—Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ –∏–ª–∏ null\",\n  \"extractedFrom\": \"–∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö\",\n  \"confidence\": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100\n}\n\n–í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ markdown –±–ª–æ–∫–æ–≤!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        1920,
        576
      ],
      "id": "596b290f-2fa8-4d65-8c61-e9efdf9bc545",
      "name": "ü§ñ AI Batch Extractor"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        2160,
        752
      ],
      "id": "e946428d-9e86-4370-b357-af2c29d928fc",
      "name": "üí≠ Think Batch"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-lite",
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1856,
        752
      ],
      "id": "4c8a7615-b3ee-4db7-b010-9b466f5bc59b",
      "name": "üß† Gemini Batch",
      "credentials": {
        "googlePalmApi": {
          "id": "YOUR_GOOGLEPALMAPI_CREDENTIAL_ID",
          "name": "Googlepalmapi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç AI –¥–ª—è –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ (Batch)\nconst aiResponse = items[0].json.output || items[0].json.response || items[0].json;\n\nlet contactData;\ntry {\n    if (typeof aiResponse === 'string') {\n        let cleanJson = aiResponse;\n        \n        // –£–¥–∞–ª—è–µ–º markdown –±–ª–æ–∫–∏\n        cleanJson = cleanJson.replace(/```json\\s*/g, '').replace(/```\\s*/g, '');\n        \n        const firstBrace = cleanJson.indexOf('{');\n        if (firstBrace > 0) {\n            cleanJson = cleanJson.substring(firstBrace);\n        }\n        const lastBrace = cleanJson.lastIndexOf('}');\n        if (lastBrace !== -1 && lastBrace < cleanJson.length - 1) {\n            cleanJson = cleanJson.substring(0, lastBrace + 1);\n        }\n        \n        const parsedData = JSON.parse(cleanJson);\n        \n        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Å—Å–∏–≤ contacts\n        if (parsedData.contacts && Array.isArray(parsedData.contacts) && parsedData.contacts.length > 0) {\n            contactData = parsedData.contacts[0];\n        } else {\n            contactData = parsedData;\n        }\n        \n    } else {\n        if (aiResponse.contacts && Array.isArray(aiResponse.contacts) && aiResponse.contacts.length > 0) {\n            contactData = aiResponse.contacts[0];\n        } else {\n            contactData = aiResponse;\n        }\n    }\n    \n    // –í–∞–ª–∏–¥–∞—Ü–∏—è\n    if (!contactData.sessionId) {\n        throw new Error('Missing sessionId in response');\n    }\n    \n    \n} catch (error) {\n    console.error('‚ùå [Batch] Parse error:', error.message);\n    \n    const sessionData = $('üîÄ Merge Loop Data').first().json;\n    contactData = {\n        sessionId: sessionData.sessionId,\n        name: null,\n        firstName: null,\n        lastName: null,\n        phone: null,\n        phoneRaw: null,\n        email: null,\n        telegram: null,\n        whatsapp: null,\n        otherContacts: null,\n        company: null,\n        position: null,\n        location: null,\n        preferredContact: null,\n        extractedFrom: 'AI parse error: ' + error.message,\n        confidence: 0\n    };\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ö–ê–ö –ï–°–¢–¨ (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–≤—ã—á–µ–∫)\nreturn [{json: contactData}];"
      },
      "id": "0fd92d5d-9fcb-4100-8e22-96df4150fdb3",
      "name": "üìã Parse Batch Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2288,
        576
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }} (\n    session_id,\n    platform,\n    full_name,\n    first_name,\n    last_name,\n    phone,\n    phone_raw,\n    email,\n    telegram,\n    whatsapp,\n    other_contacts,\n    company,\n    position,\n    location,\n    preferred_contact,\n    extracted_from,\n    confidence_score,\n    last_updated\n) VALUES (\n    '{{ $json.sessionId }}',\n    CASE \n        WHEN '{{ $json.sessionId }}' LIKE 'telegram_%' THEN 'telegram'\n        WHEN '{{ $json.sessionId }}' LIKE 'webchat_%' THEN 'webchat'\n        WHEN '{{ $json.sessionId }}' LIKE 'whatsapp_%' THEN 'whatsapp'\n        ELSE 'unknown'\n    END,\n    {{ $json.name ? \"'\" + String($json.name).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.firstName ? \"'\" + String($json.firstName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.lastName ? \"'\" + String($json.lastName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.phone ? \"'\" + $json.phone + \"'\" : 'NULL' }},\n    {{ $json.phoneRaw ? \"'\" + $json.phoneRaw + \"'\" : 'NULL' }},\n    {{ $json.email ? \"'\" + $json.email + \"'\" : 'NULL' }},\n    {{ $json.telegram ? \"'\" + $json.telegram + \"'\" : 'NULL' }},\n    {{ $json.whatsapp ? \"'\" + $json.whatsapp + \"'\" : 'NULL' }},\n    {{ $json.otherContacts && Object.keys($json.otherContacts).length > 0 ? \"'\" + JSON.stringify($json.otherContacts).replace(/'/g, \"''\") + \"'::jsonb\" : 'NULL' }},\n    {{ $json.company ? \"'\" + String($json.company).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.position ? \"'\" + String($json.position).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.location ? \"'\" + String($json.location).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.preferredContact ? \"'\" + $json.preferredContact + \"'\" : 'NULL' }},\n    {{ $json.extractedFrom ? \"'\" + String($json.extractedFrom).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.confidence || 0 }},\n    CURRENT_TIMESTAMP\n)\nON CONFLICT (session_id)\nDO UPDATE SET\n    full_name = CASE \n        -- –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ò–º—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –í–°–ï–ì–î–ê –ø–æ–±–µ–∂–¥–∞–µ—Ç –∏–º—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç confidence)\n        WHEN EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%' \n             AND ({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from LIKE '%–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è%' \n                  OR {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from IS NULL)\n             AND EXCLUDED.full_name IS NOT NULL\n        THEN EXCLUDED.full_name\n        \n        -- –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ü—Ä–∏ –†–ê–í–ù–û–ú confidence, –∏–º—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –ø–æ–±–µ–∂–¥–∞–µ—Ç\n        WHEN EXCLUDED.confidence_score = {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score\n             AND EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%'\n             AND EXCLUDED.full_name IS NOT NULL\n        THEN EXCLUDED.full_name\n        \n        -- –ü–†–ò–û–†–ò–¢–ï–¢ 3: –ï—Å–ª–∏ –Ω–æ–≤—ã–π confidence –í–´–®–ï - –æ–±–Ω–æ–≤–ª—è–µ–º\n        WHEN EXCLUDED.confidence_score > COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)\n             AND EXCLUDED.full_name IS NOT NULL\n        THEN EXCLUDED.full_name\n        \n        -- –ü–†–ò–û–†–ò–¢–ï–¢ 4: –ï—Å–ª–∏ —Å—Ç–∞—Ä–æ–≥–æ –∏–º–µ–Ω–∏ –Ω–µ—Ç - –ø–∏—à–µ–º –Ω–æ–≤–æ–µ\n        WHEN {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.full_name IS NULL \n             AND EXCLUDED.full_name IS NOT NULL\n        THEN EXCLUDED.full_name\n        \n        -- –ò–Ω–∞—á–µ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ\n        ELSE {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.full_name\n    END,\n    \n    first_name = CASE \n        WHEN EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%' \n             AND ({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from LIKE '%–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è%' \n                  OR {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from IS NULL)\n             AND EXCLUDED.first_name IS NOT NULL\n        THEN EXCLUDED.first_name\n        WHEN EXCLUDED.confidence_score = {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score\n             AND EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%'\n             AND EXCLUDED.first_name IS NOT NULL\n        THEN EXCLUDED.first_name\n        WHEN EXCLUDED.confidence_score > COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)\n             AND EXCLUDED.first_name IS NOT NULL\n        THEN EXCLUDED.first_name\n        WHEN {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.first_name IS NULL \n             AND EXCLUDED.first_name IS NOT NULL\n        THEN EXCLUDED.first_name\n        ELSE {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.first_name\n    END,\n    \n    last_name = CASE \n        WHEN EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%' \n             AND ({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from LIKE '%–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è%' \n                  OR {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from IS NULL)\n             AND EXCLUDED.last_name IS NOT NULL\n        THEN EXCLUDED.last_name\n        WHEN EXCLUDED.confidence_score = {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score\n             AND EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%'\n             AND EXCLUDED.last_name IS NOT NULL\n        THEN EXCLUDED.last_name\n        WHEN EXCLUDED.confidence_score > COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)\n             AND EXCLUDED.last_name IS NOT NULL\n        THEN EXCLUDED.last_name\n        WHEN {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.last_name IS NULL \n             AND EXCLUDED.last_name IS NOT NULL\n        THEN EXCLUDED.last_name\n        ELSE {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.last_name\n    END,\n    \n    phone = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.phone, EXCLUDED.phone),\n    phone_raw = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.phone_raw, EXCLUDED.phone_raw),\n    email = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.email, EXCLUDED.email),\n    telegram = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.telegram, EXCLUDED.telegram),\n    whatsapp = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.whatsapp, EXCLUDED.whatsapp),\n    other_contacts = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.other_contacts, EXCLUDED.other_contacts),\n    company = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.company, EXCLUDED.company),\n    position = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.position, EXCLUDED.position),\n    location = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.location, EXCLUDED.location),\n    preferred_contact = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.preferred_contact, EXCLUDED.preferred_contact),\n    \n    extracted_from = CASE\n        WHEN EXCLUDED.full_name != {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.full_name \n             OR {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.full_name IS NULL\n        THEN EXCLUDED.extracted_from\n        ELSE {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from\n    END,\n    \n    confidence_score = GREATEST(EXCLUDED.confidence_score, COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)),\n    \n    last_updated = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "id": "21a9846b-90c5-41b1-8af5-4dc806d64460",
      "name": "üêò Save Batch Contact",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2496,
        576
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pass data back to Loop\nreturn items;"
      },
      "id": "6a6385a0-48f3-4139-bbab-245f78007e89",
      "name": "üì§ Pass To Loop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2784,
        752
      ]
    },
    {
      "parameters": {
        "jsCode": "// –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ Loop\nconst allResults = items;\n\nconst summary = {\n    totalProcessed: allResults.length,\n    successful: allResults.filter(i => i.json.session_id).length,\n    failed: allResults.filter(i => !i.json.session_id).length,\n    timestamp: new Date().toISOString()\n};\n\n\nreturn [{json: summary}];"
      },
      "id": "3cd111e8-ae21-4fea-8276-ed7e9cbde049",
      "name": "üìä Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        416
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\"status\": \"success\", \"message\": \"Batch contact extraction completed\", \"processed\": $json.totalProcessed, \"successful\": $json.successful, \"failed\": $json.failed} }}",
        "options": {}
      },
      "id": "7147f36d-cd53-498c-b7cc-f59f2b19e560",
      "name": "‚úÖ Respond Batch",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        672,
        416
      ]
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è Single extraction\nconst dialogs = items;\nconst sessions = {};\n\ndialogs.forEach(item => {\n    const data = item.json;\n    if (!sessions[data.session_id]) {\n        sessions[data.session_id] = {\n            messages: [],\n            language: data.language,\n            platform: data.platform || 'unknown'\n        };\n    }\n    \n    sessions[data.session_id].messages.push({\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp\n    });\n});\n\nconst dialogsForExtraction = [];\n\nfor (const [sessionId, data] of Object.entries(sessions)) {\n    let platformInfo = '';\n    \n    if (sessionId.startsWith('telegram_')) {\n        platformInfo = '\\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: Telegram (–ø—Ä–æ–≤–µ—Ä—å –±–∞–∑—É user_contact_data –¥–ª—è –∏–º–µ–Ω–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è)';\n    } else if (sessionId.startsWith('webchat_')) {\n        platformInfo = '\\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: WebChat (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è)';\n    } else if (sessionId.startsWith('whatsapp_')) {\n        platformInfo = '\\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: WhatsApp (—Ç–µ–ª–µ—Ñ–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ session_id)';\n    }\n    \n    dialogsForExtraction.push({\n        sessionId: sessionId,\n        language: data.language,\n        platform: data.platform,\n        platformInfo: platformInfo,\n        conversation: data.messages.map(msg => \n            `${msg.type === 'human' ? '–ö–ª–∏–µ–Ω—Ç' : '–ë–æ—Ç'}: ${msg.content}`\n        ).join('\\n')\n    });\n}\n\nreturn [{\n    json: {\n        dialogs: dialogsForExtraction,\n        totalDialogs: dialogsForExtraction.length\n    }\n}];"
      },
      "id": "8820cbec-d0bd-4468-a5e6-6627ae170259",
      "name": "üìù Format Single Dialog",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT session_id, name, email, phone, company, custom_fields\nFROM {{ $('‚öôÔ∏è CONFIG').first().json.table_prechat_submissions }}\nWHERE session_id IN (\n    {{ $json.dialogs.filter(d => d.platform === 'webchat').map(d => \"'\" + d.sessionId + \"'\").join(',') || \"''\" }}\n);",
        "options": {}
      },
      "id": "a14eaf5d-21f9-4796-a276-5c7cded17303",
      "name": "üêò Get PreChat Single",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        0
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –°–æ—Ö—Ä–∞–Ω—è–µ–º prechat –¥–∞–Ω–Ω—ã–µ –≤ map –ø–æ session_id\nconst dialogsData = $('üìù Format Single Dialog').first().json;\nconst preChatItems = items || [];\n\nconst preChatMap = {};\npreChatItems.forEach(item => {\n    if (item.json && item.json.session_id) {\n        preChatMap[item.json.session_id] = item.json;\n    }\n});\n\nreturn [{\n    json: {\n        dialogs: dialogsData.dialogs,\n        totalDialogs: dialogsData.totalDialogs,\n        preChatMap: preChatMap\n    }\n}];"
      },
      "id": "ec5b3148-f76f-4f91-8d34-b3dc63ae1158",
      "name": "üì§ Pass PreChat Single",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        0
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è Single\nSELECT \n    session_id,\n    platform,\n    platform_user_id,\n    platform_username,\n    platform_first_name,\n    full_name,\n    telegram,\n    confidence_score\nFROM {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}\nWHERE session_id IN (\n    {{ $json.dialogs.map(d => \"'\" + d.sessionId + \"'\").join(',') }}\n);",
        "options": {}
      },
      "id": "5ce84515-f0a7-4d3b-b94c-98d259322833",
      "name": "üêò Check Single Existing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        416,
        112
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Single extraction —Å prechat\nconst preChatData = $('üì§ Pass PreChat Single').first().json;\nconst dialogsData = preChatData;\nconst preChatMap = preChatData.preChatMap || {};\nconst existingContacts = $input.all();\n\nconst contactsMap = {};\nexistingContacts.forEach(item => {\n    const contact = item.json;\n    if (contact && contact.session_id) {\n        contactsMap[contact.session_id] = {\n            platform: contact.platform,\n            platform_username: contact.platform_username,\n            platform_first_name: contact.platform_first_name,\n            existing_name: contact.full_name,\n            existing_telegram: contact.telegram,\n            confidence_score: contact.confidence_score\n        };\n    }\n});\n\nconst enrichedDialogs = dialogsData.dialogs.map(dialog => {\n    const existingContact = contactsMap[dialog.sessionId];\n    const preChat = preChatMap[dialog.sessionId] || null;\n    \n    let contextInfo = dialog.platformInfo || '';\n    let preChatInfo = '';\n    \n    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ prechat —Ñ–æ—Ä–º—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è webchat)\n    if (preChat && dialog.platform === 'webchat') {\n        preChatInfo = `\\n\\nüìã –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´ PRECHAT (–∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø–µ—Ä–µ–¥ —á–∞—Ç–æ–º):\\n- –ò–º—è: ${preChat.name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\\n- Email: ${preChat.email || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\\n- –¢–µ–ª–µ—Ñ–æ–Ω: ${preChat.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\\n- –ö–æ–º–ø–∞–Ω–∏—è: ${preChat.company || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`;\n    }\n    \n    if (existingContact) {\n        if (existingContact.platform === 'telegram' && existingContact.platform_first_name) {\n            contextInfo += `\\n–í –ø—Ä–æ—Ñ–∏–ª–µ Telegram —É–∫–∞–∑–∞–Ω–æ –∏–º—è: ${existingContact.platform_first_name}`;\n        }\n        if (existingContact.platform_username) {\n            contextInfo += `\\nTelegram username: ${existingContact.platform_username}`;\n        }\n        if (existingContact.existing_name && existingContact.confidence_score < 100) {\n            contextInfo += `\\n–†–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏–º—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è: ${existingContact.existing_name} (confidence: ${existingContact.confidence_score})`;\n        }\n    }\n    \n    return {\n        ...dialog,\n        platformInfo: contextInfo,\n        preChatInfo: preChatInfo,\n        hasExistingContact: !!existingContact,\n        existingConfidence: existingContact ? existingContact.confidence_score : 0,\n        hasPreChat: !!preChat\n    };\n});\n\nreturn [{\n    json: {\n        dialogs: enrichedDialogs,\n        totalDialogs: enrichedDialogs.length\n    }\n}];"
      },
      "id": "c78fb91f-fa89-4c0b-a486-439b51c4309d",
      "name": "üîÄ Merge Single Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        112
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤: {{ $json.totalDialogs }}\n\n–î–∏–∞–ª–æ–≥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n{{ $json.dialogs.map((d, i) => `\\n--- –î–∏–∞–ª–æ–≥ ${i+1} (Session: ${d.sessionId}, ${d.language}, ${d.platform}) ---${d.platformInfo}${d.preChatInfo}\\n\\nüí¨ –î–ò–ê–õ–û–ì:\\n${d.conversation}`).join('\\n\\n') }}",
        "options": {
          "systemMessage": "=#–†–æ–ª—å: –í—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ AI-–∞–≥–µ–Ω—Ç–∞–º–∏.\n\n#–ó–∞–¥–∞—á–∞: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥–∏ –∏ –∏–∑–≤–ª–µ—á—å –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ö–õ–ò–ï–ù–¢–û–í, –≤–∫–ª—é—á–∞—è –∏–º–µ–Ω–∞, —Ç–µ–ª–µ—Ñ–æ–Ω—ã, email, –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã.\n\n#–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ó–õ–ò–ß–ê–ô –û–¢–ü–†–ê–í–ò–¢–ï–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô:\n\n–í –¥–∏–∞–ª–æ–≥–µ –µ—Å—Ç—å –î–í–ê —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:\n- \"–ö–ª–∏–µ–Ω—Ç:\" ‚Üí —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (—á–µ–ª–æ–≤–µ–∫–∞)\n- \"–ë–æ—Ç:\" ‚Üí —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è AI-–ë–û–¢–ê/–ú–ï–ù–ï–î–ñ–ï–†–ê\n\n‚ö†Ô∏è –ü–†–ê–í–ò–õ–û: –ò–∑–≤–ª–µ–∫–∞–π –¢–û–õ–¨–ö–û –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –ö–õ–ò–ï–ù–¢–ê!\n\n‚ùå –ò–ì–ù–û–†–ò–†–£–ô –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞:\n- –ë–æ—Ç –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è: \"–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞\" ‚Üí –ù–ï –∏–∑–≤–ª–µ–∫–∞—Ç—å\n- –ë–æ—Ç –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏: \"–ù–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω +7-999-111-22-33\" ‚Üí –ù–ï –∏–∑–≤–ª–µ–∫–∞—Ç—å\n- –ë–æ—Ç –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å email –ø–æ–¥–¥–µ—Ä–∂–∫–∏: \"–ü–∏—à–∏—Ç–µ –Ω–∞ support@company.com\" ‚Üí –ù–ï –∏–∑–≤–ª–µ–∫–∞—Ç—å\n\n‚úÖ –ò–ó–í–õ–ï–ö–ê–ô –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞:\n- –ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è: \"–ú–µ–Ω—è –∑–æ–≤—É—Ç –õ–æ–±–∑–∏–∫\" ‚Üí –ò–ó–í–õ–ï–ß–¨ –∏–º—è\n- –ö–ª–∏–µ–Ω—Ç –¥–∞—ë—Ç —Ç–µ–ª–µ—Ñ–æ–Ω: \"–ú–æ–π –Ω–æ–º–µ—Ä +7-999-222-33-44\" ‚Üí –ò–ó–í–õ–ï–ß–¨ —Ç–µ–ª–µ—Ñ–æ–Ω\n- –ö–ª–∏–µ–Ω—Ç –¥–∞—ë—Ç email: \"–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –Ω–∞ lobzik@mail.ru\" ‚Üí –ò–ó–í–õ–ï–ß–¨ email\n\n#–î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´ PRECHAT:\n\n–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —á–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ (—Å–µ–∫—Ü–∏—è üìã –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´ PRECHAT).\n–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ FALLBACK (–∑–∞–ø–∞—Å–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫):\n\n- –ü–†–ò–û–†–ò–¢–ï–¢ 1: –î–∞–Ω–Ω—ã–µ –∏–∑ –î–ò–ê–õ–û–ì–ê (–∫–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –Ω–∞–∑–≤–∞–ª) ‚Üí confidence 100\n- –ü–†–ò–û–†–ò–¢–ï–¢ 2: –î–∞–Ω–Ω—ã–µ –∏–∑ –§–û–†–ú–´ PRECHAT (–µ—Å–ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ –Ω–µ—Ç) ‚Üí confidence 50-70\n- –ü–†–ò–û–†–ò–¢–ï–¢ 3: –î–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ ‚Üí confidence 60\n\n–ü—Ä–∏–º–µ—Ä: –í —Ñ–æ—Ä–º–µ –∏–º—è \"–õ–∞–ø–æ—Ç—å\", –≤ –¥–∏–∞–ª–æ–≥–µ –∫–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª \"–ú–µ–Ω—è –∑–æ–≤—É—Ç –õ–æ–±–∑–∏–∫\" ‚Üí –ò—Å–ø–æ–ª—å–∑—É–π \"–õ–æ–±–∑–∏–∫\" (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–∏–∞–ª–æ–≥–∞)\n–ü—Ä–∏–º–µ—Ä: –í —Ñ–æ—Ä–º–µ email \"test@mail.com\", –≤ –¥–∏–∞–ª–æ–≥–µ email –Ω–µ —É–ø–æ–º–∏–Ω–∞–ª—Å—è ‚Üí –ò—Å–ø–æ–ª—å–∑—É–π \"test@mail.com\" –∏–∑ —Ñ–æ—Ä–º—ã\n\n#–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ô –†–ê–ë–û–¢–´:\n\n–ü—Ä–∏–º–µ—Ä 1 - –ö–æ–Ω—Ç–∞–∫—Ç—ã –±–æ—Ç–∞ (–ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨):\n–ë–æ—Ç: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–æ–≤—É—Ç Cryptonus, —è AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∫–∏: +7-999-111-22-33\n–ö–ª–∏–µ–Ω—Ç: –ü—Ä–∏–≤–µ—Ç, —è –õ–æ–±–∑–∏–∫\n\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:\n- name: \"–õ–æ–±–∑–∏–∫\" ‚Üê –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞\n- phone: null ‚Üê —Ç–µ–ª–µ—Ñ–æ–Ω –±–æ—Ç–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º\n\n–ü—Ä–∏–º–µ—Ä 2 - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–∏–∞–ª–æ–≥–∞ –Ω–∞–¥ —Ñ–æ—Ä–º–æ–π:\nüìã –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´: –ò–º—è: –õ–∞–ø–æ—Ç—å, Email: lapot@mail.com\n–ö–ª–∏–µ–Ω—Ç: –ú–µ–Ω—è –∑–æ–≤—É—Ç –õ–æ–±–∑–∏–∫\n\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:\n- name: \"–õ–æ–±–∑–∏–∫\" ‚Üê –∏–∑ –¥–∏–∞–ª–æ–≥–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)\n- email: \"lapot@mail.com\" ‚Üê –∏–∑ —Ñ–æ—Ä–º—ã (fallback)\n\n#–ü–†–ê–í–ò–õ–ê –î–õ–Ø –£–í–ï–†–ï–ù–ù–û–°–¢–ò (confidence):\n\n- –ö–ª–∏–µ–Ω—Ç –Ø–í–ù–û –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è/—É–∫–∞–∑–∞–ª –≤ –¥–∏–∞–ª–æ–≥–µ ‚Üí confidence = 100\n- –î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã prechat (–∫–ª–∏–µ–Ω—Ç –Ω–µ —É–∫–∞–∑–∞–ª –≤ –¥–∏–∞–ª–æ–≥–µ) ‚Üí confidence = 60\n- –ë–æ—Ç –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –ø–æ –∏–º–µ–Ω–∏ ‚Üí confidence = 85\n- –ò–º—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ ‚Üí confidence = 60\n- –î–∞–Ω–Ω—ã–µ —É–≥–∞–¥–∞–Ω—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Üí confidence = 40\n\n#–ü—Ä–∞–≤–∏–ª–∞:\n- –ò–∑–≤–ª–µ–∫–∞–π –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ –ö–õ–ò–ï–ù–¢–ê, –∏–≥–Ω–æ—Ä–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –±–æ—Ç–∞/–∫–æ–º–ø–∞–Ω–∏–∏\n- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ\n- –ù–æ—Ä–º–∞–ª–∏–∑—É–π —Ç–µ–ª–µ—Ñ–æ–Ω—ã –∫ —Ñ–æ—Ä–º–∞—Ç—É +7XXXXXXXXXX –¥–ª—è –†–§\n- –í extractedFrom —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫: \"–∏–∑ –¥–∏–∞–ª–æ–≥–∞\", \"–∏–∑ —Ñ–æ—Ä–º—ã prechat\", \"–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è\"\n\n#–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ - —á–∏—Å—Ç—ã–π JSON:\n{\n  \"contacts\": [\n    {\n      \"sessionId\": \"id —Å–µ—Å—Å–∏–∏\",\n      \"name\": \"–ø–æ–ª–Ω–æ–µ –∏–º—è –∏–ª–∏ null\",\n      \"firstName\": \"–∏–º—è –∏–ª–∏ null\",\n      \"lastName\": \"—Ñ–∞–º–∏–ª–∏—è –∏–ª–∏ null\",\n      \"phone\": \"–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ null\",\n      \"phoneRaw\": \"—Ç–µ–ª–µ—Ñ–æ–Ω –∫–∞–∫ —É–∫–∞–∑–∞–Ω –∏–ª–∏ null\",\n      \"email\": \"email –∏–ª–∏ null\",\n      \"telegram\": \"@username –∏–ª–∏ null\",\n      \"whatsapp\": \"–Ω–æ–º–µ—Ä WhatsApp –∏–ª–∏ null\",\n      \"otherContacts\": {},\n      \"company\": \"–∫–æ–º–ø–∞–Ω–∏—è –∏–ª–∏ null\",\n      \"position\": \"–¥–æ–ª–∂–Ω–æ—Å—Ç—å –∏–ª–∏ null\",\n      \"location\": \"–≥–æ—Ä–æ–¥/—Å—Ç—Ä–∞–Ω–∞ –∏–ª–∏ null\",\n      \"preferredContact\": \"—Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ –∏–ª–∏ null\",\n      \"extractedFrom\": \"–∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö\",\n      \"confidence\": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100\n    }\n  ]\n}\n\n–í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ markdown –±–ª–æ–∫–æ–≤!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        864,
        112
      ],
      "id": "5f5e9af5-25c0-40a0-a93e-26f9af1d7458",
      "name": "ü§ñ AI Single Extractor"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        1104,
        256
      ],
      "id": "b4660cbb-9ecb-469d-8067-b4595805d328",
      "name": "üí≠ Think Single"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {
          "maxOutputTokens": 2048,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        784,
        272
      ],
      "id": "53d16ad3-fa26-437e-b0d1-d631a8944493",
      "name": "üß† Gemini Single",
      "credentials": {
        "googlePalmApi": {
          "id": "YOUR_GOOGLEPALMAPI_CREDENTIAL_ID",
          "name": "Googlepalmapi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç AI –¥–ª—è Single extraction\nconst aiResponse = items[0].json.output || items[0].json.response || items[0].json;\n\nlet contactsData;\ntry {\n    if (typeof aiResponse === 'string') {\n        let cleanJson = aiResponse;\n        \n        // –£–¥–∞–ª—è–µ–º markdown –±–ª–æ–∫–∏\n        cleanJson = cleanJson.replace(/```json\\s*/g, '').replace(/```\\s*/g, '');\n        \n        const firstBrace = cleanJson.indexOf('{');\n        if (firstBrace > 0) {\n            cleanJson = cleanJson.substring(firstBrace);\n        }\n        const lastBrace = cleanJson.lastIndexOf('}');\n        if (lastBrace !== -1 && lastBrace < cleanJson.length - 1) {\n            cleanJson = cleanJson.substring(0, lastBrace + 1);\n        }\n        \n        contactsData = JSON.parse(cleanJson);\n    } else {\n        contactsData = aiResponse;\n    }\n    \n    // –í–∞–ª–∏–¥–∞—Ü–∏—è\n    if (!contactsData.contacts || !Array.isArray(contactsData.contacts)) {\n        throw new Error('Invalid response structure: missing contacts array');\n    }\n    \n    \n    contactsData.contacts.forEach((contact, index) => {\n    });\n    \n} catch (error) {\n    console.error('‚ùå [Single] Parse error:', error.message);\n    contactsData = {\n        contacts: []\n    };\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ö–ê–ö –ï–°–¢–¨\nreturn contactsData.contacts.map(contact => ({json: contact}));"
      },
      "id": "f10019c4-ed24-493d-a358-1baaf3872eb9",
      "name": "üìã Parse Single Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }} (\n    session_id,\n    platform,\n    full_name,\n    first_name,\n    last_name,\n    phone,\n    phone_raw,\n    email,\n    telegram,\n    whatsapp,\n    other_contacts,\n    company,\n    position,\n    location,\n    preferred_contact,\n    extracted_from,\n    confidence_score,\n    last_updated\n) VALUES (\n    '{{ $json.sessionId }}',\n    CASE \n        WHEN '{{ $json.sessionId }}' LIKE 'telegram_%' THEN 'telegram'\n        WHEN '{{ $json.sessionId }}' LIKE 'webchat_%' THEN 'webchat'\n        WHEN '{{ $json.sessionId }}' LIKE 'whatsapp_%' THEN 'whatsapp'\n        ELSE 'unknown'\n    END,\n    {{ $json.name ? \"'\" + String($json.name).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.firstName ? \"'\" + String($json.firstName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.lastName ? \"'\" + String($json.lastName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.phone ? \"'\" + $json.phone + \"'\" : 'NULL' }},\n    {{ $json.phoneRaw ? \"'\" + $json.phoneRaw + \"'\" : 'NULL' }},\n    {{ $json.email ? \"'\" + $json.email + \"'\" : 'NULL' }},\n    {{ $json.telegram ? \"'\" + $json.telegram + \"'\" : 'NULL' }},\n    {{ $json.whatsapp ? \"'\" + $json.whatsapp + \"'\" : 'NULL' }},\n    {{ $json.otherContacts && Object.keys($json.otherContacts).length > 0 ? \"'\" + JSON.stringify($json.otherContacts).replace(/'/g, \"''\") + \"'::jsonb\" : 'NULL' }},\n    {{ $json.company ? \"'\" + String($json.company).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.position ? \"'\" + String($json.position).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.location ? \"'\" + String($json.location).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.preferredContact ? \"'\" + $json.preferredContact + \"'\" : 'NULL' }},\n    {{ $json.extractedFrom ? \"'\" + String($json.extractedFrom).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.confidence || 0 }},\n    CURRENT_TIMESTAMP\n)\nON CONFLICT (session_id)\nDO UPDATE SET\n    full_name = CASE \n        -- –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ò–º—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –í–°–ï–ì–î–ê –ø–æ–±–µ–∂–¥–∞–µ—Ç –∏–º—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç confidence)\n        WHEN EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%' \n             AND ({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from LIKE '%–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è%' \n                  OR {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from IS NULL)\n             AND EXCLUDED.full_name IS NOT NULL\n        THEN EXCLUDED.full_name\n        \n        -- –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ü—Ä–∏ –†–ê–í–ù–û–ú confidence, –∏–º—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –ø–æ–±–µ–∂–¥–∞–µ—Ç\n        WHEN EXCLUDED.confidence_score = {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score\n             AND EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%'\n             AND EXCLUDED.full_name IS NOT NULL\n        THEN EXCLUDED.full_name\n        \n        -- –ü–†–ò–û–†–ò–¢–ï–¢ 3: –ï—Å–ª–∏ –Ω–æ–≤—ã–π confidence –í–´–®–ï - –æ–±–Ω–æ–≤–ª—è–µ–º\n        WHEN EXCLUDED.confidence_score > COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)\n             AND EXCLUDED.full_name IS NOT NULL\n        THEN EXCLUDED.full_name\n        \n        -- –ü–†–ò–û–†–ò–¢–ï–¢ 4: –ï—Å–ª–∏ —Å—Ç–∞—Ä–æ–≥–æ –∏–º–µ–Ω–∏ –Ω–µ—Ç - –ø–∏—à–µ–º –Ω–æ–≤–æ–µ\n        WHEN {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.full_name IS NULL \n             AND EXCLUDED.full_name IS NOT NULL\n        THEN EXCLUDED.full_name\n        \n        -- –ò–Ω–∞—á–µ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ\n        ELSE {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.full_name\n    END,\n    \n    first_name = CASE \n        WHEN EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%' \n             AND ({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from LIKE '%–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è%' \n                  OR {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from IS NULL)\n             AND EXCLUDED.first_name IS NOT NULL\n        THEN EXCLUDED.first_name\n        WHEN EXCLUDED.confidence_score = {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score\n             AND EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%'\n             AND EXCLUDED.first_name IS NOT NULL\n        THEN EXCLUDED.first_name\n        WHEN EXCLUDED.confidence_score > COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)\n             AND EXCLUDED.first_name IS NOT NULL\n        THEN EXCLUDED.first_name\n        WHEN {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.first_name IS NULL \n             AND EXCLUDED.first_name IS NOT NULL\n        THEN EXCLUDED.first_name\n        ELSE {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.first_name\n    END,\n    \n    last_name = CASE \n        WHEN EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%' \n             AND ({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from LIKE '%–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è%' \n                  OR {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from IS NULL)\n             AND EXCLUDED.last_name IS NOT NULL\n        THEN EXCLUDED.last_name\n        WHEN EXCLUDED.confidence_score = {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score\n             AND EXCLUDED.extracted_from LIKE '%–∏–∑ –¥–∏–∞–ª–æ–≥–∞%'\n             AND EXCLUDED.last_name IS NOT NULL\n        THEN EXCLUDED.last_name\n        WHEN EXCLUDED.confidence_score > COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)\n             AND EXCLUDED.last_name IS NOT NULL\n        THEN EXCLUDED.last_name\n        WHEN {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.last_name IS NULL \n             AND EXCLUDED.last_name IS NOT NULL\n        THEN EXCLUDED.last_name\n        ELSE {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.last_name\n    END,\n    \n    phone = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.phone, EXCLUDED.phone),\n    phone_raw = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.phone_raw, EXCLUDED.phone_raw),\n    email = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.email, EXCLUDED.email),\n    telegram = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.telegram, EXCLUDED.telegram),\n    whatsapp = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.whatsapp, EXCLUDED.whatsapp),\n    other_contacts = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.other_contacts, EXCLUDED.other_contacts),\n    company = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.company, EXCLUDED.company),\n    position = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.position, EXCLUDED.position),\n    location = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.location, EXCLUDED.location),\n    preferred_contact = COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.preferred_contact, EXCLUDED.preferred_contact),\n    \n    extracted_from = CASE\n        WHEN EXCLUDED.full_name != {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.full_name \n             OR {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.full_name IS NULL\n        THEN EXCLUDED.extracted_from\n        ELSE {{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.extracted_from\n    END,\n    \n    confidence_score = GREATEST(EXCLUDED.confidence_score, COALESCE({{ $('‚öôÔ∏è CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)),\n    \n    last_updated = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "id": "a03ab07c-8b25-42cf-b795-fe04910dc4a0",
      "name": "üêò Save Single Contact",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1536,
        112
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\"status\": \"success\", \"message\": \"Contact data extracted\", \"processed\": 1} }}",
        "options": {}
      },
      "id": "60e102fb-1c52-49ca-a21e-5a69ede8aa11",
      "name": "‚úÖ Respond Single",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1744,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: API KEY + RATE LIMITING\n// ============================================\n\n// –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ CONFIG\nconst config = $('‚öôÔ∏è CONFIG').first().json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms || 60000;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests || 60;\n\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å Webhook\nconst inputData = $('üåê Webhook: Extract Contact').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1160,
        368
      ],
      "id": "33edc2cc-99c0-4399-af50-aae484e3eb6e",
      "name": "üîê Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1088,
        368
      ],
      "id": "970e429f-0763-45a2-b533-78ab2d9ac06e",
      "name": "‚ùì Auth Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -880,
        496
      ],
      "id": "f9a9858a-b274-40c0-a36e-d5a7e809ef96",
      "name": "‚ùå Error Response"
    }
  ],
  "pinData": {},
  "connections": {
    "üåê Webhook: Extract Contact": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è CONFIG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì• Process Request": {
      "main": [
        [
          {
            "node": "‚ùì Check Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Check Type": {
      "main": [
        [
          {
            "node": "üêò Get Single Dialog",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üêò Get Batch Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Get Single Dialog": {
      "main": [
        [
          {
            "node": "üìù Format Single Dialog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Get Batch Dialogs": {
      "main": [
        [
          {
            "node": "üì§ Pass Batch Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Pass Batch Data": {
      "main": [
        [
          {
            "node": "üìä Group By Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Group By Session": {
      "main": [
        [
          {
            "node": "üîÑ Loop Over Sessions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑ Loop Over Sessions": {
      "main": [
        [
          {
            "node": "üìä Aggregate Results",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìù Format Loop Dialog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Format Loop Dialog": {
      "main": [
        [
          {
            "node": "‚ùì IF Webchat Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì IF Webchat Loop": {
      "main": [
        [
          {
            "node": "üêò Get PreChat Loop",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Pass Empty PreChat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Get PreChat Loop": {
      "main": [
        [
          {
            "node": "üì§ Pass PreChat Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Pass PreChat Loop": {
      "main": [
        [
          {
            "node": "üêò Check Loop Existing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Pass Empty PreChat": {
      "main": [
        [
          {
            "node": "üêò Check Loop Existing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Check Loop Existing": {
      "main": [
        [
          {
            "node": "üì§ Pass Loop Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Pass Loop Check": {
      "main": [
        [
          {
            "node": "üîÄ Merge Loop Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Merge Loop Data": {
      "main": [
        [
          {
            "node": "ü§ñ AI Batch Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ AI Batch Extractor": {
      "main": [
        [
          {
            "node": "üìã Parse Batch Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üí≠ Think Batch": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ AI Batch Extractor",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üß† Gemini Batch": {
      "ai_languageModel": [
        [
          {
            "node": "ü§ñ AI Batch Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üìã Parse Batch Response": {
      "main": [
        [
          {
            "node": "üêò Save Batch Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Save Batch Contact": {
      "main": [
        [
          {
            "node": "üì§ Pass To Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Pass To Loop": {
      "main": [
        [
          {
            "node": "üîÑ Loop Over Sessions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Aggregate Results": {
      "main": [
        [
          {
            "node": "‚úÖ Respond Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Format Single Dialog": {
      "main": [
        [
          {
            "node": "üêò Get PreChat Single",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Get PreChat Single": {
      "main": [
        [
          {
            "node": "üì§ Pass PreChat Single",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Pass PreChat Single": {
      "main": [
        [
          {
            "node": "üêò Check Single Existing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Check Single Existing": {
      "main": [
        [
          {
            "node": "üîÄ Merge Single Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Merge Single Data": {
      "main": [
        [
          {
            "node": "ü§ñ AI Single Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ AI Single Extractor": {
      "main": [
        [
          {
            "node": "üìã Parse Single Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üí≠ Think Single": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ AI Single Extractor",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üß† Gemini Single": {
      "ai_languageModel": [
        [
          {
            "node": "ü§ñ AI Single Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üìã Parse Single Response": {
      "main": [
        [
          {
            "node": "üêò Save Single Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Save Single Contact": {
      "main": [
        [
          {
            "node": "‚úÖ Respond Single",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîê Security Check": {
      "main": [
        [
          {
            "node": "‚ùì Auth Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Auth Check": {
      "main": [
        [
          {
            "node": "üì• Process Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùå Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è CONFIG": {
      "main": [
        [
          {
            "node": "üîê Security Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "production-en-v1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "production-template"
  },
  "id": "contact-data-extractor-en",
  "tags": []
}