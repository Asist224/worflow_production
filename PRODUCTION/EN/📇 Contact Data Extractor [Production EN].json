{
  "name": "ğŸ“‡ Contact Data Extractor [Production EN]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ“‡ Contact Data Extractor\n\n### ğŸ“‹ Description\nExtracts client contact data from dialogs using AI.\n\n**Operating modes:**\n- `single` - extraction for one session (by sessionId)\n- `batch` - batch extraction for all new dialogs\n\n---\n\n### âš™ï¸ CONFIG Settings\n\n| Parameter | Description |\n|-----------|-------------|\n| `api_key` | API key for authentication |\n| `rate_limit_window_ms` | Rate limiting window (ms) |\n| `rate_limit_max_requests` | Max requests per window |\n| `table_chat_histories_ru` | Chat history table (RU) |\n| `table_chat_histories_en` | Chat history table (EN) |\n| `table_user_contact_data` | Contact data table |\n| `table_prechat_submissions` | Prechat forms table |\n| `gemini_model_single` | Gemini model for single |\n| `gemini_model_batch` | Gemini model for batch |\n| `gemini_temperature` | AI temperature |\n\n---\n\n### ğŸ“¥ Request Examples\n\n**Single extraction:**\n```json\nPOST /webhook/extract-contact-data?apiKey=YOUR_KEY\n{\"type\": \"single\", \"sessionId\": \"webchat_xxx\"}\n```\n\n**Batch extraction:**\n```json\nPOST /webhook/extract-contact-data?apiKey=YOUR_KEY\n{\"type\": \"batch\"}\n```\n\n---\n\n### ğŸ” Security\n- API Key authentication\n- Rate limiting by IP",
        "height": 720,
        "width": 420,
        "color": 5
      },
      "id": "sticky-note-main",
      "name": "ğŸ“ Instructions",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-1680, 160]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "api-key", "name": "api_key", "value": "YOUR_API_KEY_HERE", "type": "string"},
            {"id": "rate-window", "name": "rate_limit_window_ms", "value": 60000, "type": "number"},
            {"id": "rate-max", "name": "rate_limit_max_requests", "value": 60, "type": "number"},
            {"id": "table-chat-ru", "name": "table_chat_histories_ru", "value": "n8n_chat_histories_ru", "type": "string"},
            {"id": "table-chat-en", "name": "table_chat_histories_en", "value": "n8n_chat_histories_en", "type": "string"},
            {"id": "table-contacts", "name": "table_user_contact_data", "value": "user_contact_data", "type": "string"},
            {"id": "table-prechat", "name": "table_prechat_submissions", "value": "prechat_submissions", "type": "string"},
            {"id": "gemini-single", "name": "gemini_model_single", "value": "models/gemini-2.0-flash", "type": "string"},
            {"id": "gemini-batch", "name": "gemini_model_batch", "value": "models/gemini-2.5-flash-lite", "type": "string"},
            {"id": "gemini-temp", "name": "gemini_temperature", "value": 0.3, "type": "number"}
          ]
        },
        "options": {}
      },
      "id": "config-node",
      "name": "âš™ï¸ CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-1248, 368]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "extract-contact-data",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {"entries": [{"name": "Content-Type", "value": "application/json"}]}
        }
      },
      "id": "9482fd9f-fb9a-4d1f-a528-6877a19335cb",
      "name": "ğŸŒ Webhook: Extract Contact",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-1424, 368],
      "webhookId": "extract-contact-data-webhook"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ” Security check: API KEY + RATE LIMITING\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $('âš™ï¸ CONFIG').first().json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('ğŸŒ Webhook: Extract Contact').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1056, 368],
      "id": "33edc2cc-99c0-4399-af50-aae484e3eb6e",
      "name": "ğŸ” Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2},
          "conditions": [{"id": "auth-condition", "leftValue": "={{ $json.authorized }}", "rightValue": "", "operator": {"type": "boolean", "operation": "true", "singleValue": true}}],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-880, 368],
      "id": "970e429f-0763-45a2-b533-78ab2d9ac06e",
      "name": "â“ Auth Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {"responseCode": "={{ $json.error.status }}"}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [-688, 496],
      "id": "f9a9858a-b274-40c0-a36e-d5a7e809ef96",
      "name": "âŒ Error Response"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¥ Extract request parameters\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst requestData = items[0].json.body || items[0].json;\nconst sessionId = requestData.sessionId;\nconst extractionType = requestData.type || 'single';\n\nreturn [{\n    json: {\n        sessionId: sessionId,\n        extractionType: extractionType\n    }\n}];"
      },
      "id": "b794ec13-62f3-41ba-8c17-155d1cf2626b",
      "name": "ğŸ“¥ Process Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-688, 352]
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 1},
          "conditions": [{"leftValue": "={{ $json.extractionType }}", "rightValue": "single", "operator": {"type": "string", "operation": "equals"}}],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "73ede9a3-1374-4970-9e90-8a2a78034c9b",
      "name": "â“ Check Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [-464, 352]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“¥ Load new messages for single session\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH last_extraction AS (\n    SELECT COALESCE(last_updated, '1970-01-01'::timestamp) as last_extracted\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}\n    WHERE session_id = '{{ $json.sessionId }}'\n),\nall_chats AS (\n    SELECT id, session_id, message::json->>'type' as message_type, message::json->>'content' as content, created_at as timestamp, platform, 'ru' as language\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_ru }}\n    WHERE session_id = '{{ $json.sessionId }}'\n      AND created_at > COALESCE((SELECT last_extracted FROM last_extraction), '1970-01-01'::timestamp)\n    UNION ALL\n    SELECT id, session_id, message::json->>'type' as message_type, message::json->>'content' as content, created_at as timestamp, platform, 'en' as language\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_en }}\n    WHERE session_id = '{{ $json.sessionId }}'\n      AND created_at > COALESCE((SELECT last_extracted FROM last_extraction), '1970-01-01'::timestamp)\n)\nSELECT * FROM all_chats ORDER BY timestamp ASC;",
        "options": {}
      },
      "id": "85e9c47b-f83f-4da3-9c3c-4685eaf5e3ca",
      "name": "ğŸ˜ Get Single Dialog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-240, 112],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“¥ Get batch dialogs with filtering\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH recent_dialogs AS (\n    SELECT session_id, MAX(created_at) as last_message\n    FROM (\n        SELECT session_id, created_at FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_ru }}\n        UNION ALL\n        SELECT session_id, created_at FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_en }}\n    ) all_messages\n    WHERE created_at > NOW() - INTERVAL '24 hours'\n    GROUP BY session_id\n),\nsessions_to_process AS (\n    SELECT rd.session_id, rd.last_message, COALESCE(ucd.last_updated, '1970-01-01'::timestamp) as last_extracted\n    FROM recent_dialogs rd\n    LEFT JOIN {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }} ucd ON rd.session_id = ucd.session_id\n    WHERE ucd.session_id IS NULL OR ucd.last_updated < rd.last_message\n    LIMIT 20\n)\nSELECT ac.id, ac.session_id, ac.message_type, ac.content, ac.timestamp, ac.platform, ac.language\nFROM (\n    SELECT r.id, r.session_id, r.message::json->>'type' as message_type, r.message::json->>'content' as content, r.created_at as timestamp, r.platform, 'ru' as language\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_ru }} r\n    INNER JOIN sessions_to_process stp ON r.session_id = stp.session_id\n    WHERE r.created_at > stp.last_extracted\n    UNION ALL\n    SELECT e.id, e.session_id, e.message::json->>'type' as message_type, e.message::json->>'content' as content, e.created_at as timestamp, e.platform, 'en' as language\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_en }} e\n    INNER JOIN sessions_to_process stp ON e.session_id = stp.session_id\n    WHERE e.created_at > stp.last_extracted\n) ac\nORDER BY ac.session_id, ac.timestamp;",
        "options": {}
      },
      "id": "d1eea9f7-ad09-4217-9c2d-b94e0ebe5b55",
      "name": "ğŸ˜ Get Batch Dialogs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-224, 576],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {"jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Pass batch data\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn items;"}
      },
      "id": "739eb108-5377-4f2b-ba00-b3d45948c337",
      "name": "ğŸ“¤ Pass Batch Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [0, 576]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š Group messages by session_id\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst sessions = {};\n\nitems.forEach(item => {\n    const data = item.json;\n    const sessionId = data.session_id;\n    \n    if (!sessions[sessionId]) {\n        sessions[sessionId] = {\n            sessionId: sessionId,\n            language: data.language,\n            platform: data.platform || 'unknown',\n            messages: []\n        };\n    }\n    \n    sessions[sessionId].messages.push({\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp\n    });\n});\n\nconst result = Object.values(sessions).map(session => ({\n    json: session\n}));\n\nreturn result;"
      },
      "id": "dd2de959-6725-40ae-9ebe-bc8050142793",
      "name": "ğŸ“Š Group By Session",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [208, 576]
    },
    {
      "parameters": {"options": {}},
      "id": "7ff364e4-518c-45f5-a7ba-a7312ceb961a",
      "name": "ğŸ”„ Loop Over Sessions",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [448, 576]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“ Format dialog for AI (Loop)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst sessionData = items[0].json;\nconst sessionId = sessionData.sessionId;\nconst messages = sessionData.messages || [];\nconst language = sessionData.language;\nconst platform = sessionData.platform;\n\nlet platformInfo = '';\nif (sessionId.startsWith('telegram_')) {\n    platformInfo = '\\nPlatform: Telegram (check user_contact_data for profile name)';\n} else if (sessionId.startsWith('webchat_')) {\n    platformInfo = '\\nPlatform: WebChat (no profile data)';\n} else if (sessionId.startsWith('whatsapp_')) {\n    platformInfo = '\\nPlatform: WhatsApp (phone may be in session_id)';\n}\n\nconst conversation = messages.map(msg => \n    `${msg.type === 'human' ? 'Client' : 'Bot'}: ${msg.content}`\n).join('\\n');\n\nreturn [{\n    json: {\n        sessionId: sessionId,\n        language: language,\n        platform: platform,\n        platformInfo: platformInfo,\n        conversation: conversation,\n        messagesCount: messages.length\n    }\n}];"
      },
      "id": "b3981f67-d74e-4c80-b9e1-f53dca4826b3",
      "name": "ğŸ“ Format Loop Dialog",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [656, 576]
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 1},
          "conditions": [{"leftValue": "={{ $json.platform }}", "rightValue": "webchat", "operator": {"type": "string", "operation": "equals"}}],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ee75e5a6-c200-4265-83f6-15e6bb076922",
      "name": "â“ IF Webchat Loop",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [864, 576]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT session_id, name, email, phone, company, custom_fields\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_prechat_submissions }}\nWHERE session_id = '{{ $json.sessionId }}'\nLIMIT 1;",
        "options": {}
      },
      "id": "7ccd7187-cf95-49b7-bcc1-7aaa8b3e0c21",
      "name": "ğŸ˜ Get PreChat Loop",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1072, 480],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Pass prechat data\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dialogData = $('ğŸ“ Format Loop Dialog').first().json;\nconst preChat = items[0]?.json || null;\nconst hasPreChat = !!(preChat && preChat.session_id);\n\nreturn [{\n    json: {\n        ...dialogData,\n        preChat: hasPreChat ? preChat : null,\n        hasPreChat: hasPreChat\n    }\n}];"
      },
      "id": "b8d74fcd-8ef1-474b-a324-4ee138110ebf",
      "name": "ğŸ“¤ Pass PreChat Loop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1280, 480]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ For non-webchat platforms - no prechat\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dialogData = $('ğŸ“ Format Loop Dialog').first().json;\n\nreturn [{\n    json: {\n        ...dialogData,\n        preChat: null,\n        hasPreChat: false\n    }\n}];"
      },
      "id": "7a762006-42b7-4e3a-84ae-95b966ae00cc",
      "name": "ğŸ“¤ Pass Empty PreChat",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1072, 672]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ” Check existing contact\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSELECT session_id, platform, platform_user_id, platform_username, platform_first_name, full_name, telegram, confidence_score\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}\nWHERE session_id = '{{ $json.sessionId }}';",
        "options": {}
      },
      "id": "8ad23489-b30e-4f25-95d6-394f408894df",
      "name": "ğŸ˜ Check Loop Existing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1488, 576],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Prepare data for merge\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst existingContact = items.length > 0 && items[0].json ? items[0].json : null;\n\nreturn [{\n    json: {\n        existingContact: existingContact\n    }\n}];"
      },
      "id": "44b05f38-73b4-4d7c-85c8-a6dc6bbac3fb",
      "name": "ğŸ“¤ Pass Loop Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1696, 576]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”€ Merge data for AI\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet dialogData;\ntry {\n    dialogData = $('ğŸ“¤ Pass PreChat Loop').first().json;\n} catch (e) {\n    try {\n        dialogData = $('ğŸ“¤ Pass Empty PreChat').first().json;\n    } catch (e2) {\n        dialogData = $('ğŸ“ Format Loop Dialog').first().json;\n    }\n}\n\nconst checkData = items[0].json;\nconst existingContact = checkData.existingContact;\nconst preChat = dialogData.preChat || null;\nconst hasPreChat = dialogData.hasPreChat || false;\n\nlet contextInfo = dialogData.platformInfo || '';\n\nlet preChatInfo = '';\nif (hasPreChat && preChat) {\n    preChatInfo = `\\n\\nğŸ“‹ PRECHAT FORM DATA (filled by user before chat):\\n- Name: ${preChat.name || 'not provided'}\\n- Email: ${preChat.email || 'not provided'}\\n- Phone: ${preChat.phone || 'not provided'}\\n- Company: ${preChat.company || 'not provided'}`;\n}\n\nif (existingContact) {\n    if (existingContact.platform === 'telegram' && existingContact.platform_first_name) {\n        contextInfo += `\\nTelegram profile name: ${existingContact.platform_first_name}`;\n    }\n    if (existingContact.platform_username) {\n        contextInfo += `\\nTelegram username: ${existingContact.platform_username}`;\n    }\n    if (existingContact.full_name && existingContact.confidence_score < 100) {\n        contextInfo += `\\nPreviously saved name: ${existingContact.full_name} (confidence: ${existingContact.confidence_score})`;\n    }\n}\n\nreturn [{\n    json: {\n        sessionId: dialogData.sessionId,\n        language: dialogData.language,\n        platform: dialogData.platform,\n        platformInfo: contextInfo,\n        preChatInfo: preChatInfo,\n        conversation: dialogData.conversation,\n        hasExistingContact: !!existingContact,\n        existingConfidence: existingContact ? existingContact.confidence_score : 0,\n        hasPreChat: hasPreChat\n    }\n}];"
      },
      "id": "98a4199e-aa6e-40e1-b6fe-eb0d8c430c51",
      "name": "ğŸ”€ Merge Loop Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1904, 576]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Session ID: {{ $json.sessionId }}\nLanguage: {{ $json.language }}\n{{ $json.platformInfo }}\n{{ $json.preChatInfo }}\n\nğŸ’¬ DIALOG:\n{{ $json.conversation }}",
        "options": {
          "systemMessage": "=#Role: You are a specialist in extracting contact data from dialogs between clients and AI agents.\n\n#Task: Analyze a dialog for ONE session and extract all CLIENT contact data, including names, phones, emails, messengers and other contact information.\n\n#CRITICAL - DISTINGUISH MESSAGE SENDER:\n\nIn the dialog there are TWO types of messages:\n- \"Client:\" â†’ messages from the USER (human)\n- \"Bot:\" â†’ messages from the AI BOT/MANAGER\n\nâš ï¸ RULE: Extract ONLY contact data from CLIENT messages!\n\nâŒ IGNORE contacts from bot messages:\n- Bot may introduce itself: \"My name is Anna\" â†’ DO NOT extract\n- Bot may give company contacts: \"Our phone +7-999-111-22-33\" â†’ DO NOT extract\n- Bot may give support email: \"Write to support@company.com\" â†’ DO NOT extract\n\nâœ… EXTRACT contacts from client messages:\n- Client introduces themselves: \"My name is John\" â†’ EXTRACT name\n- Client gives phone: \"My number is +7-999-222-33-44\" â†’ EXTRACT phone\n- Client gives email: \"Write me at john@mail.com\" â†’ EXTRACT email\n\n#PRECHAT FORM DATA:\n\nBefore starting the chat, the user may have filled out a form with contacts (section ğŸ“‹ PRECHAT FORM DATA).\nUse this data as FALLBACK:\n\n- PRIORITY 1: Data from DIALOG (client explicitly stated) â†’ confidence 100\n- PRIORITY 2: Data from PRECHAT FORM (if not in dialog) â†’ confidence 50-70\n- PRIORITY 3: Data from messenger profile â†’ confidence 60\n\nExample: Form has name \"Mike\", in dialog client wrote \"My name is John\" â†’ Use \"John\" (dialog priority)\nExample: Form has email \"test@mail.com\", email not mentioned in dialog â†’ Use \"test@mail.com\" from form\n\n#CONFIDENCE RULES:\n\n- Client EXPLICITLY introduced/stated in dialog â†’ confidence = 100\n- Data from prechat form (client didn't state in dialog) â†’ confidence = 60\n- Bot addresses client by name â†’ confidence = 85\n- Name from messenger profile â†’ confidence = 60\n- Data guessed from context â†’ confidence = 40\n\n#Rules:\n- Extract ONLY CLIENT data, ignore bot/company data\n- DO NOT make up data\n- Normalize phones to +7XXXXXXXXXX format for Russia\n- In extractedFrom specify source: \"from dialog\", \"from prechat form\", \"from profile\"\n\n#Response format - clean JSON:\n{\n  \"sessionId\": \"session id\",\n  \"name\": \"full name or null\",\n  \"firstName\": \"first name or null\",\n  \"lastName\": \"last name or null\",\n  \"phone\": \"normalized phone or null\",\n  \"phoneRaw\": \"phone as stated or null\",\n  \"email\": \"email or null\",\n  \"telegram\": \"@username or null\",\n  \"whatsapp\": \"WhatsApp number or null\",\n  \"otherContacts\": {},\n  \"company\": \"company or null\",\n  \"position\": \"position or null\",\n  \"location\": \"city/country or null\",\n  \"preferredContact\": \"preferred contact method or null\",\n  \"extractedFrom\": \"data source\",\n  \"confidence\": number from 0 to 100\n}\n\nReturn ONLY valid JSON without markdown blocks!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [2112, 576],
      "id": "596b290f-2fa8-4d65-8c61-e9efdf9bc545",
      "name": "ğŸ¤– AI Batch Extractor"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [2352, 752],
      "id": "e946428d-9e86-4370-b357-af2c29d928fc",
      "name": "ğŸ’­ Think Batch"
    },
    {
      "parameters": {
        "modelName": "={{ $('âš™ï¸ CONFIG').first().json.gemini_model_batch }}",
        "options": {"temperature": "={{ $('âš™ï¸ CONFIG').first().json.gemini_temperature }}"}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [2048, 752],
      "id": "4c8a7615-b3ee-4db7-b010-9b466f5bc59b",
      "name": "ğŸ§  Gemini Batch",
      "credentials": {"googlePalmApi": {"id": "YOUR_GEMINI_CREDENTIAL_ID", "name": "Google Gemini(PaLM) Api account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“‹ Parse AI response (Batch)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst aiResponse = items[0].json.output || items[0].json.response || items[0].json;\n\nlet contactData;\ntry {\n    if (typeof aiResponse === 'string') {\n        let cleanJson = aiResponse;\n        cleanJson = cleanJson.replace(/```json\\s*/g, '').replace(/```\\s*/g, '');\n        const firstBrace = cleanJson.indexOf('{');\n        if (firstBrace > 0) { cleanJson = cleanJson.substring(firstBrace); }\n        const lastBrace = cleanJson.lastIndexOf('}');\n        if (lastBrace !== -1 && lastBrace < cleanJson.length - 1) { cleanJson = cleanJson.substring(0, lastBrace + 1); }\n        const parsedData = JSON.parse(cleanJson);\n        if (parsedData.contacts && Array.isArray(parsedData.contacts) && parsedData.contacts.length > 0) {\n            contactData = parsedData.contacts[0];\n        } else {\n            contactData = parsedData;\n        }\n    } else {\n        if (aiResponse.contacts && Array.isArray(aiResponse.contacts) && aiResponse.contacts.length > 0) {\n            contactData = aiResponse.contacts[0];\n        } else {\n            contactData = aiResponse;\n        }\n    }\n    if (!contactData.sessionId) { throw new Error('Missing sessionId in response'); }\n} catch (error) {\n    const sessionData = $('ğŸ”€ Merge Loop Data').first().json;\n    contactData = {\n        sessionId: sessionData.sessionId, name: null, firstName: null, lastName: null,\n        phone: null, phoneRaw: null, email: null, telegram: null, whatsapp: null,\n        otherContacts: null, company: null, position: null, location: null,\n        preferredContact: null, extractedFrom: 'AI parse error: ' + error.message, confidence: 0\n    };\n}\n\nreturn [{json: contactData}];"
      },
      "id": "0fd92d5d-9fcb-4100-8e22-96df4150fdb3",
      "name": "ğŸ“‹ Parse Batch Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2480, 576]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ’¾ Save contact (Batch)\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nINSERT INTO {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }} (\n    session_id, platform, full_name, first_name, last_name, phone, phone_raw, email,\n    telegram, whatsapp, other_contacts, company, position, location, preferred_contact,\n    extracted_from, confidence_score, last_updated\n) VALUES (\n    '{{ $json.sessionId }}',\n    CASE WHEN '{{ $json.sessionId }}' LIKE 'telegram_%' THEN 'telegram' WHEN '{{ $json.sessionId }}' LIKE 'webchat_%' THEN 'webchat' WHEN '{{ $json.sessionId }}' LIKE 'whatsapp_%' THEN 'whatsapp' ELSE 'unknown' END,\n    {{ $json.name ? \"'\" + String($json.name).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.firstName ? \"'\" + String($json.firstName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.lastName ? \"'\" + String($json.lastName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.phone ? \"'\" + $json.phone + \"'\" : 'NULL' }},\n    {{ $json.phoneRaw ? \"'\" + $json.phoneRaw + \"'\" : 'NULL' }},\n    {{ $json.email ? \"'\" + $json.email + \"'\" : 'NULL' }},\n    {{ $json.telegram ? \"'\" + $json.telegram + \"'\" : 'NULL' }},\n    {{ $json.whatsapp ? \"'\" + $json.whatsapp + \"'\" : 'NULL' }},\n    {{ $json.otherContacts && Object.keys($json.otherContacts).length > 0 ? \"'\" + JSON.stringify($json.otherContacts).replace(/'/g, \"''\") + \"'::jsonb\" : 'NULL' }},\n    {{ $json.company ? \"'\" + String($json.company).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.position ? \"'\" + String($json.position).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.location ? \"'\" + String($json.location).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.preferredContact ? \"'\" + $json.preferredContact + \"'\" : 'NULL' }},\n    {{ $json.extractedFrom ? \"'\" + String($json.extractedFrom).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.confidence || 0 }},\n    CURRENT_TIMESTAMP\n)\nON CONFLICT (session_id)\nDO UPDATE SET\n    full_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name, EXCLUDED.full_name),\n    first_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.first_name, EXCLUDED.first_name),\n    last_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.last_name, EXCLUDED.last_name),\n    phone = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.phone, EXCLUDED.phone),\n    email = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.email, EXCLUDED.email),\n    confidence_score = GREATEST(EXCLUDED.confidence_score, COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)),\n    last_updated = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "id": "21a9846b-90c5-41b1-8af5-4dc806d64460",
      "name": "ğŸ˜ Save Batch Contact",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [2688, 576],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {"jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Return to Loop\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn items;"}
      },
      "id": "6a6385a0-48f3-4139-bbab-245f78007e89",
      "name": "ğŸ“¤ Pass To Loop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2976, 752]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š Aggregate batch results\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst allResults = items;\n\nconst summary = {\n    totalProcessed: allResults.length,\n    successful: allResults.filter(i => i.json.session_id).length,\n    failed: allResults.filter(i => !i.json.session_id).length,\n    timestamp: new Date().toISOString()\n};\n\nreturn [{json: summary}];"
      },
      "id": "3cd111e8-ae21-4fea-8276-ed7e9cbde049",
      "name": "ğŸ“Š Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [656, 416]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\"status\": \"success\", \"message\": \"Batch contact extraction completed\", \"processed\": $json.totalProcessed, \"successful\": $json.successful, \"failed\": $json.failed} }}",
        "options": {}
      },
      "id": "7147f36d-cd53-498c-b7cc-f59f2b19e560",
      "name": "âœ… Respond Batch",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [864, 416]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“ Format dialogs for Single extraction\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dialogs = items;\nconst sessions = {};\n\ndialogs.forEach(item => {\n    const data = item.json;\n    if (!sessions[data.session_id]) {\n        sessions[data.session_id] = {\n            messages: [],\n            language: data.language,\n            platform: data.platform || 'unknown'\n        };\n    }\n    sessions[data.session_id].messages.push({\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp\n    });\n});\n\nconst dialogsForExtraction = [];\n\nfor (const [sessionId, data] of Object.entries(sessions)) {\n    let platformInfo = '';\n    if (sessionId.startsWith('telegram_')) {\n        platformInfo = '\\nPlatform: Telegram (check user_contact_data for profile name)';\n    } else if (sessionId.startsWith('webchat_')) {\n        platformInfo = '\\nPlatform: WebChat (no profile data)';\n    } else if (sessionId.startsWith('whatsapp_')) {\n        platformInfo = '\\nPlatform: WhatsApp (phone may be in session_id)';\n    }\n    dialogsForExtraction.push({\n        sessionId: sessionId,\n        language: data.language,\n        platform: data.platform,\n        platformInfo: platformInfo,\n        conversation: data.messages.map(msg => `${msg.type === 'human' ? 'Client' : 'Bot'}: ${msg.content}`).join('\\n')\n    });\n}\n\nreturn [{ json: { dialogs: dialogsForExtraction, totalDialogs: dialogsForExtraction.length } }];"
      },
      "id": "8820cbec-d0bd-4468-a5e6-6627ae170259",
      "name": "ğŸ“ Format Single Dialog",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-16, 112]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT session_id, name, email, phone, company, custom_fields\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_prechat_submissions }}\nWHERE session_id IN (\n    {{ $json.dialogs.filter(d => d.platform === 'webchat').map(d => \"'\" + d.sessionId + \"'\").join(',') || \"''\" }}\n);",
        "options": {}
      },
      "id": "a14eaf5d-21f9-4796-a276-5c7cded17303",
      "name": "ğŸ˜ Get PreChat Single",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [192, 0],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Pass prechat data for single\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dialogsData = $('ğŸ“ Format Single Dialog').first().json;\nconst preChatItems = items || [];\n\nconst preChatMap = {};\npreChatItems.forEach(item => {\n    if (item.json && item.json.session_id) {\n        preChatMap[item.json.session_id] = item.json;\n    }\n});\n\nreturn [{ json: { dialogs: dialogsData.dialogs, totalDialogs: dialogsData.totalDialogs, preChatMap: preChatMap } }];"
      },
      "id": "ec5b3148-f76f-4f91-8d34-b3dc63ae1158",
      "name": "ğŸ“¤ Pass PreChat Single",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 0]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ” Get existing contacts for Single\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSELECT session_id, platform, platform_user_id, platform_username, platform_first_name, full_name, telegram, confidence_score\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}\nWHERE session_id IN ( {{ $json.dialogs.map(d => \"'\" + d.sessionId + \"'\").join(',') }} );",
        "options": {}
      },
      "id": "5ce84515-f0a7-4d3b-b94c-98d259322833",
      "name": "ğŸ˜ Check Single Existing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [608, 112],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”€ Merge data for Single extraction with prechat\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst preChatData = $('ğŸ“¤ Pass PreChat Single').first().json;\nconst dialogsData = preChatData;\nconst preChatMap = preChatData.preChatMap || {};\nconst existingContacts = $input.all();\n\nconst contactsMap = {};\nexistingContacts.forEach(item => {\n    const contact = item.json;\n    if (contact && contact.session_id) {\n        contactsMap[contact.session_id] = {\n            platform: contact.platform,\n            platform_username: contact.platform_username,\n            platform_first_name: contact.platform_first_name,\n            existing_name: contact.full_name,\n            existing_telegram: contact.telegram,\n            confidence_score: contact.confidence_score\n        };\n    }\n});\n\nconst enrichedDialogs = dialogsData.dialogs.map(dialog => {\n    const existingContact = contactsMap[dialog.sessionId];\n    const preChat = preChatMap[dialog.sessionId] || null;\n    \n    let contextInfo = dialog.platformInfo || '';\n    let preChatInfo = '';\n    \n    if (preChat && dialog.platform === 'webchat') {\n        preChatInfo = `\\n\\nğŸ“‹ PRECHAT FORM DATA (filled by user before chat):\\n- Name: ${preChat.name || 'not provided'}\\n- Email: ${preChat.email || 'not provided'}\\n- Phone: ${preChat.phone || 'not provided'}\\n- Company: ${preChat.company || 'not provided'}`;\n    }\n    \n    if (existingContact) {\n        if (existingContact.platform === 'telegram' && existingContact.platform_first_name) {\n            contextInfo += `\\nTelegram profile name: ${existingContact.platform_first_name}`;\n        }\n        if (existingContact.platform_username) {\n            contextInfo += `\\nTelegram username: ${existingContact.platform_username}`;\n        }\n        if (existingContact.existing_name && existingContact.confidence_score < 100) {\n            contextInfo += `\\nPreviously saved name from profile: ${existingContact.existing_name} (confidence: ${existingContact.confidence_score})`;\n        }\n    }\n    \n    return {\n        ...dialog,\n        platformInfo: contextInfo,\n        preChatInfo: preChatInfo,\n        hasExistingContact: !!existingContact,\n        existingConfidence: existingContact ? existingContact.confidence_score : 0,\n        hasPreChat: !!preChat\n    };\n});\n\nreturn [{ json: { dialogs: enrichedDialogs, totalDialogs: enrichedDialogs.length } }];"
      },
      "id": "c78fb91f-fa89-4c0b-a486-439b51c4309d",
      "name": "ğŸ”€ Merge Single Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [848, 112]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Number of dialogs: {{ $json.totalDialogs }}\n\nDialogs for analysis:\n{{ $json.dialogs.map((d, i) => `\\n--- Dialog ${i+1} (Session: ${d.sessionId}, ${d.language}, ${d.platform}) ---${d.platformInfo}${d.preChatInfo}\\n\\nğŸ’¬ DIALOG:\\n${d.conversation}`).join('\\n\\n') }}",
        "options": {
          "systemMessage": "=#Role: You are a specialist in extracting contact data from dialogs between clients and AI agents.\n\n#Task: Analyze dialogs and extract all CLIENT contact data, including names, phones, emails, messengers.\n\n#CRITICAL - DISTINGUISH MESSAGE SENDER:\n\nIn the dialog there are TWO types of messages:\n- \"Client:\" â†’ messages from the USER (human)\n- \"Bot:\" â†’ messages from the AI BOT/MANAGER\n\nâš ï¸ RULE: Extract ONLY contact data from CLIENT messages!\n\nâŒ IGNORE contacts from bot messages:\n- Bot may introduce itself: \"My name is Anna\" â†’ DO NOT extract\n- Bot may give company contacts: \"Our phone +7-999-111-22-33\" â†’ DO NOT extract\n- Bot may give support email: \"Write to support@company.com\" â†’ DO NOT extract\n\nâœ… EXTRACT contacts from client messages:\n- Client introduces themselves: \"My name is John\" â†’ EXTRACT name\n- Client gives phone: \"My number is +7-999-222-33-44\" â†’ EXTRACT phone\n- Client gives email: \"Write me at john@mail.com\" â†’ EXTRACT email\n\n#PRECHAT FORM DATA:\n\nBefore starting the chat, the user may have filled out a form with contacts (section ğŸ“‹ PRECHAT FORM DATA).\nUse this data as FALLBACK:\n\n- PRIORITY 1: Data from DIALOG (client explicitly stated) â†’ confidence 100\n- PRIORITY 2: Data from PRECHAT FORM (if not in dialog) â†’ confidence 50-70\n- PRIORITY 3: Data from messenger profile â†’ confidence 60\n\n#CONFIDENCE RULES:\n\n- Client EXPLICITLY introduced/stated in dialog â†’ confidence = 100\n- Data from prechat form (client didn't state in dialog) â†’ confidence = 60\n- Bot addresses client by name â†’ confidence = 85\n- Name from messenger profile â†’ confidence = 60\n- Data guessed from context â†’ confidence = 40\n\n#Rules:\n- Extract ONLY CLIENT data, ignore bot/company data\n- DO NOT make up data\n- Normalize phones to +7XXXXXXXXXX format for Russia\n- In extractedFrom specify source: \"from dialog\", \"from prechat form\", \"from profile\"\n\n#Response format - clean JSON:\n{\n  \"contacts\": [\n    {\n      \"sessionId\": \"session id\",\n      \"name\": \"full name or null\",\n      \"firstName\": \"first name or null\",\n      \"lastName\": \"last name or null\",\n      \"phone\": \"normalized phone or null\",\n      \"phoneRaw\": \"phone as stated or null\",\n      \"email\": \"email or null\",\n      \"telegram\": \"@username or null\",\n      \"whatsapp\": \"WhatsApp number or null\",\n      \"otherContacts\": {},\n      \"company\": \"company or null\",\n      \"position\": \"position or null\",\n      \"location\": \"city/country or null\",\n      \"preferredContact\": \"preferred contact method or null\",\n      \"extractedFrom\": \"data source\",\n      \"confidence\": number from 0 to 100\n    }\n  ]\n}\n\nReturn ONLY valid JSON without markdown blocks!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [1056, 112],
      "id": "5f5e9af5-25c0-40a0-a93e-26f9af1d7458",
      "name": "ğŸ¤– AI Single Extractor"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [1296, 256],
      "id": "b4660cbb-9ecb-469d-8067-b4595805d328",
      "name": "ğŸ’­ Think Single"
    },
    {
      "parameters": {
        "modelName": "={{ $('âš™ï¸ CONFIG').first().json.gemini_model_single }}",
        "options": {"maxOutputTokens": 2048, "temperature": "={{ $('âš™ï¸ CONFIG').first().json.gemini_temperature }}"}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [976, 272],
      "id": "53d16ad3-fa26-437e-b0d1-d631a8944493",
      "name": "ğŸ§  Gemini Single",
      "credentials": {"googlePalmApi": {"id": "YOUR_GEMINI_CREDENTIAL_ID", "name": "Google Gemini(PaLM) Api account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“‹ Parse AI response (Single)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst aiResponse = items[0].json.output || items[0].json.response || items[0].json;\n\nlet contactsData;\ntry {\n    if (typeof aiResponse === 'string') {\n        let cleanJson = aiResponse;\n        cleanJson = cleanJson.replace(/```json\\s*/g, '').replace(/```\\s*/g, '');\n        const firstBrace = cleanJson.indexOf('{');\n        if (firstBrace > 0) { cleanJson = cleanJson.substring(firstBrace); }\n        const lastBrace = cleanJson.lastIndexOf('}');\n        if (lastBrace !== -1 && lastBrace < cleanJson.length - 1) { cleanJson = cleanJson.substring(0, lastBrace + 1); }\n        contactsData = JSON.parse(cleanJson);\n    } else {\n        contactsData = aiResponse;\n    }\n    if (!contactsData.contacts || !Array.isArray(contactsData.contacts)) {\n        throw new Error('Invalid response structure: missing contacts array');\n    }\n} catch (error) {\n    contactsData = { contacts: [] };\n}\n\nreturn contactsData.contacts.map(contact => ({json: contact}));"
      },
      "id": "f10019c4-ed24-493d-a358-1baaf3872eb9",
      "name": "ğŸ“‹ Parse Single Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1504, 112]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ’¾ Save contact (Single)\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nINSERT INTO {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }} (\n    session_id, platform, full_name, first_name, last_name, phone, phone_raw, email,\n    telegram, whatsapp, other_contacts, company, position, location, preferred_contact,\n    extracted_from, confidence_score, last_updated\n) VALUES (\n    '{{ $json.sessionId }}',\n    CASE WHEN '{{ $json.sessionId }}' LIKE 'telegram_%' THEN 'telegram' WHEN '{{ $json.sessionId }}' LIKE 'webchat_%' THEN 'webchat' WHEN '{{ $json.sessionId }}' LIKE 'whatsapp_%' THEN 'whatsapp' ELSE 'unknown' END,\n    {{ $json.name ? \"'\" + String($json.name).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.firstName ? \"'\" + String($json.firstName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.lastName ? \"'\" + String($json.lastName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.phone ? \"'\" + $json.phone + \"'\" : 'NULL' }},\n    {{ $json.phoneRaw ? \"'\" + $json.phoneRaw + \"'\" : 'NULL' }},\n    {{ $json.email ? \"'\" + $json.email + \"'\" : 'NULL' }},\n    {{ $json.telegram ? \"'\" + $json.telegram + \"'\" : 'NULL' }},\n    {{ $json.whatsapp ? \"'\" + $json.whatsapp + \"'\" : 'NULL' }},\n    {{ $json.otherContacts && Object.keys($json.otherContacts).length > 0 ? \"'\" + JSON.stringify($json.otherContacts).replace(/'/g, \"''\") + \"'::jsonb\" : 'NULL' }},\n    {{ $json.company ? \"'\" + String($json.company).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.position ? \"'\" + String($json.position).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.location ? \"'\" + String($json.location).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.preferredContact ? \"'\" + $json.preferredContact + \"'\" : 'NULL' }},\n    {{ $json.extractedFrom ? \"'\" + String($json.extractedFrom).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.confidence || 0 }},\n    CURRENT_TIMESTAMP\n)\nON CONFLICT (session_id)\nDO UPDATE SET\n    full_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name, EXCLUDED.full_name),\n    first_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.first_name, EXCLUDED.first_name),\n    last_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.last_name, EXCLUDED.last_name),\n    phone = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.phone, EXCLUDED.phone),\n    email = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.email, EXCLUDED.email),\n    confidence_score = GREATEST(EXCLUDED.confidence_score, COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)),\n    last_updated = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "id": "a03ab07c-8b25-42cf-b795-fe04910dc4a0",
      "name": "ğŸ˜ Save Single Contact",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1728, 112],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\"status\": \"success\", \"message\": \"Contact data extracted\", \"processed\": 1} }}",
        "options": {}
      },
      "id": "60e102fb-1c52-49ca-a21e-5a69ede8aa11",
      "name": "âœ… Respond Single",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1936, 112]
    }
  ],
  "pinData": {},
  "connections": {
    "ğŸŒ Webhook: Extract Contact": {"main": [[{"node": "âš™ï¸ CONFIG", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG": {"main": [[{"node": "ğŸ” Security Check", "type": "main", "index": 0}]]},
    "ğŸ” Security Check": {"main": [[{"node": "â“ Auth Check", "type": "main", "index": 0}]]},
    "â“ Auth Check": {"main": [[{"node": "ğŸ“¥ Process Request", "type": "main", "index": 0}], [{"node": "âŒ Error Response", "type": "main", "index": 0}]]},
    "ğŸ“¥ Process Request": {"main": [[{"node": "â“ Check Type", "type": "main", "index": 0}]]},
    "â“ Check Type": {"main": [[{"node": "ğŸ˜ Get Single Dialog", "type": "main", "index": 0}], [{"node": "ğŸ˜ Get Batch Dialogs", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Single Dialog": {"main": [[{"node": "ğŸ“ Format Single Dialog", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Batch Dialogs": {"main": [[{"node": "ğŸ“¤ Pass Batch Data", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass Batch Data": {"main": [[{"node": "ğŸ“Š Group By Session", "type": "main", "index": 0}]]},
    "ğŸ“Š Group By Session": {"main": [[{"node": "ğŸ”„ Loop Over Sessions", "type": "main", "index": 0}]]},
    "ğŸ”„ Loop Over Sessions": {"main": [[{"node": "ğŸ“Š Aggregate Results", "type": "main", "index": 0}], [{"node": "ğŸ“ Format Loop Dialog", "type": "main", "index": 0}]]},
    "ğŸ“ Format Loop Dialog": {"main": [[{"node": "â“ IF Webchat Loop", "type": "main", "index": 0}]]},
    "â“ IF Webchat Loop": {"main": [[{"node": "ğŸ˜ Get PreChat Loop", "type": "main", "index": 0}], [{"node": "ğŸ“¤ Pass Empty PreChat", "type": "main", "index": 0}]]},
    "ğŸ˜ Get PreChat Loop": {"main": [[{"node": "ğŸ“¤ Pass PreChat Loop", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass PreChat Loop": {"main": [[{"node": "ğŸ˜ Check Loop Existing", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass Empty PreChat": {"main": [[{"node": "ğŸ˜ Check Loop Existing", "type": "main", "index": 0}]]},
    "ğŸ˜ Check Loop Existing": {"main": [[{"node": "ğŸ“¤ Pass Loop Check", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass Loop Check": {"main": [[{"node": "ğŸ”€ Merge Loop Data", "type": "main", "index": 0}]]},
    "ğŸ”€ Merge Loop Data": {"main": [[{"node": "ğŸ¤– AI Batch Extractor", "type": "main", "index": 0}]]},
    "ğŸ¤– AI Batch Extractor": {"main": [[{"node": "ğŸ“‹ Parse Batch Response", "type": "main", "index": 0}]]},
    "ğŸ’­ Think Batch": {"ai_tool": [[{"node": "ğŸ¤– AI Batch Extractor", "type": "ai_tool", "index": 0}]]},
    "ğŸ§  Gemini Batch": {"ai_languageModel": [[{"node": "ğŸ¤– AI Batch Extractor", "type": "ai_languageModel", "index": 0}]]},
    "ğŸ“‹ Parse Batch Response": {"main": [[{"node": "ğŸ˜ Save Batch Contact", "type": "main", "index": 0}]]},
    "ğŸ˜ Save Batch Contact": {"main": [[{"node": "ğŸ“¤ Pass To Loop", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass To Loop": {"main": [[{"node": "ğŸ”„ Loop Over Sessions", "type": "main", "index": 0}]]},
    "ğŸ“Š Aggregate Results": {"main": [[{"node": "âœ… Respond Batch", "type": "main", "index": 0}]]},
    "ğŸ“ Format Single Dialog": {"main": [[{"node": "ğŸ˜ Get PreChat Single", "type": "main", "index": 0}]]},
    "ğŸ˜ Get PreChat Single": {"main": [[{"node": "ğŸ“¤ Pass PreChat Single", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass PreChat Single": {"main": [[{"node": "ğŸ˜ Check Single Existing", "type": "main", "index": 0}]]},
    "ğŸ˜ Check Single Existing": {"main": [[{"node": "ğŸ”€ Merge Single Data", "type": "main", "index": 0}]]},
    "ğŸ”€ Merge Single Data": {"main": [[{"node": "ğŸ¤– AI Single Extractor", "type": "main", "index": 0}]]},
    "ğŸ¤– AI Single Extractor": {"main": [[{"node": "ğŸ“‹ Parse Single Response", "type": "main", "index": 0}]]},
    "ğŸ’­ Think Single": {"ai_tool": [[{"node": "ğŸ¤– AI Single Extractor", "type": "ai_tool", "index": 0}]]},
    "ğŸ§  Gemini Single": {"ai_languageModel": [[{"node": "ğŸ¤– AI Single Extractor", "type": "ai_languageModel", "index": 0}]]},
    "ğŸ“‹ Parse Single Response": {"main": [[{"node": "ğŸ˜ Save Single Contact", "type": "main", "index": 0}]]},
    "ğŸ˜ Save Single Contact": {"main": [[{"node": "âœ… Respond Single", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {"executionOrder": "v1"},
  "versionId": "production-en-v1",
  "meta": {"templateCredsSetupCompleted": true, "instanceId": "production-template"},
  "id": "contact-data-extractor-en",
  "tags": []
}