{
  "name": "ğŸš€ Auto Send Hot Leads to CRM [Production EN]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸš€ Auto Send Hot Leads to CRM\n\n### ğŸ“‹ Description\nAutomatically send hot leads to CRM on schedule.\n\n---\n\n### âš™ï¸ CONFIG\n\n| Parameter | Description |\n|-----------|-------------|\n| `crm_endpoint_url` | CRM send endpoint URL |\n| `api_key` | API key |\n| `min_lead_score` | Minimum lead score |\n| `wait_between_requests_sec` | Delay between requests |\n| `table_crm_settings` | CRM settings table |\n| `table_dialog_analysis` | Analysis table |\n| `table_user_contact_data` | Contacts table |\n| `table_webchat_monitoring` | Monitoring table |\n| `table_crm_sent_leads` | Sent leads table |\n| `table_automation_log` | Logs table |\n\n---\n\n### ğŸ”„ Workflow Logic\n1. Runs every 15 minutes\n2. Checks auto_send_enabled settings\n3. Finds leads with score >= min_lead_score\n4. Sends each to CRM\n5. Logs actions",
        "height": 560,
        "width": 380,
        "color": 5
      },
      "id": "sticky-note-main",
      "name": "ğŸ“ Instructions",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-1100, -300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "crm-endpoint", "name": "crm_endpoint_url", "value": "http://localhost:5678/webhook/send-to-crm", "type": "string"},
            {"id": "api-key", "name": "api_key", "value": "YOUR_API_KEY_HERE", "type": "string"},
            {"id": "min-score", "name": "min_lead_score", "value": 70, "type": "number"},
            {"id": "wait-sec", "name": "wait_between_requests_sec", "value": 10, "type": "number"},
            {"id": "table-crm", "name": "table_crm_settings", "value": "crm_settings", "type": "string"},
            {"id": "table-analysis", "name": "table_dialog_analysis", "value": "dialog_analysis", "type": "string"},
            {"id": "table-contacts", "name": "table_user_contact_data", "value": "user_contact_data", "type": "string"},
            {"id": "table-monitor", "name": "table_webchat_monitoring", "value": "webchat_monitoring", "type": "string"},
            {"id": "table-sent", "name": "table_crm_sent_leads", "value": "crm_sent_leads", "type": "string"},
            {"id": "table-log", "name": "table_automation_log", "value": "automation_log", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-main",
      "name": "âš™ï¸ CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-656, -112]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "1c6a2bb9-bcff-4467-93c0-6a96539b2cba",
      "name": "â° Every 15 minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [-864, -112]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  auto_send_enabled,\n  min_lead_score,\n  webhook_url\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_crm_settings }} \nWHERE crm_type = 'bitrix24' \nLIMIT 1",
        "options": {}
      },
      "id": "fca26dec-77e6-4029-8999-c916675fc3fa",
      "name": "ğŸ˜ Get CRM Settings",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-448, -112],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {
              "id": "8f7e6d5c-4b3a-2910-1234-567890abcdef",
              "leftValue": "={{ $json.auto_send_enabled }}",
              "rightValue": true,
              "operator": {"type": "boolean", "operation": "equals"}
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0d878c7b-f9ed-4b0f-968c-5203a70af002",
      "name": "â“ Check Auto Send Enabled",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [-240, -112]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  da.session_id,\n  COALESCE((da.lead_scoring::json->>'score')::int, 0) as lead_score,\n  (da.emotional_tone::json->>'satisfaction')::int as satisfaction,\n  ucd.phone,\n  ucd.email,\n  ucd.full_name,\n  wm.platform,\n  wm.message_count\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_dialog_analysis }} da\nJOIN {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }} ucd ON da.session_id = ucd.session_id\nLEFT JOIN {{ $('âš™ï¸ CONFIG').first().json.table_webchat_monitoring }} wm ON da.session_id = wm.session_id\nLEFT JOIN {{ $('âš™ï¸ CONFIG').first().json.table_crm_sent_leads }} csl ON da.session_id = csl.session_id\nWHERE \n  csl.session_id IS NULL\n  AND COALESCE((da.lead_scoring::json->>'score')::int, 0) >= {{ $('ğŸ˜ Get CRM Settings').first().json.min_lead_score || $('âš™ï¸ CONFIG').first().json.min_lead_score }}\n  AND (ucd.phone IS NOT NULL OR ucd.email IS NOT NULL)\n  AND da.created_at > NOW() - INTERVAL '7 days'\nLIMIT 10",
        "options": {}
      },
      "id": "769dc542-5c18-422e-a3a9-9d9aee7afbd1",
      "name": "ğŸ” Find Hot Leads",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-32, -112],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "f7ad393d-a332-46e3-be36-94f43ce0418f",
      "name": "ğŸ“¦ Split in Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 2,
      "position": [176, -112]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('âš™ï¸ CONFIG').first().json.crm_endpoint_url }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "apiKey",
              "value": "={{ $('âš™ï¸ CONFIG').first().json.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"sessionId\": \"{{ $json.session_id }}\",\n  \"autoSend\": true,\n  \"webhookUrl\": \"{{ $('ğŸ˜ Get CRM Settings').first().json.webhook_url }}\"\n}",
        "options": {}
      },
      "id": "344a0060-5e5b-4b42-9730-684d84f5cb94",
      "name": "ğŸ“¤ Send to CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [384, -128],
      "retryOnFail": true,
      "maxTries": 2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO {{ $('âš™ï¸ CONFIG').first().json.table_automation_log }} (\n  action_type,\n  session_id,\n  details,\n  created_at\n) VALUES (\n  'auto_crm_send',\n  '{{ $('ğŸ“¤ Send to CRM').item.json.sessionId }}',\n  '{{ JSON.stringify($json) }}'::jsonb,\n  NOW()\n)",
        "options": {}
      },
      "id": "68143af6-e9a5-49e0-90b2-7fbf3e7e905f",
      "name": "ğŸ“ Log Action",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [592, -128],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}},
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": "={{ $('âš™ï¸ CONFIG').first().json.wait_between_requests_sec }}",
        "unit": "seconds"
      },
      "id": "337a4cd5-4a94-4be7-a917-7c9807813150",
      "name": "â³ Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [784, -128],
      "webhookId": "wait-webhook"
    },
    {
      "parameters": {},
      "id": "a4870c4f-4a43-4275-a999-7476ded75b6e",
      "name": "ğŸ›‘ Stop (Auto Send Disabled)",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [-32, 64]
    }
  ],
  "pinData": {},
  "connections": {
    "â° Every 15 minutes": {"main": [[{"node": "âš™ï¸ CONFIG", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG": {"main": [[{"node": "ğŸ˜ Get CRM Settings", "type": "main", "index": 0}]]},
    "ğŸ˜ Get CRM Settings": {"main": [[{"node": "â“ Check Auto Send Enabled", "type": "main", "index": 0}]]},
    "â“ Check Auto Send Enabled": {"main": [[{"node": "ğŸ” Find Hot Leads", "type": "main", "index": 0}], [{"node": "ğŸ›‘ Stop (Auto Send Disabled)", "type": "main", "index": 0}]]},
    "ğŸ” Find Hot Leads": {"main": [[{"node": "ğŸ“¦ Split in Batches", "type": "main", "index": 0}]]},
    "ğŸ“¦ Split in Batches": {"main": [[{"node": "ğŸ“¤ Send to CRM", "type": "main", "index": 0}]]},
    "ğŸ“¤ Send to CRM": {"main": [[{"node": "ğŸ“ Log Action", "type": "main", "index": 0}]]},
    "ğŸ“ Log Action": {"main": [[{"node": "â³ Wait", "type": "main", "index": 0}]]},
    "â³ Wait": {"main": [[{"node": "ğŸ“¦ Split in Batches", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {"executionOrder": "v1"},
  "versionId": "production-en-v1",
  "meta": {"templateCredsSetupCompleted": true, "instanceId": "production-template"},
  "id": "auto-send-hot-leads-crm-en",
  "tags": []
}