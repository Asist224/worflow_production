{
  "name": "ğŸ“‡ Contact Data Extractor [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ“‡ Contact Data Extractor\n\n### ğŸ“‹ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ\nĞ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ² Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ AI.\n\n**Ğ ĞµĞ¶Ğ¸Ğ¼Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**\n- `single` - Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ (Ğ¿Ğ¾ sessionId)\n- `batch` - Ğ¿Ğ°ĞºĞµÑ‚Ğ½Ğ¾Ğµ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²\n\n---\n\n### âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° CONFIG\n\n| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |\n|----------|----------|\n| `api_key` | API ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ |\n| `rate_limit_window_ms` | ĞĞºĞ½Ğ¾ rate limiting (Ğ¼Ñ) |\n| `rate_limit_max_requests` | ĞœĞ°ĞºÑ. Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ¾ĞºĞ½Ğµ |\n| `table_chat_histories_ru` | Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‡Ğ°Ñ‚Ğ° (RU) |\n| `table_chat_histories_en` | Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‡Ğ°Ñ‚Ğ° (EN) |\n| `table_user_contact_data` | Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… |\n| `table_prechat_submissions` | Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° prechat Ñ„Ğ¾Ñ€Ğ¼ |\n| `gemini_model_single` | ĞœĞ¾Ğ´ĞµĞ»ÑŒ Gemini Ğ´Ğ»Ñ single |\n| `gemini_model_batch` | ĞœĞ¾Ğ´ĞµĞ»ÑŒ Gemini Ğ´Ğ»Ñ batch |\n| `gemini_temperature` | Temperature Ğ´Ğ»Ñ AI |\n\n---\n\n### ğŸ“¥ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²\n\n**Single extraction:**\n```json\nPOST /webhook/extract-contact-data?apiKey=YOUR_KEY\n{\"type\": \"single\", \"sessionId\": \"webchat_xxx\"}\n```\n\n**Batch extraction:**\n```json\nPOST /webhook/extract-contact-data?apiKey=YOUR_KEY\n{\"type\": \"batch\"}\n```\n\n---\n\n### ğŸ” Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ\n- API Key Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ\n- Rate limiting Ğ¿Ğ¾ IP",
        "height": 720,
        "width": 420,
        "color": 5
      },
      "id": "sticky-note-main",
      "name": "ğŸ“ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-1680, 160]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "api-key", "name": "api_key", "value": "YOUR_API_KEY_HERE", "type": "string"},
            {"id": "rate-window", "name": "rate_limit_window_ms", "value": 60000, "type": "number"},
            {"id": "rate-max", "name": "rate_limit_max_requests", "value": 60, "type": "number"},
            {"id": "table-chat-ru", "name": "table_chat_histories_ru", "value": "n8n_chat_histories_ru", "type": "string"},
            {"id": "table-chat-en", "name": "table_chat_histories_en", "value": "n8n_chat_histories_en", "type": "string"},
            {"id": "table-contacts", "name": "table_user_contact_data", "value": "user_contact_data", "type": "string"},
            {"id": "table-prechat", "name": "table_prechat_submissions", "value": "prechat_submissions", "type": "string"},
            {"id": "gemini-single", "name": "gemini_model_single", "value": "models/gemini-2.0-flash", "type": "string"},
            {"id": "gemini-batch", "name": "gemini_model_batch", "value": "models/gemini-2.5-flash-lite", "type": "string"},
            {"id": "gemini-temp", "name": "gemini_temperature", "value": 0.3, "type": "number"}
          ]
        },
        "options": {}
      },
      "id": "config-node",
      "name": "âš™ï¸ CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-1248, 368]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "extract-contact-data",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {"entries": [{"name": "Content-Type", "value": "application/json"}]}
        }
      },
      "id": "9482fd9f-fb9a-4d1f-a528-6877a19335cb",
      "name": "ğŸŒ Webhook: Extract Contact",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-1424, 368],
      "webhookId": "extract-contact-data-webhook"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸: API KEY + RATE LIMITING\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $('âš™ï¸ CONFIG').first().json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('ğŸŒ Webhook: Extract Contact').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1056, 368],
      "id": "33edc2cc-99c0-4399-af50-aae484e3eb6e",
      "name": "ğŸ” Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2},
          "conditions": [{"id": "auth-condition", "leftValue": "={{ $json.authorized }}", "rightValue": "", "operator": {"type": "boolean", "operation": "true", "singleValue": true}}],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-880, 368],
      "id": "970e429f-0763-45a2-b533-78ab2d9ac06e",
      "name": "â“ Auth Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {"responseCode": "={{ $json.error.status }}"}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [-688, 496],
      "id": "f9a9858a-b274-40c0-a36e-d5a7e809ef96",
      "name": "âŒ Error Response"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¥ Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst requestData = items[0].json.body || items[0].json;\nconst sessionId = requestData.sessionId;\nconst extractionType = requestData.type || 'single';\n\nreturn [{\n    json: {\n        sessionId: sessionId,\n        extractionType: extractionType\n    }\n}];"
      },
      "id": "b794ec13-62f3-41ba-8c17-155d1cf2626b",
      "name": "ğŸ“¥ Process Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-688, 352]
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 1},
          "conditions": [{"leftValue": "={{ $json.extractionType }}", "rightValue": "single", "operator": {"type": "string", "operation": "equals"}}],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "73ede9a3-1374-4970-9e90-8a2a78034c9b",
      "name": "â“ Check Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [-464, 352]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ single ÑĞµÑÑĞ¸Ğ¸\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH last_extraction AS (\n    SELECT COALESCE(last_updated, '1970-01-01'::timestamp) as last_extracted\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}\n    WHERE session_id = '{{ $json.sessionId }}'\n),\nall_chats AS (\n    SELECT id, session_id, message::json->>'type' as message_type, message::json->>'content' as content, created_at as timestamp, platform, 'ru' as language\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_ru }}\n    WHERE session_id = '{{ $json.sessionId }}'\n      AND created_at > COALESCE((SELECT last_extracted FROM last_extraction), '1970-01-01'::timestamp)\n    UNION ALL\n    SELECT id, session_id, message::json->>'type' as message_type, message::json->>'content' as content, created_at as timestamp, platform, 'en' as language\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_en }}\n    WHERE session_id = '{{ $json.sessionId }}'\n      AND created_at > COALESCE((SELECT last_extracted FROM last_extraction), '1970-01-01'::timestamp)\n)\nSELECT * FROM all_chats ORDER BY timestamp ASC;",
        "options": {}
      },
      "id": "85e9c47b-f83f-4da3-9c3c-4685eaf5e3ca",
      "name": "ğŸ˜ Get Single Dialog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-240, 112],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“¥ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°ĞºĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ² Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH recent_dialogs AS (\n    SELECT session_id, MAX(created_at) as last_message\n    FROM (\n        SELECT session_id, created_at FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_ru }}\n        UNION ALL\n        SELECT session_id, created_at FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_en }}\n    ) all_messages\n    WHERE created_at > NOW() - INTERVAL '24 hours'\n    GROUP BY session_id\n),\nsessions_to_process AS (\n    SELECT rd.session_id, rd.last_message, COALESCE(ucd.last_updated, '1970-01-01'::timestamp) as last_extracted\n    FROM recent_dialogs rd\n    LEFT JOIN {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }} ucd ON rd.session_id = ucd.session_id\n    WHERE ucd.session_id IS NULL OR ucd.last_updated < rd.last_message\n    LIMIT 20\n)\nSELECT ac.id, ac.session_id, ac.message_type, ac.content, ac.timestamp, ac.platform, ac.language\nFROM (\n    SELECT r.id, r.session_id, r.message::json->>'type' as message_type, r.message::json->>'content' as content, r.created_at as timestamp, r.platform, 'ru' as language\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_ru }} r\n    INNER JOIN sessions_to_process stp ON r.session_id = stp.session_id\n    WHERE r.created_at > stp.last_extracted\n    UNION ALL\n    SELECT e.id, e.session_id, e.message::json->>'type' as message_type, e.message::json->>'content' as content, e.created_at as timestamp, e.platform, 'en' as language\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_chat_histories_en }} e\n    INNER JOIN sessions_to_process stp ON e.session_id = stp.session_id\n    WHERE e.created_at > stp.last_extracted\n) ac\nORDER BY ac.session_id, ac.timestamp;",
        "options": {}
      },
      "id": "d1eea9f7-ad09-4217-9c2d-b94e0ebe5b55",
      "name": "ğŸ˜ Get Batch Dialogs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-224, 576],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {"jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… batch\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn items;"}
      },
      "id": "739eb108-5377-4f2b-ba00-b3d45948c337",
      "name": "ğŸ“¤ Pass Batch Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [0, 576]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾ session_id\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst sessions = {};\n\nitems.forEach(item => {\n    const data = item.json;\n    const sessionId = data.session_id;\n    \n    if (!sessions[sessionId]) {\n        sessions[sessionId] = {\n            sessionId: sessionId,\n            language: data.language,\n            platform: data.platform || 'unknown',\n            messages: []\n        };\n    }\n    \n    sessions[sessionId].messages.push({\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp\n    });\n});\n\nconst result = Object.values(sessions).map(session => ({\n    json: session\n}));\n\nreturn result;"
      },
      "id": "dd2de959-6725-40ae-9ebe-bc8050142793",
      "name": "ğŸ“Š Group By Session",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [208, 576]
    },
    {
      "parameters": {"options": {}},
      "id": "7ff364e4-518c-45f5-a7ba-a7312ceb961a",
      "name": "ğŸ”„ Loop Over Sessions",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [448, 576]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ´Ğ»Ñ AI (Loop)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst sessionData = items[0].json;\nconst sessionId = sessionData.sessionId;\nconst messages = sessionData.messages || [];\nconst language = sessionData.language;\nconst platform = sessionData.platform;\n\nlet platformInfo = '';\nif (sessionId.startsWith('telegram_')) {\n    platformInfo = '\\nĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°: Telegram (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ±Ğ°Ğ·Ñƒ user_contact_data Ğ´Ğ»Ñ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ)';\n} else if (sessionId.startsWith('webchat_')) {\n    platformInfo = '\\nĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°: WebChat (Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ)';\n} else if (sessionId.startsWith('whatsapp_')) {\n    platformInfo = '\\nĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°: WhatsApp (Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ² session_id)';\n}\n\nconst conversation = messages.map(msg => \n    `${msg.type === 'human' ? 'ĞšĞ»Ğ¸ĞµĞ½Ñ‚' : 'Ğ‘Ğ¾Ñ‚'}: ${msg.content}`\n).join('\\n');\n\nreturn [{\n    json: {\n        sessionId: sessionId,\n        language: language,\n        platform: platform,\n        platformInfo: platformInfo,\n        conversation: conversation,\n        messagesCount: messages.length\n    }\n}];"
      },
      "id": "b3981f67-d74e-4c80-b9e1-f53dca4826b3",
      "name": "ğŸ“ Format Loop Dialog",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [656, 576]
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 1},
          "conditions": [{"leftValue": "={{ $json.platform }}", "rightValue": "webchat", "operator": {"type": "string", "operation": "equals"}}],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ee75e5a6-c200-4265-83f6-15e6bb076922",
      "name": "â“ IF Webchat Loop",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [864, 576]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT session_id, name, email, phone, company, custom_fields\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_prechat_submissions }}\nWHERE session_id = '{{ $json.sessionId }}'\nLIMIT 1;",
        "options": {}
      },
      "id": "7ccd7187-cf95-49b7-bcc1-7aaa8b3e0c21",
      "name": "ğŸ˜ Get PreChat Loop",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1072, 480],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… prechat\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dialogData = $('ğŸ“ Format Loop Dialog').first().json;\nconst preChat = items[0]?.json || null;\nconst hasPreChat = !!(preChat && preChat.session_id);\n\nreturn [{\n    json: {\n        ...dialogData,\n        preChat: hasPreChat ? preChat : null,\n        hasPreChat: hasPreChat\n    }\n}];"
      },
      "id": "b8d74fcd-8ef1-474b-a324-4ee138110ebf",
      "name": "ğŸ“¤ Pass PreChat Loop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1280, 480]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Ğ”Ğ»Ñ Ğ½Ğµ-webchat Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼ - Ğ±ĞµĞ· prechat\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dialogData = $('ğŸ“ Format Loop Dialog').first().json;\n\nreturn [{\n    json: {\n        ...dialogData,\n        preChat: null,\n        hasPreChat: false\n    }\n}];"
      },
      "id": "7a762006-42b7-4e3a-84ae-95b966ae00cc",
      "name": "ğŸ“¤ Pass Empty PreChat",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1072, 672]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSELECT session_id, platform, platform_user_id, platform_username, platform_first_name, full_name, telegram, confidence_score\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}\nWHERE session_id = '{{ $json.sessionId }}';",
        "options": {}
      },
      "id": "8ad23489-b30e-4f25-95d6-394f408894df",
      "name": "ğŸ˜ Check Loop Existing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1488, 576],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ merge\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst existingContact = items.length > 0 && items[0].json ? items[0].json : null;\n\nreturn [{\n    json: {\n        existingContact: existingContact\n    }\n}];"
      },
      "id": "44b05f38-73b4-4d7c-85c8-a6dc6bbac3fb",
      "name": "ğŸ“¤ Pass Loop Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1696, 576]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”€ ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ AI\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet dialogData;\ntry {\n    dialogData = $('ğŸ“¤ Pass PreChat Loop').first().json;\n} catch (e) {\n    try {\n        dialogData = $('ğŸ“¤ Pass Empty PreChat').first().json;\n    } catch (e2) {\n        dialogData = $('ğŸ“ Format Loop Dialog').first().json;\n    }\n}\n\nconst checkData = items[0].json;\nconst existingContact = checkData.existingContact;\nconst preChat = dialogData.preChat || null;\nconst hasPreChat = dialogData.hasPreChat || false;\n\nlet contextInfo = dialogData.platformInfo || '';\n\nlet preChatInfo = '';\nif (hasPreChat && preChat) {\n    preChatInfo = `\\n\\nğŸ“‹ Ğ”ĞĞĞĞ«Ğ• Ğ˜Ğ— Ğ¤ĞĞ ĞœĞ« PRECHAT (Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ´ Ñ‡Ğ°Ñ‚Ğ¾Ğ¼):\\n- Ğ˜Ğ¼Ñ: ${preChat.name || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}\\n- Email: ${preChat.email || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}\\n- Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: ${preChat.phone || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}\\n- ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: ${preChat.company || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°'}`;\n}\n\nif (existingContact) {\n    if (existingContact.platform === 'telegram' && existingContact.platform_first_name) {\n        contextInfo += `\\nĞ’ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ Telegram ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾ Ğ¸Ğ¼Ñ: ${existingContact.platform_first_name}`;\n    }\n    if (existingContact.platform_username) {\n        contextInfo += `\\nTelegram username: ${existingContact.platform_username}`;\n    }\n    if (existingContact.full_name && existingContact.confidence_score < 100) {\n        contextInfo += `\\nĞ Ğ°Ğ½ĞµĞµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ¸Ğ¼Ñ: ${existingContact.full_name} (confidence: ${existingContact.confidence_score})`;\n    }\n}\n\nreturn [{\n    json: {\n        sessionId: dialogData.sessionId,\n        language: dialogData.language,\n        platform: dialogData.platform,\n        platformInfo: contextInfo,\n        preChatInfo: preChatInfo,\n        conversation: dialogData.conversation,\n        hasExistingContact: !!existingContact,\n        existingConfidence: existingContact ? existingContact.confidence_score : 0,\n        hasPreChat: hasPreChat\n    }\n}];"
      },
      "id": "98a4199e-aa6e-40e1-b6fe-eb0d8c430c51",
      "name": "ğŸ”€ Merge Loop Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1904, 576]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Session ID: {{ $json.sessionId }}\nĞ¯Ğ·Ñ‹Ğº: {{ $json.language }}\n{{ $json.platformInfo }}\n{{ $json.preChatInfo }}\n\nğŸ’¬ Ğ”Ğ˜ĞĞ›ĞĞ“:\n{{ $json.conversation }}",
        "options": {
          "systemMessage": "=#Ğ Ğ¾Ğ»ÑŒ: Ğ’Ñ‹ â€” ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸ Ğ¸ AI-Ğ°Ğ³ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸.\n\n#Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°: ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ ĞĞ”ĞĞĞ™ ÑĞµÑÑĞ¸Ğ¸ Ğ¸ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ğ²ÑĞµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¸Ğ¼ĞµĞ½Ğ°, Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñ‹, email, Ğ¼ĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€Ñ‹ Ğ¸ Ğ´Ñ€ÑƒĞ³ÑƒÑ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ.\n\n#ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ - Ğ ĞĞ—Ğ›Ğ˜Ğ§ĞĞ™ ĞĞ¢ĞŸĞ ĞĞ’Ğ˜Ğ¢Ğ•Ğ›Ğ¯ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™:\n\nĞ’ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ ĞµÑÑ‚ÑŒ Ğ”Ğ’Ğ Ñ‚Ğ¸Ğ¿Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹:\n- \"ĞšĞ»Ğ¸ĞµĞ½Ñ‚:\" â†’ ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯ (Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°)\n- \"Ğ‘Ğ¾Ñ‚:\" â†’ ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ AI-Ğ‘ĞĞ¢Ğ/ĞœĞ•ĞĞ•Ğ”Ğ–Ğ•Ğ Ğ\n\nâš ï¸ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ: Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ!\n\nâŒ Ğ˜Ğ“ĞĞĞ Ğ˜Ğ Ğ£Ğ™ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ±Ğ¾Ñ‚Ğ°:\n- Ğ‘Ğ¾Ñ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑ‚ÑŒÑÑ: \"ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ ĞĞ½Ğ½Ğ°\" â†’ ĞĞ• Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°Ñ‚ÑŒ\n- Ğ‘Ğ¾Ñ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸: \"ĞĞ°Ñˆ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ +7-999-111-22-33\" â†’ ĞĞ• Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°Ñ‚ÑŒ\n- Ğ‘Ğ¾Ñ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ email Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸: \"ĞŸĞ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ° support@company.com\" â†’ ĞĞ• Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°Ñ‚ÑŒ\n\nâœ… Ğ˜Ğ—Ğ’Ğ›Ğ•ĞšĞĞ™ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:\n- ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ: \"ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" â†’ Ğ˜Ğ—Ğ’Ğ›Ğ•Ğ§Ğ¬ Ğ¸Ğ¼Ñ\n- ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ°Ñ‘Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½: \"ĞœĞ¾Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ +7-999-222-33-44\" â†’ Ğ˜Ğ—Ğ’Ğ›Ğ•Ğ§Ğ¬ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½\n- ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ°Ñ‘Ñ‚ email: \"ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¼Ğ½Ğµ Ğ½Ğ° lobzik@mail.ru\" â†’ Ğ˜Ğ—Ğ’Ğ›Ğ•Ğ§Ğ¬ email\n\n#Ğ”ĞĞĞĞ«Ğ• Ğ˜Ğ— Ğ¤ĞĞ ĞœĞ« PRECHAT:\n\nĞŸĞµÑ€ĞµĞ´ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¼Ğ¾Ğ³ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°Ğ¼Ğ¸ (ÑĞµĞºÑ†Ğ¸Ñ ğŸ“‹ Ğ”ĞĞĞĞ«Ğ• Ğ˜Ğ— Ğ¤ĞĞ ĞœĞ« PRECHAT).\nĞ­Ñ‚Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ĞºĞ°Ğº FALLBACK (Ğ·Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº):\n\n- ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 1: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ”Ğ˜ĞĞ›ĞĞ“Ğ (ĞºĞ»Ğ¸ĞµĞ½Ñ‚ ÑĞ²Ğ½Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ») â†’ confidence 100\n- ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 2: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¤ĞĞ ĞœĞ« PRECHAT (ĞµÑĞ»Ğ¸ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ Ğ½ĞµÑ‚) â†’ confidence 50-70\n- ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 3: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¼ĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€Ğ° â†’ confidence 60\n\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ğ’ Ñ„Ğ¾Ñ€Ğ¼Ğµ Ğ¸Ğ¼Ñ \"Ğ›Ğ°Ğ¿Ğ¾Ñ‚ÑŒ\", Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ» \"ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" â†’ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ \"Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" (Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°)\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ğ’ Ñ„Ğ¾Ñ€Ğ¼Ğµ email \"test@mail.com\", Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ email Ğ½Ğµ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ»ÑÑ â†’ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ \"test@mail.com\" Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹\n\n#ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ« ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ™ Ğ ĞĞ‘ĞĞ¢Ğ«:\n\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 1 - ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ±Ğ¾Ñ‚Ğ° (Ğ˜Ğ“ĞĞĞ Ğ˜Ğ ĞĞ’ĞĞ¢Ğ¬):\nĞ‘Ğ¾Ñ‚: Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ! ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ Cryptonus, Ñ AI-ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚. Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸: +7-999-111-22-33\nĞšĞ»Ğ¸ĞµĞ½Ñ‚: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ñ Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\n\nĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚:\n- name: \"Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" â† Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°\n- phone: null â† Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ±Ğ¾Ñ‚Ğ° Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼\n\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 2 - ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ°Ğ´ Ñ„Ğ¾Ñ€Ğ¼Ğ¾Ğ¹:\nğŸ“‹ Ğ”ĞĞĞĞ«Ğ• Ğ˜Ğ— Ğ¤ĞĞ ĞœĞ«: Ğ˜Ğ¼Ñ: Ğ›Ğ°Ğ¿Ğ¾Ñ‚ÑŒ, Email: lapot@mail.com\nĞšĞ»Ğ¸ĞµĞ½Ñ‚: ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\n\nĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚:\n- name: \"Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" â† Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° (Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚!)\n- email: \"lapot@mail.com\" â† Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹ (fallback)\n\n#Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ:\n\n1. **Ğ˜Ğ¼Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°**:\n   - ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 1: ĞšĞ»Ğ¸ĞµĞ½Ñ‚ ÑĞ²Ğ½Ğ¾ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ğ»ÑÑ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ\n   - ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 2: Ğ˜Ğ¼Ñ Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹ prechat (ĞµÑĞ»Ğ¸ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ Ğ½ĞµÑ‚)\n   - ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 3: Ğ‘Ğ¾Ñ‚ Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğº ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸\n   - ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 4: Ğ˜Ğ¼Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¼ĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€Ğ°\n\n2. **Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½/Email**:\n   - ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 1: ĞšĞ»Ğ¸ĞµĞ½Ñ‚ ÑƒĞºĞ°Ğ·Ğ°Ğ» Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ\n   - ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 2: Ğ˜Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹ prechat\n   - ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 3: Ğ˜Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ\n\n#ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ”Ğ›Ğ¯ Ğ£Ğ’Ğ•Ğ Ğ•ĞĞĞĞ¡Ğ¢Ğ˜ (confidence):\n\n- ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¯Ğ’ĞĞ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ğ»ÑÑ/ÑƒĞºĞ°Ğ·Ğ°Ğ» Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ â†’ confidence = 100\n- Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹ prechat (ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ» Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ) â†’ confidence = 60\n- Ğ‘Ğ¾Ñ‚ Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğº ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ â†’ confidence = 85\n- Ğ˜Ğ¼Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¼ĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€Ğ° â†’ confidence = 60\n- Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒĞ³Ğ°Ğ´Ğ°Ğ½Ñ‹ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° â†’ confidence = 40\n\n#ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°:\n- Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ, Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞ¹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±Ğ¾Ñ‚Ğ°/ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸\n- ĞĞ• Ğ¿Ñ€Ğ¸Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ\n- ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñ‹ Ğº Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñƒ +7XXXXXXXXXX Ğ´Ğ»Ñ Ğ Ğ¤\n- Ğ’ extractedFrom ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº: \"Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°\", \"Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹ prechat\", \"Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ\"\n\n#Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° - Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹ JSON:\n{\n  \"sessionId\": \"id ÑĞµÑÑĞ¸Ğ¸\",\n  \"name\": \"Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ¸Ğ»Ğ¸ null\",\n  \"firstName\": \"Ğ¸Ğ¼Ñ Ğ¸Ğ»Ğ¸ null\",\n  \"lastName\": \"Ñ„Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ Ğ¸Ğ»Ğ¸ null\",\n  \"phone\": \"Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¸Ğ»Ğ¸ null\",\n  \"phoneRaw\": \"Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ ĞºĞ°Ğº ÑƒĞºĞ°Ğ·Ğ°Ğ½ Ğ¸Ğ»Ğ¸ null\",\n  \"email\": \"email Ğ¸Ğ»Ğ¸ null\",\n  \"telegram\": \"@username Ğ¸Ğ»Ğ¸ null\",\n  \"whatsapp\": \"Ğ½Ğ¾Ğ¼ĞµÑ€ WhatsApp Ğ¸Ğ»Ğ¸ null\",\n  \"otherContacts\": {},\n  \"company\": \"ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ null\",\n  \"position\": \"Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ»Ğ¸ null\",\n  \"location\": \"Ğ³Ğ¾Ñ€Ğ¾Ğ´/ÑÑ‚Ñ€Ğ°Ğ½Ğ° Ğ¸Ğ»Ğ¸ null\",\n  \"preferredContact\": \"ÑĞ¿Ğ¾ÑĞ¾Ğ± ÑĞ²ÑĞ·Ğ¸ Ğ¸Ğ»Ğ¸ null\",\n  \"extractedFrom\": \"Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…\",\n  \"confidence\": Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¾Ñ‚ 0 Ğ´Ğ¾ 100\n}\n\nĞ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ JSON Ğ±ĞµĞ· markdown Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [2112, 576],
      "id": "596b290f-2fa8-4d65-8c61-e9efdf9bc545",
      "name": "ğŸ¤– AI Batch Extractor"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [2352, 752],
      "id": "e946428d-9e86-4370-b357-af2c29d928fc",
      "name": "ğŸ’­ Think Batch"
    },
    {
      "parameters": {
        "modelName": "={{ $('âš™ï¸ CONFIG').first().json.gemini_model_batch }}",
        "options": {"temperature": "={{ $('âš™ï¸ CONFIG').first().json.gemini_temperature }}"}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [2048, 752],
      "id": "4c8a7615-b3ee-4db7-b010-9b466f5bc59b",
      "name": "ğŸ§  Gemini Batch",
      "credentials": {"googlePalmApi": {"id": "YOUR_GEMINI_CREDENTIAL_ID", "name": "Google Gemini(PaLM) Api account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“‹ ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° AI (Batch)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst aiResponse = items[0].json.output || items[0].json.response || items[0].json;\n\nlet contactData;\ntry {\n    if (typeof aiResponse === 'string') {\n        let cleanJson = aiResponse;\n        cleanJson = cleanJson.replace(/```json\\s*/g, '').replace(/```\\s*/g, '');\n        const firstBrace = cleanJson.indexOf('{');\n        if (firstBrace > 0) { cleanJson = cleanJson.substring(firstBrace); }\n        const lastBrace = cleanJson.lastIndexOf('}');\n        if (lastBrace !== -1 && lastBrace < cleanJson.length - 1) { cleanJson = cleanJson.substring(0, lastBrace + 1); }\n        const parsedData = JSON.parse(cleanJson);\n        if (parsedData.contacts && Array.isArray(parsedData.contacts) && parsedData.contacts.length > 0) {\n            contactData = parsedData.contacts[0];\n        } else {\n            contactData = parsedData;\n        }\n    } else {\n        if (aiResponse.contacts && Array.isArray(aiResponse.contacts) && aiResponse.contacts.length > 0) {\n            contactData = aiResponse.contacts[0];\n        } else {\n            contactData = aiResponse;\n        }\n    }\n    if (!contactData.sessionId) { throw new Error('Missing sessionId in response'); }\n} catch (error) {\n    const sessionData = $('ğŸ”€ Merge Loop Data').first().json;\n    contactData = {\n        sessionId: sessionData.sessionId, name: null, firstName: null, lastName: null,\n        phone: null, phoneRaw: null, email: null, telegram: null, whatsapp: null,\n        otherContacts: null, company: null, position: null, location: null,\n        preferredContact: null, extractedFrom: 'AI parse error: ' + error.message, confidence: 0\n    };\n}\n\nreturn [{json: contactData}];"
      },
      "id": "0fd92d5d-9fcb-4100-8e22-96df4150fdb3",
      "name": "ğŸ“‹ Parse Batch Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2480, 576]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ° (Batch)\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nINSERT INTO {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }} (\n    session_id, platform, full_name, first_name, last_name, phone, phone_raw, email,\n    telegram, whatsapp, other_contacts, company, position, location, preferred_contact,\n    extracted_from, confidence_score, last_updated\n) VALUES (\n    '{{ $json.sessionId }}',\n    CASE WHEN '{{ $json.sessionId }}' LIKE 'telegram_%' THEN 'telegram' WHEN '{{ $json.sessionId }}' LIKE 'webchat_%' THEN 'webchat' WHEN '{{ $json.sessionId }}' LIKE 'whatsapp_%' THEN 'whatsapp' ELSE 'unknown' END,\n    {{ $json.name ? \"'\" + String($json.name).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.firstName ? \"'\" + String($json.firstName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.lastName ? \"'\" + String($json.lastName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.phone ? \"'\" + $json.phone + \"'\" : 'NULL' }},\n    {{ $json.phoneRaw ? \"'\" + $json.phoneRaw + \"'\" : 'NULL' }},\n    {{ $json.email ? \"'\" + $json.email + \"'\" : 'NULL' }},\n    {{ $json.telegram ? \"'\" + $json.telegram + \"'\" : 'NULL' }},\n    {{ $json.whatsapp ? \"'\" + $json.whatsapp + \"'\" : 'NULL' }},\n    {{ $json.otherContacts && Object.keys($json.otherContacts).length > 0 ? \"'\" + JSON.stringify($json.otherContacts).replace(/'/g, \"''\") + \"'::jsonb\" : 'NULL' }},\n    {{ $json.company ? \"'\" + String($json.company).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.position ? \"'\" + String($json.position).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.location ? \"'\" + String($json.location).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.preferredContact ? \"'\" + $json.preferredContact + \"'\" : 'NULL' }},\n    {{ $json.extractedFrom ? \"'\" + String($json.extractedFrom).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.confidence || 0 }},\n    CURRENT_TIMESTAMP\n)\nON CONFLICT (session_id)\nDO UPDATE SET\n    full_name = CASE \n        WHEN EXCLUDED.extracted_from LIKE '%Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°%' AND ({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.extracted_from LIKE '%Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ%' OR {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.extracted_from IS NULL) AND EXCLUDED.full_name IS NOT NULL THEN EXCLUDED.full_name\n        WHEN EXCLUDED.confidence_score = {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.confidence_score AND EXCLUDED.extracted_from LIKE '%Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°%' AND EXCLUDED.full_name IS NOT NULL THEN EXCLUDED.full_name\n        WHEN EXCLUDED.confidence_score > COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.confidence_score, 0) AND EXCLUDED.full_name IS NOT NULL THEN EXCLUDED.full_name\n        WHEN {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name IS NULL AND EXCLUDED.full_name IS NOT NULL THEN EXCLUDED.full_name\n        ELSE {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name\n    END,\n    first_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.first_name, EXCLUDED.first_name),\n    last_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.last_name, EXCLUDED.last_name),\n    phone = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.phone, EXCLUDED.phone),\n    phone_raw = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.phone_raw, EXCLUDED.phone_raw),\n    email = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.email, EXCLUDED.email),\n    telegram = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.telegram, EXCLUDED.telegram),\n    whatsapp = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.whatsapp, EXCLUDED.whatsapp),\n    other_contacts = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.other_contacts, EXCLUDED.other_contacts),\n    company = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.company, EXCLUDED.company),\n    position = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.position, EXCLUDED.position),\n    location = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.location, EXCLUDED.location),\n    preferred_contact = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.preferred_contact, EXCLUDED.preferred_contact),\n    extracted_from = CASE WHEN EXCLUDED.full_name != {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name OR {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name IS NULL THEN EXCLUDED.extracted_from ELSE {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.extracted_from END,\n    confidence_score = GREATEST(EXCLUDED.confidence_score, COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)),\n    last_updated = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "id": "21a9846b-90c5-41b1-8af5-4dc806d64460",
      "name": "ğŸ˜ Save Batch Contact",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [2688, 576],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {"jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ² Loop\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn items;"}
      },
      "id": "6a6385a0-48f3-4139-bbab-245f78007e89",
      "name": "ğŸ“¤ Pass To Loop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2976, 752]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š ĞĞ³Ñ€ĞµĞ³Ğ°Ñ†Ğ¸Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² batch\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst allResults = items;\n\nconst summary = {\n    totalProcessed: allResults.length,\n    successful: allResults.filter(i => i.json.session_id).length,\n    failed: allResults.filter(i => !i.json.session_id).length,\n    timestamp: new Date().toISOString()\n};\n\nreturn [{json: summary}];"
      },
      "id": "3cd111e8-ae21-4fea-8276-ed7e9cbde049",
      "name": "ğŸ“Š Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [656, 416]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\"status\": \"success\", \"message\": \"Batch contact extraction completed\", \"processed\": $json.totalProcessed, \"successful\": $json.successful, \"failed\": $json.failed} }}",
        "options": {}
      },
      "id": "7147f36d-cd53-498c-b7cc-f59f2b19e560",
      "name": "âœ… Respond Batch",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [864, 416]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ´Ğ»Ñ Single extraction\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dialogs = items;\nconst sessions = {};\n\ndialogs.forEach(item => {\n    const data = item.json;\n    if (!sessions[data.session_id]) {\n        sessions[data.session_id] = {\n            messages: [],\n            language: data.language,\n            platform: data.platform || 'unknown'\n        };\n    }\n    sessions[data.session_id].messages.push({\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp\n    });\n});\n\nconst dialogsForExtraction = [];\n\nfor (const [sessionId, data] of Object.entries(sessions)) {\n    let platformInfo = '';\n    if (sessionId.startsWith('telegram_')) {\n        platformInfo = '\\nĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°: Telegram (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ±Ğ°Ğ·Ñƒ user_contact_data Ğ´Ğ»Ñ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ)';\n    } else if (sessionId.startsWith('webchat_')) {\n        platformInfo = '\\nĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°: WebChat (Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ)';\n    } else if (sessionId.startsWith('whatsapp_')) {\n        platformInfo = '\\nĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°: WhatsApp (Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ² session_id)';\n    }\n    dialogsForExtraction.push({\n        sessionId: sessionId,\n        language: data.language,\n        platform: data.platform,\n        platformInfo: platformInfo,\n        conversation: data.messages.map(msg => `${msg.type === 'human' ? 'ĞšĞ»Ğ¸ĞµĞ½Ñ‚' : 'Ğ‘Ğ¾Ñ‚'}: ${msg.content}`).join('\\n')\n    });\n}\n\nreturn [{ json: { dialogs: dialogsForExtraction, totalDialogs: dialogsForExtraction.length } }];"
      },
      "id": "8820cbec-d0bd-4468-a5e6-6627ae170259",
      "name": "ğŸ“ Format Single Dialog",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-16, 112]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT session_id, name, email, phone, company, custom_fields\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_prechat_submissions }}\nWHERE session_id IN (\n    {{ $json.dialogs.filter(d => d.platform === 'webchat').map(d => \"'\" + d.sessionId + \"'\").join(',') || \"''\" }}\n);",
        "options": {}
      },
      "id": "a14eaf5d-21f9-4796-a276-5c7cded17303",
      "name": "ğŸ˜ Get PreChat Single",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [192, 0],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¤ ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° prechat Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ single\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dialogsData = $('ğŸ“ Format Single Dialog').first().json;\nconst preChatItems = items || [];\n\nconst preChatMap = {};\npreChatItems.forEach(item => {\n    if (item.json && item.json.session_id) {\n        preChatMap[item.json.session_id] = item.json;\n    }\n});\n\nreturn [{ json: { dialogs: dialogsData.dialogs, totalDialogs: dialogsData.totalDialogs, preChatMap: preChatMap } }];"
      },
      "id": "ec5b3148-f76f-4f91-8d34-b3dc63ae1158",
      "name": "ğŸ“¤ Pass PreChat Single",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 0]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ” ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Single\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSELECT session_id, platform, platform_user_id, platform_username, platform_first_name, full_name, telegram, confidence_score\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}\nWHERE session_id IN ( {{ $json.dialogs.map(d => \"'\" + d.sessionId + \"'\").join(',') }} );",
        "options": {}
      },
      "id": "5ce84515-f0a7-4d3b-b94c-98d259322833",
      "name": "ğŸ˜ Check Single Existing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [608, 112],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”€ ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Single extraction Ñ prechat\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst preChatData = $('ğŸ“¤ Pass PreChat Single').first().json;\nconst dialogsData = preChatData;\nconst preChatMap = preChatData.preChatMap || {};\nconst existingContacts = $input.all();\n\nconst contactsMap = {};\nexistingContacts.forEach(item => {\n    const contact = item.json;\n    if (contact && contact.session_id) {\n        contactsMap[contact.session_id] = {\n            platform: contact.platform,\n            platform_username: contact.platform_username,\n            platform_first_name: contact.platform_first_name,\n            existing_name: contact.full_name,\n            existing_telegram: contact.telegram,\n            confidence_score: contact.confidence_score\n        };\n    }\n});\n\nconst enrichedDialogs = dialogsData.dialogs.map(dialog => {\n    const existingContact = contactsMap[dialog.sessionId];\n    const preChat = preChatMap[dialog.sessionId] || null;\n    \n    let contextInfo = dialog.platformInfo || '';\n    let preChatInfo = '';\n    \n    if (preChat && dialog.platform === 'webchat') {\n        preChatInfo = `\\n\\nğŸ“‹ Ğ”ĞĞĞĞ«Ğ• Ğ˜Ğ— Ğ¤ĞĞ ĞœĞ« PRECHAT (Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ´ Ñ‡Ğ°Ñ‚Ğ¾Ğ¼):\\n- Ğ˜Ğ¼Ñ: ${preChat.name || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}\\n- Email: ${preChat.email || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}\\n- Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: ${preChat.phone || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}\\n- ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: ${preChat.company || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°'}`;\n    }\n    \n    if (existingContact) {\n        if (existingContact.platform === 'telegram' && existingContact.platform_first_name) {\n            contextInfo += `\\nĞ’ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ Telegram ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾ Ğ¸Ğ¼Ñ: ${existingContact.platform_first_name}`;\n        }\n        if (existingContact.platform_username) {\n            contextInfo += `\\nTelegram username: ${existingContact.platform_username}`;\n        }\n        if (existingContact.existing_name && existingContact.confidence_score < 100) {\n            contextInfo += `\\nĞ Ğ°Ğ½ĞµĞµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ¸Ğ¼Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ: ${existingContact.existing_name} (confidence: ${existingContact.confidence_score})`;\n        }\n    }\n    \n    return {\n        ...dialog,\n        platformInfo: contextInfo,\n        preChatInfo: preChatInfo,\n        hasExistingContact: !!existingContact,\n        existingConfidence: existingContact ? existingContact.confidence_score : 0,\n        hasPreChat: !!preChat\n    };\n});\n\nreturn [{ json: { dialogs: enrichedDialogs, totalDialogs: enrichedDialogs.length } }];"
      },
      "id": "c78fb91f-fa89-4c0b-a486-439b51c4309d",
      "name": "ğŸ”€ Merge Single Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [848, 112]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²: {{ $json.totalDialogs }}\n\nĞ”Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:\n{{ $json.dialogs.map((d, i) => `\\n--- Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ ${i+1} (Session: ${d.sessionId}, ${d.language}, ${d.platform}) ---${d.platformInfo}${d.preChatInfo}\\n\\nğŸ’¬ Ğ”Ğ˜ĞĞ›ĞĞ“:\\n${d.conversation}`).join('\\n\\n') }}",
        "options": {
          "systemMessage": "=#Ğ Ğ¾Ğ»ÑŒ: Ğ’Ñ‹ â€” ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸ Ğ¸ AI-Ğ°Ğ³ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸.\n\n#Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°: ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ¸ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ğ²ÑĞµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞšĞ›Ğ˜Ğ•ĞĞ¢ĞĞ’, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¸Ğ¼ĞµĞ½Ğ°, Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñ‹, email, Ğ¼ĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€Ñ‹.\n\n#ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ - Ğ ĞĞ—Ğ›Ğ˜Ğ§ĞĞ™ ĞĞ¢ĞŸĞ ĞĞ’Ğ˜Ğ¢Ğ•Ğ›Ğ¯ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™:\n\nĞ’ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ ĞµÑÑ‚ÑŒ Ğ”Ğ’Ğ Ñ‚Ğ¸Ğ¿Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹:\n- \"ĞšĞ»Ğ¸ĞµĞ½Ñ‚:\" â†’ ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯ (Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°)\n- \"Ğ‘Ğ¾Ñ‚:\" â†’ ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ AI-Ğ‘ĞĞ¢Ğ/ĞœĞ•ĞĞ•Ğ”Ğ–Ğ•Ğ Ğ\n\nâš ï¸ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ: Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ!\n\nâŒ Ğ˜Ğ“ĞĞĞ Ğ˜Ğ Ğ£Ğ™ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ±Ğ¾Ñ‚Ğ°:\n- Ğ‘Ğ¾Ñ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑ‚ÑŒÑÑ: \"ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ ĞĞ½Ğ½Ğ°\" â†’ ĞĞ• Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°Ñ‚ÑŒ\n- Ğ‘Ğ¾Ñ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸: \"ĞĞ°Ñˆ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ +7-999-111-22-33\" â†’ ĞĞ• Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°Ñ‚ÑŒ\n- Ğ‘Ğ¾Ñ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ email Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸: \"ĞŸĞ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ° support@company.com\" â†’ ĞĞ• Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°Ñ‚ÑŒ\n\nâœ… Ğ˜Ğ—Ğ’Ğ›Ğ•ĞšĞĞ™ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:\n- ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ: \"ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" â†’ Ğ˜Ğ—Ğ’Ğ›Ğ•Ğ§Ğ¬ Ğ¸Ğ¼Ñ\n- ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ°Ñ‘Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½: \"ĞœĞ¾Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ +7-999-222-33-44\" â†’ Ğ˜Ğ—Ğ’Ğ›Ğ•Ğ§Ğ¬ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½\n- ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ°Ñ‘Ñ‚ email: \"ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¼Ğ½Ğµ Ğ½Ğ° lobzik@mail.ru\" â†’ Ğ˜Ğ—Ğ’Ğ›Ğ•Ğ§Ğ¬ email\n\n#Ğ”ĞĞĞĞ«Ğ• Ğ˜Ğ— Ğ¤ĞĞ ĞœĞ« PRECHAT:\n\nĞŸĞµÑ€ĞµĞ´ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¼Ğ¾Ğ³ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°Ğ¼Ğ¸ (ÑĞµĞºÑ†Ğ¸Ñ ğŸ“‹ Ğ”ĞĞĞĞ«Ğ• Ğ˜Ğ— Ğ¤ĞĞ ĞœĞ« PRECHAT).\nĞ­Ñ‚Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ĞºĞ°Ğº FALLBACK (Ğ·Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº):\n\n- ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 1: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ”Ğ˜ĞĞ›ĞĞ“Ğ (ĞºĞ»Ğ¸ĞµĞ½Ñ‚ ÑĞ²Ğ½Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ») â†’ confidence 100\n- ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 2: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¤ĞĞ ĞœĞ« PRECHAT (ĞµÑĞ»Ğ¸ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ Ğ½ĞµÑ‚) â†’ confidence 50-70\n- ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ 3: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¼ĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€Ğ° â†’ confidence 60\n\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ğ’ Ñ„Ğ¾Ñ€Ğ¼Ğµ Ğ¸Ğ¼Ñ \"Ğ›Ğ°Ğ¿Ğ¾Ñ‚ÑŒ\", Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ» \"ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" â†’ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ \"Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" (Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°)\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ğ’ Ñ„Ğ¾Ñ€Ğ¼Ğµ email \"test@mail.com\", Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ email Ğ½Ğµ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ»ÑÑ â†’ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ \"test@mail.com\" Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹\n\n#ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ« ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ™ Ğ ĞĞ‘ĞĞ¢Ğ«:\n\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 1 - ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ±Ğ¾Ñ‚Ğ° (Ğ˜Ğ“ĞĞĞ Ğ˜Ğ ĞĞ’ĞĞ¢Ğ¬):\nĞ‘Ğ¾Ñ‚: Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ! ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ Cryptonus, Ñ AI-ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚. Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸: +7-999-111-22-33\nĞšĞ»Ğ¸ĞµĞ½Ñ‚: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ñ Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\n\nĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚:\n- name: \"Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" â† Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°\n- phone: null â† Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ±Ğ¾Ñ‚Ğ° Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼\n\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 2 - ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ°Ğ´ Ñ„Ğ¾Ñ€Ğ¼Ğ¾Ğ¹:\nğŸ“‹ Ğ”ĞĞĞĞ«Ğ• Ğ˜Ğ— Ğ¤ĞĞ ĞœĞ«: Ğ˜Ğ¼Ñ: Ğ›Ğ°Ğ¿Ğ¾Ñ‚ÑŒ, Email: lapot@mail.com\nĞšĞ»Ğ¸ĞµĞ½Ñ‚: ĞœĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚ Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\n\nĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚:\n- name: \"Ğ›Ğ¾Ğ±Ğ·Ğ¸Ğº\" â† Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° (Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚!)\n- email: \"lapot@mail.com\" â† Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹ (fallback)\n\n#ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ”Ğ›Ğ¯ Ğ£Ğ’Ğ•Ğ Ğ•ĞĞĞĞ¡Ğ¢Ğ˜ (confidence):\n\n- ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¯Ğ’ĞĞ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ğ»ÑÑ/ÑƒĞºĞ°Ğ·Ğ°Ğ» Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ â†’ confidence = 100\n- Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹ prechat (ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ» Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ) â†’ confidence = 60\n- Ğ‘Ğ¾Ñ‚ Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğº ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ â†’ confidence = 85\n- Ğ˜Ğ¼Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¼ĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€Ğ° â†’ confidence = 60\n- Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒĞ³Ğ°Ğ´Ğ°Ğ½Ñ‹ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° â†’ confidence = 40\n\n#ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°:\n- Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ, Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞ¹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±Ğ¾Ñ‚Ğ°/ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸\n- ĞĞ• Ğ¿Ñ€Ğ¸Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ\n- ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñ‹ Ğº Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñƒ +7XXXXXXXXXX Ğ´Ğ»Ñ Ğ Ğ¤\n- Ğ’ extractedFrom ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº: \"Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°\", \"Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹ prechat\", \"Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ\"\n\n#Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° - Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹ JSON:\n{\n  \"contacts\": [\n    {\n      \"sessionId\": \"id ÑĞµÑÑĞ¸Ğ¸\",\n      \"name\": \"Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ¸Ğ»Ğ¸ null\",\n      \"firstName\": \"Ğ¸Ğ¼Ñ Ğ¸Ğ»Ğ¸ null\",\n      \"lastName\": \"Ñ„Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ Ğ¸Ğ»Ğ¸ null\",\n      \"phone\": \"Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¸Ğ»Ğ¸ null\",\n      \"phoneRaw\": \"Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ ĞºĞ°Ğº ÑƒĞºĞ°Ğ·Ğ°Ğ½ Ğ¸Ğ»Ğ¸ null\",\n      \"email\": \"email Ğ¸Ğ»Ğ¸ null\",\n      \"telegram\": \"@username Ğ¸Ğ»Ğ¸ null\",\n      \"whatsapp\": \"Ğ½Ğ¾Ğ¼ĞµÑ€ WhatsApp Ğ¸Ğ»Ğ¸ null\",\n      \"otherContacts\": {},\n      \"company\": \"ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ null\",\n      \"position\": \"Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ»Ğ¸ null\",\n      \"location\": \"Ğ³Ğ¾Ñ€Ğ¾Ğ´/ÑÑ‚Ñ€Ğ°Ğ½Ğ° Ğ¸Ğ»Ğ¸ null\",\n      \"preferredContact\": \"ÑĞ¿Ğ¾ÑĞ¾Ğ± ÑĞ²ÑĞ·Ğ¸ Ğ¸Ğ»Ğ¸ null\",\n      \"extractedFrom\": \"Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…\",\n      \"confidence\": Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¾Ñ‚ 0 Ğ´Ğ¾ 100\n    }\n  ]\n}\n\nĞ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ JSON Ğ±ĞµĞ· markdown Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [1056, 112],
      "id": "5f5e9af5-25c0-40a0-a93e-26f9af1d7458",
      "name": "ğŸ¤– AI Single Extractor"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [1296, 256],
      "id": "b4660cbb-9ecb-469d-8067-b4595805d328",
      "name": "ğŸ’­ Think Single"
    },
    {
      "parameters": {
        "modelName": "={{ $('âš™ï¸ CONFIG').first().json.gemini_model_single }}",
        "options": {"maxOutputTokens": 2048, "temperature": "={{ $('âš™ï¸ CONFIG').first().json.gemini_temperature }}"}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [976, 272],
      "id": "53d16ad3-fa26-437e-b0d1-d631a8944493",
      "name": "ğŸ§  Gemini Single",
      "credentials": {"googlePalmApi": {"id": "YOUR_GEMINI_CREDENTIAL_ID", "name": "Google Gemini(PaLM) Api account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“‹ ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° AI (Single)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst aiResponse = items[0].json.output || items[0].json.response || items[0].json;\n\nlet contactsData;\ntry {\n    if (typeof aiResponse === 'string') {\n        let cleanJson = aiResponse;\n        cleanJson = cleanJson.replace(/```json\\s*/g, '').replace(/```\\s*/g, '');\n        const firstBrace = cleanJson.indexOf('{');\n        if (firstBrace > 0) { cleanJson = cleanJson.substring(firstBrace); }\n        const lastBrace = cleanJson.lastIndexOf('}');\n        if (lastBrace !== -1 && lastBrace < cleanJson.length - 1) { cleanJson = cleanJson.substring(0, lastBrace + 1); }\n        contactsData = JSON.parse(cleanJson);\n    } else {\n        contactsData = aiResponse;\n    }\n    if (!contactsData.contacts || !Array.isArray(contactsData.contacts)) {\n        throw new Error('Invalid response structure: missing contacts array');\n    }\n} catch (error) {\n    contactsData = { contacts: [] };\n}\n\nreturn contactsData.contacts.map(contact => ({json: contact}));"
      },
      "id": "f10019c4-ed24-493d-a358-1baaf3872eb9",
      "name": "ğŸ“‹ Parse Single Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1504, 112]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ° (Single)\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nINSERT INTO {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }} (\n    session_id, platform, full_name, first_name, last_name, phone, phone_raw, email,\n    telegram, whatsapp, other_contacts, company, position, location, preferred_contact,\n    extracted_from, confidence_score, last_updated\n) VALUES (\n    '{{ $json.sessionId }}',\n    CASE WHEN '{{ $json.sessionId }}' LIKE 'telegram_%' THEN 'telegram' WHEN '{{ $json.sessionId }}' LIKE 'webchat_%' THEN 'webchat' WHEN '{{ $json.sessionId }}' LIKE 'whatsapp_%' THEN 'whatsapp' ELSE 'unknown' END,\n    {{ $json.name ? \"'\" + String($json.name).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.firstName ? \"'\" + String($json.firstName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.lastName ? \"'\" + String($json.lastName).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.phone ? \"'\" + $json.phone + \"'\" : 'NULL' }},\n    {{ $json.phoneRaw ? \"'\" + $json.phoneRaw + \"'\" : 'NULL' }},\n    {{ $json.email ? \"'\" + $json.email + \"'\" : 'NULL' }},\n    {{ $json.telegram ? \"'\" + $json.telegram + \"'\" : 'NULL' }},\n    {{ $json.whatsapp ? \"'\" + $json.whatsapp + \"'\" : 'NULL' }},\n    {{ $json.otherContacts && Object.keys($json.otherContacts).length > 0 ? \"'\" + JSON.stringify($json.otherContacts).replace(/'/g, \"''\") + \"'::jsonb\" : 'NULL' }},\n    {{ $json.company ? \"'\" + String($json.company).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.position ? \"'\" + String($json.position).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.location ? \"'\" + String($json.location).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.preferredContact ? \"'\" + $json.preferredContact + \"'\" : 'NULL' }},\n    {{ $json.extractedFrom ? \"'\" + String($json.extractedFrom).replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.confidence || 0 }},\n    CURRENT_TIMESTAMP\n)\nON CONFLICT (session_id)\nDO UPDATE SET\n    full_name = CASE \n        WHEN EXCLUDED.extracted_from LIKE '%Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°%' AND ({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.extracted_from LIKE '%Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ%' OR {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.extracted_from IS NULL) AND EXCLUDED.full_name IS NOT NULL THEN EXCLUDED.full_name\n        WHEN EXCLUDED.confidence_score = {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.confidence_score AND EXCLUDED.extracted_from LIKE '%Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°%' AND EXCLUDED.full_name IS NOT NULL THEN EXCLUDED.full_name\n        WHEN EXCLUDED.confidence_score > COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.confidence_score, 0) AND EXCLUDED.full_name IS NOT NULL THEN EXCLUDED.full_name\n        WHEN {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name IS NULL AND EXCLUDED.full_name IS NOT NULL THEN EXCLUDED.full_name\n        ELSE {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name\n    END,\n    first_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.first_name, EXCLUDED.first_name),\n    last_name = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.last_name, EXCLUDED.last_name),\n    phone = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.phone, EXCLUDED.phone),\n    phone_raw = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.phone_raw, EXCLUDED.phone_raw),\n    email = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.email, EXCLUDED.email),\n    telegram = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.telegram, EXCLUDED.telegram),\n    whatsapp = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.whatsapp, EXCLUDED.whatsapp),\n    other_contacts = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.other_contacts, EXCLUDED.other_contacts),\n    company = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.company, EXCLUDED.company),\n    position = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.position, EXCLUDED.position),\n    location = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.location, EXCLUDED.location),\n    preferred_contact = COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.preferred_contact, EXCLUDED.preferred_contact),\n    extracted_from = CASE WHEN EXCLUDED.full_name != {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name OR {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.full_name IS NULL THEN EXCLUDED.extracted_from ELSE {{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.extracted_from END,\n    confidence_score = GREATEST(EXCLUDED.confidence_score, COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_user_contact_data }}.confidence_score, 0)),\n    last_updated = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "id": "a03ab07c-8b25-42cf-b795-fe04910dc4a0",
      "name": "ğŸ˜ Save Single Contact",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1728, 112],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\"status\": \"success\", \"message\": \"Contact data extracted\", \"processed\": 1} }}",
        "options": {}
      },
      "id": "60e102fb-1c52-49ca-a21e-5a69ede8aa11",
      "name": "âœ… Respond Single",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1936, 112]
    }
  ],
  "pinData": {},
  "connections": {
    "ğŸŒ Webhook: Extract Contact": {"main": [[{"node": "âš™ï¸ CONFIG", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG": {"main": [[{"node": "ğŸ” Security Check", "type": "main", "index": 0}]]},
    "ğŸ” Security Check": {"main": [[{"node": "â“ Auth Check", "type": "main", "index": 0}]]},
    "â“ Auth Check": {"main": [[{"node": "ğŸ“¥ Process Request", "type": "main", "index": 0}], [{"node": "âŒ Error Response", "type": "main", "index": 0}]]},
    "ğŸ“¥ Process Request": {"main": [[{"node": "â“ Check Type", "type": "main", "index": 0}]]},
    "â“ Check Type": {"main": [[{"node": "ğŸ˜ Get Single Dialog", "type": "main", "index": 0}], [{"node": "ğŸ˜ Get Batch Dialogs", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Single Dialog": {"main": [[{"node": "ğŸ“ Format Single Dialog", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Batch Dialogs": {"main": [[{"node": "ğŸ“¤ Pass Batch Data", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass Batch Data": {"main": [[{"node": "ğŸ“Š Group By Session", "type": "main", "index": 0}]]},
    "ğŸ“Š Group By Session": {"main": [[{"node": "ğŸ”„ Loop Over Sessions", "type": "main", "index": 0}]]},
    "ğŸ”„ Loop Over Sessions": {"main": [[{"node": "ğŸ“Š Aggregate Results", "type": "main", "index": 0}], [{"node": "ğŸ“ Format Loop Dialog", "type": "main", "index": 0}]]},
    "ğŸ“ Format Loop Dialog": {"main": [[{"node": "â“ IF Webchat Loop", "type": "main", "index": 0}]]},
    "â“ IF Webchat Loop": {"main": [[{"node": "ğŸ˜ Get PreChat Loop", "type": "main", "index": 0}], [{"node": "ğŸ“¤ Pass Empty PreChat", "type": "main", "index": 0}]]},
    "ğŸ˜ Get PreChat Loop": {"main": [[{"node": "ğŸ“¤ Pass PreChat Loop", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass PreChat Loop": {"main": [[{"node": "ğŸ˜ Check Loop Existing", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass Empty PreChat": {"main": [[{"node": "ğŸ˜ Check Loop Existing", "type": "main", "index": 0}]]},
    "ğŸ˜ Check Loop Existing": {"main": [[{"node": "ğŸ“¤ Pass Loop Check", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass Loop Check": {"main": [[{"node": "ğŸ”€ Merge Loop Data", "type": "main", "index": 0}]]},
    "ğŸ”€ Merge Loop Data": {"main": [[{"node": "ğŸ¤– AI Batch Extractor", "type": "main", "index": 0}]]},
    "ğŸ¤– AI Batch Extractor": {"main": [[{"node": "ğŸ“‹ Parse Batch Response", "type": "main", "index": 0}]]},
    "ğŸ’­ Think Batch": {"ai_tool": [[{"node": "ğŸ¤– AI Batch Extractor", "type": "ai_tool", "index": 0}]]},
    "ğŸ§  Gemini Batch": {"ai_languageModel": [[{"node": "ğŸ¤– AI Batch Extractor", "type": "ai_languageModel", "index": 0}]]},
    "ğŸ“‹ Parse Batch Response": {"main": [[{"node": "ğŸ˜ Save Batch Contact", "type": "main", "index": 0}]]},
    "ğŸ˜ Save Batch Contact": {"main": [[{"node": "ğŸ“¤ Pass To Loop", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass To Loop": {"main": [[{"node": "ğŸ”„ Loop Over Sessions", "type": "main", "index": 0}]]},
    "ğŸ“Š Aggregate Results": {"main": [[{"node": "âœ… Respond Batch", "type": "main", "index": 0}]]},
    "ğŸ“ Format Single Dialog": {"main": [[{"node": "ğŸ˜ Get PreChat Single", "type": "main", "index": 0}]]},
    "ğŸ˜ Get PreChat Single": {"main": [[{"node": "ğŸ“¤ Pass PreChat Single", "type": "main", "index": 0}]]},
    "ğŸ“¤ Pass PreChat Single": {"main": [[{"node": "ğŸ˜ Check Single Existing", "type": "main", "index": 0}]]},
    "ğŸ˜ Check Single Existing": {"main": [[{"node": "ğŸ”€ Merge Single Data", "type": "main", "index": 0}]]},
    "ğŸ”€ Merge Single Data": {"main": [[{"node": "ğŸ¤– AI Single Extractor", "type": "main", "index": 0}]]},
    "ğŸ¤– AI Single Extractor": {"main": [[{"node": "ğŸ“‹ Parse Single Response", "type": "main", "index": 0}]]},
    "ğŸ’­ Think Single": {"ai_tool": [[{"node": "ğŸ¤– AI Single Extractor", "type": "ai_tool", "index": 0}]]},
    "ğŸ§  Gemini Single": {"ai_languageModel": [[{"node": "ğŸ¤– AI Single Extractor", "type": "ai_languageModel", "index": 0}]]},
    "ğŸ“‹ Parse Single Response": {"main": [[{"node": "ğŸ˜ Save Single Contact", "type": "main", "index": 0}]]},
    "ğŸ˜ Save Single Contact": {"main": [[{"node": "âœ… Respond Single", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {"executionOrder": "v1"},
  "versionId": "production-ru-v1",
  "meta": {"templateCredsSetupCompleted": true, "instanceId": "production-template"},
  "id": "contact-data-extractor-ru",
  "tags": []
}