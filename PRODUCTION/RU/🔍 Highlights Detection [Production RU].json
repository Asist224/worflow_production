{
  "name": "ğŸ” Highlights Detection [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ” Highlights Detection\n\n### ğŸ“‹ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ\nAI-Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°Ñ…:\n- ğŸ’° PRICING - ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ Ñ†ĞµĞ½Ñ‹\n- âŒ OBJECTION - Ğ²Ğ¾Ğ·Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ\n- âœ… BUYING_SIGNAL - ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸\n\n---\n\n### âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° CONFIG\n\n| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |\n|----------|----------|\n| `api_key` | API ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ |\n| `gemini_model` | ĞœĞ¾Ğ´ĞµĞ»ÑŒ Gemini |\n| `table_*` | Ğ˜Ğ¼ĞµĞ½Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ† |\n\n---\n\n### ğŸ“¥ API Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹\n\n**ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°:**\n```json\nPOST /webhook/detect-highlights?apiKey=YOUR_KEY\n{\n  \"sessionId\": \"user123_chat456\",\n  \"userName\": \"John\",\n  \"language\": \"ru\"\n}\n```\n\n**ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ highlights:**\n```\nGET /webhook/get-highlights?apiKey=YOUR_KEY&sessionId=user123_chat456\n```",
        "height": 520,
        "width": 380,
        "color": 5
      },
      "id": "sticky-note-main",
      "name": "ğŸ“ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-2400, -400]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "api-key", "name": "api_key", "value": "YOUR_API_KEY_HERE", "type": "string"},
            {"id": "rate-window", "name": "rate_limit_window_ms", "value": 60000, "type": "number"},
            {"id": "rate-max", "name": "rate_limit_max_requests", "value": 60, "type": "number"},
            {"id": "table-highlights", "name": "table_conversation_highlights", "value": "conversation_highlights", "type": "string"},
            {"id": "table-chat-ru", "name": "table_chat_histories_ru", "value": "n8n_chat_histories_ru", "type": "string"},
            {"id": "table-chat-en", "name": "table_chat_histories_en", "value": "n8n_chat_histories_en", "type": "string"},
            {"id": "table-language", "name": "table_analysis_language_settings", "value": "analysis_language_settings", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-detect",
      "name": "âš™ï¸ CONFIG: Detect",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-1888, -144]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "api-key", "name": "api_key", "value": "YOUR_API_KEY_HERE", "type": "string"},
            {"id": "rate-window", "name": "rate_limit_window_ms", "value": 60000, "type": "number"},
            {"id": "rate-max", "name": "rate_limit_max_requests", "value": 60, "type": "number"},
            {"id": "table-highlights", "name": "table_conversation_highlights", "value": "conversation_highlights", "type": "string"},
            {"id": "table-chat-ru", "name": "table_chat_histories_ru", "value": "n8n_chat_histories_ru", "type": "string"},
            {"id": "table-chat-en", "name": "table_chat_histories_en", "value": "n8n_chat_histories_en", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-get",
      "name": "âš™ï¸ CONFIG: Get",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-1888, 352]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "detect-highlights",
        "responseMode": "responseNode",
        "options": {"allowedOrigins": "*"}
      },
      "id": "a8adc06d-2e50-4f1c-8c2b-44bc242e1336",
      "name": "ğŸŒ Webhook: Detect",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-2096, -144],
      "webhookId": "detect-highlights-webhook"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸: API KEY + RATE LIMITING\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $('âš™ï¸ CONFIG: Detect').first().json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('ğŸŒ Webhook: Detect').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) { delete staticData.rateLimits[ip]; }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429 } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) { return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }]; }\nif (providedKey !== API_KEY) { return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }]; }\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1696, -144],
      "id": "9f78f979-5d5c-40e8-94d8-94a080818bba",
      "name": "ğŸ” Security Check (Detect)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2},
          "conditions": [{"id": "auth-condition", "leftValue": "={{ $json.authorized }}", "rightValue": "", "operator": {"type": "boolean", "operation": "true", "singleValue": true}}],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-1536, -144],
      "id": "5df2b8a7-b02e-4635-8985-b8d21548ea44",
      "name": "â“ Auth Check (Detect)"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¥ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst requestData = items[0].json.body || items[0].json;\n\nconst sessionId = requestData.sessionId;\nconst userName = requestData.userName || 'Guest';\nconst language = requestData.language || 'ru';\n\nif (!sessionId) {\n    throw new Error('sessionId is required');\n}\n\nreturn [{\n    json: {\n        sessionId: sessionId,\n        userName: userName,\n        language: language\n    }\n}];"
      },
      "id": "86628ecb-3712-477a-bf83-ba3794a2abb3",
      "name": "ğŸ“¥ Process Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1344, -144]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT language_code FROM {{ $('âš™ï¸ CONFIG: Detect').first().json.table_analysis_language_settings }} ORDER BY id DESC LIMIT 1;",
        "options": {}
      },
      "id": "ccd257dc-fd7e-46b9-92ed-ad415a70aae9",
      "name": "ğŸ˜ Get Analysis Language",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-1152, -144],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”„ ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸ ÑĞ·Ñ‹ĞºĞ°\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst requestData = $('ğŸ“¥ Process Request').first().json;\nconst langSetting = items[0]?.json?.language_code || 'ru';\n\nreturn [{\n    json: {\n        sessionId: requestData.sessionId,\n        userName: requestData.userName,\n        language: requestData.language,\n        analysisLanguage: langSetting\n    }\n}];"
      },
      "id": "aa8be4ea-5963-4f70-ae3c-32a1796c9b37",
      "name": "ğŸ”„ Merge with Language",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-960, -144]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH all_chats AS (\n    SELECT id, session_id, message::json->>'type' as message_type, message::json->>'content' as content, created_at as timestamp, platform, 'ru' as language\n    FROM {{ $('âš™ï¸ CONFIG: Detect').first().json.table_chat_histories_ru }}\n    WHERE session_id = '{{ $json.sessionId }}' AND created_at >= NOW() - INTERVAL '20 days'\n    UNION ALL\n    SELECT id, session_id, message::json->>'type' as message_type, message::json->>'content' as content, created_at as timestamp, platform, 'en' as language\n    FROM {{ $('âš™ï¸ CONFIG: Detect').first().json.table_chat_histories_en }}\n    WHERE session_id = '{{ $json.sessionId }}' AND created_at >= NOW() - INTERVAL '20 days'\n)\nSELECT * FROM all_chats ORDER BY timestamp ASC;",
        "options": {}
      },
      "id": "3b137110-8882-4864-97c9-9ec15ad04855",
      "name": "ğŸ˜ Get Dialog Messages",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-768, -144],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ´Ğ»Ñ AI Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dialogs = items;\nconst mergedData = $('ğŸ”„ Merge with Language').first().json;\nconst analysisLanguage = mergedData.analysisLanguage || 'ru';\n\nconst sessionData = {\n    messages: [],\n    language: mergedData.language,\n    sessionId: mergedData.sessionId,\n    messagesMap: {}\n};\n\ndialogs.forEach((item, index) => {\n    const data = item.json;\n    const orderNumber = index + 1;\n    \n    sessionData.messages.push({\n        id: data.id,\n        orderNumber: orderNumber,\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp,\n        platform: data.platform\n    });\n    \n    sessionData.messagesMap[orderNumber] = data.id;\n});\n\nconst clientLabel = analysisLanguage === 'en' ? 'Client' : 'ĞšĞ»Ğ¸ĞµĞ½Ñ‚';\nconst botLabel = analysisLanguage === 'en' ? 'Bot' : 'Ğ‘Ğ¾Ñ‚';\n\nconst conversation = sessionData.messages.map(msg => \n    `[${msg.orderNumber}] ${msg.type === 'human' ? clientLabel : botLabel}: ${msg.content}`\n).join('\\n');\n\nreturn [{\n    json: {\n        sessionId: mergedData.sessionId,\n        userName: mergedData.userName,\n        language: mergedData.language,\n        analysisLanguage: analysisLanguage,\n        conversation: conversation,\n        messages: sessionData.messages,\n        messagesMap: sessionData.messagesMap,\n        totalMessages: sessionData.messages.length\n    }\n}];"
      },
      "id": "60eb17e0-7554-4844-8945-2796a72a16fb",
      "name": "ğŸ“ Format Dialog for AI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-576, -144]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Ğ¯Ğ·Ñ‹Ğº Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°: {{ $json.analysisLanguage || 'ru' }}\nSESSION ID: {{ $json.sessionId }}\nĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {{ $json.totalMessages }}\n\nĞ”Ğ¸Ğ°Ğ»Ğ¾Ğ³:\n{{ $json.conversation }}",
        "options": {
          "systemMessage": "# Ğ ĞĞ›Ğ¬\nĞ’Ñ‹ â€” ÑĞºÑĞ¿ĞµÑ€Ñ‚-Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ğ¾Ğ² (highlights).\n\n# Ğ¢Ğ˜ĞŸĞ« HIGHLIGHTS\n\n## 1. ğŸ’° PRICING_MENTION\nĞ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ñ†ĞµĞ½Ğµ, Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ°Ñ…, Ğ±ÑĞ´Ğ¶ĞµÑ‚Ğµ, Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ.\n\n## 2. âŒ OBJECTION\nĞ¡Ğ¾Ğ¼Ğ½ĞµĞ½Ğ¸Ñ, Ğ¾Ñ‚ĞºĞ°Ğ·Ñ‹, Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ² Ğ¾ Ñ†ĞµĞ½Ğµ/Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğµ.\n\n## 3. âœ… BUYING_SIGNAL\nĞ˜Ğ½Ñ‚ĞµÑ€ĞµÑ, Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ/ĞºÑƒĞ¿Ğ¸Ñ‚ÑŒ.\n\n# ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ\n1. ĞĞ´Ğ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ ĞĞ•Ğ¡ĞšĞĞ›Ğ¬ĞšĞ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²\n2. Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¢ĞĞ›Ğ¬ĞšĞ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ğ° (ĞĞ• Ğ‘Ğ¾Ñ‚Ğ°)\n3. Confidence: 0.70-1.00 (Ğ½Ğ¸Ğ¶Ğµ 0.70 Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒ)\n4. Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ°Ñ… = PRICING + BUYING_SIGNAL\n\n# Ğ¤ĞĞ ĞœĞĞ¢ ĞĞ¢Ğ’Ğ•Ğ¢Ğ (Ğ¢ĞĞ›Ğ¬ĞšĞ JSON!)\n{\n  \"highlights\": [\n    {\n      \"messageId\": Ğ½Ğ¾Ğ¼ĞµÑ€_ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ,\n      \"messageText\": \"Ñ‚ĞµĞºÑÑ‚\",\n      \"type\": \"pricing\" | \"objection\" | \"buying_signal\",\n      \"confidence\": 0.70-1.00,\n      \"reasoning\": \"Ğ¾Ğ±ÑŠÑÑĞ½ĞµĞ½Ğ¸Ğµ\",\n      \"matchedPatterns\": [\"Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹\"]\n    }\n  ],\n  \"summary\": {\n    \"totalHighlights\": Ñ‡Ğ¸ÑĞ»Ğ¾,\n    \"byType\": {\"pricing\": N, \"objection\": N, \"buying_signal\": N},\n    \"overallAssessment\": \"Ğ¾Ñ†ĞµĞ½ĞºĞ° Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°\"\n  }\n}"
        }
      },
      "id": "608dc9fa-426f-41ca-9946-098f31b8eaf3",
      "name": "ğŸ¤– AI Agent (Gemini)",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [-384, -144]
    },
    {
      "parameters": {"options": {}},
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [-432, 32],
      "id": "2c7a051a-dcf7-4994-b1d2-a2d7c6b22c0a",
      "name": "Google Gemini Chat Model",
      "credentials": {"googlePalmApi": {"id": "YOUR_GEMINI_CREDENTIAL_ID", "name": "Google Gemini(PaLM) Api account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ AI\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst aiResponse = items[0].json.output;\nconst sessionData = $('ğŸ“ Format Dialog for AI').first().json;\nconst messagesMap = sessionData.messagesMap || {};\n\nlet parsed;\ntry {\n    let cleanJson = aiResponse.trim();\n    cleanJson = cleanJson.replace(/^```json\\s*/i, '').replace(/^```\\s*/i, '').replace(/\\s*```$/i, '');\n    parsed = JSON.parse(cleanJson);\n    \n    if (!parsed.highlights || !Array.isArray(parsed.highlights)) {\n        throw new Error('Invalid response structure');\n    }\n} catch (error) {\n    return [{\n        json: {\n            hasHighlights: false,\n            sessionId: sessionData.sessionId,\n            totalDetected: 0,\n            highlights: [],\n            error: 'Failed to parse AI response'\n        }\n    }];\n}\n\nconst validHighlights = parsed.highlights.filter(h => h.confidence >= 0.70);\n\nconst enrichedHighlights = validHighlights.map(h => {\n    const orderNumber = h.messageId;\n    const realMessageId = messagesMap[orderNumber];\n    const message = sessionData.messages.find(m => m.id === realMessageId);\n    \n    return {\n        sessionId: sessionData.sessionId,\n        messageId: realMessageId,\n        messageText: h.messageText || message?.content || '',\n        messageType: message?.type || 'human',\n        messageTimestamp: h.messageTimestamp || message?.timestamp,\n        type: h.type,\n        confidence: h.confidence,\n        detection_method: 'ai',\n        reasoning: h.reasoning,\n        matched_patterns: h.matchedPatterns || [],\n        language: sessionData.language,\n        platform: message?.platform || 'unknown'\n    };\n});\n\nreturn [{\n    json: {\n        hasHighlights: enrichedHighlights.length > 0,\n        sessionId: sessionData.sessionId,\n        totalDetected: enrichedHighlights.length,\n        highlights: enrichedHighlights,\n        summary: parsed.summary || {},\n        aiAssessment: parsed.summary?.overallAssessment || ''\n    }\n}];"
      },
      "id": "41340751-2c13-4135-a548-c636c249988f",
      "name": "ğŸ“Š Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-192, -144]
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [{"id": "has-highlights", "leftValue": "={{ $json.hasHighlights }}", "rightValue": true, "operator": {"type": "boolean", "operation": "true"}}],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ffe59fbf-57da-4fda-9196-08438b157b76",
      "name": "â“ Has Highlights?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [0, -144]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM {{ $('âš™ï¸ CONFIG: Detect').first().json.table_conversation_highlights }} WHERE session_id = '{{ $('ğŸ“Š Parse AI Response').first().json.sessionId }}';",
        "options": {}
      },
      "id": "aaa0b649-2374-425e-8577-8670285fe21e",
      "name": "ğŸ˜ Delete Old Highlights",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [208, -352],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ‘Ğ”\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst result = items[0].json;\nconst highlights = result.highlights;\n\nif (!highlights || highlights.length === 0) { return []; }\n\nconst uniqueMap = new Map();\nhighlights.forEach(h => {\n    const key = `${h.messageId}_${h.type}`;\n    if (!uniqueMap.has(key) || h.confidence > uniqueMap.get(key).confidence) {\n        uniqueMap.set(key, h);\n    }\n});\n\nconst prepared = Array.from(uniqueMap.values()).map(h => ({\n    json: {\n        session_id: h.sessionId,\n        message_id: h.messageId,\n        message_text: h.messageText,\n        message_type: h.messageType,\n        message_timestamp: h.messageTimestamp,\n        highlight_type: h.type,\n        confidence: h.confidence,\n        detection_method: 'ai',\n        matched_keywords: h.matched_patterns,\n        reasoning: h.reasoning,\n        language: h.language,\n        platform: h.platform\n    }\n}));\n\nreturn prepared;"
      },
      "id": "a6d1f1e0-6eef-4e72-8948-3f0a9526a774",
      "name": "ğŸ“ Prepare DB Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [208, -160]
    },
    {
      "parameters": {
        "schema": {"__rl": true, "value": "public", "mode": "list"},
        "table": {"__rl": true, "value": "={{ $('âš™ï¸ CONFIG: Detect').first().json.table_conversation_highlights }}", "mode": "raw"},
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session_id }}",
            "message_id": "={{ $json.message_id }}",
            "message_text": "={{ $json.message_text }}",
            "message_type": "={{ $json.message_type }}",
            "message_timestamp": "={{ $json.message_timestamp }}",
            "highlight_type": "={{ $json.highlight_type }}",
            "confidence": "={{ $json.confidence }}",
            "detection_method": "={{ $json.detection_method }}",
            "matched_keywords": "={{ $json.matched_keywords }}",
            "language": "={{ $json.language }}",
            "platform": "={{ $json.platform }}"
          }
        },
        "options": {}
      },
      "id": "a6313e63-086a-4200-96ec-9869184e189e",
      "name": "ğŸ˜ Save to DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [400, -160],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, sessionId: $('ğŸ“Š Parse AI Response').first().json.sessionId, totalDetected: $('ğŸ“Š Parse AI Response').first().json.totalDetected, highlights: $('ğŸ“Š Parse AI Response').first().json.highlights.map(h => ({ type: h.type, confidence: h.confidence, messageText: h.messageText.substring(0, 100), reasoning: h.reasoning })), summary: $('ğŸ“Š Parse AI Response').first().json.summary } }}",
        "options": {}
      },
      "id": "68748655-5f53-4d98-ad70-b66d9fdb6e7f",
      "name": "âœ… Response Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [592, -160]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, sessionId: $('ğŸ“Š Parse AI Response').first().json.sessionId, totalDetected: 0, message: 'No highlights detected', highlights: [] } }}",
        "options": {}
      },
      "id": "f360ada7-785f-4cb9-a58f-013490b19c19",
      "name": "âœ… Response No Highlights",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [288, 128]
    },
    {
      "parameters": {"respondWith": "json", "responseBody": "={{ $json.error }}", "options": {"responseCode": "={{ $json.error.status }}"}},
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [-1344, 16],
      "id": "38323d42-d363-4411-b279-32c244183bc8",
      "name": "âŒ Error Response (Detect)"
    },
    {
      "parameters": {
        "path": "get-highlights",
        "responseMode": "responseNode",
        "options": {"allowedOrigins": "*"}
      },
      "id": "36e3aaf4-6f55-4340-a39c-46af8bc35137",
      "name": "ğŸŒ Webhook: Get",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-2096, 352],
      "webhookId": "get-highlights-webhook"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸: API KEY + RATE LIMITING\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $('âš™ï¸ CONFIG: Get').first().json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('ğŸŒ Webhook: Get').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) { delete staticData.rateLimits[ip]; }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429 } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) { return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }]; }\nif (providedKey !== API_KEY) { return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }]; }\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1696, 352],
      "id": "149039b4-942c-4a88-a907-341a6ead70c0",
      "name": "ğŸ” Security Check (Get)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2},
          "conditions": [{"id": "auth-condition", "leftValue": "={{ $json.authorized }}", "rightValue": "", "operator": {"type": "boolean", "operation": "true", "singleValue": true}}],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-1536, 352],
      "id": "2a405925-65f4-4dd4-bc8a-004988a5d63a",
      "name": "â“ Auth Check (Get)"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¥ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° GET Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst query = items[0].json.query || {};\nconst sessionId = query.session_id || query.sessionId;\n\nif (!sessionId) {\n    throw new Error('session_id parameter is required');\n}\n\nreturn [{ json: { sessionId: sessionId } }];"
      },
      "id": "6fffa22e-8eed-47b3-b34a-e304c4255167",
      "name": "ğŸ“¥ Process Get Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1344, 352]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM {{ $('âš™ï¸ CONFIG: Get').first().json.table_conversation_highlights }} WHERE session_id = '{{ $json.sessionId }}' ORDER BY message_timestamp ASC;",
        "options": {}
      },
      "id": "e4ee5c22-85cc-4282-a138-285ed919cedb",
      "name": "ğŸ˜ Get Highlights from DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-1152, 352],
      "alwaysOutputData": true,
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst highlights = items;\nconst sessionId = $('ğŸ“¥ Process Get Request').first().json.sessionId;\n\nconst isEmpty = !highlights || highlights.length === 0 || !highlights[0]?.json?.id;\n\nif (isEmpty) {\n    return [{\n        json: {\n            success: true,\n            sessionId: sessionId,\n            hasHighlights: false,\n            total: 0,\n            highlights: [],\n            byType: { pricing: 0, objection: 0, buying_signal: 0 }\n        }\n    }];\n}\n\nconst byType = { pricing: 0, objection: 0, buying_signal: 0 };\nlet totalConfidence = 0;\n\nconst formatted = highlights.map(item => {\n    const h = item.json;\n    if (byType[h.highlight_type] !== undefined) byType[h.highlight_type]++;\n    totalConfidence += parseFloat(h.confidence || 0);\n    \n    return {\n        id: h.id,\n        messageId: h.message_id,\n        messageText: h.message_text,\n        type: h.highlight_type,\n        confidence: parseFloat(h.confidence),\n        reasoning: h.reasoning || '',\n        createdAt: h.created_at\n    };\n});\n\nreturn [{\n    json: {\n        success: true,\n        sessionId: sessionId,\n        hasHighlights: true,\n        total: formatted.length,\n        highlights: formatted,\n        byType: byType,\n        avgConfidence: (totalConfidence / formatted.length).toFixed(2)\n    }\n}];"
      },
      "id": "c83a38fb-1dd4-402b-aae0-ef09a7f4d15d",
      "name": "ğŸ“Š Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-960, 352]
    },
    {
      "parameters": {"respondWith": "json", "responseBody": "={{ $json }}", "options": {}},
      "id": "9b09ee8d-a050-4659-b164-f9259810d32b",
      "name": "âœ… Response Highlights",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [-768, 352]
    },
    {
      "parameters": {"respondWith": "json", "responseBody": "={{ $json.error }}", "options": {"responseCode": "={{ $json.error.status }}"}},
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [-1344, 512],
      "id": "8892c7ad-79c2-4933-87e3-b1231354faba",
      "name": "âŒ Error Response (Get)"
    }
  ],
  "pinData": {},
  "connections": {
    "ğŸŒ Webhook: Detect": {"main": [[{"node": "âš™ï¸ CONFIG: Detect", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG: Detect": {"main": [[{"node": "ğŸ” Security Check (Detect)", "type": "main", "index": 0}]]},
    "ğŸ” Security Check (Detect)": {"main": [[{"node": "â“ Auth Check (Detect)", "type": "main", "index": 0}]]},
    "â“ Auth Check (Detect)": {"main": [[{"node": "ğŸ“¥ Process Request", "type": "main", "index": 0}], [{"node": "âŒ Error Response (Detect)", "type": "main", "index": 0}]]},
    "ğŸ“¥ Process Request": {"main": [[{"node": "ğŸ˜ Get Analysis Language", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Analysis Language": {"main": [[{"node": "ğŸ”„ Merge with Language", "type": "main", "index": 0}]]},
    "ğŸ”„ Merge with Language": {"main": [[{"node": "ğŸ˜ Get Dialog Messages", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Dialog Messages": {"main": [[{"node": "ğŸ“ Format Dialog for AI", "type": "main", "index": 0}]]},
    "ğŸ“ Format Dialog for AI": {"main": [[{"node": "ğŸ¤– AI Agent (Gemini)", "type": "main", "index": 0}]]},
    "ğŸ¤– AI Agent (Gemini)": {"main": [[{"node": "ğŸ“Š Parse AI Response", "type": "main", "index": 0}]]},
    "Google Gemini Chat Model": {"ai_languageModel": [[{"node": "ğŸ¤– AI Agent (Gemini)", "type": "ai_languageModel", "index": 0}]]},
    "ğŸ“Š Parse AI Response": {"main": [[{"node": "â“ Has Highlights?", "type": "main", "index": 0}]]},
    "â“ Has Highlights?": {"main": [[{"node": "ğŸ“ Prepare DB Data", "type": "main", "index": 0}, {"node": "ğŸ˜ Delete Old Highlights", "type": "main", "index": 0}], [{"node": "âœ… Response No Highlights", "type": "main", "index": 0}]]},
    "ğŸ“ Prepare DB Data": {"main": [[{"node": "ğŸ˜ Save to DB", "type": "main", "index": 0}]]},
    "ğŸ˜ Save to DB": {"main": [[{"node": "âœ… Response Success", "type": "main", "index": 0}]]},
    "ğŸŒ Webhook: Get": {"main": [[{"node": "âš™ï¸ CONFIG: Get", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG: Get": {"main": [[{"node": "ğŸ” Security Check (Get)", "type": "main", "index": 0}]]},
    "ğŸ” Security Check (Get)": {"main": [[{"node": "â“ Auth Check (Get)", "type": "main", "index": 0}]]},
    "â“ Auth Check (Get)": {"main": [[{"node": "ğŸ“¥ Process Get Request", "type": "main", "index": 0}], [{"node": "âŒ Error Response (Get)", "type": "main", "index": 0}]]},
    "ğŸ“¥ Process Get Request": {"main": [[{"node": "ğŸ˜ Get Highlights from DB", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Highlights from DB": {"main": [[{"node": "ğŸ“Š Format Response", "type": "main", "index": 0}]]},
    "ğŸ“Š Format Response": {"main": [[{"node": "âœ… Response Highlights", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {"executionOrder": "v1"},
  "versionId": "production-ru-v1",
  "meta": {"templateCredsSetupCompleted": true, "instanceId": "production-template"},
  "id": "highlights-detection-ru",
  "tags": []
}