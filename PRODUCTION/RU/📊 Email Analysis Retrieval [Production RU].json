{
  "name": "ğŸ“Š Email Analysis Retrieval [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ“Š ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Email\n\n### ğŸ“‹ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ\nAPI Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° email-Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ².\n\n---\n\n### âš™ï¸ CONFIG\n\n| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |\n|----------|----------|\n| `api_key` | API ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ |\n| `rate_limit_window_ms` | ĞĞºĞ½Ğ¾ rate limiting (Ğ¼Ñ) |\n| `rate_limit_max_requests` | ĞœĞ°ĞºÑ. Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ¾ĞºĞ½Ğµ |\n| `table_email_dialog_analysis` | Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° email |\n\n---\n\n### ğŸ”— Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹\n\n| ĞœĞµÑ‚Ğ¾Ğ´ | ĞŸÑƒÑ‚ÑŒ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |\n|-------|------|----------|\n| GET | `/get-email-analysis` | ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ğ¾ email |\n| GET | `/get-all-email-analysis` | ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ñ‹ |\n\n---\n\n### ğŸ“¥ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²\n\n**GET /get-email-analysis:**\n- `email` - email Ğ°Ğ´Ñ€ĞµÑ\n- `type` - Ñ‚Ğ¸Ğ¿ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° (single/batch)\n\n**GET /get-all-email-analysis:**\n- `days` - Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ N Ğ´Ğ½ĞµĞ¹\n- `language` - Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑĞ·Ñ‹ĞºÑƒ",
        "height": 580,
        "width": 380,
        "color": 5
      },
      "id": "sticky-note-main",
      "name": "ğŸ“ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-1100, -200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "api-key", "name": "api_key", "value": "YOUR_API_KEY_HERE", "type": "string"},
            {"id": "rate-window", "name": "rate_limit_window_ms", "value": 60000, "type": "number"},
            {"id": "rate-max", "name": "rate_limit_max_requests", "value": 60, "type": "number"},
            {"id": "table-analysis", "name": "table_email_dialog_analysis", "value": "email_dialog_analysis", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-get-analysis",
      "name": "âš™ï¸ CONFIG: Get Analysis",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-464, -192]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "api-key", "name": "api_key", "value": "YOUR_API_KEY_HERE", "type": "string"},
            {"id": "rate-window", "name": "rate_limit_window_ms", "value": 60000, "type": "number"},
            {"id": "rate-max", "name": "rate_limit_max_requests", "value": 60, "type": "number"},
            {"id": "table-analysis", "name": "table_email_dialog_analysis", "value": "email_dialog_analysis", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-get-all",
      "name": "âš™ï¸ CONFIG: Get All",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-464, 192]
    },
    {
      "parameters": {
        "path": "get-email-analysis",
        "responseMode": "responseNode",
        "options": {"allowedOrigins": "*"}
      },
      "id": "webhook-get-analysis",
      "name": "ğŸŒ Webhook: Get Analysis",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-672, -192],
      "webhookId": "get-email-analysis-webhook"
    },
    {
      "parameters": {
        "path": "get-all-email-analysis",
        "responseMode": "responseNode",
        "options": {"allowedOrigins": "*"}
      },
      "id": "webhook-get-all",
      "name": "ğŸŒ Webhook: Get All",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-672, 192],
      "webhookId": "get-all-email-analysis-webhook"
    },
    {
      "parameters": {
        "jsCode": "const config = $('âš™ï¸ CONFIG: Get Analysis').first().json;\nconst inputData = $('ğŸŒ Webhook: Get Analysis').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > config.rate_limit_window_ms) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > config.rate_limit_max_requests) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²', details: `Ğ›Ğ¸Ğ¼Ğ¸Ñ‚: ${config.rate_limit_max_requests} Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + config.rate_limit_window_ms - now) / 1000) } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API ĞºĞ»ÑÑ‡ Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½', status: 401 } } }];\n}\nif (providedKey !== config.api_key) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ API ĞºĞ»ÑÑ‡', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-256, -192],
      "id": "security-get-analysis",
      "name": "ğŸ” Security Check"
    },
    {
      "parameters": {
        "jsCode": "const config = $('âš™ï¸ CONFIG: Get All').first().json;\nconst inputData = $('ğŸŒ Webhook: Get All').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > config.rate_limit_window_ms) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > config.rate_limit_max_requests) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²', details: `Ğ›Ğ¸Ğ¼Ğ¸Ñ‚: ${config.rate_limit_max_requests} Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + config.rate_limit_window_ms - now) / 1000) } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API ĞºĞ»ÑÑ‡ Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½', status: 401 } } }];\n}\nif (providedKey !== config.api_key) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ API ĞºĞ»ÑÑ‡', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-256, 192],
      "id": "security-get-all",
      "name": "ğŸ” Security Check 2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2},
          "conditions": [{"id": "auth-check", "leftValue": "={{ $json.authorized }}", "rightValue": "", "operator": {"type": "boolean", "operation": "true", "singleValue": true}}],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-48, -192],
      "id": "auth-check-1",
      "name": "â“ Auth Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2},
          "conditions": [{"id": "auth-check", "leftValue": "={{ $json.authorized }}", "rightValue": "", "operator": {"type": "boolean", "operation": "true", "singleValue": true}}],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-48, 192],
      "id": "auth-check-2",
      "name": "â“ Auth Check 2"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {"responseCode": "={{ $json.error.status }}"}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [160, -96],
      "id": "error-response-1",
      "name": "âŒ Error Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {"responseCode": "={{ $json.error.status }}"}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [160, 288],
      "id": "error-response-2",
      "name": "âŒ Error Response 2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    email,\n    thread_id,\n    user_name,\n    analysis_type,\n    language,\n    emotional_tone,\n    customer_needs,\n    missed_opportunities,\n    recommendations,\n    statistics,\n    satisfaction_percentage,\n    lead_scoring,\n    created_at,\n    updated_at\nFROM {{ $('âš™ï¸ CONFIG: Get Analysis').first().json.table_email_dialog_analysis }} \nWHERE email = '{{ $json.query.email }}' \nAND analysis_type = '{{ $json.query.type || 'single' }}' \nORDER BY created_at DESC \nLIMIT 1",
        "options": {}
      },
      "id": "get-analysis-db",
      "name": "ğŸ˜ Get Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [160, -288],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT DISTINCT ON (email) \n    email,\n    thread_id,\n    user_name,\n    analysis_type,\n    language,\n    emotional_tone,\n    customer_needs,\n    missed_opportunities,\n    recommendations,\n    statistics,\n    satisfaction_percentage,\n    lead_scoring,\n    created_at,\n    updated_at\nFROM {{ $('âš™ï¸ CONFIG: Get All').first().json.table_email_dialog_analysis }} \nWHERE analysis_type = 'single'\n    {{ $json.query?.days ? \"AND created_at >= NOW() - INTERVAL '\" + $json.query.days + \" days'\" : \"\" }}\n    {{ $json.query?.language ? \"AND language = '\" + $json.query.language + \"'\" : \"\" }}\nORDER BY email, created_at DESC",
        "options": {}
      },
      "id": "get-all-analysis-db",
      "name": "ğŸ˜ Get All Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [160, 96],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "const data = items[0]?.json;\nif (!data) {\n  return [{json: {found: false, message: 'ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½'}}];\n}\n\nconst parseJsonField = (field) => {\n  if (!field) return null;\n  if (typeof field === 'string') {\n    try { return JSON.parse(field); } catch(e) { return field; }\n  }\n  return field;\n};\n\nreturn [{\n  json: {\n    found: true,\n    email: data.email,\n    threadId: data.thread_id,\n    userName: data.user_name,\n    analysisType: data.analysis_type,\n    language: data.language,\n    emotionalTone: parseJsonField(data.emotional_tone),\n    customerNeeds: parseJsonField(data.customer_needs),\n    missedOpportunities: parseJsonField(data.missed_opportunities),\n    recommendations: parseJsonField(data.recommendations),\n    statistics: parseJsonField(data.statistics),\n    satisfactionPercentage: data.satisfaction_percentage || parseJsonField(data.emotional_tone)?.satisfaction || 0,\n    leadScoring: parseJsonField(data.lead_scoring),\n    createdAt: data.created_at,\n    updatedAt: data.updated_at\n  }\n}];"
      },
      "id": "format-analysis",
      "name": "ğŸ“‹ Format Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [368, -288]
    },
    {
      "parameters": {
        "jsCode": "const analyses = {};\n\nconst parseJsonField = (field) => {\n  if (!field) return null;\n  if (typeof field === 'string') {\n    try { return JSON.parse(field); } catch(e) { return field; }\n  }\n  return field;\n};\n\nitems.forEach(item => {\n  const data = item.json;\n  const emotionalTone = parseJsonField(data.emotional_tone);\n  const leadScoring = parseJsonField(data.lead_scoring);\n  \n  analyses[data.email] = {\n    emotionalTone: emotionalTone?.overall || 'unknown',\n    satisfactionPercentage: data.satisfaction_percentage || emotionalTone?.satisfaction || 0,\n    leadScoring: leadScoring?.score || 0,\n    leadTemperature: leadScoring?.temperature || 'cold',\n    createdAt: data.created_at,\n    updatedAt: data.updated_at\n  };\n});\n\nreturn [{json: {analyses}}];"
      },
      "id": "format-all-analysis",
      "name": "ğŸ“‹ Format All",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [368, 96]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-analysis",
      "name": "âœ… Respond Analysis",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [576, -288]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-all",
      "name": "âœ… Respond All",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [576, 96]
    }
  ],
  "pinData": {},
  "connections": {
    "ğŸŒ Webhook: Get Analysis": {"main": [[{"node": "âš™ï¸ CONFIG: Get Analysis", "type": "main", "index": 0}]]},
    "ğŸŒ Webhook: Get All": {"main": [[{"node": "âš™ï¸ CONFIG: Get All", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG: Get Analysis": {"main": [[{"node": "ğŸ” Security Check", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG: Get All": {"main": [[{"node": "ğŸ” Security Check 2", "type": "main", "index": 0}]]},
    "ğŸ” Security Check": {"main": [[{"node": "â“ Auth Check", "type": "main", "index": 0}]]},
    "ğŸ” Security Check 2": {"main": [[{"node": "â“ Auth Check 2", "type": "main", "index": 0}]]},
    "â“ Auth Check": {"main": [[{"node": "ğŸ˜ Get Analysis", "type": "main", "index": 0}], [{"node": "âŒ Error Response", "type": "main", "index": 0}]]},
    "â“ Auth Check 2": {"main": [[{"node": "ğŸ˜ Get All Analysis", "type": "main", "index": 0}], [{"node": "âŒ Error Response 2", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Analysis": {"main": [[{"node": "ğŸ“‹ Format Analysis", "type": "main", "index": 0}]]},
    "ğŸ˜ Get All Analysis": {"main": [[{"node": "ğŸ“‹ Format All", "type": "main", "index": 0}]]},
    "ğŸ“‹ Format Analysis": {"main": [[{"node": "âœ… Respond Analysis", "type": "main", "index": 0}]]},
    "ğŸ“‹ Format All": {"main": [[{"node": "âœ… Respond All", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {"executionOrder": "v1"},
  "versionId": "production-ru-v1",
  "meta": {"templateCredsSetupCompleted": true, "instanceId": "production-template"},
  "id": "email-analysis-retrieval-ru",
  "tags": []
}
