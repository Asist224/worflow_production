{
  "name": "ğŸ‘¤ Email Contact Extractor [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ‘¤ Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ² Ğ¸Ğ· Email\n\n### ğŸ“‹ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ\nĞ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· email-Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ AI.\n\n---\n\n### âš™ï¸ CONFIG\n\n| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |\n|----------|----------|\n| `api_key` | API ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ |\n| `rate_limit_window_ms` | ĞĞºĞ½Ğ¾ rate limiting (Ğ¼Ñ) |\n| `rate_limit_max_requests` | ĞœĞ°ĞºÑ. Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ¾ĞºĞ½Ğµ |\n| `table_gmail_conversations` | Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞ¾Ğº |\n| `table_email_contact_data` | Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ² |\n\n---\n\n### ğŸ”— Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹\n\n| ĞœĞµÑ‚Ğ¾Ğ´ | ĞŸÑƒÑ‚ÑŒ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |\n|-------|------|----------|\n| POST | `/extract-email-contact` | Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ |\n| GET | `/get-email-contact-data` | ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ |\n\n---\n\n### ğŸ“¥ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ POST\n\n- `email` - email Ğ°Ğ´Ñ€ĞµÑ\n- `type` - Ñ‚Ğ¸Ğ¿ (single/batch)\n\n---\n\n### ğŸ¤– AI ĞœĞ¾Ğ´ĞµĞ»ÑŒ\n\nĞ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Google Gemini Ğ´Ğ»Ñ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ:\n- Ğ˜Ğ¼ĞµĞ½Ğ¸\n- Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°\n- ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸\n- Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸\n- Ğ”Ğ¾Ğ¿. ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ² (Telegram, WhatsApp)",
        "height": 620,
        "width": 380,
        "color": 5
      },
      "id": "sticky-note-main",
      "name": "ğŸ“ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-1400, -200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "api-key", "name": "api_key", "value": "YOUR_API_KEY_HERE", "type": "string"},
            {"id": "rate-window", "name": "rate_limit_window_ms", "value": 60000, "type": "number"},
            {"id": "rate-max", "name": "rate_limit_max_requests", "value": 60, "type": "number"},
            {"id": "table-conv", "name": "table_gmail_conversations", "value": "gmail_conversations", "type": "string"},
            {"id": "table-contact", "name": "table_email_contact_data", "value": "email_contact_data", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-extract",
      "name": "âš™ï¸ CONFIG: Extract",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-784, -192]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "api-key", "name": "api_key", "value": "YOUR_API_KEY_HERE", "type": "string"},
            {"id": "rate-window", "name": "rate_limit_window_ms", "value": 60000, "type": "number"},
            {"id": "rate-max", "name": "rate_limit_max_requests", "value": 60, "type": "number"},
            {"id": "table-conv", "name": "table_gmail_conversations", "value": "gmail_conversations", "type": "string"},
            {"id": "table-contact", "name": "table_email_contact_data", "value": "email_contact_data", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-get",
      "name": "âš™ï¸ CONFIG: Get",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-784, 320]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "extract-email-contact",
        "responseMode": "responseNode",
        "options": {"allowedOrigins": "*"}
      },
      "id": "webhook-extract",
      "name": "ğŸŒ Webhook: Extract",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-992, -192],
      "webhookId": "extract-email-contact-webhook"
    },
    {
      "parameters": {
        "path": "get-email-contact-data",
        "responseMode": "responseNode",
        "options": {"allowedOrigins": "*"}
      },
      "id": "webhook-get",
      "name": "ğŸŒ Webhook: Get Contacts",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-992, 320],
      "webhookId": "get-email-contact-data-webhook"
    },
    {
      "parameters": {
        "jsCode": "const config = $('âš™ï¸ CONFIG: Extract').first().json;\nconst inputData = $('ğŸŒ Webhook: Extract').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > config.rate_limit_window_ms) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > config.rate_limit_max_requests) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²', status: 429 } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey || providedKey !== config.api_key) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ API ĞºĞ»ÑÑ‡', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-576, -192],
      "id": "security-extract",
      "name": "ğŸ” Security Check"
    },
    {
      "parameters": {
        "jsCode": "const config = $('âš™ï¸ CONFIG: Get').first().json;\nconst inputData = $('ğŸŒ Webhook: Get Contacts').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > config.rate_limit_window_ms) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > config.rate_limit_max_requests) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²', status: 429 } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey || providedKey !== config.api_key) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ API ĞºĞ»ÑÑ‡', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-576, 320],
      "id": "security-get",
      "name": "ğŸ” Security Check 2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2},
          "conditions": [{"id": "auth-check", "leftValue": "={{ $json.authorized }}", "rightValue": "", "operator": {"type": "boolean", "operation": "true", "singleValue": true}}],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-368, -192],
      "id": "auth-check-1",
      "name": "â“ Auth Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2},
          "conditions": [{"id": "auth-check", "leftValue": "={{ $json.authorized }}", "rightValue": "", "operator": {"type": "boolean", "operation": "true", "singleValue": true}}],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-368, 320],
      "id": "auth-check-2",
      "name": "â“ Auth Check 2"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {"responseCode": "={{ $json.error.status }}"}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [-160, -96],
      "id": "error-response-1",
      "name": "âŒ Error Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {"responseCode": "={{ $json.error.status }}"}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [-160, 416],
      "id": "error-response-2",
      "name": "âŒ Error Response 2"
    },
    {
      "parameters": {
        "jsCode": "const requestData = items[0].json.body || items[0].json;\nreturn [{\n    json: {\n        email: requestData.email,\n        threadId: requestData.threadId,\n        extractionType: requestData.type || 'single'\n    }\n}];"
      },
      "id": "process-request",
      "name": "ğŸ“‹ Process Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-160, -288]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    email,\n    thread_id,\n    subject,\n    messages,\n    language,\n    message_count\nFROM {{ $('âš™ï¸ CONFIG: Extract').first().json.table_gmail_conversations }}\nWHERE email = '{{ $json.email }}'\nORDER BY updated_at DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-email-dialog",
      "name": "ğŸ˜ Get Email Dialog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [48, -288],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "const dialogs = items;\nconst dialogsForExtraction = [];\n\ndialogs.forEach(item => {\n    const data = item.json;\n    let messages = [];\n    try {\n        messages = typeof data.messages === 'string' ? JSON.parse(data.messages) : data.messages || [];\n    } catch (e) { messages = []; }\n    \n    const conversation = messages.map(msg => \n        `${msg.type === 'incoming' ? 'ĞšĞ»Ğ¸ĞµĞ½Ñ‚' : 'ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ'}: ${msg.content}`\n    ).join('\\n');\n    \n    dialogsForExtraction.push({\n        email: data.email,\n        threadId: data.thread_id,\n        subject: data.subject,\n        language: data.language,\n        conversation: conversation\n    });\n});\n\nreturn [{ json: { dialogs: dialogsForExtraction, totalDialogs: dialogsForExtraction.length } }];"
      },
      "id": "format-for-ai",
      "name": "ğŸ“‹ Format for AI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [256, -288]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²: {{ $json.totalDialogs }}\n\nEmail Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:\n{{ $json.dialogs.map((d, i) => `\\n--- Email Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ ${i+1} (Email: ${d.email}) ---\\nĞ¢ĞµĞ¼Ğ°: ${d.subject}\\nĞ¯Ğ·Ñ‹Ğº: ${d.language}\\n${d.conversation}`).join('\\n\\n') }}",
        "options": {
          "systemMessage": "#Ğ Ğ¾Ğ»ÑŒ: Ğ’Ñ‹ â€” ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· email-Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸.\n\n#Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°: ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ email-Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ¸ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ğ²ÑĞµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ².\n\n#Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸:\n1. Ğ˜Ğ¼Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° - Ğ¸Ğ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ\n2. Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ - Ğ¸Ğ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ»Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ°\n3. ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ - Ğ¸Ğ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸\n4. Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ - LinkedIn, Telegram, WhatsApp\n\n#Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° - Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹ JSON:\n{\n  \"contacts\": [\n    {\n      \"email\": \"email Ğ¸Ğ· Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°\",\n      \"name\": \"Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ¸Ğ»Ğ¸ null\",\n      \"firstName\": \"Ğ¸Ğ¼Ñ Ğ¸Ğ»Ğ¸ null\",\n      \"lastName\": \"Ñ„Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ Ğ¸Ğ»Ğ¸ null\",\n      \"phone\": \"Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¸Ğ»Ğ¸ null\",\n      \"company\": \"ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ null\",\n      \"position\": \"Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ»Ğ¸ null\",\n      \"location\": \"Ğ³Ğ¾Ñ€Ğ¾Ğ´/ÑÑ‚Ñ€Ğ°Ğ½Ğ° Ğ¸Ğ»Ğ¸ null\",\n      \"otherContacts\": {\"whatsapp\": null, \"telegram\": null},\n      \"extractedFrom\": \"Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ²Ğ·ÑÑ‚Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ\",\n      \"confidence\": Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¾Ñ‚ 0 Ğ´Ğ¾ 100\n    }\n  ]\n}\n\nĞ’Ğ°Ğ¶Ğ½Ğ¾: Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹Ñ‚Ğµ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ JSON!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [464, -288],
      "id": "ai-agent",
      "name": "ğŸ¤– Contact Extractor AI"
    },
    {
      "parameters": {"options": {"temperature": 0.3}},
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [464, -96],
      "id": "gemini-model",
      "name": "ğŸ§  Google Gemini",
      "credentials": {"googlePalmApi": {"id": "YOUR_GEMINI_CREDENTIAL_ID", "name": "Google Gemini Api"}}
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = items[0].json.output || items[0].json;\nlet contactsData;\ntry {\n    if (typeof aiResponse === 'string') {\n        let cleanJson = aiResponse;\n        const firstBrace = cleanJson.indexOf('{');\n        if (firstBrace > 0) cleanJson = cleanJson.substring(firstBrace);\n        const lastBrace = cleanJson.lastIndexOf('}');\n        if (lastBrace !== -1) cleanJson = cleanJson.substring(0, lastBrace + 1);\n        contactsData = JSON.parse(cleanJson.replace(/`/g, ''));\n    } else {\n        contactsData = aiResponse;\n    }\n    if (!contactsData.contacts) throw new Error('Invalid structure');\n} catch (e) {\n    contactsData = { contacts: [] };\n}\nreturn contactsData.contacts.map(contact => ({json: contact}));"
      },
      "id": "parse-response",
      "name": "ğŸ“‹ Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [672, -288]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO {{ $('âš™ï¸ CONFIG: Extract').first().json.table_email_contact_data }} (\n    email, full_name, first_name, last_name, phone,\n    company, position, location, other_contacts,\n    extracted_from, confidence_score, last_updated\n) VALUES (\n    '{{ $json.email }}',\n    {{ $json.name ? \"'\" + $json.name.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.firstName ? \"'\" + $json.firstName.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.lastName ? \"'\" + $json.lastName.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.phone ? \"'\" + $json.phone + \"'\" : 'NULL' }},\n    {{ $json.company ? \"'\" + $json.company.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.position ? \"'\" + $json.position.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.location ? \"'\" + $json.location.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    {{ $json.otherContacts ? \"'\" + JSON.stringify($json.otherContacts).replace(/'/g, \"''\") + \"'::jsonb\" : 'NULL' }},\n    '{{ ($json.extractedFrom || 'AI extraction').replace(/'/g, \"''\") }}',\n    {{ $json.confidence || 0 }},\n    CURRENT_TIMESTAMP\n)\nON CONFLICT (email) DO UPDATE SET\n    full_name = COALESCE(EXCLUDED.full_name, {{ $('âš™ï¸ CONFIG: Extract').first().json.table_email_contact_data }}.full_name),\n    phone = COALESCE(EXCLUDED.phone, {{ $('âš™ï¸ CONFIG: Extract').first().json.table_email_contact_data }}.phone),\n    company = COALESCE(EXCLUDED.company, {{ $('âš™ï¸ CONFIG: Extract').first().json.table_email_contact_data }}.company),\n    last_updated = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "id": "save-contact",
      "name": "ğŸ˜ Save Contact",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [880, -288],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\"status\": \"success\", \"message\": \"ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ñ‹\", \"processed\": $items('ğŸ“‹ Parse Response').length} }}",
        "options": {}
      },
      "id": "respond-extract",
      "name": "âœ… Respond Extract",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1088, -288]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    ecd.*,\n    gc.lead_score,\n    gc.subject,\n    gc.message_count\nFROM {{ $('âš™ï¸ CONFIG: Get').first().json.table_email_contact_data }} ecd\nLEFT JOIN {{ $('âš™ï¸ CONFIG: Get').first().json.table_gmail_conversations }} gc ON ecd.email = gc.email\nWHERE ecd.last_updated >= NOW() - INTERVAL '30 days'\nORDER BY ecd.last_updated DESC;",
        "options": {}
      },
      "id": "get-contacts-db",
      "name": "ğŸ˜ Get Contacts",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-160, 224],
      "credentials": {"postgres": {"id": "YOUR_POSTGRES_CREDENTIAL_ID", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "jsCode": "const contacts = {};\nitems.forEach(item => {\n    const data = item.json;\n    contacts[data.email] = {\n        email: data.email,\n        name: data.full_name || `${data.first_name || ''} ${data.last_name || ''}`.trim() || null,\n        phone: data.phone,\n        company: data.company,\n        position: data.position,\n        location: data.location,\n        otherContacts: data.other_contacts,\n        leadScore: data.lead_score || 0,\n        confidence: data.confidence_score,\n        lastUpdated: data.last_updated\n    };\n});\nreturn [{json: {contacts}}];"
      },
      "id": "format-contacts",
      "name": "ğŸ“‹ Format Contacts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [48, 224]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-get",
      "name": "âœ… Respond Get",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [256, 224]
    }
  ],
  "pinData": {},
  "connections": {
    "ğŸŒ Webhook: Extract": {"main": [[{"node": "âš™ï¸ CONFIG: Extract", "type": "main", "index": 0}]]},
    "ğŸŒ Webhook: Get Contacts": {"main": [[{"node": "âš™ï¸ CONFIG: Get", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG: Extract": {"main": [[{"node": "ğŸ” Security Check", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG: Get": {"main": [[{"node": "ğŸ” Security Check 2", "type": "main", "index": 0}]]},
    "ğŸ” Security Check": {"main": [[{"node": "â“ Auth Check", "type": "main", "index": 0}]]},
    "ğŸ” Security Check 2": {"main": [[{"node": "â“ Auth Check 2", "type": "main", "index": 0}]]},
    "â“ Auth Check": {"main": [[{"node": "ğŸ“‹ Process Request", "type": "main", "index": 0}], [{"node": "âŒ Error Response", "type": "main", "index": 0}]]},
    "â“ Auth Check 2": {"main": [[{"node": "ğŸ˜ Get Contacts", "type": "main", "index": 0}], [{"node": "âŒ Error Response 2", "type": "main", "index": 0}]]},
    "ğŸ“‹ Process Request": {"main": [[{"node": "ğŸ˜ Get Email Dialog", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Email Dialog": {"main": [[{"node": "ğŸ“‹ Format for AI", "type": "main", "index": 0}]]},
    "ğŸ“‹ Format for AI": {"main": [[{"node": "ğŸ¤– Contact Extractor AI", "type": "main", "index": 0}]]},
    "ğŸ§  Google Gemini": {"ai_languageModel": [[{"node": "ğŸ¤– Contact Extractor AI", "type": "ai_languageModel", "index": 0}]]},
    "ğŸ¤– Contact Extractor AI": {"main": [[{"node": "ğŸ“‹ Parse Response", "type": "main", "index": 0}]]},
    "ğŸ“‹ Parse Response": {"main": [[{"node": "ğŸ˜ Save Contact", "type": "main", "index": 0}]]},
    "ğŸ˜ Save Contact": {"main": [[{"node": "âœ… Respond Extract", "type": "main", "index": 0}]]},
    "ğŸ˜ Get Contacts": {"main": [[{"node": "ğŸ“‹ Format Contacts", "type": "main", "index": 0}]]},
    "ğŸ“‹ Format Contacts": {"main": [[{"node": "âœ… Respond Get", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {"executionOrder": "v1"},
  "versionId": "production-ru-v1",
  "meta": {"templateCredsSetupCompleted": true, "instanceId": "production-template"},
  "id": "email-contact-extractor-ru",
  "tags": []
}
